#### **1.1 Введение в тему занятия**

- Начало занятия, проверка связи и трансляции экрана.
- Обсуждение целей занятия: **создание и наполнение основного слоя Data Vault**.
- Курс ориентирован на **реализацию хранилища данных** с использованием методологии **Data Vault**.
- Разбираются **основные объекты** модели: **Hubs, Links, Satellites**.
- Вопрос о **каскадном удалении** таблиц, его влиянии на целостность данных.

---

#### **1.2 Каскадное удаление в Data Vault**

- **Каскадное удаление (ON DELETE CASCADE)** — механизм удаления записей в связанных таблицах.
- Проблема: если удалить **Hub**, а на него ссылаются **Links и Satellites**, в базе останутся **"висячие" ссылки**.
- Решение: удалять **данные по уровням**:
    1. **Сначала** удаляются **Satellites**.
    2. **Затем** удаляются **Links**.
    3. **Последними** удаляются **Hubs**.
- Каскадное удаление **может привести к неожиданному удалению** данных.
- Альтернативный вариант: **ручное удаление в строгом порядке** (без CASCADE).

---

#### **1.3 Создание схемы `DataVault`**

- В схеме **Public** остаются **временные таблицы (staging)**.
- **Все основные таблицы перемещаются в схему `DataVault`**.
- Создание схемы:
    
    ```sql
    CREATE SCHEMA DataVault;
    ```
    
- Перенос всех объектов в новую схему.
- **Ошибка**: в некоторых местах не указана схема `DataVault`, из-за чего ссылки ссылаются на `Public`.
- **Исправление**: везде, где есть `REFERENCES`, добавить `DataVault.` перед именем таблицы.

---

#### **1.4 Добавление системных полей**

- В каждую таблицу добавляются **два технических поля**:
    1. `load_date TIMESTAMP NOT NULL DEFAULT NOW()` — **дата загрузки** записи в хранилище.
    2. `record_source VARCHAR(50) NOT NULL` — **источник данных** (например, название системы).
- Эти поля нужны для **отслеживания изменений и источника данных**.

Пример:

```sql
ALTER TABLE staging.Film
ADD COLUMN load_date TIMESTAMP NOT NULL DEFAULT NOW(),
ADD COLUMN record_source VARCHAR(50) NOT NULL;
```

- Эти поля добавляются во **все Staging-таблицы**: `Film`, `Inventory`, `Rental`.
- Ошибка: после добавления **старый код загрузки не заполняет новые поля**.
- **Исправление**: добавить заполнение `load_date` и `record_source` в код загрузки.

Пример:

```sql
INSERT INTO staging.Film (film_id, title, description, load_date, record_source)
VALUES (1, 'Titanic', 'Epic romance', NOW(), 'Source A');
```

---

#### **1.5 Пересоздание схемы и тестирование**

- После исправлений все таблицы в **Public** удаляются.
- Система **пересоздается с учетом новой схемы** `DataVault`.
- Проверка:
    
    ```sql
    SELECT * FROM DataVault.HubFilm;
    ```
    
- Убеждаемся, что таблицы созданы **в правильных схемах**.
- Тестовая загрузка данных, проверка заполнения **`load_date` и `record_source`**.

---

✅ **Выводы по части 1**:

- **Каскадное удаление не используется**, данные удаляются **в строгом порядке**.
- Создана **новая схема `DataVault`**, в ней размещены **Hubs, Links, Satellites**.
- Введены **системные поля** `load_date` и `record_source`.
- Проведено **пересоздание и тестирование** структуры.