### **2.1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏**

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ `fact_rental` –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:

- –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å **SQL-—Å–∫—Ä–∏–ø—Ç**, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç **–ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å —Å—Ç–µ–π–¥–∂–∏–Ω–≥- –∏ core-—Å–ª–æ–∏**.
- –£–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –ø–µ—Ä–µ–¥ –∏—Ö –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ–º.
- –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∑–∞–Ω–æ–≤–æ –≤—Å–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î.
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.

–≠—Ç–æ—Ç —ç—Ç–∞–ø –≤–∞–∂–µ–Ω –¥–ª—è **–ø–æ–≤—Ç–æ—Ä—è–µ–º–æ—Å—Ç–∏** –ø—Ä–æ—Ü–µ—Å—Å–∞: –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ë–î –Ω–∞ –¥—Ä—É–≥–æ–º —Å–µ—Ä–≤–µ—Ä–µ, –º—ã —Å–º–æ–∂–µ–º –ª–µ–≥–∫–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã.

---

### **2.2. –°–æ–∑–¥–∞–Ω–∏–µ SQL-—Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ–µ–≤**

–°–∫—Ä–∏–ø—Ç –≤–∫–ª—é—á–∞–µ—Ç **—É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä**, –∞ –∑–∞—Ç–µ–º –∏—Ö –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ.

#### **–£–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä**

–í –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å —É–¥–∞–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—ã –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, –∏—Å–ø–æ–ª—å–∑—É—è `DROP IF EXISTS`, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫:

```sql
DROP TABLE IF EXISTS core.fact_rental CASCADE;
DROP TABLE IF EXISTS core.dim_inventory CASCADE;
DROP TABLE IF EXISTS core.dim_staff CASCADE;
DROP TABLE IF EXISTS staging.rental CASCADE;
DROP TABLE IF EXISTS staging.payment CASCADE;

DROP PROCEDURE IF EXISTS load_core_rental;
```

- **–ü–æ—á–µ–º—É `CASCADE`?**  
    ‚Üí –û–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ `fact_rental` —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ `dim_inventory`.

---

### **2.3. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü**

–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–Ω–æ–≤–æ.

#### **–°–æ–∑–¥–∞–Ω–∏–µ `fact_rental`**

```sql
CREATE TABLE core.fact_rental (
    rental_id SERIAL PRIMARY KEY,
    rental_date DATE NOT NULL,
    return_date DATE,
    total_amount NUMERIC DEFAULT 0,
    inventory_fk INT REFERENCES core.dim_inventory(inventory_fk),
    staff_fk INT REFERENCES core.dim_staff(staff_fk)
);
```

- `total_amount` –ø–æ–ª—É—á–∞–µ—Ç `DEFAULT 0`, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å `NULL`.
- `inventory_fk` –∏ `staff_fk` ‚Äî —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è.

#### **–°–æ–∑–¥–∞–Ω–∏–µ `dim_inventory`**

```sql
CREATE TABLE core.dim_inventory (
    inventory_fk SERIAL PRIMARY KEY,
    inventory_id INT NOT NULL UNIQUE
);
```

- `inventory_id` ‚Äî —ç—Ç–æ –≤–Ω–µ—à–Ω–∏–π –∫–ª—é—á –¥–ª—è —Å–≤—è–∑–∏ —Å `staging.rental`.

#### **–°–æ–∑–¥–∞–Ω–∏–µ `dim_staff`**

```sql
CREATE TABLE core.dim_staff (
    staff_fk SERIAL PRIMARY KEY,
    staff_id INT NOT NULL UNIQUE
);
```

- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ `dim_inventory`, –Ω–æ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.

#### **–°–æ–∑–¥–∞–Ω–∏–µ `staging.rental`**

```sql
CREATE TABLE staging.rental (
    rental_id INT PRIMARY KEY,
    rental_date TIMESTAMP NOT NULL,
    return_date TIMESTAMP,
    inventory_id INT NOT NULL,
    staff_id INT NOT NULL
);
```

- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ç–º–µ—Ç–∫–∏ (`TIMESTAMP`), —Ç–∞–∫ –∫–∞–∫ –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –∞—Ä–µ–Ω–¥—ã.

#### **–°–æ–∑–¥–∞–Ω–∏–µ `staging.payment`**

```sql
CREATE TABLE staging.payment (
    payment_id SERIAL PRIMARY KEY,
    rental_id INT REFERENCES staging.rental(rental_id),
    amount NUMERIC NOT NULL DEFAULT 0
);
```

- **–°—Å—ã–ª–∫–∞ –Ω–∞ `rental_id`** ‚Üí —Å–≤—è–∑—å –º–µ–∂–¥—É –ø–ª–∞—Ç–µ–∂–∞–º–∏ –∏ –∞—Ä–µ–Ω–¥–æ–π.

---

### **2.4. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö**

–ü–æ—Å–ª–µ —Ç–∞–±–ª–∏—Ü **–ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ü–µ–¥—É—Ä—É `load_core_rental`**, –∫–∞–∫ —ç—Ç–æ –±—ã–ª–æ –æ–ø–∏—Å–∞–Ω–æ –≤ —á–∞—Å—Ç–∏ 1:

```sql
CREATE OR REPLACE PROCEDURE load_core_rental()
LANGUAGE plpgsql
AS $$
BEGIN
    DELETE FROM core.fact_rental;
    
    INSERT INTO core.fact_rental (rental_date, return_date, total_amount, inventory_fk, staff_fk)
    SELECT rental_date::date, return_date::date, COALESCE(SUM(p.amount), 0), di.inventory_fk, ds.staff_fk
    FROM staging.rental r
    LEFT JOIN staging.payment p ON r.rental_id = p.rental_id
    INNER JOIN core.dim_inventory di ON r.inventory_id = di.inventory_id
    INNER JOIN core.dim_staff ds ON r.staff_id = ds.staff_id
    GROUP BY rental_date, return_date, di.inventory_fk, ds.staff_fk;
END;
$$;
```

- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ **–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞**: –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è.
- `COALESCE(SUM(p.amount), 0)` —Ç–µ–ø–µ—Ä—å –∑–∞–º–µ–Ω—è–µ—Ç `NULL` –Ω–∞ `0`.

---

### **2.5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–ª–æ–µ–≤**

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–ª–∏—Å—å:

```sql
SELECT * FROM core.fact_rental LIMIT 10;
```

- –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ `relation does not exist`, –∑–Ω–∞—á–∏—Ç, —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞.
- –ï—Å–ª–∏ `SELECT` –ø—É—Å—Ç, –Ω–æ –æ—à–∏–±–æ–∫ –Ω–µ—Ç, –∑–Ω–∞—á–∏—Ç, –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö.

–ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏:

```sql
CALL load_core_rental();
```

–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–æ–∫:

```sql
SELECT COUNT(*) FROM core.fact_rental;
```

---

### **–í—ã–≤–æ–¥**

- **–£–¥–∞–ª–µ–Ω—ã –∏ –∑–∞–Ω–æ–≤–æ —Å–æ–∑–¥–∞–Ω—ã** —Ç–∞–±–ª–∏—Ü—ã —Å—Ç–µ–π–¥–∂–∏–Ω–≥- –∏ core-—Å–ª–æ—è.
- **–ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ `load_core_rental`**.
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏** (`NULL` –≤ `total_amount`, –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞).
- **–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ `fact_rental`** –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.

---

–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –ø–æ–ø—Ä–æ—Å–∏—Ç—å **–ø–µ—Ä–µ—Å–∫–∞–∑ —á–∞—Å—Ç–∏ 3**, –≥–¥–µ —Ä–∞–∑–±–µ—Ä–µ–º **–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫ –≤ `rental` –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏**! üöÄ