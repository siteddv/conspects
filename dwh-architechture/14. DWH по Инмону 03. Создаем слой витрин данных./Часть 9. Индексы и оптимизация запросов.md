## 🎯 **Основные вопросы блока**

🔹 **Нужно ли создавать индексы в DWH?**  
🔹 **Как индексы влияют на скорость работы?**  
🔹 **Какие типы индексов использовать?**  
🔹 **Как сбалансировать скорость загрузки и выборки данных?**

---

## 📌 **Нужно ли создавать индексы в хранилище данных?**

🎯 **Что делают индексы?**

- Ускоряют **поиск данных** в таблицах.
- Оптимизируют **фильтрацию и соединение таблиц (JOIN'ы)**.
- Уменьшают нагрузку на базу данных при выполнении запросов.

🎯 **Почему в DWH индексы не всегда полезны?**

- В хранилищах **данные загружаются пакетами (Batch Load)**.
- Если в таблице **много индексов**, это **замедляет вставку данных**.
- Индексы полезны **для витрин и аналитики, но не всегда для слоя DDS**.

📌 **Когда индексы нужны?**  
✅ Если таблица **используется в отчетах и BI-инструментах**.  
✅ Если по таблице часто выполняются **фильтрации и поиск по ключам**.  
✅ Если таблица **не обновляется часто**, а в основном используется для чтения.

📌 **Когда индексы НЕ нужны?**  
❌ Если таблица **обновляется большими пакетами данных**.  
❌ Если запросы выполняются **по всей таблице без фильтрации**.  
❌ Если данные агрегируются **и используются редко**.

---

## 📌 **Как индексы влияют на скорость работы?**

🎯 **Влияние индексов на производительность**

|Действие|Без индекса|С индексом|
|---|---|---|
|**Вставка данных (INSERT, UPDATE, DELETE)**|🔹 Быстрая|🔻 Медленная (индексы нужно обновлять)|
|**Поиск по ключу (SELECT с WHERE)**|🔻 Медленный|🔹 Быстрый|
|**Группировка и сортировка (GROUP BY, ORDER BY)**|🔻 Медленный|🔹 Быстрый|

✅ **Вывод:**

- Если таблица **постоянно обновляется**, индексы могут **замедлить загрузку данных**.
- Если таблица **только читается**, индексы **ускоряют запросы**.
- В витринах данных **индексы чаще полезны**, чем в слое DDS.

---

## 📌 **Какие типы индексов использовать?**

🎯 **1. Обычный (B-Tree) индекс**

- **Используется для поиска по точному значению или диапазону (`=`, `>`, `<`)**.
- Подходит для полей с **даты, идентификаторы (ID), суммы**.

📌 **Пример:**

```sql
CREATE INDEX idx_sales_date ON report.sales_by_date (sales_date);
```

✅ **Ускоряет запросы с `WHERE sales_date BETWEEN '2023-01-01' AND '2023-01-31'`.**

---

🎯 **2. Уникальный индекс (Unique Index)**

- **Запрещает дубликаты в таблице**.
- Подходит для **уникальных ключей (например, ID клиентов, заказов и т. д.)**.

📌 **Пример:**

```sql
CREATE UNIQUE INDEX idx_unique_sales ON report.sales_by_date (sales_date);
```

✅ **Гарантирует, что в таблице не будет дубликатов дат.**

---

🎯 **3. Индекс на несколько колонок (Composite Index)**

- **Используется, когда запрос фильтруется по нескольким полям**.
- Подходит для **группировки данных по нескольким критериям**.

📌 **Пример:**

```sql
CREATE INDEX idx_sales_film ON report.sales_by_film (sales_date, film_title);
```

✅ **Ускоряет запросы с `WHERE sales_date = '2023-01-01' AND film_title = 'Интерстеллар'`.**

---

🎯 **4. Покрывающий индекс (Covering Index)**

- **Создаётся для часто используемых запросов**.
- Позволяет базе данных **получать все нужные данные прямо из индекса, без обращения к таблице**.

📌 **Пример:**

```sql
CREATE INDEX idx_sales_covering ON report.sales_by_date (sales_date, amount) INCLUDE (film_id);
```

✅ **Ускоряет выборку `sales_date`, `amount` и `film_id` без обращения к основной таблице.**

---

## 📌 **Как сбалансировать скорость загрузки и выборки данных?**

🎯 **Если таблица используется в отчетах и BI:**  
✅ Добавляем индексы для ускорения `SELECT`-запросов.  
✅ Оптимизируем индексы, чтобы не создавать лишние.

🎯 **Если таблица загружается большими пакетами данных:**  
❌ Убираем индексы перед загрузкой (`DROP INDEX`).  
✅ Загружаем данные **без индексов**, затем создаем их (`CREATE INDEX`).

📌 **Пример:**

```sql
-- Удаляем индексы перед загрузкой данных
DROP INDEX IF EXISTS idx_sales_date;

-- Загружаем данные в витрину
INSERT INTO report.sales_by_date (sales_date, amount)
SELECT sales_date, SUM(amount) FROM dds.payment GROUP BY sales_date;

-- Восстанавливаем индекс после загрузки
CREATE INDEX idx_sales_date ON report.sales_by_date (sales_date);
```

✅ **Такой подход ускоряет процесс загрузки данных в 3-5 раз!**

---

## 🔑 **Вывод**

✅ **Индексы полезны для аналитических запросов, но замедляют загрузку данных.**  
✅ **Для витринных таблиц индексы ускоряют работу BI-инструментов.**  
✅ **Для таблиц DDS индексы можно не использовать, чтобы ускорить загрузку.**  
✅ **Если загружается большой объем данных, лучше сначала удалить индексы, а потом пересоздать.**