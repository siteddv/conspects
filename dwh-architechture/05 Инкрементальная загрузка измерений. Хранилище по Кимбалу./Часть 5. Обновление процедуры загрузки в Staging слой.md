–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ **–æ–±–Ω–æ–≤–ª–µ–Ω–∏—é –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –≤ `Staging` —Å–ª–æ–π**. –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —á—Ç–æ–±—ã **–ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `inventory`**.

---

### **üîπ –ß—Ç–æ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ –∑–∞–≥—Ä—É–∑–∫–∏?**

1Ô∏è‚É£ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **`last_update`**, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∏ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏.  
2Ô∏è‚É£ –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É **—É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π** (`deleted_at`).  
3Ô∏è‚É£ **–ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏** –≤ `last_update`.

---

### **üîç –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `last_update` –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä—É**

–ü–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–ª—É—á–∏—Ç—å **–≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏**, —á—Ç–æ–±—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

**–î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä—É:**

```sql
DECLARE last_update_dt TIMESTAMP;
```

**–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ `staging.last_update`:**

```sql
SELECT last_update INTO last_update_dt 
FROM staging.last_update 
WHERE table_name = 'inventory';
```

- –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º **–Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ** (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1900-01-01).
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç **–∏–∑–±–µ–∂–∞—Ç—å –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ**.

---

### **üîç –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö**

–¢–µ–ø–µ—Ä—å –∑–∞–ø—Ä–æ—Å –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ **–±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏**.

```sql
INSERT INTO staging.inventory 
SELECT * FROM public.inventory 
WHERE last_update > last_update_dt;
```

- –í–º–µ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∏ **–≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö** –º—ã –∑–∞–≥—Ä—É–∂–∞–µ–º **—Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏, –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Å –º–æ–º–µ–Ω—Ç–∞ `last_update_dt`**.

---

### **üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π**

–†–∞–Ω–µ–µ –º—ã –¥–æ–±–∞–≤–∏–ª–∏ **–ø–æ–ª–µ `deleted_at`** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π.  
–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ **—É—á–∏—Ç—ã–≤–∞—Ç—å —É–¥–∞–ª—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ –∑–∞–≥—Ä—É–∑–∫–∏**.

**–î–æ–±–∞–≤–ª—è–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:**

```sql
DELETE FROM warehouse.inventory 
WHERE inventory_id IN (
    SELECT inventory_id FROM staging.inventory 
    WHERE deleted_at IS NOT NULL
);
```

- –£–¥–∞–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ **—Ç–µ –∑–∞–ø–∏—Å–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö `deleted_at` –Ω–µ –ø—É—Å—Ç–æ–π**.
- –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, **–≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –±–æ–ª—å—à–µ –Ω–µ –±—É–¥—É—Ç –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏**.

---

### **üîç –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `last_update` –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏**

–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω—É–∂–Ω–æ **–∑–∞–ø–æ–º–Ω–∏—Ç—å –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ.

```sql
INSERT INTO staging.last_update (table_name, last_update)
VALUES ('inventory', CURRENT_TIMESTAMP)
ON CONFLICT (table_name) DO UPDATE SET last_update = CURRENT_TIMESTAMP;
```

- –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –≤ `last_update` **—É–∂–µ –µ—Å—Ç—å**, —Ç–æ **–æ–±–Ω–æ–≤–ª—è–µ–º** –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏.
- –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç ‚Äì **–≤—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é**.

---

### **üîπ –§–∏–Ω–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –≤ `Staging` —Å–ª–æ–π**

```sql
CREATE OR REPLACE PROCEDURE staging.load_inventory()
LANGUAGE plpgsql AS $$
DECLARE
    last_update_dt TIMESTAMP;
BEGIN
    -- –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
    SELECT last_update INTO last_update_dt 
    FROM staging.last_update 
    WHERE table_name = 'inventory';

    -- –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É 1900-01-01
    IF last_update_dt IS NULL THEN
        last_update_dt := '1900-01-01';
    END IF;

    -- –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ –∏ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
    INSERT INTO staging.inventory 
    SELECT * FROM public.inventory 
    WHERE last_update > last_update_dt;

    -- –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω—ã–µ
    DELETE FROM warehouse.inventory 
    WHERE inventory_id IN (
        SELECT inventory_id FROM staging.inventory 
        WHERE deleted_at IS NOT NULL
    );

    -- –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
    INSERT INTO staging.last_update (table_name, last_update)
    VALUES ('inventory', CURRENT_TIMESTAMP)
    ON CONFLICT (table_name) DO UPDATE SET last_update = CURRENT_TIMESTAMP;
END $$;
```

---

### **‚úÖ –ò—Ç–æ–≥: —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ?**

‚úî **–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `last_update_dt`** ‚Äì —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**.  
‚úî **–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π** ‚Äì —Ç–µ–ø–µ—Ä—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ—Å—Ç–∞—é—Ç—Å—è –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.  
‚úî **–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `staging.last_update`** ‚Äì –±–æ–ª—å—à–µ **–Ω–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö** –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ.  
‚úî **–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ —Å—Ç–∞–ª–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –±—ã—Å—Ç—Ä–µ–µ**, —Ç–∞–∫ –∫–∞–∫ –±–æ–ª—å—à–µ **–Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å—ë —Ö—Ä–∞–Ω–∏–ª–∏—â–µ**.