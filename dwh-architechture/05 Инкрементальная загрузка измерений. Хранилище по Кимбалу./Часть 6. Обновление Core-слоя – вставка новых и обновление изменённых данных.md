–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ Staging —Å–ª–æ–π, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–Ω–æ–≤–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (Core-—Å–ª–æ–π), —á—Ç–æ–±—ã —É—á–∏—Ç—ã–≤–∞—Ç—å –Ω–æ–≤—ã–µ, –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –∏ —É–¥–∞–ª—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏.

---

### **üîπ –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ Core-—Å–ª–æ–π**

1Ô∏è‚É£ **–î–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏**, –µ—Å–ª–∏ –æ–Ω–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –≤ `Staging`.  
2Ô∏è‚É£ **–û–±–Ω–æ–≤–ª—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏**, –µ—Å–ª–∏ –æ–Ω–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å.  
3Ô∏è‚É£ **–£–¥–∞–ª—è—Ç—å –∑–∞–ø–∏—Å–∏**, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ `deleted_at`.  
4Ô∏è‚É£ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ.

---

### **üîç –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `ON CONFLICT DO UPDATE` –≤ PostgreSQL**

–í PostgreSQL –Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã `MERGE` (–∫–∞–∫ –≤ Oracle –∏–ª–∏ MS SQL), –Ω–æ –µ—Å—Ç—å –∞–Ω–∞–ª–æ–≥ ‚Äì `ON CONFLICT DO UPDATE`.  
–≠—Ç–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç **–≤—Å—Ç–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ, –∞ –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –∏—Ö**.

üìå **–ü—Ä–∏–º–µ—Ä:**

```sql
INSERT INTO core.inventory (inventory_id, film_id, store_id, last_update)
SELECT inventory_id, film_id, store_id, last_update 
FROM staging.inventory
ON CONFLICT (inventory_id) 
DO UPDATE SET 
    film_id = EXCLUDED.film_id,
    store_id = EXCLUDED.store_id,
    last_update = EXCLUDED.last_update;
```

üîπ **–ß—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?**

- **–ï—Å–ª–∏ `inventory_id` —É–∂–µ –µ—Å—Ç—å –≤ `core.inventory`**, —Ç–æ –∑–∞–ø–∏—Å—å **–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è**.
- **–ï—Å–ª–∏ `inventory_id` –Ω–µ—Ç**, —Ç–æ –∑–∞–ø–∏—Å—å **–≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –Ω–æ–≤–∞—è**.
- `EXCLUDED.film_id` ‚Äì —ç—Ç–æ **–Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ `staging.inventory`**.

‚úÖ –¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ **—É—Å—Ç—Ä–∞–Ω—è–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** –∏ **–æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏**.

---

### **üîç –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –∏–∑ Core-—Å–ª–æ—è**

–†–∞–Ω–µ–µ –º—ã **–¥–æ–±–∞–≤–∏–ª–∏ `deleted_at`** –≤ `Staging`, —Ç–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ **–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —É–¥–∞–ª—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ Core-—Å–ª–æ–µ**.

üìå **–£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω—ã–µ:**

```sql
DELETE FROM core.inventory 
WHERE inventory_id IN (
    SELECT inventory_id FROM staging.inventory 
    WHERE deleted_at IS NOT NULL
);
```

- –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å —É–¥–∞–ª–∏—Ç **—Ç–æ–ª—å–∫–æ —Ç–µ –∑–∞–ø–∏—Å–∏**, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ **–ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω—ã–µ –≤ Staging**.

---

### **üîπ –§–∏–Ω–∞–ª—å–Ω—ã–π SQL-–∫–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Core-—Å–ª–æ–π**

```sql
CREATE OR REPLACE PROCEDURE core.load_inventory()
LANGUAGE plpgsql AS $$
BEGIN
    -- –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω—ã–µ
    DELETE FROM core.inventory 
    WHERE inventory_id IN (
        SELECT inventory_id FROM staging.inventory 
        WHERE deleted_at IS NOT NULL
    );

    -- –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
    INSERT INTO core.inventory (inventory_id, film_id, store_id, last_update)
    SELECT inventory_id, film_id, store_id, last_update 
    FROM staging.inventory
    ON CONFLICT (inventory_id) 
    DO UPDATE SET 
        film_id = EXCLUDED.film_id,
        store_id = EXCLUDED.store_id,
        last_update = EXCLUDED.last_update;
END $$;
```

---

### **‚úÖ –ò—Ç–æ–≥: —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ Core-—Å–ª–æ–µ?**

‚úî **–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `ON CONFLICT DO UPDATE`** ‚Äì —Ç–µ–ø–µ—Ä—å **–Ω–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö**.  
‚úî **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π —Å `deleted_at`** ‚Äì —Ç–µ–ø–µ—Ä—å **–≤ Core –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**.  
‚úî **–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞–ª–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –±—ã—Å—Ç—Ä–µ–µ**, —Ç–∞–∫ –∫–∞–∫ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏**.