# **–°–æ–∑–¥–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äì –û—Å–Ω–æ–≤—ã Data Vault**

## **–ß–∞—Å—Ç—å 6: –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞—Ç–µ–ª–ª–∏—Ç–æ–≤ (Satellites) –≤ Data Vault**

### **üìå –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã:**

- –ß—Ç–æ —Ç–∞–∫–æ–µ **—Å–∞—Ç–µ–ª–ª–∏—Ç (Satellite)** –≤ Data Vault?
- –°–æ–∑–¥–∞–Ω–∏–µ **—Å–∞—Ç–µ–ª–ª–∏—Ç–æ–≤** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—Ç—Ä–∏–±—É—Ç–æ–≤.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ **–∏—Å—Ç–æ—Ä–∏—á–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö**.
- –í–≤–µ–¥–µ–Ω–∏–µ **—Ö–µ—à-–¥–∏—Ñ–∞ (`hash_diff`)** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è.
- –°–æ–∑–¥–∞–Ω–∏–µ **–ø—Ä–æ—Ü–µ–¥—É—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–∞—Ç–µ–ª–ª–∏—Ç—ã**.

---

## **üîπ –®–∞–≥ 1. –ß—Ç–æ —Ç–∞–∫–æ–µ Satellite –≤ Data Vault?**

üìå **Satellite (–°–∞—Ç–µ–ª–ª–∏—Ç) ‚Äì —ç—Ç–æ —Ç–∞–±–ª–∏—Ü–∞, –∫–æ—Ç–æ—Ä–∞—è —Ö—Ä–∞–Ω–∏—Ç –∞—Ç—Ä–∏–±—É—Ç—ã –æ–±—ä–µ–∫—Ç–æ–≤.**

- –°–∞—Ç–µ–ª–ª–∏—Ç—ã –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ **—Ö–∞–±–∞–º –∏–ª–∏ –ª–∏–Ω–∫–∞–º**.
- –•—Ä–∞–Ω—è—Ç **–∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π** –¥–∞–Ω–Ω—ã—Ö.
- **–í—Å—è –Ω–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞**.

üìå **–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –≤ Satellite:**

|–ü–æ–ª–µ|–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|---|
|`hash_hub`|`VARCHAR(32)`|–•–µ—à-–∫–ª—é—á —Ö–∞–±–∞ –∏–ª–∏ –ª–∏–Ω–∫–∞|
|`load_date`|`TIMESTAMP`|–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö|
|`record_source`|`VARCHAR(50)`|–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö|
|`hash_diff`|`VARCHAR(32)`|–•–µ—à –≤—Å–µ—Ö –∑–Ω–∞—á–∏–º—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤|
|`attribute_1`|–†–∞–∑–Ω—ã–π —Ç–∏–ø|–ê—Ç—Ä–∏–±—É—Ç 1|
|`attribute_2`|–†–∞–∑–Ω—ã–π —Ç–∏–ø|–ê—Ç—Ä–∏–±—É—Ç 2|

---

## **üîπ –®–∞–≥ 2. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞—Ç–µ–ª–ª–∏—Ç–∞ –¥–ª—è `hub_film` (`sat_film`)**

üìå **–°–∞—Ç–µ–ª–ª–∏—Ç `sat_film` —Ö—Ä–∞–Ω–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏–ª—å–º–æ–≤.**

üîπ **–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É `sat_film`:**

```sql
CREATE TABLE sat_film (
    hash_hub VARCHAR(32) NOT NULL REFERENCES hub_film(hash_key),
    load_date TIMESTAMP NOT NULL,
    record_source VARCHAR(50) NOT NULL,
    hash_diff VARCHAR(32) NOT NULL,
    title VARCHAR(255),
    description TEXT,
    release_year INT,
    PRIMARY KEY (hash_hub, load_date)
);
```

üìå **–î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞:**

```sql
CREATE INDEX idx_sat_film ON sat_film (hash_hub);
```

---

## **üîπ –®–∞–≥ 3. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞—Ç–µ–ª–ª–∏—Ç–∞ –¥–ª—è `hub_inventory` (`sat_inventory`)**

üìå **–°–∞—Ç–µ–ª–ª–∏—Ç `sat_inventory` —Ö—Ä–∞–Ω–∏—Ç –∞—Ç—Ä–∏–±—É—Ç—ã –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è.**

üîπ **–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É `sat_inventory`:**

```sql
CREATE TABLE sat_inventory (
    hash_hub VARCHAR(32) NOT NULL REFERENCES hub_inventory(hash_key),
    load_date TIMESTAMP NOT NULL,
    record_source VARCHAR(50) NOT NULL,
    hash_diff VARCHAR(32) NOT NULL,
    store_id INT,
    last_update TIMESTAMP,
    PRIMARY KEY (hash_hub, load_date)
);
```

üìå **–î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å:**

```sql
CREATE INDEX idx_sat_inventory ON sat_inventory (hash_hub);
```

---

## **üîπ –®–∞–≥ 4. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞—Ç–µ–ª–ª–∏—Ç–∞ –¥–ª—è `hub_rental` (`sat_rental`)**

üìå **–°–∞—Ç–µ–ª–ª–∏—Ç `sat_rental` —Ö—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞—Ä–µ–Ω–¥–µ.**

üîπ **–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É `sat_rental`:**

```sql
CREATE TABLE sat_rental (
    hash_hub VARCHAR(32) NOT NULL REFERENCES hub_rental(hash_key),
    load_date TIMESTAMP NOT NULL,
    record_source VARCHAR(50) NOT NULL,
    hash_diff VARCHAR(32) NOT NULL,
    rental_date TIMESTAMP,
    return_date TIMESTAMP,
    staff_id INT,
    PRIMARY KEY (hash_hub, load_date)
);
```

üìå **–î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å:**

```sql
CREATE INDEX idx_sat_rental ON sat_rental (hash_hub);
```

---

## **üîπ –®–∞–≥ 5. –ü—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–∞—Ç–µ–ª–ª–∏—Ç—ã**

üìå **–ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è `hash_diff`?**

- –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –∑–Ω–∞—á–∏–º—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã –≤ **–æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É**.
- –í—ã—á–∏—Å–ª—è–µ–º **MD5-—Ö–µ—à** –æ—Ç —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏.
- –ü–æ–∑–≤–æ–ª—è–µ—Ç **–±—ã—Å—Ç—Ä–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å** –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–µ–∑ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

üîπ **–§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ `hash_diff`:**

```sql
CREATE OR REPLACE FUNCTION generate_hash_diff(input_value TEXT)
RETURNS VARCHAR(32) AS $$
BEGIN
    RETURN MD5(input_value);
END;
$$ LANGUAGE plpgsql;
```

---

### **üìå –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ `sat_film`**

```sql
CREATE OR REPLACE FUNCTION load_sat_film()
RETURNS VOID AS $$
BEGIN
    INSERT INTO sat_film (hash_hub, load_date, record_source, hash_diff, title, description, release_year)
    SELECT 
        generate_hash_key(f.film_id::TEXT),
        NOW(),
        'source_system',
        generate_hash_diff(f.title || f.description || f.release_year),
        f.title,
        f.description,
        f.release_year
    FROM staging.film f
    ON CONFLICT (hash_hub, load_date) DO NOTHING;
END;
$$ LANGUAGE plpgsql;
```

---

### **üìå –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ `sat_inventory`**

```sql
CREATE OR REPLACE FUNCTION load_sat_inventory()
RETURNS VOID AS $$
BEGIN
    INSERT INTO sat_inventory (hash_hub, load_date, record_source, hash_diff, store_id, last_update)
    SELECT 
        generate_hash_key(i.inventory_id::TEXT),
        NOW(),
        'source_system',
        generate_hash_diff(i.store_id::TEXT || i.last_update::TEXT),
        i.store_id,
        i.last_update
    FROM staging.inventory i
    ON CONFLICT (hash_hub, load_date) DO NOTHING;
END;
$$ LANGUAGE plpgsql;
```

---

### **üìå –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ `sat_rental`**

```sql
CREATE OR REPLACE FUNCTION load_sat_rental()
RETURNS VOID AS $$
BEGIN
    INSERT INTO sat_rental (hash_hub, load_date, record_source, hash_diff, rental_date, return_date, staff_id)
    SELECT 
        generate_hash_key(r.rental_id::TEXT),
        NOW(),
        'source_system',
        generate_hash_diff(r.rental_date::TEXT || r.return_date::TEXT || r.staff_id::TEXT),
        r.rental_date,
        r.return_date,
        r.staff_id
    FROM staging.rental r
    ON CONFLICT (hash_hub, load_date) DO NOTHING;
END;
$$ LANGUAGE plpgsql;
```

---

## **üîπ –®–∞–≥ 6. –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—â–µ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–∞—Ç–µ–ª–ª–∏—Ç–æ–≤**

```sql
CREATE OR REPLACE FUNCTION load_all_satellites()
RETURNS VOID AS $$
BEGIN
    PERFORM load_sat_film();
    PERFORM load_sat_inventory();
    PERFORM load_sat_rental();
END;
$$ LANGUAGE plpgsql;
```

üìå **–í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É:**

```sql
SELECT load_all_satellites();
```

---

## **‚úÖ –ò—Ç–æ–≥ 6-–π —á–∞—Å—Ç–∏:**

‚úî **–°–æ–∑–¥–∞–Ω—ã —Å–∞—Ç–µ–ª–ª–∏—Ç—ã:** `sat_film`, `sat_inventory`, `sat_rental`.  
‚úî **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `hash_diff` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.**  
‚úî **–î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞.**  
‚úî **–°–æ–∑–¥–∞–Ω—ã –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–∞—Ç–µ–ª–ª–∏—Ç—ã.**  
‚úî **–ü–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–∞—Ç–µ–ª–ª–∏—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π.**