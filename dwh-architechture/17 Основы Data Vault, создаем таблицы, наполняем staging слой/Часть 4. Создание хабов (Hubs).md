# **–°–æ–∑–¥–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äì –û—Å–Ω–æ–≤—ã Data Vault**

## **–ß–∞—Å—Ç—å 4: –°–æ–∑–¥–∞–Ω–∏–µ —Ö–∞–±–æ–≤ (Hubs) –≤ Data Vault**

### **üìå –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã:**

- –ß—Ç–æ —Ç–∞–∫–æ–µ **Hub** –≤ Data Vault?
- –°–æ–∑–¥–∞–Ω–∏–µ **—Ö–∞–±–æ–≤ (Hubs)** –≤ PostgreSQL.
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ **–∫–ª—é—á–µ–≤—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤**.
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ **–±–∏–∑–Ω–µ—Å-–∫–ª—é—á–µ–π** –∏ –∏—Ö —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ.
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ –∏–Ω–¥–µ–∫—Å–æ–≤**.

---

## **üîπ –®–∞–≥ 1. –ß—Ç–æ —Ç–∞–∫–æ–µ Hub –≤ Data Vault?**

üìå **Hub (–•–∞–±) ‚Äì —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤ Data Vault, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è –±–∏–∑–Ω–µ—Å-–∫–ª—é—á–∏.**

- –í —Ö–∞–±–∞—Ö **–Ω–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–æ–≤**, –∫—Ä–æ–º–µ **–∫–ª—é—á–∞ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö**.
- **–ö–∞–∂–¥–∞—è —Å—É—â–Ω–æ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, Film, Inventory, Rental) –∏–º–µ–µ—Ç —Å–≤–æ–π —Ö–∞–±**.
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ **—Å–∞—Ç–µ–ª–ª–∏—Ç–∞—Ö**, –∞ —Å–≤—è–∑–∏ ‚Äì –≤ **–ª–∏–Ω–∫–∞—Ö**.

**üìå –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –≤ Hub:**

|–ü–æ–ª–µ|–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|---|
|`hash_key`|`VARCHAR(32)`|–•–µ—à-–∫–ª—é—á —Å—Ç—Ä–æ–∫–∏ (md5 –æ—Ç –±–∏–∑–Ω–µ—Å-–∫–ª—é—á–∞)|
|`business_key`|`INT` (–∏–ª–∏ `VARCHAR`)|–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞|
|`load_date`|`TIMESTAMP`|–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Data Vault|
|`record_source`|`VARCHAR(50)`|–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö|

---

## **üîπ –®–∞–≥ 2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã Hub –¥–ª—è —Ñ–∏–ª—å–º–æ–≤ (`hub_film`)**

üìå **–ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è `hash_key`?**

- –•–µ—à —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç `film_id` (–±–∏–∑–Ω–µ—Å-–∫–ª—é—á–∞).
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–ª–≥–æ—Ä–∏—Ç–º **MD5**.
- `hash_key` –¥–ª–∏–Ω–æ–π **32 —Å–∏–º–≤–æ–ª–∞** (md5 –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 32 —Å–∏–º–≤–æ–ª–∞).

üîπ **–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É `hub_film`:**

```sql
CREATE TABLE hub_film (
    hash_key VARCHAR(32) PRIMARY KEY,
    film_id INT NOT NULL,
    load_date TIMESTAMP NOT NULL,
    record_source VARCHAR(50) NOT NULL
);
```

üìå **–î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞:**

```sql
CREATE UNIQUE INDEX idx_hub_film ON hub_film (film_id);
```

---

## **üîπ –®–∞–≥ 3. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã Hub –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è (`hub_inventory`)**

üìå **–ë–∏–∑–Ω–µ—Å-–∫–ª—é—á–æ–º —è–≤–ª—è–µ—Ç—Å—è `inventory_id`**.

```sql
CREATE TABLE hub_inventory (
    hash_key VARCHAR(32) PRIMARY KEY,
    inventory_id INT NOT NULL,
    load_date TIMESTAMP NOT NULL,
    record_source VARCHAR(50) NOT NULL
);
```

üìå **–î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å:**

```sql
CREATE UNIQUE INDEX idx_hub_inventory ON hub_inventory (inventory_id);
```

---

## **üîπ –®–∞–≥ 4. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã Hub –¥–ª—è –∞—Ä–µ–Ω–¥—ã (`hub_rental`)**

üìå **–ë–∏–∑–Ω–µ—Å-–∫–ª—é—á–æ–º —è–≤–ª—è–µ—Ç—Å—è `rental_id`**.

```sql
CREATE TABLE hub_rental (
    hash_key VARCHAR(32) PRIMARY KEY,
    rental_id INT NOT NULL,
    load_date TIMESTAMP NOT NULL,
    record_source VARCHAR(50) NOT NULL
);
```

üìå **–î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å:**

```sql
CREATE UNIQUE INDEX idx_hub_rental ON hub_rental (rental_id);
```

---

## **üîπ –®–∞–≥ 5. –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ö–∞–±—ã**

üìå **–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ö–∞–±—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º MD5-—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è.**

üîπ **–§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ `hash_key`:**

```sql
CREATE OR REPLACE FUNCTION generate_hash_key(input_value TEXT)
RETURNS VARCHAR(32) AS $$
BEGIN
    RETURN MD5(input_value);
END;
$$ LANGUAGE plpgsql;
```

üîπ **–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ `hub_film`:**

```sql
CREATE OR REPLACE FUNCTION load_hub_film()
RETURNS VOID AS $$
BEGIN
    INSERT INTO hub_film (hash_key, film_id, load_date, record_source)
    SELECT 
        generate_hash_key(film_id::TEXT),
        film_id, 
        NOW(), 
        'source_system'
    FROM staging.film
    ON CONFLICT (film_id) DO NOTHING;
END;
$$ LANGUAGE plpgsql;
```

üîπ **–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ `hub_inventory`:**

```sql
CREATE OR REPLACE FUNCTION load_hub_inventory()
RETURNS VOID AS $$
BEGIN
    INSERT INTO hub_inventory (hash_key, inventory_id, load_date, record_source)
    SELECT 
        generate_hash_key(inventory_id::TEXT),
        inventory_id, 
        NOW(), 
        'source_system'
    FROM staging.inventory
    ON CONFLICT (inventory_id) DO NOTHING;
END;
$$ LANGUAGE plpgsql;
```

üîπ **–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ `hub_rental`:**

```sql
CREATE OR REPLACE FUNCTION load_hub_rental()
RETURNS VOID AS $$
BEGIN
    INSERT INTO hub_rental (hash_key, rental_id, load_date, record_source)
    SELECT 
        generate_hash_key(rental_id::TEXT),
        rental_id, 
        NOW(), 
        'source_system'
    FROM staging.rental
    ON CONFLICT (rental_id) DO NOTHING;
END;
$$ LANGUAGE plpgsql;
```

---

## **üîπ –®–∞–≥ 6. –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—â–µ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Ö–∞–±–æ–≤**

```sql
CREATE OR REPLACE FUNCTION load_all_hubs()
RETURNS VOID AS $$
BEGIN
    PERFORM load_hub_film();
    PERFORM load_hub_inventory();
    PERFORM load_hub_rental();
END;
$$ LANGUAGE plpgsql;
```

üìå **–í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É:**

```sql
SELECT load_all_hubs();
```

---

## **‚úÖ –ò—Ç–æ–≥ 4-–π —á–∞—Å—Ç–∏:**

‚úî **–°–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã —Ö–∞–±–æ–≤:** `hub_film`, `hub_inventory`, `hub_rental`.  
‚úî **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ MD5-—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–∫–ª—é—á–µ–π.**  
‚úî **–î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞.**  
‚úî **–°–æ–∑–¥–∞–Ω—ã –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ö–∞–±—ã.**  
‚úî **–ü–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ö–∞–±–æ–≤ —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π.**