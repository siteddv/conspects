# **–°–æ–∑–¥–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äì –û—Å–Ω–æ–≤—ã Data Vault**

## **–ß–∞—Å—Ç—å 3: –°–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç–µ–π–¥–∂–∏–Ω–≥ —Å–ª–æ—è**

### **üìå –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã:**

- –°–æ–∑–¥–∞–Ω–∏–µ **—Å—Ç–µ–π–¥–∂–∏–Ω–≥ —Å–ª–æ—è** (Staging).
- –°–æ–∑–¥–∞–Ω–∏–µ **—Å—Ö–µ–º—ã** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ **—Ç–∞–±–ª–∏—Ü –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö** –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞.
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è **–ø—Ä–æ—Ü–µ–¥—É—Ä –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ç–µ–π–¥–∂–∏–Ω–≥ —Å–ª–æ—è**.
- –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É **–ø–æ–ª–Ω–æ–π –∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π**.

---

## **üîπ –®–∞–≥ 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã Staging**

üìå **–ó–∞—á–µ–º –Ω—É–∂–µ–Ω staging —Å–ª–æ–π?**

- –≠—Ç–æ **–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ**, –∫—É–¥–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è **—Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ** –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∏ **–∑–∞–≥—Ä—É–∑–∫–æ–π –≤ Data Vault**.
- –ü–æ–∑–≤–æ–ª—è–µ—Ç **–∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏** –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

üîπ **–°–æ–∑–¥–∞–¥–∏–º —Å—Ö–µ–º—É `staging`:**

```sql
CREATE SCHEMA staging;
```

–¢–µ–ø–µ—Ä—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã **staging —Å–ª–æ—è** –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –∑–¥–µ—Å—å.

---

## **üîπ –®–∞–≥ 2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü Staging**

üìå **–ö–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã –±—É–¥–µ–º –∑–∞–≥—Ä—É–∂–∞—Ç—å?**

- **–§–∏–ª—å–º—ã (`staging.film`)**
- **–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (`staging.inventory`)**
- **–§–∞–∫—Ç—ã –∞—Ä–µ–Ω–¥—ã (`staging.rental`)**

### **üìå –¢–∞–±–ª–∏—Ü–∞ `staging.film`**

- –°–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–∏—Å–æ–∫ —Ñ–∏–ª—å–º–æ–≤.
- –•—Ä–∞–Ω–∏—Ç –∞—Ç—Ä–∏–±—É—Ç—ã: –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, –≥–æ–¥, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Ä–µ–π—Ç–∏–Ω–≥.
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `last_update` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.

```sql
CREATE TABLE staging.film (
    film_id INT PRIMARY KEY,
    title VARCHAR(255),
    description TEXT,
    release_year INT,
    rental_duration INT,
    rental_rate NUMERIC(4,2),
    length INT,
    replacement_cost NUMERIC(5,2),
    rating VARCHAR(10),
    last_update TIMESTAMP
);
```

---

### **üìå –¢–∞–±–ª–∏—Ü–∞ `staging.inventory`**

- –•—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –æ **–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–ø–∏—è—Ö —Ñ–∏–ª—å–º–æ–≤**.
- –°–≤—è–∑—ã–≤–∞–µ—Ç —Ñ–∏–ª—å–º—ã —Å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º–∏ –Ω–æ—Å–∏—Ç–µ–ª—è–º–∏ (DVD, Blu-ray –∏ —Ç. –¥.).

```sql
CREATE TABLE staging.inventory (
    inventory_id INT PRIMARY KEY,
    film_id INT REFERENCES staging.film(film_id),
    store_id INT,
    last_update TIMESTAMP
);
```

---

### **üìå –¢–∞–±–ª–∏—Ü–∞ `staging.rental`**

- –§–∏–∫—Å–∏—Ä—É–µ—Ç **—Ñ–∞–∫—Ç—ã –∞—Ä–µ–Ω–¥—ã —Ñ–∏–ª—å–º–æ–≤**.
- –°–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ **–¥–∞—Ç–µ –∞—Ä–µ–Ω–¥—ã –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞**.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è **–∞–Ω–∞–ª–∏–∑–∞ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ —Ñ–∏–ª—å–º–æ–≤**.

```sql
CREATE TABLE staging.rental (
    rental_id INT PRIMARY KEY,
    rental_date TIMESTAMP,
    inventory_id INT REFERENCES staging.inventory(inventory_id),
    customer_id INT,
    return_date TIMESTAMP,
    staff_id INT,
    last_update TIMESTAMP
);
```

---

## **üîπ –®–∞–≥ 3. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Staging**

üìå **–ö–∞–∫ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ?**

- **–§–∏–ª—å–º—ã –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é** (–Ω–µ–±–æ–ª—å—à–æ–π –æ–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö).
- **–§–∞–∫—Ç—ã –∞—Ä–µ–Ω–¥—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ** (–æ–±—ä–µ–º –±–æ–ª—å—à–æ–π).

---

### **üìå –ü–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (Full Load)**

üîπ **–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã `staging.film` (–≤–µ—Å—å —Å–ø–∏—Å–æ–∫ —Ñ–∏–ª—å–º–æ–≤):**

```sql
CREATE OR REPLACE FUNCTION staging.load_film()
RETURNS VOID AS $$
BEGIN
    DELETE FROM staging.film;
    INSERT INTO staging.film
    SELECT * FROM film_src.film;
END;
$$ LANGUAGE plpgsql;
```

üîπ **–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã `staging.inventory`:**

```sql
CREATE OR REPLACE FUNCTION staging.load_inventory()
RETURNS VOID AS $$
BEGIN
    DELETE FROM staging.inventory;
    INSERT INTO staging.inventory
    SELECT * FROM film_src.inventory;
END;
$$ LANGUAGE plpgsql;
```

‚úÖ **–≠—Ç–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç –¥–∞–Ω–Ω—ã–µ** –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∑–∞–≥—Ä—É–∑–∫–µ.

---

### **üìå –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (Incremental Load)**

üìå **–§–∞–∫—Ç—ã –∞—Ä–µ–Ω–¥—ã (rental) –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏!**

1Ô∏è‚É£ **–î–æ–±–∞–≤–∏–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏:**

```sql
CREATE TABLE staging.load_log (
    table_name VARCHAR(50) PRIMARY KEY,
    last_load_time TIMESTAMP
);
```

2Ô∏è‚É£ **–°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é `staging.get_last_load_time()`** ‚Äì –ø–æ–ª—É—á–∞–µ—Ç –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏:

```sql
CREATE OR REPLACE FUNCTION staging.get_last_load_time(tablename VARCHAR)
RETURNS TIMESTAMP AS $$
DECLARE
    last_time TIMESTAMP;
BEGIN
    SELECT last_load_time INTO last_time FROM staging.load_log WHERE table_name = tablename;
    RETURN COALESCE(last_time, '2000-01-01'); -- –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å, –±–µ—Ä–µ–º —Å—Ç–∞—Ä—É—é –¥–∞—Ç—É
END;
$$ LANGUAGE plpgsql;
```

3Ô∏è‚É£ **–°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ü–µ–¥—É—Ä—É `staging.load_rental()` ‚Äì –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏:**

```sql
CREATE OR REPLACE FUNCTION staging.load_rental()
RETURNS VOID AS $$
DECLARE
    last_load TIMESTAMP;
    current_time TIMESTAMP := NOW();
BEGIN
    last_load := staging.get_last_load_time('rental');

    DELETE FROM staging.rental WHERE last_update > last_load;
    
    INSERT INTO staging.rental
    SELECT * FROM film_src.rental WHERE last_update > last_load;
    
    -- –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
    INSERT INTO staging.load_log (table_name, last_load_time)
    VALUES ('rental', current_time)
    ON CONFLICT (table_name) DO UPDATE SET last_load_time = current_time;
END;
$$ LANGUAGE plpgsql;
```

‚úÖ **–¢–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏!**

---

## **üîπ –®–∞–≥ 4. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏**

üìå **–î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Å–æ–∑–¥–∞–µ–º –æ–¥–Ω—É –ø—Ä–æ—Ü–µ–¥—É—Ä—É `staging.full_load()`, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ:**

```sql
CREATE OR REPLACE FUNCTION staging.full_load()
RETURNS VOID AS $$
BEGIN
    PERFORM staging.load_film();
    PERFORM staging.load_inventory();
    PERFORM staging.load_rental();
END;
$$ LANGUAGE plpgsql;
```

üìå **–í—ã–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É:**

```sql
SELECT staging.full_load();
```

---

## **‚úÖ –ò—Ç–æ–≥ 3-–π —á–∞—Å—Ç–∏:**

‚úî **–°–æ–∑–¥–∞–Ω–∞ —Å—Ö–µ–º–∞ `staging`.**  
‚úî **–°–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã `staging.film`, `staging.inventory`, `staging.rental`.**  
‚úî **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –ø–æ–ª–Ω–æ–π –∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏.**  
‚úî **–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—ç–∫–æ–Ω–æ–º–∏–º —Ä–µ—Å—É—Ä—Å—ã).**