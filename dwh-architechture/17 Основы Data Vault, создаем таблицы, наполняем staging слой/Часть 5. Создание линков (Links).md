# **–°–æ–∑–¥–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äì –û—Å–Ω–æ–≤—ã Data Vault**

## **–ß–∞—Å—Ç—å 5: –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏–Ω–∫–æ–≤ (Links) –≤ Data Vault**

### **üìå –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã:**

- –ß—Ç–æ —Ç–∞–∫–æ–µ **Link (–õ–∏–Ω–∫)** –≤ Data Vault?
- –°–æ–∑–¥–∞–Ω–∏–µ **–ª–∏–Ω–∫–æ–≤** –≤ PostgreSQL.
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ **—Ö–µ—à-–∫–ª—é—á–µ–π** –¥–ª—è —Å–≤—è–∑–∏.
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ –∏–Ω–¥–µ–∫—Å–æ–≤**.
- –ü—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ **Links**.

---

## **üîπ –®–∞–≥ 1. –ß—Ç–æ —Ç–∞–∫–æ–µ Link –≤ Data Vault?**

üìå **Link (–õ–∏–Ω–∫) ‚Äì —ç—Ç–æ —Ç–∞–±–ª–∏—Ü–∞, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–µ–¥–∏–Ω—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ö–∞–±–æ–≤ (Hubs).**

- **–•—Ä–∞–Ω–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –æ–±—ä–µ–∫—Ç–∞–º–∏, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤.**
- **–ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤—è–∑–µ–π –º–µ–∂–¥—É –æ–±—ä–µ–∫—Ç–∞–º–∏.**
- **–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö** (–∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚Äì –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å).
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ö–µ—à-–∫–ª—é—á–∏** (MD5 –æ—Ç –≤—Å–µ—Ö –±–∏–∑–Ω–µ—Å-–∫–ª—é—á–µ–π —Ö–∞–±–æ–≤).

**üìå –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –≤ Link:**

|–ü–æ–ª–µ|–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|---|
|`hash_key`|`VARCHAR(32)`|–•–µ—à-–∫–ª—é—á —Å–≤—è–∑–∏ (MD5 –æ—Ç –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –±–∏–∑–Ω–µ—Å-–∫–ª—é—á–µ–π)|
|`hash_hub_1`|`VARCHAR(32)`|–•–µ—à-–∫–ª—é—á –ø–µ—Ä–≤–æ–≥–æ —Ö–∞–±–∞|
|`hash_hub_2`|`VARCHAR(32)`|–•–µ—à-–∫–ª—é—á –≤—Ç–æ—Ä–æ–≥–æ —Ö–∞–±–∞|
|`load_date`|`TIMESTAMP`|–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–∏ –≤ Data Vault|
|`record_source`|`VARCHAR(50)`|–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö|

---

## **üîπ –®–∞–≥ 2. –°–æ–∑–¥–∞–Ω–∏–µ Link –º–µ–∂–¥—É `hub_film` –∏ `hub_inventory`**

üìå **–ó–∞—á–µ–º –Ω—É–∂–µ–Ω —ç—Ç–æ—Ç Link?**

- –°–≤—è–∑—ã–≤–∞–µ—Ç **—Ñ–∏–ª—å–º—ã** –∏ **–∏—Ö —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –∫–æ–ø–∏–∏ (DVD, Blu-ray –∏ —Ç. –¥.)**.
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å, –∫–∞–∫–æ–π **—Ñ–∏–ª—å–º –Ω–∞ –∫–∞–∫–æ–º —Å–∫–ª–∞–¥–µ**.

üîπ **–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É `link_film_inventory`:**

```sql
CREATE TABLE link_film_inventory (
    hash_key VARCHAR(32) PRIMARY KEY,
    hash_hub_film VARCHAR(32) NOT NULL REFERENCES hub_film(hash_key),
    hash_hub_inventory VARCHAR(32) NOT NULL REFERENCES hub_inventory(hash_key),
    load_date TIMESTAMP NOT NULL,
    record_source VARCHAR(50) NOT NULL
);
```

üìå **–°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞:**

```sql
CREATE UNIQUE INDEX idx_link_film_inventory ON link_film_inventory (hash_hub_film, hash_hub_inventory);
```

---

## **üîπ –®–∞–≥ 3. –°–æ–∑–¥–∞–Ω–∏–µ Link –º–µ–∂–¥—É `hub_inventory` –∏ `hub_rental`**

üìå **–ó–∞—á–µ–º –Ω—É–∂–µ–Ω —ç—Ç–æ—Ç Link?**

- –°–≤—è–∑—ã–≤–∞–µ—Ç **–∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–æ–ø–∏—é —Ñ–∏–ª—å–º–∞ (Inventory) —Å —Ñ–∞–∫—Ç–æ–º –∞—Ä–µ–Ω–¥—ã (Rental)**.
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å **–∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–∫–∞—Ç–∞**.

üîπ **–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É `link_rental_inventory`:**

```sql
CREATE TABLE link_rental_inventory (
    hash_key VARCHAR(32) PRIMARY KEY,
    hash_hub_inventory VARCHAR(32) NOT NULL REFERENCES hub_inventory(hash_key),
    hash_hub_rental VARCHAR(32) NOT NULL REFERENCES hub_rental(hash_key),
    load_date TIMESTAMP NOT NULL,
    record_source VARCHAR(50) NOT NULL
);
```

üìå **–°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å:**

```sql
CREATE UNIQUE INDEX idx_link_rental_inventory ON link_rental_inventory (hash_hub_inventory, hash_hub_rental);
```

---

## **üîπ –®–∞–≥ 4. –ü—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Links**

üìå **–ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è `hash_key` –¥–ª—è Link?**

- –•–µ—à–∏—Ä—É–µ—Ç—Å—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è **–≤—Å–µ—Ö –±–∏–∑–Ω–µ—Å-–∫–ª—é—á–µ–π** —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ö–∞–±–æ–≤.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **MD5**, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 32-—Å–∏–º–≤–æ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É.

üîπ **–§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ `hash_key`:**

```sql
CREATE OR REPLACE FUNCTION generate_link_hash_key(input_value TEXT)
RETURNS VARCHAR(32) AS $$
BEGIN
    RETURN MD5(input_value);
END;
$$ LANGUAGE plpgsql;
```

üîπ **–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ `link_film_inventory`:**

```sql
CREATE OR REPLACE FUNCTION load_link_film_inventory()
RETURNS VOID AS $$
BEGIN
    INSERT INTO link_film_inventory (hash_key, hash_hub_film, hash_hub_inventory, load_date, record_source)
    SELECT 
        generate_link_hash_key(f.film_id::TEXT || i.inventory_id::TEXT),
        generate_hash_key(f.film_id::TEXT),
        generate_hash_key(i.inventory_id::TEXT),
        NOW(),
        'source_system'
    FROM staging.inventory i
    JOIN staging.film f ON f.film_id = i.film_id
    ON CONFLICT (hash_hub_film, hash_hub_inventory) DO NOTHING;
END;
$$ LANGUAGE plpgsql;
```

üîπ **–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ `link_rental_inventory`:**

```sql
CREATE OR REPLACE FUNCTION load_link_rental_inventory()
RETURNS VOID AS $$
BEGIN
    INSERT INTO link_rental_inventory (hash_key, hash_hub_inventory, hash_hub_rental, load_date, record_source)
    SELECT 
        generate_link_hash_key(i.inventory_id::TEXT || r.rental_id::TEXT),
        generate_hash_key(i.inventory_id::TEXT),
        generate_hash_key(r.rental_id::TEXT),
        NOW(),
        'source_system'
    FROM staging.rental r
    JOIN staging.inventory i ON i.inventory_id = r.inventory_id
    ON CONFLICT (hash_hub_inventory, hash_hub_rental) DO NOTHING;
END;
$$ LANGUAGE plpgsql;
```

---

## **üîπ –®–∞–≥ 5. –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—â–µ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö Links**

```sql
CREATE OR REPLACE FUNCTION load_all_links()
RETURNS VOID AS $$
BEGIN
    PERFORM load_link_film_inventory();
    PERFORM load_link_rental_inventory();
END;
$$ LANGUAGE plpgsql;
```

üìå **–í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É:**

```sql
SELECT load_all_links();
```

---

## **‚úÖ –ò—Ç–æ–≥ 5-–π —á–∞—Å—Ç–∏:**

‚úî **–°–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã Links:** `link_film_inventory`, `link_rental_inventory`.  
‚úî **–ù–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å–≤—è–∑–∏ —Å —Ö–∞–±–∞–º–∏ (`hub_film`, `hub_inventory`, `hub_rental`).**  
‚úî **–î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞.**  
‚úî **–°–æ–∑–¥–∞–Ω—ã –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Links.**  
‚úî **–ü–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ª–∏–Ω–∫–æ–≤ —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π.**