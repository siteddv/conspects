### **4.1 Таблица фактов `fact_payment`**

- **Описание структуры**:
    - `payment_pk` – **суррогатный ключ**.
    - `payment_id` – **идентификатор платежа из источника**.
    - `amount` – **сумма платежа**.
    - `payment_date` – **дата платежа** (без времени).
    - `inventory_fk` – **ссылка на `dim_inventory`**.
    - `staff_fk` – **ссылка на `dim_staff`**.

#### **4.1.1 Алгоритм загрузки `fact_payment`**

1. **Удаление старых данных** (`DELETE FROM core.fact_payment`).
2. **Создание SQL-запроса** для загрузки данных:
    - Источник данных → `staging.payment`.
    - Присоединяем `staging.rental` → получаем связь платежа с арендой.
    - Присоединяем `core.dim_inventory` → получаем `inventory_fk`.
    - Присоединяем `core.dim_staff` → получаем `staff_fk`.
    - Группируем платежи по `inventory_fk`, `staff_fk` и `payment_date`.
    - Преобразуем `payment_date` в формат **"дата без времени"** (`CAST(payment_date AS DATE)`).
3. **Заполняем таблицу `fact_payment`**.

✅ **Результат**:

- В таблицу **`fact_payment` загружено 14 596 строк**.
- **Совпадает с источником** (`staging.payment`).
- Группировка **не изменила количество строк** (так как платежи уникальны).

---

### **4.2 Таблица фактов `fact_rental`**

- **Описание структуры**:
    - `rental_pk` – **суррогатный ключ**.
    - `inventory_fk` – **ссылка на `dim_inventory`**.
    - `staff_fk` – **ссылка на `dim_staff`**.
    - `rental_date` – **дата аренды** (без времени).
    - `return_date` – **дата возврата** (без времени).
    - `amount` – **сумма платежа**.
    - `count` – **количество аренд**.

#### **4.2.1 Домашнее задание для участников**

- **Нужно самостоятельно написать SQL-запрос для загрузки `fact_rental`**.
- **Алгоритм аналогичен `fact_payment`**, но:
    - Источник данных → `staging.rental`.
    - Присоединяем `core.dim_inventory` и `core.dim_staff`.
    - Группируем по `inventory_fk`, `staff_fk`, `rental_date`.

---

### **4.3 Ошибки при загрузке и их исправление**

#### **4.3.1 Ошибка: нарушение внешних ключей**

- **Ошибка:**
    
    - **При удалении данных из `dim_inventory` и `dim_staff` возникает ошибка**.
    - Причина → **Таблицы фактов (`fact_payment` и `fact_rental`) ссылаются на измерения**.
    - **SQL-сервер запрещает удаление записей, на которые ссылаются другие таблицы**.
- **Решение:**
    
    - Перед загрузкой измерений **нужно удалить данные из таблиц фактов**.
    - **Добавляем процедуру очистки фактов перед загрузкой измерений**:
        
        ```sql
        CREATE OR REPLACE PROCEDURE core.fact_delete() 
        LANGUAGE SQL 
        AS $$
        DELETE FROM core.fact_payment;
        DELETE FROM core.fact_rental;
        $$;
        ```
        
    - **Вносим изменения в процедуру загрузки Core-слоя**:
        - **Перед загрузкой измерений вызываем `fact_delete()`**.

✅ **Результат**: Ошибка устранена.

---

### **4.4 Проверка данных**

- **После исправлений выполняем полный цикл загрузки**.
- **Результаты**:
    - `dim_inventory` загружено → **4 584 строки**.
    - `dim_staff` загружено → **2 строки**.
    - `fact_payment` загружено → **14 596 строк**.
    - `fact_rental` → **участникам нужно реализовать самостоятельно**.

---

### **Выводы по этой части**

✅ **Реализована полная загрузка `fact_payment`**.  
✅ **Исправлены ошибки с внешними ключами**.  
✅ **Задание: реализовать загрузку `fact_rental`**.