### **6.1 Зачем удалять данные перед загрузкой?**

- **Проблема:**
    
    - Мы используем **полную перезагрузку данных** (**Full Reload**).
    - Это означает, что перед каждой загрузкой **нужно удалить старые данные**, иначе они будут дублироваться.
- **Решение:**
    
    - Добавляем процедуры удаления данных перед каждой загрузкой.
    - **Порядок удаления важен**, так как таблицы связаны внешними ключами.

---

### **6.2 Очистка данных в таблицах фактов**

- **Создаем процедуру `fact_delete()`** для удаления данных перед загрузкой:

```sql
CREATE OR REPLACE PROCEDURE core.fact_delete() 
LANGUAGE SQL 
AS $$
DELETE FROM core.fact_payment;
DELETE FROM core.fact_rental;
$$;
```

- **Теперь перед загрузкой измерений (`dim_inventory`, `dim_staff`) вызываем `fact_delete()`**.

---

### **6.3 Полный процесс загрузки (Full Load)**

- **Создаем единую процедуру `full_load()`**, которая:
    1. **Удаляет данные из фактов** (`fact_delete()`).
    2. **Перезагружает данные в измерения** (`load_inventory()`, `load_staff()`).
    3. **Загружает факты** (`load_fact_payment()`, `load_fact_rental()`).

```sql
CREATE OR REPLACE PROCEDURE core.full_load() 
LANGUAGE SQL 
AS $$
CALL core.fact_delete();
CALL core.load_inventory();
CALL core.load_staff();
CALL core.load_fact_payment();
CALL core.load_fact_rental();
$$;
```

- Теперь **достаточно вызвать `full_load()`**, чтобы полностью обновить данные.

✅ **Преимущество:**

- Все **данные загружаются в правильном порядке**.
- Нет **ошибок с внешними ключами**.
- Можно **запускать раз в день/час**, чтобы хранилище всегда было актуальным.

---

### **6.4 Тестирование очистки и загрузки**

1. **Проверяем, что `fact_payment` и `fact_rental` содержат данные**.
2. **Выполняем `CALL core.fact_delete();`** → проверяем, что таблицы фактов **опустели**.
3. **Запускаем `CALL core.full_load();`** → проверяем, что данные загрузились правильно.
4. **Сравниваем количество строк с источником (`staging.payment`, `staging.rental`)**.

✅ **Результат:**

- После `fact_delete()` → таблицы фактов **пустые**.
- После `full_load()` → **все данные загружены правильно**.

---

### **Выводы по этой части**

✅ **Создана процедура `fact_delete()` для удаления данных перед загрузкой**.  
✅ **Оптимизирована процедура `full_load()` – теперь загрузка полностью автоматизирована**.  
✅ **Все тесты показали корректность загрузки**.