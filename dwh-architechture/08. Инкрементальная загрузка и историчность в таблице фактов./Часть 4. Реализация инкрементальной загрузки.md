### **4.1. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—Ä–µ–º–µ–Ω–µ–º –∑–∞–≥—Ä—É–∑–∫–∏**

–î–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –±—ã–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω—ã **–¥–≤–µ –∫–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**:

#### **1Ô∏è‚É£ `GetLastUpdate(tableName)`**

- **–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É.**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∂–∞—Ç—å **—Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏**.

üìå **–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã:**

```sql
SELECT GetLastUpdate('rental');
```

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:

```
2024-09-04 10:00:00
```

(—ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å **4 —Å–µ–Ω—Ç—è–±—Ä—è –≤ 10:00**)

---

#### **2Ô∏è‚É£ `SetLastUpdate(tableName, updateTime)`**

- **–û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏** –≤ —Ç–∞–±–ª–∏—Ü–µ `LastUpdate`.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ –∑–∞–≥—Ä—É–∑–∫–∏, —á—Ç–æ–±—ã –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å **–≤—Ä–µ–º—è –Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏**.

üìå **–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã:**

```sql
CALL SetLastUpdate('rental', CURRENT_TIMESTAMP);
```

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã –≤ `LastUpdate` –±—É–¥–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–æ:

```
| table_name | last_update          |
|------------|----------------------|
| rental     | 2024-09-04 12:00:00  |
```

(—ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ `rental` –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã **4 —Å–µ–Ω—Ç—è–±—Ä—è –≤ 12:00**)

---

### **4.2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ**

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ **—É–¥–∞–ª–µ–Ω–∞**, –º—ã –Ω–µ –º–æ–∂–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –µ–µ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∞ –ø—Ä–æ—Å—Ç–æ –∏—Å—á–µ–∑–∞–µ—Ç.
- –ö–∞–∫ —Å–ª–µ–¥—Å—Ç–≤–∏–µ, –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ **–æ—Å—Ç–∞–Ω–µ—Ç—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è**, —Å–æ–∑–¥–∞–≤–∞—è –æ—à–∏–±–∫–∏ –≤ –æ—Ç—á–µ—Ç–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ:**  
‚úÖ –î–æ–±–∞–≤–ª—è–µ–º **–ø–æ–ª–µ `deleted`** –≤ —Ç–∞–±–ª–∏—Ü—É `rental` –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ  
‚úÖ –í–º–µ—Å—Ç–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è **–ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–∞—Ç—É —É–¥–∞–ª–µ–Ω–∏—è**

üìå **–ö–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (`rental`)**:

```
| rental_id | film_id | rental_date        | return_date        | deleted            |
|-----------|--------|--------------------|--------------------|--------------------|
| 101       | 5      | 2024-09-01 10:00:00 | 2024-09-02 12:00:00 | NULL               |
| 102       | 7      | 2024-09-03 14:30:00 | NULL               | 2024-09-04 08:00:00 |
```

**–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∫–æ–ª–æ–Ω–∫–∞ `deleted`:**

- **NULL** ‚Üí –ó–∞–ø–∏—Å—å **–∞–∫—Ç–∏–≤–Ω–∞**
- **–î–∞—Ç–∞** ‚Üí –ó–∞–ø–∏—Å—å **—É–¥–∞–ª–µ–Ω–∞ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è**

---

### **4.3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã staging-—Ç–∞–±–ª–∏—Ü—ã**

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–Ω–æ–≤–∏—Ç—å **—Å–ª–æ–π staging**:  
‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É **`deleted`** –≤ —Ç–∞–±–ª–∏—Ü—É `staging.rental`  
‚úÖ –¢–µ–ø–µ—Ä—å staging-—Ç–∞–±–ª–∏—Ü–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç **—Ç–æ–ª—å–∫–æ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** (–Ω–æ–≤—ã–µ, –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∏ —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏)

üìå **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π SQL-–∫–æ–¥:**

```sql
CREATE TABLE staging.rental (
    rental_id INT PRIMARY KEY,
    film_id INT,
    rental_date TIMESTAMP,
    return_date TIMESTAMP,
    last_update TIMESTAMP,
    deleted TIMESTAMP  -- –ù–æ–≤–æ–µ –ø–æ–ª–µ!
);
```

---

### **4.4. –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö**

–¢–µ–ø–µ—Ä—å, –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º **–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É**:  
1Ô∏è‚É£ **–ò–∑ staging.rental –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏**  
2Ô∏è‚É£ **–ü–æ–º–µ—á–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∫–∞–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ**

#### **1Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏**

```sql
INSERT INTO core.rental (rental_id, film_id, rental_date, return_date, is_active)
SELECT r.rental_id, r.film_id, r.rental_date, r.return_date, TRUE
FROM staging.rental r
LEFT JOIN core.rental c ON r.rental_id = c.rental_id
WHERE r.last_update > GetLastUpdate('rental');  -- –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
```

‚úÖ **–¢–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏**

---

#### **2Ô∏è‚É£ –ü–æ–º–µ—á–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∫–∞–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ**

```sql
UPDATE core.rental
SET is_active = FALSE
WHERE rental_id IN (
    SELECT rental_id FROM staging.rental WHERE deleted IS NOT NULL
);
```

‚úÖ –¢–µ–ø–µ—Ä—å —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ **–Ω–µ –∏—Å—á–µ–∑–∞—é—Ç**, –∞ –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏.

---

### **–í—ã–≤–æ–¥ –ø–æ —á–µ—Ç–≤–µ—Ä—Ç–æ–π —á–∞—Å—Ç–∏**

üìå **–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–∫—Ç–æ–≤**  
üìå **–¢–µ–ø–µ—Ä—å —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**  
üìå **–ö–æ–¥ —Å—Ç–∞–ª –≥–∏–±–∫–∏–º –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º**