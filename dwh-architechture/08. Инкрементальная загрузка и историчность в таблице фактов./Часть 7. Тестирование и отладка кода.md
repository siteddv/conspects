### **7.1. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö**

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –∏—Å—Ç–æ—Ä–∏—á–Ω–æ—Å—Ç–∏ –≤–æ–∑–Ω–∏–∫ –≤–æ–ø—Ä–æ—Å: **–Ω–∞—Å–∫–æ–ª—å–∫–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –∫–æ–¥?**

üìå **–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –º–µ—Å—Ç–∞ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**

1. **–ò–∑–±—ã—Ç–æ—á–Ω–æ–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞** –≤ SQL-–ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤** –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
3. **–ù–µ–Ω—É–∂–Ω—ã–µ `JOIN`-–æ–ø–µ—Ä–∞—Ü–∏–∏** –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π**

**–¶–µ–ª—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**  
‚úÖ –£–º–µ–Ω—å—à–∏—Ç—å –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö  
‚úÖ –°–Ω–∏–∑–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö  
‚úÖ –ò—Å–∫–ª—é—á–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π

---

### **7.2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å –≤—Ä–µ–º–µ–Ω–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (`LastUpdate`)**

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –°–µ–π—á–∞—Å –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ **—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ**
- –ü—Ä–∏ –∫–∞–∂–¥–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è `GetLastUpdate()`
- –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç **–ª–∏—à–Ω–∏–µ SQL-–∑–∞–ø—Ä–æ—Å—ã**

**–†–µ—à–µ–Ω–∏–µ:**  
‚úÖ –•—Ä–∞–Ω–∏—Ç—å `LastUpdate` **–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π** –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

```sql
UPDATE core.rental
SET valid_to = CURRENT_TIMESTAMP
WHERE rental_id IN (
    SELECT rental_id FROM staging.rental WHERE last_update > GetLastUpdate('rental')
);
```

(–∑–∞–ø—Ä–æ—Å –∫ `LastUpdate` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–∫–∞–∂–¥—ã–π —Ä–∞–∑**)

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

```sql
DECLARE LastUpdateTime TIMESTAMP;
SET LastUpdateTime = GetLastUpdate('rental');

UPDATE core.rental
SET valid_to = CURRENT_TIMESTAMP
WHERE rental_id IN (
    SELECT rental_id FROM staging.rental WHERE last_update > LastUpdateTime
);
```

üìå **–¢–µ–ø–µ—Ä—å `LastUpdateTime` –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑, –≤–º–µ—Å—Ç–æ —Å–æ—Ç–µ–Ω –æ–±—Ä–∞—â–µ–Ω–∏–π**.

‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–∞—Ö –¥–∞–Ω–Ω—ã—Ö.**

---

### **7.3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –ø–æ–ª—è**

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –¢–∞–±–ª–∏—Ü—ã `core.rental` –∏ `staging.rental` **–ø–æ—Å—Ç–æ—è–Ω–Ω–æ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ `JOIN`-–∞—Ö**
- **–ù–µ—Ç –∏–Ω–¥–µ–∫—Å–æ–≤** –Ω–∞ –ø–æ–ª—è—Ö `rental_id`, `last_update`, `deleted`

**–†–µ—à–µ–Ω–∏–µ:**  
‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

```sql
SELECT * FROM staging.rental WHERE last_update > '2024-09-04';
```

(–±–µ–∑ –∏–Ω–¥–µ–∫—Å–∞ ‚Äì **–ø–æ–∏—Å–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü–µ!**)

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

```sql
CREATE INDEX idx_last_update ON staging.rental(last_update);
CREATE INDEX idx_deleted ON staging.rental(deleted);
```

üìå **–¢–µ–ø–µ—Ä—å –ø–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã.**

‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É—Å–∫–æ—Ä—è–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–∞–∑—ã.**

---

### **7.4. –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π**

**–ü—Ä–æ–±–ª–µ–º–∞:**

- –°–µ–π—á–∞—Å —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ **–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –¥–≤—É–º—è –∑–∞–ø—Ä–æ—Å–∞–º–∏**
- `UPDATE is_active = FALSE`
- `UPDATE valid_to = CURRENT_TIMESTAMP`

**–†–µ—à–µ–Ω–∏–µ:**  
‚úÖ –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ –æ–¥–∏–Ω

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

```sql
UPDATE core.rental
SET is_active = FALSE
WHERE rental_id IN (SELECT rental_id FROM staging.rental WHERE deleted IS NOT NULL);

UPDATE core.rental
SET valid_to = CURRENT_TIMESTAMP
WHERE rental_id IN (SELECT rental_id FROM staging.rental WHERE deleted IS NOT NULL);
```

(–¥–≤–∞ `UPDATE`-–∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏)

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

```sql
UPDATE core.rental
SET is_active = FALSE, valid_to = CURRENT_TIMESTAMP
WHERE rental_id IN (SELECT rental_id FROM staging.rental WHERE deleted IS NOT NULL);
```

üìå **–¢–µ–ø–µ—Ä—å —É–¥–∞–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ–¥–Ω–∏–º SQL-–∑–∞–ø—Ä–æ—Å–æ–º.**

‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π –∏ —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.**

---

### **7.5. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π**

**–ü—Ä–æ–±–ª–µ–º–∞:**

- **–í—Å–µ –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `LEFT JOIN`**, —á—Ç–æ –∑–∞–º–µ–¥–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å

**–†–µ—à–µ–Ω–∏–µ:**  
‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **`NOT EXISTS`**, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

```sql
INSERT INTO core.rental (rental_id, film_id, rental_date, return_date, is_active, valid_from, valid_to)
SELECT r.rental_id, r.film_id, r.rental_date, r.return_date, TRUE, CURRENT_TIMESTAMP, '9999-12-31'
FROM staging.rental r
LEFT JOIN core.rental c ON r.rental_id = c.rental_id
WHERE c.rental_id IS NULL; -- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ
```

(–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `LEFT JOIN`, —á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤)

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

```sql
INSERT INTO core.rental (rental_id, film_id, rental_date, return_date, is_active, valid_from, valid_to)
SELECT r.rental_id, r.film_id, r.rental_date, r.return_date, TRUE, CURRENT_TIMESTAMP, '9999-12-31'
FROM staging.rental r
WHERE NOT EXISTS (
    SELECT 1 FROM core.rental c WHERE c.rental_id = r.rental_id
);
```

üìå **–¢–µ–ø–µ—Ä—å –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ä–∞–∑—ã –±—ã—Å—Ç—Ä–µ–µ** –∑–∞ —Å—á–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è `LEFT JOIN`.

‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–ª—É—á—à–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π.**

---

### **7.6. –ò—Ç–æ–≥–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç –æ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**

–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –±—ã–ª–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ **–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**.

üìå **–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

- –ü–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (`Full Load`): **38 —Å–µ–∫—É–Ω–¥**
- –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (`LoadRentals`): **7 —Å–µ–∫—É–Ω–¥**
- –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (`Delete Processing`): **3.5 —Å–µ–∫—É–Ω–¥—ã**

üìå **–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

- –ü–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (`Full Load`): **21 —Å–µ–∫—É–Ω–¥–∞** (**-45% –≤—Ä–µ–º–µ–Ω–∏**)
- –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (`LoadRentals`): **3.2 —Å–µ–∫—É–Ω–¥—ã** (**-55% –≤—Ä–µ–º–µ–Ω–∏**)
- –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (`Delete Processing`): **1.5 —Å–µ–∫—É–Ω–¥—ã** (**-57% –≤—Ä–µ–º–µ–Ω–∏**)

üöÄ **–û–±—â–∏–π –ø—Ä–∏—Ä–æ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: ~50%**

‚úÖ **–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö**  
‚úÖ **–ë–æ–ª–µ–µ –±—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π**  
‚úÖ **–ú–µ–Ω—å—à–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤**

---

### **–í—ã–≤–æ–¥ –ø–æ —Å–µ–¥—å–º–æ–π —á–∞—Å—Ç–∏**

üìå **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∫–ª—é—á–µ–≤—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã**  
üìå **–î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã, —á—Ç–æ —É—Å–∫–æ—Ä–∏–ª–æ –≤—ã–±–æ—Ä–∫–∏**  
üìå **–£–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –æ–ø–µ—Ä–∞—Ü–∏–π**  
üìå **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∞ –Ω–∞ 50%**