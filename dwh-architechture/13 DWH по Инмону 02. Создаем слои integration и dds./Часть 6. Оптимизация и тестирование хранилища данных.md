## **1. ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡Ð½Ð¾ÑÑ‚ÑŒÑŽ** _(2:30:00 - 2:40:00)_

ðŸ“Œ **Ð¦ÐµÐ»ÑŒ:** Ð¼Ð¸Ð½Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ñ‚Ñ€ÑƒÐ´, ÑƒÑÐºÐ¾Ñ€Ð¸Ñ‚ÑŒ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸ ÑƒÐ¼ÐµÐ½ÑŒÑˆÐ¸Ñ‚ÑŒ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ð¾ÑˆÐ¸Ð±Ð¾Ðº.

âœ… **Ð§Ñ‚Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼?**  
1ï¸âƒ£ **ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹** (Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð²ÐµÑ€ÑÐ¸Ð¹)  
2ï¸âƒ£ **Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹** (Ð²ÑÑ‚Ð°Ð²ÐºÐ° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ñ… Ð¸ Ð½Ð¾Ð²Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…)  
3ï¸âƒ£ **ÐŸÐ¾Ð¼ÐµÑ‚ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹**

### **ðŸ”¹ SQL Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡Ð½Ð¾ÑÑ‚Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…**

```sql
WITH changed_rows AS (
    SELECT d.product_id
    FROM dds.products d
    JOIN raw_data.products r ON d.product_id = r.product_id
    WHERE md5(concat(d.category, d.price, d.description)) 
          != md5(concat(r.category, r.price, r.description))
    AND d.version_end = '9999-12-31'
)
UPDATE dds.products 
SET version_end = now()
WHERE product_id IN (SELECT product_id FROM changed_rows);
```

### **ðŸ“Œ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Airflow Ð¸Ð»Ð¸ SQL-ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²**

- **Airflow DAG** Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° ETL-Ð¸Ð½ÐºÑ€ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ.
- **ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ SQL-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²** (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð° Ð´Ð°Ñ‚).
- **Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ…Ñ€Ð°Ð½Ð¸Ð¼Ñ‹Ñ… Ð¿Ñ€Ð¾Ñ†ÐµÐ´ÑƒÑ€** Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹.

---

## **2. Ð”Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ SQL-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²** _(2:40:00 - 2:50:00)_

ðŸ“Œ **ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°:** ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð¾Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ† Ð¼Ð¾Ð¶ÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÑÑ‚ÑŒÑÑ, Ð° SQL-Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð¿Ð¾Ð´ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°Ñ‚ÑŒÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸.

âœ… **Ð ÐµÑˆÐµÐ½Ð¸Ðµ: Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ SQL-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Python, PL/pgSQL, Spark Ð¸Ð»Ð¸ dbt.**

ðŸ”¹ **ÐŸÑ€Ð¸Ð¼ÐµÑ€ PL/pgSQL-Ñ…Ñ€Ð°Ð½Ð¸Ð¼Ð¾Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÐ´ÑƒÑ€Ñ‹ Ð´Ð»Ñ Ð²ÑÑ‚Ð°Ð²ÐºÐ¸ Ð½Ð¾Ð²Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…**

```sql
CREATE OR REPLACE FUNCTION insert_new_versions()
RETURNS VOID AS $$
DECLARE
    column_list TEXT;
    value_list TEXT;
BEGIN
    -- Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÑ‚Ð¾Ð»Ð±Ñ†Ð¾Ð²
    SELECT string_agg(column_name, ', ') INTO column_list
    FROM information_schema.columns
    WHERE table_name = 'raw_data_products';
    
    -- Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ SQL-Ð·Ð°Ð¿Ñ€Ð¾Ñ
    EXECUTE format(
        'INSERT INTO dds.products (%s, version_start, version_end)
         SELECT %s, now(), ''9999-12-31''
         FROM raw_data.products p
         LEFT JOIN dds.products d ON p.product_id = d.product_id
         WHERE d.product_id IS NULL;', column_list, column_list);
END;
$$ LANGUAGE plpgsql;
```

âœ” **Ð“Ð¸Ð±ÐºÐ¾ÑÑ‚ÑŒ:** ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð½Ð¾Ð²Ñ‹Ñ… Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð¾Ð² Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ SQL.  
âœ” **Ð£Ð´Ð¾Ð±ÑÑ‚Ð²Ð¾:** ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ… ÐºÐ¾Ð»Ð¾Ð½Ð¾Ðº.

---

## **3. Ð˜Ð½ÐºÑ€ÐµÐ¼ÐµÐ½Ñ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹** _(2:50:00 - 3:00:00)_

ðŸ“Œ **ÐŸÐ¾Ð»Ð½Ð°Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð·Ð°Ð¼ÐµÐ´Ð»ÑÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ, Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¸Ð½ÐºÑ€ÐµÐ¼ÐµÐ½Ñ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´.**

âœ… **ÐšÐ°Ðº ÑÑ‚Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚?**  
1ï¸âƒ£ **Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´Ð°Ñ‚Ñƒ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸.**  
2ï¸âƒ£ **Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð»Ð¸ Ð½Ð¾Ð²Ñ‹Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸.**  
3ï¸âƒ£ **Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¸: "Ð´Ð°Ñ‚Ð° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ" Ð¸Ð»Ð¸ "Ñ…ÐµÑˆ-ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ".**

ðŸ”¹ **SQL-Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…**

```sql
INSERT INTO dds.products (product_id, category, price, description, version_start, version_end, is_deleted)
SELECT product_id, category, price, description, now(), '9999-12-31', 0
FROM raw_data.products
WHERE updated_at > (SELECT MAX(version_start) FROM dds.products);
```

âœ” **Ð¡Ð¾ÐºÑ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸** Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€.  
âœ” **Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…** Ð±ÐµÐ· Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð¿ÐµÑ€ÐµÑÑ‡ÐµÑ‚Ð°.

---

## **4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ÑÑ‚Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð²ÑÐµÑ… Ð¿Ñ€Ð¾Ñ†ÐµÐ´ÑƒÑ€** _(3:00:00 - 3:10:00)_

ðŸ“Œ **ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²Ð°Ð¶Ð½Ð¾?**  
âœ… ÐžÑˆÐ¸Ð±ÐºÐ¸ Ð² ETL Ð¼Ð¾Ð³ÑƒÑ‚ Ð¿Ñ€Ð¸Ð²ÐµÑÑ‚Ð¸ Ðº Ð¿Ð¾Ñ‚ÐµÑ€Ðµ Ð¸Ð»Ð¸ Ð¸ÑÐºÐ°Ð¶ÐµÐ½Ð¸ÑŽ Ð´Ð°Ð½Ð½Ñ‹Ñ….  
âœ… ÐÑƒÐ¶Ð½Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ½Ð¾ÑÑÑ‚ÑÑ Ð² DDS.

âœ… **ÐœÐµÑ‚Ð¾Ð´Ñ‹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸:**  
1ï¸âƒ£ **Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð¼ÐµÐ¶Ð´Ñƒ `raw_data` Ð¸ `dds`**

```sql
SELECT COUNT(*) FROM raw_data.products;
SELECT COUNT(*) FROM dds.products WHERE version_end = '9999-12-31';
```

2ï¸âƒ£ **ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ñ Ð½ÐµÐ·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð²ÐµÑ€ÑÐ¸ÑÐ¼Ð¸ (`version_end IS NULL`)**

```sql
SELECT * FROM dds.products WHERE version_end IS NULL;
```

3ï¸âƒ£ **Ð’Ñ‹ÑÐ²Ð»ÐµÐ½Ð¸Ðµ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ð¾Ð² Ð² `dds`**

```sql
SELECT product_id, COUNT(*) 
FROM dds.products 
GROUP BY product_id 
HAVING COUNT(*) > 1;
```