# **10. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Reference-—Å–ª–æ—è**

–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ —É –Ω–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ **–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö**, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ **—Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Reference-—Å–ª–æ–π (—Å–ª–æ–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π)**.

üîπ **Reference Layer (REF)** ‚Äì —ç—Ç–æ —Å–ª–æ–π, –≤ –∫–æ—Ç–æ—Ä–æ–º –∫–∞–∂–¥–æ–º—É –æ–±—ä–µ–∫—Ç—É –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ **–Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã–π –∫–ª—é—á (SK)**,  
—á—Ç–æ–±—ã **–æ–±–µ—Å–ø–µ—á–∏—Ç—å –µ–¥–∏–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.

---

## **üìå 10.1 –ó–∞—á–µ–º –Ω—É–∂–µ–Ω Reference-—Å–ª–æ–π?**

üìå **–ö–∞–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–∞–µ—Ç Reference-—Å–ª–æ–π?**  
üîπ **1. –†–∞–∑–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –≤ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö**

- –í –æ–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∫–ª–∏–µ–Ω—Ç `customer_id = 123`, –≤ –¥—Ä—É–≥–æ–π `user_id = ABC`.
- –í Reference-—Å–ª–æ–µ —Å–æ–∑–¥–∞–µ–º **–µ–¥–∏–Ω—ã–π –∫–ª—é—á `customer_sk`**, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ.

üîπ **2. –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∑–∞–ø–∏—Å–∏ (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)**

- –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∫–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö —Å —Ä–∞–∑–Ω—ã–º–∏ ID.
- Reference-—Å–ª–æ–π –ø–æ–º–æ–≥–∞–µ—Ç **–æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –¥—É–±–ª–∏ –≤ –æ–¥–Ω—É –∑–∞–ø–∏—Å—å**.

üîπ **3. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö**

- –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö ID –æ–±—ä–µ–∫—Ç–æ–≤ –º–æ–≥—É—Ç **–∏–∑–º–µ–Ω—è—Ç—å—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º**.
- –í Reference-—Å–ª–æ–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º **—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ (SK)**, –∫–æ—Ç–æ—Ä—ã–µ **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è**.

‚úÖ **Reference-—Å–ª–æ–π = "–µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ø—Ä–∞–≤–¥—ã" –¥–ª—è –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã DWH.**

---

## **üìå 10.2 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Reference-—Å–ª–æ—è**

üìå **–ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω Reference-—Å–ª–æ–π?**  
üîπ –í –Ω–µ–º —Å–æ–∑–¥–∞—é—Ç—Å—è **—Ç–∞–±–ª–∏—Ü—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π (mapping tables)**:

|**–¢–∞–±–ª–∏—Ü–∞**|**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**|
|---|---|
|`ref.customers`|–°–≤—è–∑—ã–≤–∞–µ—Ç `customer_id` –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Å–∏—Å—Ç–µ–º —Å `customer_sk`|
|`ref.products`|–ù–∞–∑–Ω–∞—á–∞–µ—Ç `product_sk` —Ç–æ–≤–∞—Ä–∞–º|
|`ref.rentals`|–°–æ–∑–¥–∞–µ—Ç –µ–¥–∏–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –∞—Ä–µ–Ω–¥–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π|

üîπ **–ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `*_sk` –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä**:

```sql
customer_id | system | customer_sk
------------|--------|------------
123         | CRM    | 10001
456         | ERP    | 10002
ABC         | API    | 10003
```

‚úÖ –¢–µ–ø–µ—Ä—å –≤—Å–µ –æ—Ç—á–µ—Ç—ã –∏ BI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç–∞—é—Ç **–ø–æ –µ–¥–∏–Ω–æ–º—É `customer_sk`**, –∞ –Ω–µ –ø–æ —Ä–∞–∑–Ω—ã–º `customer_id`.

---

## **üìå 10.3 –°–æ–∑–¥–∞–Ω–∏–µ Reference-—Ç–∞–±–ª–∏—Ü**

üìå **–°–æ–∑–¥–∞–µ–º Reference-—Ç–∞–±–ª–∏—Ü—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤**

```sql
CREATE TABLE ref.customers (
    customer_sk SERIAL PRIMARY KEY, -- –°—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã–π –∫–ª—é—á
    customer_nk TEXT NOT NULL, -- –ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π –∫–ª—é—á –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
    system_name TEXT NOT NULL, -- –ò–º—è —Å–∏—Å—Ç–µ–º—ã (CRM, ERP, API)
    created_at TIMESTAMP DEFAULT NOW() -- –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
);
```

üìå **–¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ (products)**

```sql
CREATE TABLE ref.products (
    product_sk SERIAL PRIMARY KEY,
    product_nk TEXT NOT NULL,
    system_name TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);
```

üìå **–¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∞—Ä–µ–Ω–¥—ã (rentals)**

```sql
CREATE TABLE ref.rentals (
    rental_sk SERIAL PRIMARY KEY,
    rental_nk TEXT NOT NULL,
    system_name TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);
```

‚úÖ **–¢–µ–ø–µ—Ä—å –Ω–∞–º –Ω—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω—è—Ç—å Reference-—Ç–∞–±–ª–∏—Ü—ã –∏–∑ ODS-—Å–ª–æ—è.**

---

## **üìå 10.4 –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ Reference-—Å–ª–æ—è (–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π)**

üìå **–ê–ª–≥–æ—Ä–∏—Ç–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π:**  
1Ô∏è‚É£ **–ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ ODS (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤).**  
2Ô∏è‚É£ **–°–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–π –æ–±—ä–µ–∫—Ç –≤ Reference-—Å–ª–æ–µ.**  
3Ô∏è‚É£ **–ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç–∞ –Ω–µ—Ç ‚Üí —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å —Å `*_sk`.**  
4Ô∏è‚É£ **–ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç —É–∂–µ –µ—Å—Ç—å ‚Üí –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º.**

üìå **–§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ Reference-—Å–ª–æ–π**

```sql
CREATE OR REPLACE FUNCTION ref.sync_customers()
RETURNS VOID AS $$
BEGIN
    INSERT INTO ref.customers (customer_nk, system_name)
    SELECT DISTINCT customer_id, 'CRM'
    FROM ods.customers
    ON CONFLICT (customer_nk, system_name) DO NOTHING;
END;
$$ LANGUAGE plpgsql;
```

üìå **–§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –≤ Reference-—Å–ª–æ–π**

```sql
CREATE OR REPLACE FUNCTION ref.sync_products()
RETURNS VOID AS $$
BEGIN
    INSERT INTO ref.products (product_nk, system_name)
    SELECT DISTINCT product_id, 'ERP'
    FROM ods.products
    ON CONFLICT (product_nk, system_name) DO NOTHING;
END;
$$ LANGUAGE plpgsql;
```

üìå **–§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä–µ–Ω–¥–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ Reference-—Å–ª–æ–π**

```sql
CREATE OR REPLACE FUNCTION ref.sync_rentals()
RETURNS VOID AS $$
BEGIN
    INSERT INTO ref.rentals (rental_nk, system_name)
    SELECT DISTINCT rental_id, 'API'
    FROM ods.rentals
    ON CONFLICT (rental_nk, system_name) DO NOTHING;
END;
$$ LANGUAGE plpgsql;
```

‚úÖ **–¢–µ–ø–µ—Ä—å —É –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –µ—Å—Ç—å –µ–¥–∏–Ω—ã–π `*_sk` –≤ Reference-—Å–ª–æ–µ.**

---

## **üìå 10.5 –°–≤—è–∑—ã–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏**

üìå **–ö–∞–∫ —Ç–µ–ø–µ—Ä—å —Å—Ç—Ä–æ–∏—Ç—å —Å–≤—è–∑–∏ –≤ DWH?**

- –í–º–µ—Å—Ç–æ `customer_id` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º `customer_sk`.
- –í–º–µ—Å—Ç–æ `product_id` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º `product_sk`.
- –í–º–µ—Å—Ç–æ `rental_id` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º `rental_sk`.

üìå **–ü—Ä–∏–º–µ—Ä –∑–∞–º–µ–Ω—ã –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã—Ö –∫–ª—é—á–µ–π –Ω–∞ —Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã–µ**

```sql
SELECT
    r.rental_sk,
    c.customer_sk,
    p.product_sk,
    r.rental_date
FROM dds.rentals r
JOIN ref.customers c ON r.customer_nk = c.customer_nk
JOIN ref.products p ON r.product_nk = p.product_nk;
```

‚úÖ **–¢–µ–ø–µ—Ä—å DWH –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `*_sk`, –∞ –Ω–µ `*_id` –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.**

---

## **üìå 10.6 –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è Reference-—Å–ª–æ—è**

üìå **–°–æ–∑–¥–∞–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö Reference-—Ç–∞–±–ª–∏—Ü**

```sql
CREATE OR REPLACE FUNCTION ref.sync_all()
RETURNS VOID AS $$
BEGIN
    PERFORM ref.sync_customers();
    PERFORM ref.sync_products();
    PERFORM ref.sync_rentals();
END;
$$ LANGUAGE plpgsql;
```

üìå **–î–æ–±–∞–≤–ª—è–µ–º –≤—ã–∑–æ–≤ –≤ ETL-–ø—Ä–æ—Ü–µ—Å—Å**

```sql
SELECT ref.sync_all();
```

‚úÖ **Reference-—Å–ª–æ–π —Ç–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!** üöÄ

---

## **üìå 10.7 –ò—Ç–æ–≥–∏**

üéØ **–¢–µ–ø–µ—Ä—å DWH –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Reference-—Å–ª–æ–π!**  
‚úÖ **–°–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π (Reference-tables).**  
‚úÖ **–û–±—ä–µ–∫—Ç—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ–ª—É—á–∏–ª–∏ —Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏.**  
‚úÖ **–°–≤—è–∑–∏ –≤ DWH —Ç–µ–ø–µ—Ä—å —Å—Ç—Ä–æ—è—Ç—Å—è –ø–æ `*_sk`, –∞ –Ω–µ `*_id`.**  
‚úÖ **Reference-—Å–ª–æ–π –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ ETL.**