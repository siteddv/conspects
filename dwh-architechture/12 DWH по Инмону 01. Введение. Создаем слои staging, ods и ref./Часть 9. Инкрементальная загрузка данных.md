–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –º—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ **—Å—Ç–µ–π–¥–∂–∏–Ω–≥-—Å–ª–æ–π (staging)** –∏ **–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–ª–æ–π (ODS)**, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ **–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö**. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç **–æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∏ –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏**, –∞ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤—Å—é —Ç–∞–±–ª–∏—Ü—É, —á—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø–æ–≤—ã—Å–∏—Ç **–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ETL-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤**.

---

## **üìå 9.1 –ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö**

üìå **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∑–∞–≥—Ä—É–∂–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–Ω–æ–≤–æ?**  
‚ùå **–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö** ‚Äì –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–∏–ª–ª–∏–æ–Ω—ã —Å—Ç—Ä–æ–∫.  
‚ùå **–†–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö** ‚Äì –≤–æ–∑–º–æ–∂–Ω—ã –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏.  
‚ùå **–î–ª–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏** ‚Äì –ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å —á–∞—Å—ã.

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** **–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** ‚Äì –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö –∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

---

## **üìå 9.2 –°–ø–æ—Å–æ–±—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏**

üîπ **1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Last Update (–¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)**

- –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–π —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏.
- –í—ã–±–∏—Ä–∞–µ–º –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏, –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞.

üîπ **2. –§–ª–∞–≥ "–∏–∑–º–µ–Ω–µ–Ω–æ/—É–¥–∞–ª–µ–Ω–æ" –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ –¥–∞–Ω–Ω—ã—Ö**

- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–∏—Å—Ç–µ–º—ã –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤–µ–¥—É—Ç –ø—Ä–∏–∑–Ω–∞–∫ "UPDATED_AT", "DELETED_FLAG".
- –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏.

üîπ **3. CDC (Change Data Capture) ‚Äì –ª–æ–≤–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏**

- –ò—Å–ø–æ–ª—å–∑—É–µ–º PostgreSQL Logical Replication, Debezium, Kafka –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
- –°–∞–º—ã–π –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –Ω–æ —Å–ª–æ–∂–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ.

---

## **üìå 9.3 –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Last Update –≤ PostgreSQL**

üìå **–®–∞–≥–∏:**  
1Ô∏è‚É£ –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏.  
2Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º **—Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏**.  
3Ô∏è‚É£ –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ **–æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏**.

üìå **–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É Last Update**

```sql
CREATE TABLE staging.last_update (
    table_name TEXT PRIMARY KEY,
    last_load_time TIMESTAMP
);
```

üìå **–§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏**

```sql
CREATE OR REPLACE FUNCTION staging.get_last_update(table_name TEXT) RETURNS TIMESTAMP AS $$
DECLARE
    last_time TIMESTAMP;
BEGIN
    SELECT last_load_time INTO last_time
    FROM staging.last_update
    WHERE staging.last_update.table_name = get_last_update.table_name;
    
    IF last_time IS NULL THEN
        RETURN '1900-01-01'::TIMESTAMP; -- –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ –±—ã–ª–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—á–µ–Ω—å —Å—Ç–∞—Ä—É—é –¥–∞—Ç—É
    ELSE
        RETURN last_time;
    END IF;
END;
$$ LANGUAGE plpgsql;
```

üìå **–û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏**

```sql
CREATE OR REPLACE FUNCTION staging.set_last_update(table_name TEXT, load_time TIMESTAMP) RETURNS VOID AS $$
BEGIN
    INSERT INTO staging.last_update (table_name, last_load_time)
    VALUES (table_name, load_time)
    ON CONFLICT (table_name) DO UPDATE 
    SET last_load_time = EXCLUDED.last_load_time;
END;
$$ LANGUAGE plpgsql;
```

‚úÖ **–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.**

---

## **üìå 9.4 –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã Rental**

üìå **1. –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏**

```sql
SELECT staging.get_last_update('rental');
```

üìå **2. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏**

```sql
INSERT INTO staging.rental (rental_id, inventory_id, customer_id, return_date, last_update)
SELECT rental_id, inventory_id, customer_id, return_date, last_update
FROM source.rental
WHERE last_update > staging.get_last_update('rental');
```

üìå **3. –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –∑–∞–≥—Ä—É–∑–∫–∏**

```sql
SELECT staging.set_last_update('rental', NOW());
```

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.

---

## **üìå 9.5 –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**

üìå **–ö–∞–∫ —É–¥–∞–ª—è—Ç—å –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–ª—å—à–µ –Ω–µ—Ç –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ?**  
üîπ **1. –õ–æ–≥–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (soft delete)**

- –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É `is_deleted BOOLEAN DEFAULT FALSE`.
- –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞ –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ, –≤ DWH –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏–º `is_deleted = TRUE`.

üìå **–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è**

```sql
UPDATE staging.rental
SET is_deleted = TRUE
WHERE rental_id NOT IN (SELECT rental_id FROM source.rental);
```

üîπ **2. –§–∏–∑–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (hard delete)**

- –†–µ–∞–ª—å–Ω–æ —É–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã ODS.
- –ò—Å–ø–æ–ª—å–∑—É–µ–º `DELETE FROM ods.rental WHERE rental_id NOT IN (SELECT rental_id FROM source.rental)`.
- **–ú–∏–Ω—É—Å:** –Ω–µ —Å–º–æ–∂–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

‚úÖ **–õ—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äì —Ö—Ä–∞–Ω–∏—Ç—å —Ñ–ª–∞–≥ —É–¥–∞–ª–µ–Ω–∏—è (`is_deleted`), –∞ –Ω–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—Ç—å —Å—Ç—Ä–æ–∫–∏.**

---

## **üìå 9.6 –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏**

üìå **–°–æ–∑–¥–∞–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü**

```sql
CREATE OR REPLACE FUNCTION staging.incremental_load()
RETURNS VOID AS $$
DECLARE 
    now_time TIMESTAMP := NOW();
BEGIN
    -- –ó–∞–≥—Ä—É–∂–∞–µ–º Rental
    INSERT INTO staging.rental (rental_id, inventory_id, customer_id, return_date, last_update)
    SELECT rental_id, inventory_id, customer_id, return_date, last_update
    FROM source.rental
    WHERE last_update > staging.get_last_update('rental');

    -- –û–±–Ω–æ–≤–ª—è–µ–º last_update
    PERFORM staging.set_last_update('rental', now_time);
END;
$$ LANGUAGE plpgsql;
```

üìå **–ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏**

```sql
SELECT staging.incremental_load();
```

‚úÖ **DWH —Ç–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏!** üöÄ

---

## **üìå 9.7 –ò—Ç–æ–≥–∏**

üéØ **–¢–µ–ø–µ—Ä—å DWH –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É!**  
‚úÖ **–¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.**  
‚úÖ **–£–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥ `is_deleted`.**  
‚úÖ **–ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ ETL-—Ñ—É–Ω–∫—Ü–∏–∏.**