–¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ **–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —á–∞—Å—Ç–∏** ‚Äì —Å–æ–∑–¥–∞–Ω–∏—é **–±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, ETL-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤** –∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –≤ **—Å–ª–æ–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø–æ –ò–Ω–º–∞–Ω—É**.

---

### **üîπ 1. –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É**

#### **üìå –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö DWH**

–î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ **–ø–æ –ò–Ω–º–∞–Ω—É** —Å–æ–∑–¥–∞–µ—Ç—Å—è **–Ω–æ–≤–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** –≤ PostgreSQL:

```sql
CREATE DATABASE dvh_inmon TEMPLATE template1;
```

- **`dvh_inmon`** ‚Äì –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
- **–®–∞–±–ª–æ–Ω `template1`** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—É—Å—Ç–æ–π –ë–î.

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–æ–∑–¥–∞–Ω–∞ **–Ω–æ–≤–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**, –≤ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è DWH.

---

#### **üìå –®–∞–≥ 2: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ PostgreSQL**

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ë–î –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ **–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**:

```sql
\c dvh_inmon;
```

–ó–∞—Ç–µ–º —Å–æ–∑–¥–∞–µ–º **–Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ** –≤ SQL-–∫–ª–∏–µ–Ω—Ç–µ.

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.

---

#### **üìå –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É –¥–∞–Ω–Ω—ã—Ö**

**–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö** ‚Äì –±–∞–∑–∞ **–∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞**.  
–î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ **–∏—Å–ø–æ–ª—å–∑—É–µ–º PostgreSQL Foreign Data Wrapper (FDW)**:

1. **–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ FDW –¥–ª—è PostgreSQL**:
    
    ```sql
    CREATE EXTENSION postgres_fdw;
    ```
    
    - –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç **–ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ –≤–Ω–µ—à–Ω–∏–º –±–∞–∑–∞–º –¥–∞–Ω–Ω—ã—Ö PostgreSQL**.
2. **–°–æ–∑–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ-–∏—Å—Ç–æ—á–Ω–∏–∫—É**:
    
    ```sql
    CREATE SERVER source_db
    FOREIGN DATA WRAPPER postgres_fdw
    OPTIONS (host 'localhost', dbname 'source_database', port '5432');
    ```
    
    - **`source_db`** ‚Äì –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.
    - **`source_database`** ‚Äì –∏–º—è –±–∞–∑—ã-–∏—Å—Ç–æ—á–Ω–∏–∫–∞.
3. **–°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**:
    
    ```sql
    CREATE USER MAPPING FOR current_user
    SERVER source_db
    OPTIONS (user 'source_user', password 'source_password');
    ```
    
    - –ú—ç–ø–ø–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∑–≤–æ–ª—è–µ—Ç **–æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –≤–Ω–µ—à–Ω–µ–π –±–∞–∑–µ**.
4. **–°–æ–∑–¥–∞–µ–º —Å—Ö–µ–º—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü**:
    
    ```sql
    CREATE SCHEMA film_src;
    ```
    
    - **–°—Ö–µ–º–∞ `film_src`** –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å **—Ç–∞–±–ª–∏—Ü—ã –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞**.
5. **–ü–æ–¥–∫–ª—é—á–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞**:
    
    ```sql
    IMPORT FOREIGN SCHEMA public
    FROM SERVER source_db
    INTO film_src;
    ```
    
    - –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç **–≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –±–∞–∑—ã –∏—Å—Ç–æ—á–Ω–∏–∫–∞**.

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í DWH –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–∞–±–ª–∏—Ü—ã **–∏–∑ –≤–Ω–µ—à–Ω–µ–π –±–∞–∑—ã**, –∏ –∏—Ö –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.

---

### **üîπ 2. –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ–µ–≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (Staging, ODS, Reference)**

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ **—Å–ª–æ–∏ DWH**.

#### **üìå –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º –¥–ª—è —Å–ª–æ–µ–≤**

```sql
CREATE SCHEMA staging;
CREATE SCHEMA ods;
CREATE SCHEMA ref;
```

- **`staging`** ‚Äì —Å–ª–æ–π —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
- **`ods`** ‚Äì –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–ª–æ–π.
- **`ref`** ‚Äì —Å–ª–æ–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤.

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–æ–∑–¥–∞–Ω—ã **—Ç—Ä–∏ —Å—Ö–µ–º—ã** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

---

#### **üìå –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ Staging-—Å–ª–æ–µ**

Staging-—Å–ª–æ–π **–∫–æ–ø–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞**:

```sql
CREATE TABLE staging.film AS TABLE film_src.film WITH NO DATA;
CREATE TABLE staging.inventory AS TABLE film_src.inventory WITH NO DATA;
CREATE TABLE staging.rental AS TABLE film_src.rental WITH NO DATA;
```

- **–°–æ–∑–¥–∞—é—Ç—Å—è —Ç–æ—á–Ω—ã–µ –∫–æ–ø–∏–∏ —Ç–∞–±–ª–∏—Ü**, –Ω–æ **–±–µ–∑ –¥–∞–Ω–Ω—ã—Ö**.
- –í staging **–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤—Ä–µ–º–µ–Ω–Ω–æ** (–±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏).

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í Staging **–ø–æ—è–≤–∏–ª–∏—Å—å —Ç–∞–±–ª–∏—Ü—ã**, –≤ –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –¥–∞–Ω–Ω—ã–µ.

---

#### **üìå –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ ODS-—Å–ª–æ–µ**

ODS-—Å–ª–æ–π **—Ö—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** (–Ω–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω–æ–µ):

```sql
CREATE TABLE ods.film AS TABLE staging.film WITH NO DATA;
CREATE TABLE ods.inventory AS TABLE staging.inventory WITH NO DATA;
CREATE TABLE ods.rental AS TABLE staging.rental WITH NO DATA;
```

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í ODS —Å–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å **—Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ**.

---

#### **üìå –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ Reference-—Å–ª–æ—è (—Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏)**

Ref-—Å–ª–æ–π **—Å–æ–∑–¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (SK)**:

```sql
CREATE TABLE ref.film (
    film_sk SERIAL PRIMARY KEY,
    film_nk INTEGER UNIQUE
);

CREATE TABLE ref.inventory (
    inventory_sk SERIAL PRIMARY KEY,
    inventory_nk INTEGER UNIQUE
);

CREATE TABLE ref.rental (
    rental_sk SERIAL PRIMARY KEY,
    rental_nk INTEGER UNIQUE
);
```

- **SK (Surrogate Key)** ‚Äì —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á **–¥–ª—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞**.
- **NK (Natural Key)** ‚Äì –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä **–∏–∑ —Å–∏—Å—Ç–µ–º—ã –∏—Å—Ç–æ—á–Ω–∏–∫–∞**.

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å –∫–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å –≤ DWH –∏–º–µ–µ—Ç **—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á**.

---

### **üîπ 3. –°–æ–∑–¥–∞–Ω–∏–µ ETL-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤**

#### **üìå –®–∞–≥ 1: –ü—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Staging**

–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö **–∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞** –≤ Staging:

```sql
CREATE OR REPLACE FUNCTION staging.load_film()
RETURNS void AS $$
BEGIN
    DELETE FROM staging.film;
    INSERT INTO staging.film SELECT * FROM film_src.film;
END;
$$ LANGUAGE plpgsql;
```

- **–£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ.**
- **–ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞.**

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** Staging **–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏**.

---

#### **üìå –®–∞–≥ 2: –ü—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ ODS**

–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö **–∏–∑ Staging –≤ ODS**:

```sql
CREATE OR REPLACE FUNCTION ods.load_film()
RETURNS void AS $$
BEGIN
    DELETE FROM ods.film;
    INSERT INTO ods.film SELECT * FROM staging.film;
END;
$$ LANGUAGE plpgsql;
```

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í ODS –ø–æ–ø–∞–¥–∞—é—Ç **–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**.

---

#### **üìå –®–∞–≥ 3: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ Reference-—Å–ª–æ—è**

Reference-—Å–ª–æ–π —Å–æ–∑–¥–∞–µ—Ç **—Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏**:

```sql
CREATE OR REPLACE FUNCTION ref.sync_film_keys()
RETURNS void AS $$
BEGIN
    INSERT INTO ref.film (film_nk)
    SELECT f.film_id FROM ods.film f
    WHERE NOT EXISTS (
        SELECT 1 FROM ref.film r WHERE r.film_nk = f.film_id
    );
END;
$$ LANGUAGE plpgsql;
```

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í Reference-—Å–ª–æ–π –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è **–Ω–æ–≤—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã**.

---

### **üîπ 4. –ü–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (Full ETL)**

–°–æ–∑–¥–∞–µ–º **–µ–¥–∏–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–ª–æ–µ–≤**:

```sql
CREATE OR REPLACE FUNCTION full_etl()
RETURNS void AS $$
BEGIN
    -- –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Staging
    PERFORM staging.load_film();

    -- –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ ODS
    PERFORM ods.load_film();

    -- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏
    PERFORM ref.sync_film_keys();
END;
$$ LANGUAGE plpgsql;
```

–¢–µ–ø–µ—Ä—å **–≤—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π**:

```sql
SELECT full_etl();
```

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç **–≤–µ—Å—å ETL-–ø—Ä–æ—Ü–µ—Å—Å**, –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è.

---

### **üîπ –ò—Ç–æ–≥–∏**

- –°–æ–∑–¥–∞–Ω–æ **DWH –ø–æ –ò–Ω–º–∞–Ω—É** —Å **—Ç—Ä–µ–º—è —Å–ª–æ—è–º–∏ (Staging, ODS, Reference)**.
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã **ETL-–ø—Ä–æ—Ü–µ—Å—Å—ã** –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.
- –í–Ω–µ–¥—Ä–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ **—Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π**.
- –¢–µ–ø–µ—Ä—å –¥–∞–Ω–Ω—ã–µ –º–æ–∂–Ω–æ **–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ —Å—Ç—Ä–æ–∏—Ç—å –¥–∞—Ç–∞-–º–∞—Ä—Ç—ã**.