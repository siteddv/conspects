## **๐ 8.1 ะงัะพ ัะฐะบะพะต ETL?**

**ETL (Extract, Transform, Load)** โ ะฟัะพัะตัั **ะธะทะฒะปะตัะตะฝะธั ะดะฐะฝะฝัั ะธะท ะธััะพัะฝะธะบะพะฒ, ะธั ะพะฑัะฐะฑะพัะบะธ ะธ ะทะฐะณััะทะบะธ ะฒ DWH**.

### **๐น ะัะฝะพะฒะฝัะต ััะฐะฟั ETL**

1๏ธโฃ **Extract (ะะทะฒะปะตัะตะฝะธะต ะดะฐะฝะฝัั)**

- ะะพะปััะตะฝะธะต ะดะฐะฝะฝัั ะธะท **ERP, CRM, API, ัะฐะนะปะพะฒ (CSV, JSON, XML, Parquet)**.
- ะะฐะฑะพัะฐ ั **ัะตะปััะธะพะฝะฝัะผะธ (PostgreSQL, MySQL, Oracle) ะธ NoSQL (MongoDB, Redis, ClickHouse) ะฑะฐะทะฐะผะธ ะดะฐะฝะฝัั**.

2๏ธโฃ **Transform (ะขัะฐะฝััะพัะผะฐัะธั ะดะฐะฝะฝัั)**

- ะัะธััะบะฐ, ะฝะพัะผะฐะปะธะทะฐัะธั, ัะดะฐะปะตะฝะธะต ะดัะฑะปะธะบะฐัะพะฒ.
- ะะฑะพะณะฐัะตะฝะธะต ะดะฐะฝะฝัั, ัะพะทะดะฐะฝะธะต ััััะพะณะฐัะฝัั ะบะปััะตะน.
- ะะณัะตะณะฐัะธั ะดะฐะฝะฝัั, ัะฐััะตัั ะฟะพะบะฐะทะฐัะตะปะตะน.

3๏ธโฃ **Load (ะะฐะณััะทะบะฐ ะฒ ััะฐะฝะธะปะธัะต)**

- ะะฐะฟะธัั ะดะฐะฝะฝัั ะฒ **ODS, Reference, Integration, DDS**.
- ะััะพัะธะทะฐัะธั ะดะฐะฝะฝัั (SCD Type 2).

๐ **ะะฐะบ ะฒัะณะปัะดะธั ETL-ะฟัะพัะตัั?**

```
[ ะััะพัะฝะธะบะธ ะดะฐะฝะฝัั (ERP, CRM, API) ]
        โ (Extract)
[ Staging Layer (ััััะต ะดะฐะฝะฝัะต) ]
        โ (Transform)
[ ODS Layer (ะพะฟะตัะฐัะธะพะฝะฝัะต ะดะฐะฝะฝัะต) ]
        โ (Transform)
[ Reference Layer (ะฝะพัะผะฐะปะธะทะฐัะธั ะบะปััะตะน) ]
        โ (Transform)
[ DDS Layer (ะธััะพัะธัะตัะบะธะต ะดะฐะฝะฝัะต) ]
        โ (Load)
[ Data Marts (ะพััะตัั ะดะปั BI) ]
```

โ **ETL-ะฟะฐะนะฟะปะฐะนะฝ ะฟัะพัะพะดะธั ัะตัะตะท ะฒัะต ัะปะพะธ ััะฐะฝะธะปะธัะฐ.**

---

## **๐ 8.2 ะะฝััััะผะตะฝัั ะดะปั ETL**

ะะฐััะผะพััะธะผ ะพัะฝะพะฒะฝัะต **ะธะฝััััะผะตะฝัั ะดะปั ะฐะฒัะพะผะฐัะธะทะฐัะธะธ ETL-ะฟัะพัะตััะพะฒ**.

|**ะะฝััััะผะตะฝั**|**ะะฟะธัะฐะฝะธะต**|
|---|---|
|**Apache Airflow**|ะฃะฟัะฐะฒะปะตะฝะธะต ETL-ะฟะฐะนะฟะปะฐะนะฝะฐะผะธ (Python)|
|**Apache Nifi**|ะะธะทัะฐะปัะฝัะน ETL-ะบะพะฝะฒะตะนะตั|
|**Talend**|ะัะฐัะธัะตัะบะธะน ETL-ะธะฝััััะผะตะฝั|
|**DBT (Data Build Tool)**|SQL-ะฟะปะฐััะพัะผะฐ ะดะปั ะพะฑัะฐะฑะพัะบะธ ะดะฐะฝะฝัั|
|**Python (pandas, psycopg2, SQLAlchemy)**|ะัะพะณัะฐะผะผะธัะพะฒะฐะฝะธะต ETL-ะฟัะพัะตััะพะฒ|
|**SQL (PL/pgSQL, Stored Procedures)**|ะัััะพะตะฝะฝัะต SQL-ัะบัะธะฟัั ะฒ DWH|

โ **ะัััะธะน ะฒัะฑะพั ะดะปั ะฝะฐัะตะณะพ ะฟัะธะผะตัะฐ:**

- **PostgreSQL (ััะฐะฝะธะผัะต ะฟัะพัะตะดััั) โ Python (ETL-ัะบัะธะฟัั) โ Apache Airflow (ะฐะฒัะพะผะฐัะธะทะฐัะธั).**

---

## **๐ 8.3 ะะฐะทัะฐะฑะพัะบะฐ ETL ะดะปั Staging Layer (ััััะต ะดะฐะฝะฝัะต)**

๐ **ะะฐะดะฐัะฐ:** ะะฐะณััะถะฐัั ััััะต ะดะฐะฝะฝัะต ะธะท ะธััะพัะฝะธะบะพะฒ ะฒ **Staging Layer**.

๐ **ะัะธะผะตั ETL ะฒ SQL (PostgreSQL)**

```sql
CREATE TABLE staging.sales_raw (
    id SERIAL PRIMARY KEY,
    source_system VARCHAR(50), -- CRM, ERP, API
    data JSONB, -- ะััะพะดะฝัะต ะดะฐะฝะฝัะต ะฒ JSON
    load_timestamp TIMESTAMP DEFAULT now()
);
```

โ **ะกัััะต ะดะฐะฝะฝัะต ััะฐะฝัััั ะฒ ัะพัะผะฐัะต JSON, ััะพะฑั ัะพััะฐะฝััั ััััะบัััั ะธััะพัะฝะธะบะพะฒ.**

๐ **Python-ัะบัะธะฟั ะดะปั ะทะฐะณััะทะบะธ ะดะฐะฝะฝัั ะธะท API ะฒ Staging Layer**

```python
import requests
import psycopg2
import json

# ะะพะดะบะปััะตะฝะธะต ะบ PostgreSQL
conn = psycopg2.connect("dbname=dwh user=etl password=secret")
cur = conn.cursor()

# ะะฐะฟัะพั ะบ API
response = requests.get("https://api.salesdata.com/orders")
data = response.json()

# ะะฐะฟะธัั ะดะฐะฝะฝัั ะฒ Staging
for record in data:
    cur.execute("INSERT INTO staging.sales_raw (source_system, data) VALUES (%s, %s)",
                ('CRM', json.dumps(record)))

conn.commit()
cur.close()
conn.close()
```

โ **ะะตะทัะปััะฐั:** ะะฐะฝะฝัะต ะธะท API ะทะฐะณััะถะฐัััั ะฒ **Staging Layer**.

---

## **๐ 8.4 ะะฐะทัะฐะฑะพัะบะฐ ETL ะดะปั ODS Layer (ะพะฟะตัะฐัะธะพะฝะฝัะต ะดะฐะฝะฝัะต)**

๐ **ะะฐะดะฐัะฐ:**

- ะัะธััะธัั ััััะต ะดะฐะฝะฝัะต.
- ะะฐะทะฒะตัะฝััั JSON ะฒ ัะฐะฑะปะธัั.
- ะฃะดะฐะปะธัั ะดัะฑะปะธะบะฐัั.

๐ **ะัะธะผะตั SQL-ััะฐะฝััะพัะผะฐัะธะธ ะดะฐะฝะฝัั ะธะท Staging ะฒ ODS**

```sql
CREATE TABLE ods.sales (
    sale_id INT PRIMARY KEY,
    customer_id INT,
    product_id INT,
    amount DECIMAL(10,2),
    sale_date TIMESTAMP
);

INSERT INTO ods.sales (sale_id, customer_id, product_id, amount, sale_date)
SELECT 
    (data->>'id')::INT AS sale_id,
    (data->>'customer_id')::INT AS customer_id,
    (data->>'product_id')::INT AS product_id,
    (data->>'amount')::DECIMAL(10,2) AS amount,
    (data->>'sale_date')::TIMESTAMP AS sale_date
FROM staging.sales_raw;
```

โ **ะะตะทัะปััะฐั:** **ODS ัะพะดะตัะถะธั "ัะธัััะต" ะดะฐะฝะฝัะต ะฒ ััััะบัััะธัะพะฒะฐะฝะฝะพะผ ะฒะธะดะต.**

---

## **๐ 8.5 ะะฐะทัะฐะฑะพัะบะฐ ETL ะดะปั Reference Layer (ะฝะพัะผะฐะปะธะทะฐัะธั ะธะดะตะฝัะธัะธะบะฐัะพัะพะฒ)**

๐ **ะะฐะดะฐัะฐ:**

- ะกะพะทะดะฐัั **ะตะดะธะฝัะต ID ะบะปะธะตะฝัะพะฒ ะธ ะฟัะพะดัะบัะพะฒ**.
- ะัะบะปััะธัั ะดัะฑะปะธ ะธะท ัะฐะทะฝัั ัะธััะตะผ.

๐ **ะัะธะผะตั SQL ะดะปั Reference Layer**

```sql
CREATE TABLE ref.customers (
    customer_sk SERIAL PRIMARY KEY,
    source_id INT UNIQUE,
    full_name VARCHAR(255)
);

INSERT INTO ref.customers (source_id, full_name)
SELECT DISTINCT customer_id, CONCAT(first_name, ' ', last_name)
FROM ods.sales;
```

โ **ะะตะทัะปััะฐั:** ะฃ ะบะฐะถะดะพะณะพ ะบะปะธะตะฝัะฐ ัะตะฟะตัั ะตััั **ะณะปะพะฑะฐะปัะฝัะน ะธะดะตะฝัะธัะธะบะฐัะพั (customer_sk)**.

---

## **๐ 8.6 ะะฐะทัะฐะฑะพัะบะฐ ETL ะดะปั DDS Layer (ะธััะพัะธัะตัะบะธะต ะดะฐะฝะฝัะต)**

๐ **ะะฐะดะฐัะฐ:**

- **ะะพะฑะฐะฒะปััั ะฝะพะฒัะต ะฒะตััะธะธ ะดะฐะฝะฝัั**, ะตัะปะธ ะทะฝะฐัะตะฝะธั ะธะทะผะตะฝะธะปะธัั.
- **ะัะฟะพะปัะทะพะฒะฐัั ะผะตัะพะด SCD Type 2** ะดะปั ััะฐะฝะตะฝะธั ะธััะพัะธะธ.

๐ **ะัะธะผะตั SQL ะดะปั ััะฐะฝะตะฝะธั ะธััะพัะธะธ ะฟัะพะดะฐะถ**

```sql
CREATE TABLE dds.sales_history (
    id SERIAL PRIMARY KEY,
    customer_sk INT,
    product_id INT,
    amount DECIMAL(10,2),
    status VARCHAR(50),
    valid_from TIMESTAMP,
    valid_to TIMESTAMP NULL DEFAULT NULL
);
```

๐ **ะฅัะฐะฝะธะผะฐั ะฟัะพัะตะดััะฐ ะดะปั ะดะพะฑะฐะฒะปะตะฝะธั ะธััะพัะธะธ (SCD Type 2)**

```sql
CREATE OR REPLACE FUNCTION update_sales_history()
RETURNS VOID AS $$
BEGIN
    -- ะะฐะฒะตััะฐะตะผ ััะฐััั ะทะฐะฟะธัั
    UPDATE dds.sales_history
    SET valid_to = now()
    WHERE customer_sk IN (SELECT customer_sk FROM ref.customers)
    AND valid_to IS NULL;

    -- ะััะฐะฒะปัะตะผ ะฝะพะฒัั ะฒะตััะธั ะดะฐะฝะฝัั
    INSERT INTO dds.sales_history (customer_sk, product_id, amount, status, valid_from)
    SELECT 
        customer_sk, product_id, amount, status, now()
    FROM ods.sales;
END $$ LANGUAGE plpgsql;
```

โ **ะะตะทัะปััะฐั:** **ะัะต ะธะทะผะตะฝะตะฝะธั ะดะฐะฝะฝัั ัะพััะฐะฝััััั, ะผะพะถะฝะพ ะพััะปะตะถะธะฒะฐัั ะธััะพัะธั.**

---

## **๐ 8.7 ะะฒัะพะผะฐัะธะทะฐัะธั ETL ัะตัะตะท Apache Airflow**

๐ **ะะฐะดะฐัะฐ:**

- ะะฒัะพะผะฐัะธะทะธัะพะฒะฐัั ะฒัะฟะพะปะฝะตะฝะธะต ะฒัะตั ETL-ัะบัะธะฟัะพะฒ ะฟะพ ัะฐัะฟะธัะฐะฝะธั.
- ะะฑะตัะฟะตัะธัั ะฝะฐะดะตะถะฝะพััั ETL-ะฟะฐะนะฟะปะฐะนะฝะฐ.

๐ **ะัะธะผะตั DAG ะฒ Apache Airflow**

```python
from airflow import DAG
from airflow.operators.bash_operator import BashOperator
from datetime import datetime

default_args = {
    'owner': 'etl_team',
    'start_date': datetime(2024, 1, 1),
    'retries': 1
}

dag = DAG(
    'dwh_etl_pipeline',
    default_args=default_args,
    schedule_interval='@daily'
)

extract_data = BashOperator(
    task_id='extract_data',
    bash_command='python extract.py',
    dag=dag
)

transform_load = BashOperator(
    task_id='transform_load',
    bash_command='psql -f transform_load.sql',
    dag=dag
)

extract_data >> transform_load
```

โ **ะะตะทัะปััะฐั:** **ETL ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฒัะฟะพะปะฝัะตััั ะบะฐะถะดัะน ะดะตะฝั.**

---

## **๐ ะัะพะณะธ**

๐ฏ **ะขะตะฟะตัั ั ะฝะฐั ะตััั ะฟะพะปะฝัะน ETL ะดะปั ััะฐะฝะธะปะธัะฐ ะฟะพ ะะฝะผะฐะฝั:**  
โ **Staging Layer** โ ััััะต ะดะฐะฝะฝัะต.  
โ **ODS Layer** โ ะพะฟะตัะฐัะธะพะฝะฝัะต ะดะฐะฝะฝัะต.  
โ **Reference Layer** โ ะฝะพัะผะฐะปะธะทะฐัะธั.  
โ **DDS Layer** โ ะธััะพัะธัะตัะบะธะต ะดะฐะฝะฝัะต.  
โ **ะะฒัะพะผะฐัะธะทะฐัะธั ัะตัะตะท Apache Airflow.**

๐ **ะกะปะตะดัััะธะน ัะฐะณ** โ **ะกะพะทะดะฐะฝะธะต Data Marts ะธ BI-ะฐะฝะฐะปะธัะธะบะธ (Power BI, Tableau, Grafana).** ๐