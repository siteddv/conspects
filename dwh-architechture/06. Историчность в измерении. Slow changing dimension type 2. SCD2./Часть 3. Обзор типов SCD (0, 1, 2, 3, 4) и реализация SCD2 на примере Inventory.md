```markdown
# 3. Обзор типов SCD (0, 1, 2, 3, 4) и реализация SCD2 на примере Inventory

**Время на видео:** примерно 0:12:02 – 0:23:49

## 3.1. Краткий обзор Slow Changing Dimensions (SCD)

Преподаватель упоминает, что *Slow Changing Dimensions* (SCD) — это классификация способов, как в хранилище данных учитывать изменения в измерениях (справочниках). Основные типы:

1. **SCD Type 0 (No change)**  
   - Измерение «статично»: изменения в источнике не переносятся или игнорируются.  
   - Полезно, когда нужно хранить «бессменные» справочники (например, стандарты, кодировки, которые никогда не меняются) или когда бизнес-логика не требует учёта изменений.  
   - В реальных системах почти не применяется для сущностей, которые могут меняться.

2. **SCD Type 1 (Overwrite)**  
   - При изменении значения атрибута в источнике в хранилище **старое затирается новым** (полная перезапись).  
   - История не сохраняется; в измерении всегда только «текущее» состояние.  
   - Плюсы: простая реализация (обычный `UPDATE`).  
   - Минусы: невозможно ответить на вопросы о прошлом (например, какой у этого товара был рейтинг год назад).

3. **SCD Type 2 (Add new row)**  
   - **Самый распространённый** способ хранить полную историю изменений.  
   - При изменении атрибута **добавляется новая строка** с периодом действия; старая версия «закрывается».  
   - Таким образом, в измерении на одного физического «объекта» (например, диск) может быть несколько записей, каждая описывает состояние в определённый промежуток времени.  
   - Для закрытой версии проставляется `effective_date_to` (дата «окончания»), `is_active = false`; для новой версии — `effective_date_from = дата изменения`, `is_active = true`, `effective_date_to = 9999-12-31` (или другой большой «конечный» интервал).

4. **SCD Type 3 (Add new column)**  
   - В одной и той же записи измерения добавляют «старое» и «новое» поле. Например, `current_film_id` и `previous_film_id`.  
   - Позволяет хранить только **один** шаг назад (или ограниченное число версий) — не полная история.  
   - В нашем сценарии (с дисками и фильмами) часто изменений может быть много, поэтому SCD3 не даёт всей нужной истории.

5. **SCD Type 4 (Mini-dimension)**  
   - Выносят меняющиеся атрибуты в отдельную «мини-измерение», давая ему собственный суррогатный ключ.  
   - Особенно полезно, если в измерении есть *группа* полей, которые меняются очень часто, тогда их оптимальнее держать в отдельной таблице.

> Преподаватель делает акцент, что здесь (в примере с дисками) **SCD Type 2** наиболее уместен, так как нужно хранить всю историю (каждую смену фильма).

---

## 3.2. Почему выбран SCD2 для `dim_inventory`

1. **Частая бизнес-задача**: узнать, какие фильмы *точно* были на дисках в определённые даты.  
2. **Нужна полная история**: диск может несколько раз меняться (сегодня Фильм A, через неделю Фильм B, потом опять другой и т.д.).  
3. **Аналитические отчёты**: необходимо понять, какой фильм генерировал выручку в какой промежуток. SCD2 легко даёт эту информацию по датам (`effective_date_from` / `effective_date_to`).

Преподаватель подчеркивает, что SCD2 требует:
- Добавить поля для дат действия (From/To).  
- Менять процедуру загрузки, чтобы при изменении добавлялась **новая запись** вместо обновления.

---

## 3.3. Структура полей в реализации SCD2

Для примера таблицы `dim_inventory` в Core слое вводятся следующие колонки (или их аналоги):
1. **Surrogate Key** (например, `inventory_pk`) — первичный ключ *именно в DWH*. Он **не** равен `inventory_id` источника, чтобы при каждой новой версии появлялся отдельный PK.
2. **Natural Key** (тут: `inventory_id`) — ключ из источника, показывающий, что все версии принадлежат к одному реальному диску.
3. **Атрибуты** (например, `film_id`, `film_title`, `rating` и т.п.).  
4. **effective_date_from** (дата начала актуальности строки).  
5. **effective_date_to** (дата окончания актуальности строки). В открытых записях может быть значением «далёкого будущего» (например, `9999-12-31`).  
6. **is_active** (булево) — отметка, действует ли эта версия сейчас (`true`) или уже закрыта (`false`).

---

## 3.4. Процесс при изменении (пример с диском)

### Предыдущее состояние
- В хранилище: для `inventory_id = 1` есть строка  
  - `is_active = true`,  
  - `effective_date_from = 1900-01-01`,  
  - `effective_date_to = 9999-12-31`,  
  - `film_id = 1` (Фильм A).

### Появляется новое состояние в источнике
- Источник меняет `film_id` на 2 (Фильм B).  
- В Staging попадает новая запись: «диск 1, фильм = 2, `last_update = 2022-08-10` (к примеру)».  

### Действия в DWH (SCD2)
1. **Закрываем старую версию**:  
   - `UPDATE dim_inventory`  
   - `SET is_active = false, effective_date_to = '2022-08-10'`  
   - `WHERE inventory_id = 1 AND is_active = true`  
2. **Добавляем новую версию**:  
   - `INSERT INTO dim_inventory(...) VALUES (... film_id = 2, effective_date_from = '2022-08-10', effective_date_to = '9999-12-31', is_active = true, ...)`  
   - Теперь в DWH уже **две** записи для `inventory_id = 1`: одна действует до `2022-08-10`, другая — с `2022-08-10` до конца.

---

## 3.5. Преимущества и важные нюансы SCD2

1. **Преимущества**  
   - **Полная историчность**: можно сделать отчёт за любой период и корректно определить, какой фильм был на диске.  
   - **Легкость для аналитиков**: достаточно понимать, что любая фактическая запись (проката, оплаты) может связаться именно с той версией измерения, которая действовала на момент транзакции.

2. **Нюансы**  
   - **Увеличение объёма**: в некоторых измерениях часто меняются атрибуты, и каждая смена добавляет новую строку. Нужно следить за размером таблицы.  
   - **Необходимость хранить даты изменений**: если в источнике нет «признака времени обновления», нужно придумать иной способ (например, контрольные суммы, триггеры или CDC).  
   - **Сложность логики загрузки**: вместо простого `UPDATE` придётся аккуратно «закрывать» старую версию и «открывать» новую. Ошибки в этой логике могут приводить к пропущенным или наложенным интервалам.

---

## 3.6. Подготовка к демонстрации в коде

Преподаватель анонсирует, что в следующих частях:
- Будет подробно показано, как **переписать** DDL (ALTER TABLE) для `dim_inventory`, добавив поля `effective_date_from`, `effective_date_to`, `is_active`.  
- Как изменить скрипты загрузки (пошагово) для учёта новых, изменённых, удалённых записей из источника.  
- Как тестировать сценарии (например, поменять фильм, удалить диск, посмотреть, появились ли в DWH нужные версии).

> Фокус на конкретном техническом решении: SCD2 с датами.

---

### Краткий итог раздела
В третьей части ролика даётся **теоретический** базис по SCD: перечисляются основные типы (0–4), кратко описываются их отличия. Основной упор делается на **SCD Type 2**, так как для задачи хранения истории (какие фильмы были на каком диске в разные периоды) — это наиболее подходящий и распространённый подход. Преподаватель показывает, как именно SCD2 позволит сохранять несколько версий для одного `inventory_id`, закрывая старую запись датой изменения и создавая новую «актуальную» версию.
```