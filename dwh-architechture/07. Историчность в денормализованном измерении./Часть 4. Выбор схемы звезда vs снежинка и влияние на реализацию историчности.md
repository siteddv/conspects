### 4.1 Схема «снежинка» и упрощённая историчность по разным измерениям

1. **Описание схемы снежинка**
    
    - В схеме «снежинка» таблицы измерений могут быть **нормализованы** дальше. Например, есть отдельное измерение `dim_film`, к которому ссылается `dim_inventory` (по `film_id`).
    - Тогда изменения в фильмах (**SCD Type 2**) могут вестись **в своей таблице** (`dim_film`), независимо от `dim_inventory`.
    - Аналогично, `dim_inventory` уже не хранит поля фильма (title, rental_rate, и т.д.), а лишь хранит ссылку `film_pk`.
2. **Преимущество снежинки для SCD**
    
    - Если нужно реализовать **историчность** на уровне `film`, создаём SCD Type 2 **только** в `dim_film`.
    - `dim_inventory` отвечает **только** за историю изменений инвентаря (когда `inventory_id` стал неактивным, сменился диск и т.д.).
    - Когда в отчёте нужно поле `title` или `rental_rate`, оно подтягивается через JOIN к `dim_film`.
3. **Недостатки снежинки**
    
    - Увеличение количества таблиц.
    - Усложнение SQL-запросов для аналитиков: нужно JOIN-ить несколько измерений.
    - Потенциально большая «глубина» связей (если ещё и «адрес» и «city» вынести в отдельные измерения).

---

### 4.2 Схема «звезда» и денормализация полей `film` в `dim_inventory`

1. **Описание схемы звезда**
    
    - В схеме «звезда» есть центральная таблица фактов, а вокруг неё — **непосредственно** примкнувшие таблицы измерений (каждая максимально «де-нормализована»).
    - В текущем примере: «факт аренды» → `dim_inventory`, где уже есть поля из `film` (`title`, `rental_rate`, `rental_duration` и т.п.).
2. **Преимущество звезды**
    
    - **Проще** писать аналитические запросы: фактически, для разреза по фильмам не нужно JOIN-ить `dim_film`; всё (или почти всё) уже в `dim_inventory`.
    - Производительность при «чтении» для аналитики зачастую лучше, так как меньше соединений (JOIN), особенно на больших объёмах.
3. **Недостаток**: усложнение SCD
    
    - Раз мы храним данные о фильме **прямо** в `dim_inventory`, значит, любое изменение полей фильма (название, цена аренды и т.д.) должно вести к **новому** актуальному состоянию SCD-записи в `dim_inventory`.
    - Возникает необходимость **двойной** логики:
        1. При смене `film_id` («этот диск теперь с другим фильмом») — новая строка,
        2. При смене **параметров** фильма — тоже новая строка.
    - Если бы было отдельное измерение `dim_film`, всё это происходило бы внутри него, а `dim_inventory` не затрагивалось (если не менялся сам `film_id`).

---

### 4.3 Обоснование выбора «звезды» в учебном (и нередко реальном) примере

1. **Почему часто выбирают звезду**
    
    - **Упрощение** жизни для аналитиков: им нужен один JOIN (факт → измерение) и сразу доступ ко всем полям (`title`, `rental_rate`), без дополнительного соединения.
    - **Оптимизация** чтения в BI-системах (Power BI, Tableau и т.д.): предсказуемые запросы, не требуется многоуровневая денормализация.
2. **Жертвы при таком подходе**
    
    - Сложнее кодить ETL-процесс, так как поля из `film` должны историться **вместе** с `inventory`.
    - При наличии ещё нескольких справочников, с которых нужно «подтягивать» поля (например, `language`, `actors`), `dim_inventory` начинает раздуваться и логику обновления становится труднее поддерживать.
3. **Рекомендации**
    
    - Если объём данных или сложность таблицы `film` очень велики, и в ней много полей, которые часто меняются, стоит **подумать** о снежинке или хотя бы гибридном подходе.
    - Если «всё довольно компактно» (количество фильмов не такое большое, изменение не слишком частое), «звезда» зачастую проще для конечных пользователей.

---

### 4.4 Итог для историчности в схеме «звезда»

- **Главная мысль**: мы **оставляем** «звезду», чтобы ускорить аналитику и избежать JOINS по многим измерениям.
- **Следствие**: необходимость явно «притащить» логику SCD для полей из `film`. То есть каждый раз, когда `film` обновляется, в `dim_inventory` будет появляться **новая** строка (SCD Type 2), а старая «закрываться».
- **Фокус занятия**: показать, как это технически сделать в SQL, проверяя **обновления** и **вставляя** по нужным правилам историчности.

> **Резюме Часть 4**:
> 
> - Альтернатива — сделать отдельное измерение `dim_film` (снежинка) и вести историчность только там. Так проще разделить зоны ответственности.
> - Однако «звезда» в большинстве BI-сценариев предпочтительнее, поскольку ускоряет и упрощает аналитику.
> - В итоге придётся «научиться» в одной таблице `dim_inventory` обрабатывать и изменения диска, и изменения характеристик фильма.