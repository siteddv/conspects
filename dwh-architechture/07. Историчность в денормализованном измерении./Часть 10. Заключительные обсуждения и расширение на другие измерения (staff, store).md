### 10.1 Нужно ли вести историчность по «staff» (сотрудникам), «store» (магазинам) и другим сущностям

1. **Сотрудники (staff)**
    
    - В реальном бизнесе сотрудник может менять **фамилию**, **имя** или **должность**. Вопрос: важно ли нам хранить, например, старую фамилию?
    - Часто для аналитики имя-фамилия сотрудника не настолько критичны, поэтому можно просто **обновлять** поле «ФИО» в той же самой строке, без создания новой SCD-записи.
    - Однако если критично понимать, **сколько** продаж совершил сотрудник именно под старой должностью или до смены имени (есть бизнес-сценарии, где это может играть роль), тогда вводят SCD Type 2. Но это гораздо реже требуется, чем в случае изменения цены аренды фильма.
2. **Адрес и город магазина (store → address → city)**
    
    - Может ли магазин **переехать** на новый адрес, оставаясь с тем же идентификатором? Теоретически возможно, но в большинстве случаев в системах источника при переезде создают **новый** объект «Store», а старый считается закрытым.
    - Переименование улицы или города: ещё один случай, который часто не влияет на аналитику, поскольку маркетинговая статистика рассматривает «магазин №5» как один и тот же объект, без детализации того, что адресная строчка изменилась.
    - Если важно анализировать продажи в контексте «старого адреса vs нового адреса», то нужно либо SCD Type 2 для полей адреса, либо (как альтернатива) новый `store_id`.
3. **Итог**
    
    - Каждая ситуация индивидуальна. Нужно смотреть на **бизнес-требования**: важно ли сравнивать продажи магазина **до** и **после** смены адреса/менеджера/названия, или достаточно считать, что это один объект, и просто «обновить» поле?

---

### 10.2 Общая стратегия расширения историчности

1. **Выбор важных полей**
    
    - В любом измерении (будь то `staff`, `store`, `film`) нужно заранее определить, какие именно изменения влияют на отчёты. Это могут быть:
        - Ставки аренды, продолжительность проката, возрастной рейтинг (в случае фильма),
        - Статус магазина, его класс или менеджер (в случае `store`),
        - Должность, ставка зарплаты и т.п. (в случае `staff`).
2. **Сокращение объёма обновлений**
    
    - Если есть большие текстовые поля (описание, биография), которые часто меняются и не важны для аналитики, лучше **не вести** SCD Type 2 по ним. Это снижает объёмы хранения и нагрузку на ETL.
3. **Принципиальная похожесть логики**
    
    - Техническая реализация SCD Type 2 похожа: для любого измерения есть момент «предыдущее состояние» и «новое состояние». Нужно «закрыть» старую строку (или её часть периода) и открыть новую.
    - То есть если мы поняли, как это делается для `inventory` и `film`, то мы можем ту же технику применить к `store` или `staff`.

---

### 10.3 Финальные выводы по итогам занятия

1. **Что сделано**
    
    - Реализована историчность измерения `dim_inventory` **не только** при смене самого диска (`inventory_id` → `film_id`), но и при изменении **полей** фильма из таблицы `film`.
    - Показано, как **инкрементально** грузить данные из `inventory`, **полностью** грузить данные из `film` и сопоставлять их в `core`-слое (DWH).
    - Разобраны детали SCD Type 2: `date_from`, `date_to`, `is_active`, аккуратное закрытие старой строки и вставка новой с обновлёнными полями.
2. **Домашнее задание (примерное)**
    
    - Авторы предлагают **повторить** все эти шаги на примере собственного проекта или тестовой базы, настроить такие же процедуры и убедиться, что изменения в `film` (название, рейтинг, `rental_rate` и др.) приводят к появлению новых строк в измерении.
    - Возможно, по желанию, можно добавить историчность ещё к одному измерению (например, `staff`), чтобы потренироваться.
3. **Практическая ценность**
    
    - Эта техника часто нужна, когда бизнес хочет видеть **ретроспективные** отчёты: «какой параметр был действительно действителен в момент события (аренды)?».
    - СCD Type 2 — относительно распространённый подход, и понимание его тонкостей (особенно, как корректно разделять периоды, работать с несколькими источниками и поддерживать последовательность обновлений) крайне важно для архитектора DWH и разработчика ETL.

---

### 10.4 Итоговые рекомендации

- **Вести учёт историчности** только там, где изменения реально влияют на аналитику.
- **Внимательно проектировать** схему: «звезда» упрощает использование, но усложняет ETL, тогда как «снежинка» (разделённая) может быть проще в обновлениях, но сложнее в аналитических запросах.
- **Следить за корректностью дат** (особенно если изменения происходят часто и timestamps могут совпадать).
- **Тестировать** на различных сценариях (смена фильма, смена цены, удаление диска, повторная активация и т.д.) и убедиться, что историчность отражена корректно без «дыр» и «перекрытий» во временных интервалах.

---

> **Резюме Часть 10**:
> 
> - После успешной настройки SCD Type 2 для `inventory` + `film`, обсуждают, как аналогично вести историчность в других измерениях (`staff`, `store`, адрес/город и т.д.)
> - Ответ зависит от **бизнес-потребностей**: не всегда нужно историть фамилии сотрудников или переименования улиц.
> - Завершается урок закреплением вывода: у нас теперь есть полноценная система хранения изменений (SCD Type 2) для полей `film`, и при необходимости те же принципы можно масштабировать на все остальные важные сущности.