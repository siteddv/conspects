### 1.1 Общая схема хранилища данных (DWH)

1. **Архитектура DWH**
    
    - Существуют таблицы фактов (например, `fact_rental`, `fact_payment`), отражающие операции по аренде и оплате.
    - Каждая факт-таблица имеет связь **один-ко-многим** с таблицей измерений `dim_inventory` через внешний ключ (`inventory_pk`), который ссылается на внутренний (суррогатный) ключ измерения.
2. **Измерение `inventory`**
    
    - Отвечает за учёт физических копий фильмов (компакт-диски).
    - Содержит:
        - Идентификатор в источнике (`inventory_id`),
        - Суррогатный ключ (`inventory_pk`) для DWH,
        - Поле для связи с фильмом (`film_id`),
        - Дополнительные поля, заимствованные из таблицы `film` (например, `title`, `rental_duration` и т.п.),
        - Метаданные для SCD Type 2: даты начала и конца актуальности (`date_from`, `date_to`), флаг `is_active`.
3. **Роль таблицы `film`**
    
    - Содержит описание фильма: название, рейтинг, год выпуска, время аренды и др.
    - Логика в DWH предполагает, что часть полей из `film` «де-нормализуется» и переносится напрямую в `dim_inventory`, чтобы аналитикам было удобнее работать по схеме «звезда».

---

### 1.2 Историчность данных (SCD Type 2)

1. **Зачем нужна историчность**
    - **SCD Type 2 (Slowly Changing Dimensions)** позволяет хранить не только текущее состояние измерения, но и всю историю изменений.
    - История важна, когда нужно анализировать факты (например, аренды) в разрезе тех значений, которые были действительны **на момент события**.
2. **Техника реализации**
    - Добавляются поля `date_from` и `date_to`:
        - `date_from` указывает, с какого момента строка является «актуальной»,
        - `date_to` определяет момент, когда она перестаёт быть актуальной (или ставится очень «далёкая» дата, если изменения пока не было).
    - Применяется **суррогатный ключ** (`inventory_pk`), чтобы разные «версии» одной и той же сущности (одного `inventory_id`) могли храниться в нескольких строках с разными периодами активности.
    - Когда данные в источнике меняются (например, меняется `film_id` у `inventory`), старая строка «закрывается» (`date_to` = дата изменения, `is_active = false`), а новая строка вставляется с обновлёнными значениями.

---

### 1.3 Постановка задачи

1. **Расширение области историчности**
    
    - На момент обсуждения историчность уже реализована **только** на уровне связки «компакт-диск → фильм», т.е. при смене `film_id` у одного и того же `inventory_id`.
    - **Новая цель**: учитывать и изменения **самого** фильма (таблица `film`), например, если меняется название, рейтинг, длительность аренды и т.д.
2. **Зачем это нужно**
    
    - Чтобы для отчётов по аренде (и дальнейших метрик) было ясно, какие именно характеристики у фильма были в момент сдачи в прокат.
    - Без этой историчности можно потерять важные данные (например, сколько раз брали фильм под старым рейтингом vs под новым).
3. **Подход к решению**
    
    - Нужно дополнить загрузочный процесс:
        - Ранее DWH обновлялся, реагируя только на изменения **в самой таблице `inventory`** (смена диска или его удаление).
        - Теперь требуется «подсматривать» ещё и в `film`, фиксируя любые существенные изменения.
        - Если параметр фильма изменился, в `dim_inventory` должна появиться **новая строка** (новая версия), отражающая эти изменения.
4. **Вывод**
    
    - Для **корректного учёта** аренды (и других фактов) важно не потерять изменения характеристик фильма.
    - Задача на урок: **продумать** и **реализовать** логику SCD Type 2, учитывающую, что «историческое измерение» теперь обновляется и при изменениях внутри `film`.

---

> **Резюме Часть 1:**
> 
> 1. В хранилище (DWH) уже сделана историческая таблица `dim_inventory`, которая фиксирует, что на каком диске и когда было.
> 2. Требуется расширить историчность так, чтобы и **характеристики** фильма (например, `title`, `rental_duration`, `rental_rate`) тоже правильно отображались в разрезе времени.
> 3. Ключевой вызов — **синхронно** обрабатывать изменения и в `inventory`, и в `film`, чтобы не терять логику.

Это завершает конспект **Части 1**. В последующих сегментах рассматриваются вопросы: какие поля у фильма действительно критичны для исторического учёта, как обрабатывать параллельные изменения, как избежать «сложных» ситуаций при одновременной смене фильма на диске и смене характеристик фильма и т.д.