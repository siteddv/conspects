Рассматриваемые распределенные системы — это системы без разделения ресурсов (shared-nothing), где каждая машина имеет свою оперативную память и жесткий диск, а связь между ними осуществляется только через сеть. Такая архитектура широко используется в интернет-сервисах из-за своей дешевизны, отсутствия необходимости в специальном аппаратном обеспечении и возможностях облачных сервисов. Кроме того, она обеспечивает высокую надежность благодаря географической избыточности в ЦОДах. Интернет и внутренние сети ЦОДов (например, Ethernet) работают на основе асинхронных сетей пакетной передачи данных, где не гарантируется доставка сообщений. Это создает ряд проблем: запрос может быть потерян, задержан из-за перегрузки сети, или удаленный узел может временно выйти из строя. Также может случиться, что запрос обработан, но ответ потеряется при передаче. В асинхронных сетях трудно определить, почему не был получен ответ: был ли потерян запрос, не функционирует ли узел или задержан ответ. Для решения таких проблем часто устанавливается время ожидания, по истечении которого запрос считается не полученным, но все равно остается неизвестным, был ли он доставлен или не обработан.

### Сетевые сбои на практике

Компьютерные сети, несмотря на многолетний опыт их разработки, продолжают сталкиваться с проблемами, даже в контролируемых условиях. В одном из исследований в ЦОДе было зафиксировано около 12 сбоев в месяц, что включает как отключение отдельных машин, так и целых стоек. Избыточность оборудования не всегда помогает избежать сбоев, поскольку человеческий фактор, например ошибки в настройке, остаётся главной причиной перебоев. Также часто происходят кратковременные сбои в облачных сервисах, таких как EC2. Нарушения связности сети могут привести к серьезным последствиям, таким как блокировки в кластерах или потеря данных. Поэтому важно, чтобы приложения умели справляться с сетевыми сбоями, и было проведено тестирование их реакций на такие проблемы, например, с помощью утилиты Chaos Monkey.

### Обнаружение сбоев

Автоматическое обнаружение сбойных узлов необходимо в разных системах. Например, балансировщик нагрузки должен прекратить отправлять запросы на неработающие узлы, а в распределенных базах данных при сбое ведущего узла его заменяет ведомый. Однако из-за неопределенности сети сложно точно определить состояние узла.

Если машина доступна, но процесс не слушает целевой порт, ОС может закрыть TCP-соединение. В случае сбоя узла во время запроса невозможно определить, сколько данных было обработано.

Если узел сбойнул, но его ОС работает, можно оповестить другие узлы для переноса нагрузки. В некоторых случаях, например, в ЦОДах, доступ к коммутаторам позволяет узнать о сбоях сетевых подключений.

Также маршрутизаторы могут сообщить о недоступности IP через ICMP-пакет "Адресат недоступен". Однако, даже при успешной доставке TCP-пакетов приложение может не обработать запрос. В таких случаях можно повторить запрос несколько раз или ожидать истечения времени ожидания.

### Время ожидания и неограниченные задержки

Ограничение времени ожидания является одним из способов обнаружения сбоев в распределённых системах, однако выбор его длительности не имеет универсального решения. Если время ожидания слишком долгое, пользователи будут долго ждать, прежде чем система объявит узел неработающим. Если же оно слишком короткое, можно ошибочно определить узел как вышедший из строя, хотя он лишь временно замедлил работу (например, из-за перегрузки).

Ошибочное объявление узла неработающим может привести к проблемам, например, дублированию выполнения задач. Передача обязанностей узла другим узлам увеличивает нагрузку и может ухудшить ситуацию, особенно в случае перегрузки системы. В худшем случае это может вызвать каскадный сбой, при котором все узлы станут неработающими.

В идеальных условиях, например, в системе с гарантированной задержкой пакетов и временем обработки запросов, можно определить оптимальное время ожидания, равное 2d + r, где d — максимальная задержка пакета, а r — время обработки запроса. Однако в реальных условиях асинхронных сетей и не гарантированного времени отклика серверов задержки могут варьироваться, что усложняет выбор времени ожидания.

Перегрузка сети, очереди и виртуализация также влияют на задержки. Например, при высокой нагрузке на сеть пакеты могут ожидать в очереди, а в виртуализированных средах задержки еще более непредсказуемы. TCP использует управление потоком, что помогает избежать перегрузки, но также может увеличивать задержки из-за повторной отправки потерянных пакетов.

![[48. Network timeout.png]]

Для чувствительных к задержке приложений, таких как видеоконференции, используется UDP, который не повторяет отправку потерянных пакетов, снижая вариативность задержек. Однако при этом данные, которые запоздали, теряют свою ценность, что делает UDP более подходящим для таких случаев.

В условиях общего облака или многопользовательских ЦОДов ресурсы могут использоваться несколькими потребителями, что также увеличивает вариативность задержек. В таких средах оптимальное время ожидания подбирается экспериментально, анализируя распределение задержек и используя адаптивные методы, такие как Phi Accrual, для подстройки времени ожидания в зависимости от текущей ситуации.

### Асинхронные и синхронные сети

Гарантировать доставку пакетов с фиксированной задержкой без потерь в распределённых системах невозможно из-за особенностей работы современных сетей. Для сравнения, в телефонных сетях используется коммутация каналов, где каждому вызову выделяется фиксированная полоса пропускания на весь путь, что исключает очереди и гарантирует ограниченную задержку. Это идеально подходит для приложений, как голосовые вызовы, где стабильная скорость передачи данных критична.

Однако в сетях, использующих коммутацию пакетов (Ethernet, IP), таких как Интернет, передача данных зависит от текущей загрузки сети, что приводит к очередям и непредсказуемым задержкам. TCP-протокол динамически регулирует скорость передачи данных в зависимости от состояния сети, что эффективно для трафика с переменной нагрузкой, как передача файлов или веб-запросов.

Для трафика с постоянной нагрузкой, как в аудио- или видеозвонках, подход с коммутацией каналов подходит лучше, но для переменной нагрузки этот способ неэффективен, так как невозможно точно предсказать нужную полосу пропускания. Современные сети оптимизированы для динамического разделения ресурсов, что позволяет эффективно использовать полосы пропускания, но это ведет к образованию очередей и изменчивым задержкам.

Гибридные решения, такие как ATM и InfiniBand, пытаются объединить лучшие стороны обоих подходов, однако проблемы с перегрузками остаются. QoS помогает улучшить ситуацию, но не решает всех проблем в мультиарендных облаках и общедоступных ЦОДах, где задержки и потери пакетов остаются трудно предсказуемыми.