Транзакции поддерживаются как реляционными, так и некоторыми нереляционными СУБД. Ранние реляционные системы (например, System R) заложили основу транзакций, которая сохраняется и сегодня. В NoSQL базах транзакции ослаблены или отсутствуют, что связано с масштабируемостью. Однако мнение, что транзакции всегда мешают производительности, и что они обязательны для «ценных данных», преувеличены. Транзакции имеют свои плюсы и минусы.

### Смысл аббревиатуры ACID

Транзакции описываются аббревиатурой ACID (атомарность, согласованность, изоляция, сохраняемость), предложенной в 1983 году для обеспечения отказоустойчивости. Однако реализации ACID могут различаться, и термин стал маркетинговым. Системы, не соответствующие ACID, называют BASE, что часто означает «не ACID» и имеет расплывчатое значение.

### Атомарность

Атомарность в контексте ACID означает, что транзакция выполняется как единое целое: либо все изменения выполняются, либо при сбое они откатываются. Это предотвращает частичное выполнение операций и ошибки, такие как дублирование данных. Если транзакция не может быть завершена из-за ошибки, все её изменения отменяются. Атомарность позволяет избежать недоразумений при повторном выполнении транзакции, гарантируя, что ничего не было изменено, и изменения можно безопасно повторить.

### Согласованность

Слово «согласованность» имеет несколько значений. В контексте ACID оно означает, что данные в базе должны оставаться в допустимом состоянии, соответствующем определённым инвариантам (например, сбалансированные счета в бухгалтерии). Однако это зависит от приложения, которое формулирует и контролирует инварианты, а база данных лишь хранит данные. База не может гарантировать соблюдение этих инвариантов, только проверять их с помощью ограничений. Следовательно, согласованность в ACID — это свойство приложения, а не базы данных.

### Изоляция

Когда несколько клиентов одновременно обращаются к базе данных, может возникнуть проблема конкурентного доступа, например, при увеличении счетчика. Если два клиента одновременно читают и записывают одно и то же значение, это может привести к состоянию гонки, где результат окажется неправильным (например, счетчик увеличится на 1, а не на 2). Изоляция в контексте ACID гарантирует, что транзакции не мешают друг другу, и результат их выполнения будет таким, как если бы они выполнялись последовательно. Однако, изоляция сериализуемости, которая предоставляет наибольшую защиту, редко используется из-за проблем с производительностью. Вместо этого в некоторых СУБД, таких как Oracle, используется более слабая изоляция снимков состояния.

### Сохраняемость

Сохраняемость (durability) в СУБД — это гарантия того, что данные, записанные и успешно зафиксированные в транзакции, не будут потеряны, даже при сбое системы или аппаратного обеспечения. В одноузловых БД сохраняемость часто означает запись данных на энергонезависимый носитель, например, на жесткий диск или SSD, с использованием журнала упреждающей записи для восстановления в случае повреждения данных. В реплицируемых БД сохраняемость предполагает, что данные успешно скопированы на несколько узлов, и база ждет завершения этих операций записи или репликации перед фиксацией транзакции.

Однако абсолютная надежность невозможна. В случае полного уничтожения носителей или резервных копий БД не сможет гарантировать восстановление данных. Проблемы могут возникать и при использовании разных методов сохраняемости:

- Запись на диск защищает от поломки компьютера, но не спасает от сбоя системы, если все данные находятся только в оперативной памяти.
- Репликация может быть подвержена коррелированным сбоям, например, отключению питания, которое выведет из строя все реплики.
- В асинхронной репликации могут потеряться последние записи при внезапной недоступности ведущего узла.
- SSD могут нарушать ожидаемые гарантии, например, при отключении питания, и данные могут портиться даже на исправных дисках.

На практике для обеспечения надежности используются комбинированные методы, такие как запись на диск, репликация и резервные копии. Однако абсолютных гарантий в защите данных не существует, и к таким "гарантиям" следует относиться с осторожностью.

### Однообъектные и многообъектные операции

В ACID концепции атомарности и изоляции описывают действия базы данных при выполнении клиентом нескольких операций записи в одной транзакции:

* Атомарность: Если в процессе выполнения транзакции возникает ошибка, все предыдущие операции отменяются. Это гарантирует принцип «все или ничего», что защищает от частичных отказов и несогласованности данных.

* Изоляция: Конкурентные транзакции не должны влиять друг на друга. Если одна транзакция изменяет несколько данных, другая транзакция должна видеть либо все изменения, либо никакие, исключая промежуточные состояния. Это предотвращает такие проблемы, как несоответствие счетчиков и почтовых сообщений в приложении.

Пример из электронной почты иллюстрирует, как нарушение изоляции может привести к несоответствию между количеством непрочитанных сообщений и счетчиком. Атомарность же гарантирует, что при ошибке в одной части транзакции все изменения будут откатаны.

В реляционных базах данных транзакции отслеживаются через соединение между клиентом и сервером (между операторами BEGIN TRANSACTION и COMMIT). Однако многие нереляционные БД, даже с многообъектными операциями, не обеспечивают транзакционность, что может привести к частичному обновлению данных, оставляя базу в несогласованном состоянии.

### Однообъектные операции записи

Атомарность и изоляция важны даже при обновлении одного объекта, например, при записи большого JSON-документа в базу данных. Проблемы могут возникнуть при разрыве сетевого соединения, сбое питания или при параллельном доступе другого клиента к частично обновленному документу. В таких случаях важно обеспечить атомарность и изоляцию, чтобы избежать записи частично обновленных данных или смешивания старого и нового содержимого.

Для решения этих проблем базы данных используют механизмы журналирования для восстановления после сбоев и блокировки объектов для обеспечения изоляции. Это гарантирует, что данные будут либо полностью записаны, либо не записаны вовсе, без промежуточных состояний. Также многие базы данных поддерживают сложные атомарные операции, такие как атомарный инкремент или сравнение с обменом, которые предотвращают потерю обновлений при конкурентных записях в один объект. Однако такие операции не являются полноценными транзакциями в традиционном понимании, поскольку они затрагивают только один объект, а не группу операций.

### Востребованность многообъектных транзакций

