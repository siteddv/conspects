Перебалансировка в базе данных — процесс перемещения нагрузки (данных, запросов) между узлами кластера для оптимизации работы системы. С ростом количества запросов и объема данных требуется добавление процессоров, дисков и памяти. Перебалансировка должна обеспечить равномерное распределение нагрузки, минимизировать перебои в работе базы данных и уменьшить затраты на ввод/вывод. Процесс должен быть быстрым, с минимальными переносами данных между узлами.

### Методики перебалансировки

Существует несколько различных способов распределения секций по узлам.
Обсудим вкратце их все по очереди.

### Как делать не следует: хеширование по модулю N

При секционировании по хешу использование оператора mod может привести к частым перемещениям данных при изменении количества узлов. Например, при переходе от 10 узлов к 11 или 12 ключи могут переместиться в другие узлы, что делает перебалансировку затратной. Вместо простого mod предложено использовать разбивку хешей на диапазоны, где каждый диапазон соответствует своей секции. Это уменьшает количество перемещаемых данных при изменении числа узлов и упрощает перебалансировку.

### Фиксированное количество секций

Для эффективной перебалансировки в распределенной базе данных рекомендуется создать значительно больше секций, чем узлов. Например, в кластере из 10 узлов можно создать 1000 секций, по 100 секций на узел. При добавлении нового узла он может "позаимствовать" несколько секций у каждого из существующих узлов до тех пор, пока распределение не станет равномерным. Секции перемещаются целиком, при этом количество данных и соответствие ключей секциям не изменяется, только их распределение по узлам. Этот процесс может занимать время, и во время перемещения используется старое распределение. 

![[39. Rebalancing sections.png]]

Система может учитывать производительность узлов, распределяя больше секций на более мощные узлы. Количество секций фиксируется при первоначальной настройке базы данных и обычно не меняется. Правильный выбор количества секций важен, так как слишком большое их количество увеличивает накладные расходы на управление, а слишком малое — приводит к дополнительным расходам. Идеальный размер секций зависит от изменений в объеме данных, поскольку большие секции требуют больше ресурсов для перебалансировки, а маленькие — увеличивают накладные расходы.

### Динамическое секционирование

Динамическое секционирование используется для оптимального распределения данных в базе, когда фиксированное количество секций с жесткими границами неудобно. В таких СУБД, как HBase и RethinkDB, секции создаются и перераспределяются автоматически. Когда секция достигает заданного размера (например, 10 Гбайт в HBase), она разбивается на две, и наоборот, при уменьшении данных секция может быть объединена с соседней. Эти операции помогают поддерживать баланс нагрузки и предотвращают перегрузку узлов. Динамическое секционирование адаптируется к объему данных, минимизируя накладные расходы при малом объеме и обеспечивая балансировку при большом. Однако, при начальной настройке БД, пока она пустая, все данные обрабатываются одним узлом. Чтобы уменьшить простои, HBase и MongoDB позволяют задавать начальный набор секций для пустой БД, что называется предварительным разбиением (pre-splitting). Для динамического секционирования важно правильно предсказать распределение ключей. Такой подход эффективен как для секционирования по диапазонам значений, так и для хеш-секционирования.

### Секционирование пропорционально количеству узлов

При динамическом секционировании количество секций зависит от объема данных, поскольку секции разбиваются и сливаются для поддержания заданных размеров. В случае фиксированного количества секций размер каждой секции пропорционален размеру данных. В СУБД, таких как Cassandra и Ketama, количество секций пропорционально количеству узлов, при этом размер секций изменяется с увеличением объема данных, но остается стабильным при увеличении узлов. При добавлении нового узла происходит случайное разбиение существующих секций, и новый узел забирает равную долю нагрузки. Это требует использования хеш-секционирования для выбора границ секций. Такой подход основывается на принципах согласованного хеширования, что помогает сбалансировать нагрузку между узлами, минимизируя избыточность метаданных. В Cassandra 3.0 был внедрен новый алгоритм перебалансировки, позволяющий избежать неравных разбиений.

### Эксплуатация: автоматическая или ручная перебалансировка

