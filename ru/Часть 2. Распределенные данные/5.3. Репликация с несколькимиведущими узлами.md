Глава посвящена альтернативам архитектуры репликации с одним ведущим узлом, которая имеет недостаток: все операции записи зависят от единственного узла, что создает риски при его недоступности. Решением является схема репликации с несколькими ведущими узлами (multi-leader replication), где несколько узлов могут обрабатывать записи и обмениваться изменениями. Эта модель, известная как «главный — главный» или «активный/активный», обеспечивает большую доступность и устойчивость системы, позволяя каждому узлу быть как ведущим, так и ведомым.

### Сценарии использования репликации с несколькими ведущими узлами

Репликация с несколькими ведущими узлами в одном ЦОД редко оправдана из-за усложнений, но в некоторых случаях может быть целесообразной.

### Эксплуатация с несколькими ЦОДами

В главе рассматривается архитектура репликации баз данных с несколькими ведущими узлами в разных ЦОДах для повышения устойчивости к сбоям и улучшения производительности. В обычной схеме с одним ведущим узлом все записи проходят через один ЦОД, что может замедлять операции из-за сетевых задержек. В схеме с несколькими ведущими узлами каждый ЦОД имеет своего ведущего узла, что позволяет обрабатывать записи локально и асинхронно реплицировать изменения в другие ЦОДы, минимизируя задержки.

Преимущества схемы с несколькими ведущими узлами включают независимость ЦОДов при сбоях, устойчивость к сетевым проблемам и улучшение субъективной производительности. Однако существуют и недостатки, такие как возможность возникновения конфликтов записи, когда данные модифицируются одновременно в разных ЦОДах, что требует разрешения конфликтов. Эта схема может также столкнуться с проблемами настройки и взаимодействия с другими функциями баз данных, поэтому её использование следует тщательно обдумывать.

![[27. Multi-master replication.png]]

### Офлайн-клиенты

Репликация с несколькими ведущими узлами также подходит для приложений, которые должны функционировать без постоянного подключения к Интернету. Примером могут служить приложения-календари на мобильных устройствах, где пользователи могут просматривать и добавлять события независимо от наличия соединения. В этом случае каждое устройство имеет локальную базу данных, принимающую запросы на запись, и происходит асинхронная репликация между устройствами при следующем подключении к сети.

Задержка репликации может варьироваться от часов до дней, в зависимости от доступа к Интернету. Эта архитектура по сути является расширением схемы с несколькими ведущими узлами, где каждое устройство выступает в роли "ЦОДа" с ненадежным соединением. Реализация такой схемы может быть сложной, как показывает практика неудачных попыток синхронизации календарей. Для упрощения этого процесса существуют специализированные инструменты, такие как СУБД CouchDB.

### Совместное редактирование

Приложения для совместного редактирования, такие как Etherpad и Google Docs, позволяют нескольким пользователям одновременно работать над документом. Изменения мгновенно применяются к локальной версии документа и асинхронно реплицируются на сервер и другим пользователям. Хотя совместное редактирование не считается задачей репликации баз данных, оно схоже с офлайн-редактированием.

Для предотвращения конфликтов редактирования приложение может блокировать документ перед его изменением. В этом случае другие пользователи должны подождать, пока первый завершит редактирование. Это соответствует модели с одним ведущим узлом. Однако для повышения скорости совместной работы следует уменьшить размер блоков изменений, что позволяет нескольким пользователям редактировать одновременно, но при этом возникают проблемы, связанные с репликацией и необходимостью разрешения конфликтов.

### Обработка конфликтов записи

Основная проблема репликации с несколькими ведущими узлами — конфликты записи. Например, если два пользователя одновременно изменяют название страницы «Википедии» на разные значения, возникает конфликт при асинхронной репликации, чего не случилось бы при репликации с одним ведущим узлом.

![[28. Replication conflict example.png]]

### Асинхронное и синхронное обнаружение конфликтов

В базе данных с одним ведущим узлом операции записи блокируются до завершения предыдущих или требуют повторного выполнения. В схеме с несколькими ведущими узлами обе операции успешно завершаются, но конфликты могут быть обнаружены позднее, что затрудняет их разрешение для пользователей. Синхронное обнаружение конфликтов, при котором репликация операций ожидает завершения на всех узлах, уничтожает главное преимущество этой схемы — независимую обработку операций. В этом случае лучше использовать модель с одним ведущим узлом.

### Предотвращение конфликтов

