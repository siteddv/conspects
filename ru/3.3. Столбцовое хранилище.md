Хранение и выполнение запросов в складах данных с триллионами строк и петабайтами данных представляет собой сложную задачу. Таблицы фактов, которые могут содержать более 100 столбцов, часто запрашиваются по нескольким из них (обычно 4-5). Например, запрос может обращаться к столбцам, содержащим дату, товар и количество, игнорируя остальные.

В традиционных OLTP системах данные хранятся построчно, что затрудняет выборку необходимых столбцов, поскольку необходимо загружать и обрабатывать все строки, даже если требуется лишь часть атрибутов. Чтобы оптимизировать запросы, используются индексы, однако это все равно может быть медленным процессом.

Столбцовые хранилища предлагают решение: данные хранятся по столбцам, что позволяет читать только необходимые столбцы. Это значительно ускоряет выполнение запросов. Например, в столбцовом формате Parquet данные организованы так, что каждый столбец хранится отдельно, позволяя эффективно собирать строки из соответствующих значений.

### Сжатие столбцов

Для повышения эффективности работы с данными в складах данных применяются методы сжатия, что особенно важно при использовании столбцовых хранилищ. Столбцы часто содержат много повторяющихся значений, что делает их хорошими кандидатами для сжатия. Одним из эффективных методов сжатия является кодирование с помощью битовой карты, где для каждого уникального значения создается битовая карта, показывающая наличие этого значения в каждой строке. Такой подход особенно полезен при выполнении запросов, основанных на нескольких значениях.

Например, запросы, использующие конструкцию WHERE product_sk IN (...), могут эффективно обрабатывать битовые карты, используя поразрядное ИЛИ. Аналогично, запросы с условием AND могут использовать поразрядное И для фильтрации данных.

Также важным аспектом является пропускная способность, поскольку выполнение запросов может ограничиваться скоростью передачи данных с диска в память. Для решения этой проблемы векторизованная обработка позволяет более эффективно использовать циклы CPU, обрабатывая данные в непрерывных циклах без вызовов функций. Это особенно эффективно в комбинации с сжатыми столбцовыми данными, что позволяет разместить больше строк в кэше и ускорить обработку.