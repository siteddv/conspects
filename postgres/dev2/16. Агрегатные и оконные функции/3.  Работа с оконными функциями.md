### Часть 3: Работа с оконными функциями (12:00 - 18:00)

#### Отличия оконных функций от агрегатных
- **Основное отличие**:
  - Агрегатные функции "схлопывают" множество строк в одну, возвращая одно значение.
  - Оконные функции вычисляют значения для каждой строки, не изменяя количество строк в результате.

- **Синтаксис оконных функций**:
  - Для использования оконной функции добавляется ключевое слово `OVER` после вызова функции.
  - В скобках после `OVER` можно указать рамки (`frame`), внутри которых будет выполняться вычисление.

#### Механизм работы оконных функций
- **Простой случай**:
  - Если указано просто `OVER ()`, то рамка охватывает всю выборку.
  - Например, для таблицы из пяти строк среднее значение будет одинаковым для всех строк.

- **Использование конструкции PARTITION BY**:
  - Аналогично `GROUP BY`, но строки не объединяются.
  - Функция вычисляется отдельно для каждой группы, но все строки остаются в результате.

#### Примеры использования различных рамок и конструкций
- **Базовый пример**:
  - Созданная ранее функция `my_avg` работает как оконная без дополнительных изменений.
  - Пример использования:
    ```sql
    SELECT numbers, my_avg(numbers) OVER () FROM test;
    ```
    Результат: среднее значение 3 для всех строк.

- **Использование PARTITION BY**:
  - Вычисление среднего значения для каждой группы:
    ```sql
    SELECT numbers, group_field, my_avg(numbers) OVER (PARTITION BY group_field) FROM test;
    ```
    Результат:
    - Группа 'a': среднее значение = 1.5
    - Группа 'b': среднее значение = 4

- **Изменяющиеся рамки**:
  - Можно задавать рамки, которые меняются от строки к строке.
  - Например, использование `ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW`:
    - Рамка начинается от первой строки и до текущей строки.
    - Первая строка: среднее = 1
    - Вторая строка: среднее = 1.5
    - Третья строка: среднее = 2
    - И так далее...

- **Реализация скользящих средних**:
  - Можно задать рамку, которая включает фиксированное количество предыдущих строк.
  - Например, `ROWS BETWEEN 2 PRECEDING AND CURRENT ROW`:
    - Рамка включает текущую строку и две предыдущие.
    - Это используется для расчета скользящих средних.

#### Особенности реализации
- **Оптимизация вычислений**:
  - При простых рамках система может использовать уже вычисленное значение.
  - При сложных рамках требуется повторное вычисление для каждой строки.

---

Это завершает третью часть конспекта. Хотите перейти к четвертой части?