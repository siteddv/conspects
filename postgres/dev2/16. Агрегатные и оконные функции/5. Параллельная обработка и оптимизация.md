### Часть 5: Параллельная обработка и оптимизация (24:00 - 28:00)

#### Механизмы параллельной обработки
- **Параллельные запросы**:
  - Встроенные агрегатные функции могут вычисляться в параллельных запросах.
  - Это позволяет ускорить обработку больших объемов данных за счет распределения нагрузки между несколькими процессами.

- **Частичная агрегация**:
  - Представьте, что у вас есть несколько параллельных процессов, каждый из которых вычисляет частичную агрегацию на основе своей части данных.
  - В результате получается несколько состояний, которые нужно объединить для получения окончательного результата.

#### Создание функций объединения состояний
- **Необходимость функции объединения**:
  - Для работы с параллельными процессами нужна специальная функция, которая сможет объединить два состояния.
  - Эта функция принимает два состояния и возвращает объединенное состояние.

- **Реализация функции объединения**:
  - Функция `avg_combine` объединяет два состояния, суммируя аккумуляторы и количества:
    ```sql
    CREATE OR REPLACE FUNCTION avg_combine(avg_state, avg_state) RETURNS avg_state AS $$
    BEGIN
        RETURN (state1.accumulator + state2.accumulator, state1.count + state2.count);
    END;
    $$ LANGUAGE plpgsql;
    ```

- **Обновление агрегатной функции**:
  - Для использования параллельной обработки необходимо обновить определение агрегатной функции:
    ```sql
    CREATE AGGREGATE my_avg(INT) (
        SFUNC = avg_transition,
        STYPE = avg_state,
        INITCOND = '(0, 0)',
        FINALFUNC = avg_final,
        COMBINEFUNC = avg_combine,
        PARALLEL = SAFE
    );
    ```

#### Практические примеры оптимизации
- **Создание большой таблицы**:
  - Для демонстрации создается большая таблица с миллионом случайных чисел:
    ```sql
    CREATE TABLE big_test(numbers INT);
    INSERT INTO big_test SELECT random() * 100 FROM generate_series(1, 1000000);
    ```

- **План выполнения запроса**:
  - При использовании стандартной функции `SUM` видно, что запрос выполняется параллельно:
    - Параллельное сканирование таблицы.
    - Частичная агрегация в нескольких процессах.
    - Объединение результатов в одном узле.

- **План выполнения пользовательской функции**:
  - Без функции объединения пользовательская функция работает последовательно.
  - После добавления функции объединения пользовательская функция также может работать параллельно.

- **Пример выполнения**:
  - Выполняется запрос с использованием пользовательской функции:
    ```sql
    SELECT my_avg(numbers) FROM big_test;
    ```
  - Результат: среднее значение примерно равно 5.
  - Видно, что функция объединения вызывалась три раза:
    - Первый раз объединяла состояние с нулем.
    - Второй раз объединяла полученное состояние с другим состоянием.
    - В итоге получено окончательное значение.

#### Ограничения для оконных функций
- **Отсутствие параллельной обработки**:
  - Оконные функции не поддерживают параллельную обработку.
  - Это относится как к стандартным, так и к собственным оконным функциям.

---

Это завершает пятую часть конспекта. Хотите перейти к шестой части?