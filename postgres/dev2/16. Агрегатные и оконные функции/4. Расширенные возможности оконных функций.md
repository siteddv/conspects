### Часть 4: Расширенные возможности оконных функций (18:00 - 24:00)

#### Реализация скользящих средних
- **Скользящие средние**:
  - Это метод расчета среднего значения, который учитывает только фиксированное количество последних значений.
  - Пример использования: расчет среднего расхода топлива за последние несколько минут или километров.

- **Конструкция рамки**:
  - Для реализации скользящих средних используется конструкция `ROWS BETWEEN n PRECEDING AND CURRENT ROW`.
  - Например, `ROWS BETWEEN 2 PRECEDING AND CURRENT ROW` означает, что рамка включает текущую строку и две предыдущие.

- **Проблема с удалением значений**:
  - При использовании изменяющихся рамок возникает необходимость удалять значения из состояния.
  - Стандартная функция перехода не подходит, так как она только добавляет значения.

#### Создание функции инверсии
- **Функция инверсии**:
  - Для удаления значений из состояния создается специальная функция инверсии (`inverse function`).
  - Эта функция принимает текущее состояние и значение, которое нужно удалить, и возвращает новое состояние.

- **Реализация функции инверсии**:
  - Функция `avg_inverse` вычитает значение из аккумулятора и уменьшает счетчик:
    ```sql
    CREATE OR REPLACE FUNCTION avg_inverse(avg_state, INT) RETURNS avg_state AS $$
    BEGIN
        RETURN (state.accumulator - value, state.count - 1);
    END;
    $$ LANGUAGE plpgsql;
    ```

- **Обновление агрегатной функции**:
  - Для использования функции инверсии необходимо обновить определение агрегатной функции:
    ```sql
    CREATE AGGREGATE my_avg(INT) (
        SFUNC = avg_transition,
        STYPE = avg_state,
        INITCOND = '(0, 0)',
        FINALFUNC = avg_final,
        MINVFUNC = avg_inverse
    );
    ```

#### Особенности работы с изменяемыми рамками
- **Эффективность вычислений**:
  - При широких рамках может возникать много лишних вычислений.
  - Использование функции инверсии позволяет экономить ресурсы, так как не требуется пересчитывать все значения заново.

- **Пример работы**:
  - Первая строка: среднее = 1
  - Вторая строка: среднее = 1.5
  - Третья строка: среднее = 2
  - Четвертая строка: удаляется первое значение, добавляется четвертое, среднее = 3
  - И так далее...

---

Это завершает четвертую часть конспекта. Хотите перейти к пятой части?