### **4. Преобразование типов данных**

#### Введение в преобразование типов
Преобразование типов данных — это ключевой аспект работы с серверными подпрограммами, особенно когда данные передаются между базой данных и языком программирования. В этом разделе мы подробно разберем, как происходит преобразование типов, какие проблемы могут возникнуть и как их решать.

---

#### Основные принципы преобразования типов
1. **Типы данных в базе данных**:
   - База данных имеет собственные типы данных (например, `integer`, `text`, `boolean`, `json`, массивы).
   - Эти типы данных могут не совпадать с типами данных в используемом языке программирования.

2. **Типы данных в языке программирования**:
   - Язык программирования также имеет свои типы данных (например, в Python: `int`, `str`, `bool`, `dict`, `list`).
   - При вызове функции на языке программирования база данных преобразует свои типы данных в типы, понятные языку.

3. **Двустороннее преобразование**:
   - Преобразование происходит дважды:
     - **На входе**: Типы данных базы данных преобразуются в типы данных языка.
     - **На выходе**: Результат выполнения функции преобразуется обратно в типы данных базы данных.

---

#### Пример: Преобразование типов в Python
4. **Создание функции**:
   - Создадим функцию на Python, которая принимает параметры различных типов и выводит их типы:
     ```sql
     CREATE OR REPLACE FUNCTION show_types(param1 integer, param2 text, param3 boolean)
     RETURNS void AS $$
         import plpy
         plpy.info(f"param1: {param1}, type: {type(param1)}")
         plpy.info(f"param2: {param2}, type: {type(param2)}")
         plpy.info(f"param3: {param3}, type: {type(param3)}")
     $$ LANGUAGE plpythonu;
     ```

5. **Вызов функции**:
   - Вызовем функцию с различными параметрами:
     ```sql
     SELECT show_types(42, 'hello', true);
     ```
   - Результат:
     ```
     INFO:  param1: 42, type: <class 'int'>
     INFO:  param2: hello, type: <class 'str'>
     INFO:  param3: True, type: <class 'bool'>
     ```

6. **Результат преобразования**:
   - `integer` → `int`
   - `text` → `str`
   - `boolean` → `bool`
   - Массивы (`integer[]`) → `list`

---

#### Проблемы с преобразованием JSON
7. **Проблема**:
   - Тип `json` в базе данных может некорректно преобразовываться в язык программирования.
   - Например, в Python JSON может интерпретироваться как строка (`str`), а не как словарь (`dict`).

8. **Пример**:
   - Создадим функцию, которая принимает и возвращает JSON:
     ```sql
     CREATE OR REPLACE FUNCTION process_json(data json)
     RETURNS json AS $$
         import plpy
         plpy.info(f"data: {data}, type: {type(data)}")
         return data
     $$ LANGUAGE plpythonu;
     ```
   - Вызовем функцию:
     ```sql
     SELECT process_json('{"key": "value"}');
     ```
   - Результат:
     ```
     INFO:  data: {"key": "value"}, type: <class 'str'>
     ```

9. **Причина**:
   - По умолчанию JSON преобразуется в строку, что делает его использование неудобным.

---

#### Решение: Добавление трансформации для JSON
10. **Трансформация типов**:
   - Начиная с определенной версии PostgreSQL (не раньше 10-й), появилась возможность добавлять пользовательские трансформации типов.
   - Трансформация позволяет указать, как именно преобразовывать типы данных.

11. **Добавление трансформации для JSON**:
   - Используем расширение `jsonb_plpythonu`:
     ```sql
     CREATE EXTENSION jsonb_plpythonu;
     ```
   - После этого можно указать трансформацию при создании функции:
     ```sql
     CREATE OR REPLACE FUNCTION process_json(data json)
     RETURNS json AS $$
         import plpy
         plpy.info(f"data: {data}, type: {type(data)}")
         return data
     $$ LANGUAGE plpythonu TRANSFORM FOR TYPE json;
     ```

12. **Результат**:
   - Теперь JSON корректно преобразуется в словарь (`dict`) в Python:
     ```
     INFO:  data: {'key': 'value'}, type: <class 'dict'>
     ```

---

#### Как работает трансформация?
13. **Механизм**:
   - Трансформация определяется через две функции:
     - **Функция для преобразования из базы данных в язык**.
     - **Функция для преобразования из языка в базу данных**.
   - Эти функции пишутся на языке C и регистрируются в базе данных.

14. **Пример команды**:
   - При создании трансформации используется команда:
     ```sql
     CREATE TRANSFORM FOR TYPE json LANGUAGE plpythonu (
         FROM SQL WITH FUNCTION json_to_python(json),
         TO SQL WITH FUNCTION python_to_json(dict)
     );
     ```

15. **Готовые решения**:
   - Для популярных языков (например, Python) уже существуют готовые трансформации, которые можно использовать.

---

#### Преобразование других типов данных
16. **Числа**:
   - `integer` → `int`
   - `numeric` → `Decimal` (в Python)

17. **Строки**:
   - `text` → `str`
   - `varchar` → `str`

18. **Массивы**:
   - `integer[]` → `list`
   - `text[]` → `list`

19. **JSON/JSONB**:
   - Без трансформации: `json` → `str`
   - С трансформацией: `json` → `dict`

20. **Композитные типы**:
   - Композитные типы (например, строки таблицы) могут преобразовываться в словари или объекты, в зависимости от языка.

---

#### Практический пример: Обработка JSON
21. **Без трансформации**:
   - Функция обрабатывает JSON как строку:
     ```sql
     CREATE OR REPLACE FUNCTION process_json(data json)
     RETURNS json AS $$
         import plpy
         plpy.info(f"data: {data}, type: {type(data)}")
         return data
     $$ LANGUAGE plpythonu;
     ```
   - Результат:
     ```
     INFO:  data: {"key": "value"}, type: <class 'str'>
     ```

22. **С трансформацией**:
   - Функция обрабатывает JSON как словарь:
     ```sql
     CREATE OR REPLACE FUNCTION process_json(data json)
     RETURNS json AS $$
         import plpy
         plpy.info(f"data: {data}, type: {type(data)}")
         return data
     $$ LANGUAGE plpythonu TRANSFORM FOR TYPE json;
     ```
   - Результат:
     ```
     INFO:  data: {'key': 'value'}, type: <class 'dict'>
     ```

---

#### Заключение раздела
Преобразование типов данных — это важный аспект работы с серверными подпрограммами. Правильное преобразование обеспечивает корректную обработку данных и минимизирует ошибки. В следующем разделе мы углубимся в тему интерфейсов взаимодействия языков с базой данных.