### **3. Подключение новых языков**

#### Введение в подключение языков
Подключение нового языка для написания серверных подпрограмм — это процесс, который требует выполнения определенных шагов и соблюдения технических требований. В этом разделе мы подробно разберем, как происходит подключение языков, какие компоненты необходимы и как они взаимодействуют с базой данных.

---

#### Требования для подключения нового языка
1. **Интерпретируемость**:
   - Язык должен быть интерпретируемым, то есть иметь интерпретатор, который может принимать текст программы и выполнять его.
   - Пример: Python, Perl, JavaScript.

2. **Наличие интерпретатора**:
   - Интерпретатор должен быть установлен в операционной системе, где работает база данных.
   - Например, для Python требуется установка интерпретатора Python в систему.

3. **Механизм расширений**:
   - Большинство языков подключаются через механизм расширений PostgreSQL (`CREATE EXTENSION`).
   - Расширение регистрирует язык в базе данных и определяет необходимые компоненты для его работы.

---

#### Компоненты для создания языка
Для успешного подключения нового языка необходимо определить три основных компонента:

4. **Обработчик (Handler)**:
   - Обработчик — это функция на языке C, которая отвечает за выполнение кода на подключенном языке.
   - При вызове функции обработчик получает текст функции и её параметры, передает их интерпретатору и возвращает результат.
   - Пример: Для Python используется специальный обработчик, который взаимодействует с интерпретатором Python.

5. **Валидатор (Validator)**:
   - Валидатор — это функция, которая выполняет статическую проверку кода при создании функции.
   - Если в коде есть ошибки (например, обращение к несуществующей таблице), валидатор выдает ошибку до выполнения функции.
   - Пример: В PL/pgSQL валидатор проверяет синтаксис SQL-запросов.

6. **Функция для анонимных блоков**:
   - Если язык поддерживает выполнение анонимных блоков (блоков кода без имени), необходимо определить функцию для их обработки.
   - Это необязательный компонент, но он расширяет возможности языка.

---

#### Пример подключения языка через `CREATE EXTENSION`
7. **Команда подключения**:
   - Для подключения языка используется команда:
     ```sql
     CREATE EXTENSION plpythonu;
     ```
   - Эта команда выполняет скрипт, который регистрирует язык в базе данных.

8. **Содержимое скрипта**:
   - Внутри скрипта выполняется команда `CREATE LANGUAGE`, которая указывает обработчик, валидатор и другие компоненты.
   - Пример:
     ```sql
     CREATE LANGUAGE plpythonu
     HANDLER plpython_call_handler
     VALIDATOR plpython_validator;
     ```

9. **Результат подключения**:
   - После выполнения команды язык становится доступным для написания функций.
   - Пример проверки доступных языков:
     ```sql
     SELECT * FROM pg_language;
     ```

---

#### Особенности подключения доверенных и недоверенных языков
10. **Доверенные языки**:
   - Для доверенных языков необходимо указать ключевое слово `TRUSTED` при создании.
   - Пример:
     ```sql
     CREATE TRUSTED LANGUAGE plperl;
     ```
   - Доверенные языки ограничены в своих возможностях и безопасны для использования.

11. **Недоверенные языки**:
   - Недоверенные языки создаются без ключевого слова `TRUSTED`.
   - Они предоставляют полный доступ к функционалу языка, но доступны только для суперпользователей.
   - Пример:
     ```sql
     CREATE LANGUAGE plpythonu;
     ```

---

#### Автоматизация подключения языков
12. **Шаблонная база данных**:
   - Если язык нужно автоматически подключать при создании новых баз данных, его можно добавить в шаблонную базу данных (`template1`).
   - Пример:
     ```sql
     CREATE EXTENSION plpythonu IN DATABASE template1;
     ```

13. **Клонирование базы данных**:
   - При клонировании базы данных (`CREATE DATABASE ... TEMPLATE`) язык автоматически копируется в новую базу.

---

#### Практический пример: Чтение файлов на Python
14. **На недоверенном языке**:
   - На недоверенном языке (например, `plpythonu`) можно написать функцию для чтения файлов:
     ```sql
     CREATE OR REPLACE FUNCTION read_file(filename text)
     RETURNS text AS $$
         with open(filename, 'r') as f:
             return f.read()
     $$ LANGUAGE plpythonu;
     ```
   - Эта функция читает содержимое файла и возвращает его в виде строки.

15. **На доверенном языке**:
   - Попытка выполнить аналогичную операцию на доверенном языке вызовет ошибку, так как доверенные языки не имеют доступа к файловой системе.

---

#### Ограничения некоторых языков
16. **PL/pgSQL**:
   - PL/pgSQL является процедурным языком и тесно интегрирован с PostgreSQL.
   - Он ограничен в своих возможностях и не поддерживает взаимодействие с внешними ресурсами.

17. **Python**:
   - Python поддерживается только в недоверенной версии (`plpythonu`).
   - Доверенная версия Python отсутствует, что делает его использование небезопасным по умолчанию.

18. **Perl**:
   - Для Perl существуют две версии: доверенная (`plperl`) и недоверенная (`plperlu`).

---

#### Заключение раздела
Подключение новых языков — это важный этап в разработке серверных подпрограмм. Каждый язык имеет свои особенности и ограничения, которые необходимо учитывать при выборе. В следующем разделе мы углубимся в тему преобразования типов данных между базой данных и языком программирования.