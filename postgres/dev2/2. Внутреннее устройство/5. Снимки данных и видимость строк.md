### Часть 5: Снимки данных и видимость строк

#### 5.1 Концепция снимков данных
- **Снимок данных** — это согласованная картина состояния базы данных на определенный момент времени.
- Снимок используется для определения, какие данные доступны для чтения в рамках текущей транзакции.
- Ось времени в PostgreSQL измеряется не в секундах или миллисекундах, а в номерах транзакций:
  - Каждая новая транзакция получает уникальный номер.
  - Чем больше номер транзакции, тем "позже" она была выполнена.

#### 5.2 Горизонт событий
- **Горизонт событий** — это граница, за которой находятся только завершенные (зафиксированные) транзакции.
- Горизонт событий существует как для отдельной транзакции, так и для всей базы данных.
- Для базы данных горизонт событий определяется минимальным значением `xmin` среди всех активных транзакций:
  - Все версии строк, созданные транзакциями с номерами меньше `xmin`, гарантированно зафиксированы и могут быть удалены при очистке.
  - Версии строк за горизонтом событий считаются устаревшими и подлежат вычищению.

#### 5.3 Правила видимости строк
- **Основные правила видимости**:
  - Версия строки видима, если:
    - Транзакция, создавшая строку (`xmin`), завершена и зафиксирована до момента создания снимка данных.
    - Транзакция, удалившая строку (`xmax`), еще не завершена или была отменена.
  - Если `xmin` и `xmax` относятся к одной и той же транзакции, то строка видима только внутри этой транзакции.

- **Исключения**:
  - Если курсор открыт для таблицы, то изменения, сделанные внутри транзакции после открытия курсора, не видны операциям извлечения данных из курсора.
  - Для таких случаев используются дополнительные служебные поля (`cmin` и `cmax`), которые помогают определить видимость изменений внутри транзакции.

#### 5.4 Уровни изоляции транзакций
- **READ COMMITTED**:
  - Снимок данных создается в начале каждого оператора.
  - Это означает, что между выполнением двух запросов в рамках одной транзакции данные могут измениться.
  - Возможна аномалия "неповторяемого чтения".

- **REPEATABLE READ** и **SERIALIZABLE**:
  - Снимок данных создается один раз — в начале первого оператора транзакции.
  - После этого снимок не меняется, и все последующие запросы видят одни и те же данные.
  - Это гарантирует согласованность данных в рамках транзакции.

#### 5.5 Пример работы снимков данных
- **Сценарий**:
  - В системе выполняются пять транзакций: 1, 2, 3, 4, 5.
  - Транзакции 1 и 3 завершены, транзакции 2 и 4 активны, транзакция 5 начнется после создания снимка.
  - Создается снимок данных на текущий момент времени.

- **Состав снимка**:
  - `xmax`: Номер следующей транзакции, которая будет выдана (например, 5).
  - Список активных транзакций: [2, 4].
  - `xmin`: Минимальный номер активной транзакции (в данном случае 2).

- **Правила видимости**:
  - Изменения транзакций с номерами меньше `xmin` (т.е. завершенные транзакции) всегда видны.
  - Изменения транзакций с номерами больше `xmax` (т.е. будущие транзакции) никогда не видны.
  - Изменения активных транзакций (из списка активных) видны только внутри этих транзакций.

#### 5.6 Практический пример
- Создана таблица `t` с двумя столбцами:
  - `id` (числовой).
  - `c` (строковый).
- Добавлена строка `(42, 'foo')`.
- Выполнено обновление строки: `(42, 'bar')`.
- Использовано расширение `pageinspect` для анализа:
  - В таблице видны две версии строки:
    - Первая версия: `xmin = 591`, `xmax = 592`.
    - Вторая версия: `xmin = 592`, `xmax = 0`.
  - В индексе остается только одна запись, указывающая на первую версию строки.

---

Это завершает пятую часть конспекта. Хотите продолжить с шестой частью?