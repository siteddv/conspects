### Часть 3: Журнал транзакций и механизм фиксации изменений

#### 3.1 Журнал транзакций (CLOG)
- **Структура журнала**:
  - Журнал транзакций (CLOG) — это специальная область общей памяти, где хранится статус каждой транзакции.
  - Каждая запись в журнале содержит два ключевых признака:
    - **Зафиксирована ли транзакция**.
    - **Отменена ли транзакция**.
  - Если транзакция еще выполняется, то в журнале ничего не указано напротив этих признаков.

- **Роль журнала**:
  - Журнал используется для определения статуса транзакции до момента её завершения.
  - Когда транзакция завершается (успешно или с ошибкой), соответствующие признаки проставляются в журнале.

#### 3.2 Процесс фиксации изменений
- **Что происходит при фиксации**:
  - При выполнении команды `COMMIT` изменения фиксируются в журнале транзакций, а не в самих данных таблицы или индекса.
  - В журнале проставляется признак, что транзакция была успешно зафиксирована.
  - Данные в таблице или индексе остаются без изменений.

- **Проверка статуса транзакции**:
  - Когда другая транзакция пытается прочитать строку, она проверяет статус транзакции через журнал транзакций.
  - Если транзакция была зафиксирована, читающая транзакция обновляет биты в заголовке строки, чтобы отметить это.
  - Это позволяет последующим транзакциям сразу видеть, что строка доступна, без необходимости обращаться к журналу транзакций.

#### 3.3 Оптимизация работы с журналом
- **Почему не обновляются данные сразу**:
  - Если бы PostgreSQL обновлял биты в заголовках строк сразу при фиксации транзакции, это могло бы привести к значительным накладным расходам.
  - Например, если транзакция добавила большое количество строк в разные таблицы, то при фиксации потребовалось бы пробежать по всем страницам и обновить заголовки строк.
  - Это сделало бы операцию `COMMIT` очень дорогой и медленной.

- **Роль читающих транзакций**:
  - Вместо этого задача обновления битов в заголовках строк перекладывается на следующую читающую транзакцию.
  - Читающая транзакция проверяет статус транзакции в журнале и, если транзакция была зафиксирована, обновляет биты в заголовке строки.
  - Это позволяет избежать массовых обновлений данных при фиксации транзакции.

#### 3.4 Массовая запись на диск
- **Эффект от работы читающих транзакций**:
  - Когда читающая транзакция обновляет биты в заголовке строки, она изменяет всю страницу в буферном кэше.
  - Это может привести к массовой записи измененных страниц на диск, даже если транзакция только читала данные.
  - Этот эффект важно учитывать при работе с большими объемами данных.

#### 3.5 Практический пример
- Создана таблица `t` с двумя столбцами:
  - `id` (числовой).
  - `c` (строковый).
- Добавлена строка `(42, 'foo')`.
- Выполнено обновление строки: `(42, 'bar')`.
- Использовано расширение `pageinspect` для анализа:
  - В таблице видны две версии строки:
    - Первая версия: `xmin = 591`, `xmax = 592`.
    - Вторая версия: `xmin = 592`, `xmax = 0`.
  - В индексе остается только одна запись, указывающая на первую версию строки.

---

Это завершает третью часть конспекта. Хотите продолжить с четвертой частью?