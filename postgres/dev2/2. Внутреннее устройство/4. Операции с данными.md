### Часть 4: Операции с данными

#### 4.1 Вставка новых строк
- **Процесс вставки**:
  - При выполнении команды `INSERT` новая строка добавляется в таблицу.
  - Одновременно создается соответствующая запись в индексе, если он существует.
  - В поле `xmin` новой строки записывается номер текущей транзакции.
  - Поле `xmax` устанавливается в значение `0`, так как строка еще не удалена или изменена.

- **Особенности вставки**:
  - Если в таблице есть индекс, то новая запись добавляется и в индекс.
  - Индексная строка содержит:
    - Индексируемое значение (например, значение столбца, по которому создан индекс).
    - Указатель на соответствующую строку в таблице.

#### 4.2 Удаление строк
- **Процесс удаления**:
  - При выполнении команды `DELETE` текущая транзакция записывает свой номер в поле `xmax` строки.
  - Например, если транзакция с номером `101` удаляет строку, то `xmax = 101`.
  - До момента фиксации (`COMMIT`) строка считается заблокированной, так как её статус еще не определен.

- **Блокировка строк**:
  - Если другая транзакция попытается изменить или удалить ту же строку, она увидит, что поле `xmax` уже занято номером активной транзакции.
  - Это предотвращает конфликты и обеспечивает целостность данных.

#### 4.3 Обновление строк
- **Обычное обновление**:
  - При выполнении команды `UPDATE` создается новая версия строки, а старая версия помечается как удаленная.
  - В поле `xmax` старой версии записывается номер транзакции, выполнившей обновление.
  - Новая версия строки получает значение `xmin`, равное номеру транзакции, выполнившей обновление.

- **Оптимизация "HOT-обновления"**:
  - Если обновление не затрагивает индексируемые столбцы, PostgreSQL использует оптимизацию, называемую **HOT-обновление** (Heap-Only Tuple).
  - В этом случае:
    - В таблице создается новая версия строки.
    - В индексе остается только ссылка на старую версию строки.
    - Новая версия строки связывается со старой через специальную цепочку указателей.

#### 4.4 Особенности ход-обновления
- **Условия применения**:
  - HOT-обновление применяется, если обновление не затрагивает индексируемые столбцы.
  - Например, если индекс создан по столбцу `id`, а обновляется столбец `c`, то новая версия строки не добавляется в индекс.

- **Преимущества**:
  - Снижается нагрузка на индексы, так как не создаются лишние записи.
  - Уменьшается объем данных, которые нужно обрабатывать при последующих операциях.

- **Цепочка обновлений**:
  - Если несколько обновлений выполняются подряд и не затрагивают индексируемые столбцы, строки связываются в цепочку.
  - Цепочка может быть длинной, но ограничивается границами одной страницы.
  - Если новая версия строки не помещается на текущей странице, создается новая запись в индексе.

#### 4.5 Практический пример
- Создана таблица `t` с двумя столбцами:
  - `id` (числовой).
  - `c` (строковый).
- Добавлена строка `(42, 'foo')`.
- Выполнено обновление строки: `(42, 'bar')`.
- Использовано расширение `pageinspect` для анализа:
  - В таблице видны две версии строки:
    - Первая версия: `xmin = 591`, `xmax = 592`.
    - Вторая версия: `xmin = 592`, `xmax = 0`.
  - В индексе осталась только одна запись, указывающая на первую версию строки.

---

Это завершает четвертую часть конспекта. Хотите продолжить с пятой частью?