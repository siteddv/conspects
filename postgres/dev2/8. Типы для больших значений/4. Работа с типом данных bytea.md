### Часть 4: Работа с типом данных bytea

#### 1. Практические примеры использования
- **Создание таблицы**:
  - Создается таблица с двумя столбцами: `file_name` (имя файла) и `data` (данные файла).
  - Столбец `data` имеет тип `bytea`, предназначенный для хранения двоичных данных.

- **Загрузка файла**:
  - Для загрузки файла используется функция `pg_read_binary_file`.
  - Файл `bookstore2.sql`, размером около 17 МБ, загружается в таблицу.
  - При загрузке файла данные автоматически выносятся в служебную таблицу TOAST, если они превышают размер страницы.

#### 2. Форматы представления данных
- **Шестнадцатеричный формат**:
  - По умолчанию данные типа `bytea` выводятся в шестнадцатеричном формате.
  - Первый символ `\x` указывает на шестнадцатеричное представление.
  - Пример: строка "hello" будет представлена как `\x68656c6c6f`.

- **Формат escape-последовательностей**:
  - Можно переключиться на формат escape-последовательностей, где ASCII-символы отображаются как есть, а остальные символы используют специальные последовательности.
  - Например, нулевой символ представляется как `\000`.

#### 3. Демонстрация загрузки файла
- **Добавление строки в таблицу**:
  - Выполняется команда `INSERT`, которая загружает файл в таблицу.
  - В результате, данные файла хранятся в служебной таблице TOAST, а основная таблица содержит только ссылку на эти данные.

- **Проверка размера данных**:
  - Размер данных в основной таблице составляет 8 КБ, что указывает на то, что данные были вынесены в TOAST.
  - Размер данных в TOAST меньше исходного размера файла (примерно 770 КБ вместо 17 МБ), что свидетельствует о сжатии данных.

#### 4. Сравнение размеров до и после сжатия
- **Стратегия хранения extended**:
  - По умолчанию столбец `bytea` использует стратегию хранения `extended`, которая предполагает сжатие данных перед выносом в TOAST.
  - Текстовые данные обычно хорошо сжимаются, что объясняет значительное уменьшение размера.

- **Изменение стратегии хранения**:
  - Если изменить стратегию хранения на `external`, данные не будут сжиматься.
  - При повторной загрузке файла размер данных в TOAST становится немного больше исходного размера файла (например, 17.5 МБ вместо 17 МБ).

#### 5. Накладные расходы при хранении в TOAST
- **Дополнительные данные**:
  - Каждая строка в TOAST содержит служебные данные: `chunk_id`, `chunk_seq`, и `chunk_data`.
  - У каждой строки также есть служебный заголовок размером 24 байта.
  - Эти накладные расходы увеличивают общий размер данных в TOAST.

- **Индексы**:
  - Для быстрого доступа к фрагментам данных создается уникальный индекс по первым двум столбцам (`chunk_id`, `chunk_seq`).
  - Индекс также занимает дополнительное место в базе данных.

#### 6. Преимущества и недостатки
- **Преимущества**:
  - Возможность использования транзакционных механизмов и управления доступом средствами СУБД.
  - Прозрачное управление данными для приложения (склейка и разбиение данных происходит автоматически).

- **Недостатки**:
  - Увеличение размера базы данных и объема WAL-логов.
  - Более медленная работа по сравнению с файловой системой.
  - При изменении даже небольшого фрагмента данных весь атрибут загружается в буферный кэш и изменяется целиком.

Эта часть конспекта подробно охватывает практические аспекты работы с типом данных `bytea`, включая форматы представления данных, демонстрацию загрузки файла, сравнение размеров до и после сжатия, а также преимущества и недостатки использования этого типа данных.