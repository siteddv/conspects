### Часть 4: Журнал предзаписи (WAL)

#### 4.1 Принцип работы журнала предзаписи
Журнал предзаписи (Write-Ahead Logging, WAL) — это механизм, который используется для обеспечения надёжности и восстановления данных после сбоя. Основная идея WAL заключается в том, что **все изменения данных записываются в журнал до того, как они физически применяются к страницам данных на диске**.

- **Причины использования WAL**:
  - При сбое оперативная память теряет все данные, включая буферный кэш и грязные страницы.
  - Без механизма WAL невозможно гарантировать согласованность данных на диске, так как часть изменений может быть потеряна.

- **Правило предзаписи**:
  - Запись в журнал всегда должна попасть на диск раньше, чем соответствующие изменения в страницах данных.
  - Это гарантирует, что при сбое можно будет восстановить потерянные изменения из журнала.

#### 4.2 Устройство журнала
Журнал WAL представляет собой непрерывный поток байтов, который логически разделён на записи. Каждая запись содержит информацию о конкретных изменениях, которые были выполнены в системе.

- **Структура журнальной записи**:
  - **Заголовок**: Содержит служебную информацию, такую как:
    - Номер транзакции, которой принадлежит запись.
    - Тип изменения (например, модификация таблицы или индекса).
    - Менеджер ресурсов — компонент системы, который знает, как интерпретировать данные записи.
  - **Данные**: Содержатся сами изменения, которые нужно применить к страницам данных.
  - **Контрольная сумма**: Используется для проверки целостности записи. Если контрольная сумма не совпадает, запись считается повреждённой и не используется.

- **Адресация записей**:
  - Каждая запись имеет уникальный номер, называемый **LSN (Log Sequence Number)**.
  - LSN — это 64-битное число, которое указывает смещение записи от начала журнала.
  - Благодаря большому размеру LSN (64 бита), переполнение адресного пространства практически невозможно.

#### 4.3 Контрольные точки
Контрольные точки (checkpoints) — это механизм, который позволяет ограничить объём журнальных записей, необходимых для восстановления после сбоя.

- **Проблема без контрольных точек**:
  - Без контрольных точек система была бы вынуждена хранить все журнальные записи с момента запуска сервера.
  - Это привело бы к огромному объёму данных и длительному времени восстановления.

- **Как работают контрольные точки**:
  1. **Маркировка грязных страниц**:
     - На первой стадии контрольной точки система быстро проходит по всему буферному кэшу и помечает грязные страницы специальным флагом.
  2. **Сброс страниц на диск**:
     - На второй стадии система постепенно записывает помеченные страницы на диск, снимая флаг после завершения записи.
     - Этот процесс растянут во времени, чтобы минимизировать влияние на производительность.
  3. **Удаление старых записей**:
     - После завершения контрольной точки все журнальные записи, предшествующие её началу, могут быть удалены, так как их данные уже зафиксированы на диске.

- **Автоматические и ручные контрольные точки**:
  - Контрольные точки выполняются автоматически через определённые интервалы времени.
  - Также их можно вызвать вручную с помощью команды `CHECKPOINT`.

#### 4.4 Восстановление после сбоя
Процесс восстановления после сбоя основывается на использовании журнала WAL и информации из последней успешно завершённой контрольной точки.

- **Этапы восстановления**:
  1. **Определение точки восстановления**:
     - Система читает управляющий файл (`pg_control`), чтобы найти позицию последней контрольной точки.
     - Восстановление начинается с этой позиции.
  2. **Применение журнальных записей**:
     - Система последовательно читает записи WAL и применяет их к страницам данных.
     - Для каждой страницы проверяется её текущий LSN. Если он меньше LSN записи, изменения применяются; если больше — страница пропускается.
  3. **Обработка незавершённых транзакций**:
     - Все транзакции, которые были начаты, но не завершены на момент сбоя, отменяются.
     - Для этого обновляется таблица состояний транзакций.
  4. **Финальная контрольная точка**:
     - После завершения восстановления выполняется контрольная точка, чтобы зафиксировать восстановленное состояние на диске.

---

Это завершает четвёртую часть конспекта, посвящённую журналу предзаписи (WAL). Хотите перейти к пятой части, где рассматривается восстановление после сбоя?