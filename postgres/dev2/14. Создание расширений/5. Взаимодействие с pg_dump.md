### Часть 5: Взаимодействие с `pg_dump`

#### Особенности выгрузки расширений
1. **Как работает `pg_dump` с расширениями**:
   - При выполнении логической выгрузки базы данных (`pg_dump`) объекты, принадлежащие расширению, не выгружаются по отдельности.
   - Вместо этого сохраняется только команда `CREATE EXTENSION`, которая при восстановлении заново создает все объекты расширения.
   - Это связано с тем, что объекты расширения связаны между собой и должны быть созданы целиком.

2. **Пример вывода `pg_dump`**:
   - Результат работы `pg_dump` для базы данных с установленным расширением может выглядеть так:
     ```sql
     -- Dumped by pg_dump version 14.0
     SET statement_timeout = 0;
     SET lock_timeout = 0;

     CREATE EXTENSION IF NOT EXISTS units_of_magic WITH SCHEMA public;

     COMMENT ON EXTENSION units_of_magic IS 'Магическое расширение для конвертации единиц измерения';
     ```

3. **Потеря пользовательских данных**:
   - Если пользователь добавил данные в таблицы расширения (например, новые единицы измерения), эти данные не будут автоматически сохранены при выгрузке.
   - Например, если пользователь добавил запись:
     ```sql
     INSERT INTO units (unit_name, conversion_factor, unit_class)
     VALUES ('verst', 1066.8, 'length');
     ```
     эта запись будет потеряна при восстановлении дампа, если не настроить дополнительные параметры.

#### Сохранение пользовательских данных
4. **Использование функции `pg_extension_config_dump`**:
   - Для сохранения пользовательских данных используется функция `pg_extension_config_dump`.
   - Эта функция позволяет указать, какие данные из таблиц расширения должны быть выгружены.
   - Пример использования:
     ```sql
     SELECT pg_extension_config_dump('units', 'WHERE is_predefined = FALSE');
     ```
   - В этом случае `pg_dump` будет выгружать только те строки, которые соответствуют условию `is_predefined = FALSE`.

5. **Добавление столбца для разделения данных**:
   - Чтобы разделить предопределенные и пользовательские данные, можно добавить столбец `is_predefined`:
     ```sql
     ALTER TABLE units ADD COLUMN is_predefined BOOLEAN DEFAULT TRUE;

     UPDATE units SET is_predefined = TRUE;
     ```

6. **Обновление скрипта расширения**:
   - В скрипте обновления до версии 1.2 добавляем:
     ```sql
     ALTER TABLE units ADD COLUMN is_predefined BOOLEAN DEFAULT TRUE;

     UPDATE units SET is_predefined = TRUE;

     SELECT pg_extension_config_dump('units', 'WHERE is_predefined = FALSE');
     ```

7. **Результат выгрузки после настройки**:
   - После настройки `pg_extension_config_dump` в дампе появится команда для выгрузки пользовательских данных:
     ```sql
     COPY units (unit_name, conversion_factor, unit_class, is_predefined) FROM stdin;
     verst    1066.8    length    f
     \.
     ```

#### Конфигурирование процесса backup
8. **Настройка условий для выгрузки**:
   - Условие в `pg_extension_config_dump` позволяет гибко управлять тем, какие данные будут сохранены.
   - Например, можно добавить более сложное условие:
     ```sql
     SELECT pg_extension_config_dump('units', 'WHERE is_predefined = FALSE AND unit_class = ''mass''');
     ```

9. **Проверка корректности выгрузки**:
   - Для проверки корректности выгрузки можно выполнить восстановление дампа и убедиться, что пользовательские данные сохранились:
     ```bash
     pg_restore -d my_database dump.sql
     ```

10. **Автоматизация процесса**:
   - Если расширение часто используется в разных базах данных, можно автоматизировать процесс настройки `pg_extension_config_dump` через скрипты обновления.

#### Пример практического применения
11. **Добавление пользовательских данных**:
   - Пользователь добавляет новые единицы измерения:
     ```sql
     INSERT INTO units (unit_name, conversion_factor, unit_class, is_predefined)
     VALUES ('verst', 1066.8, 'length', FALSE);
     ```

12. **Выгрузка данных с помощью `pg_dump`**:
   - Выполняем команду:
     ```bash
     pg_dump my_database > dump.sql
     ```

13. **Восстановление данных**:
   - После восстановления дампа пользовательские данные остаются доступными:
     ```sql
     SELECT * FROM units WHERE is_predefined = FALSE;
     ```

---

Если вы готовы, можем перейти к следующей части — "Практические задания".