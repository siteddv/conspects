### Часть 3: Работа с версиями расширений

#### Механизм обновлений
1. **Обновление с одной версии на другую**:
   - PostgreSQL поддерживает механизм обновления расширений с одной версии на другую. Это позволяет разработчикам выпускать новые версии расширений, сохраняя совместимость с предыдущими версиями.
   - Для обновления используется команда:
     ```sql
     ALTER EXTENSION <имя_расширения> UPDATE TO '<новая_версия>';
     ```
   - Если новая версия не указана, PostgreSQL автоматически выбирает следующую доступную версию.

2. **Скрипты обновления**:
   - Для каждой пары версий (например, от 1.0 до 1.1) создается отдельный SQL-скрипт обновления.
   - Имя файла строится по шаблону: `<имя_расширения>--<старая_версия>--<новая_версия>.sql`.
   - Пример имени файла для обновления с версии 1.0 до 1.1:
     ```
     units_of_magic--1.0--1.1.sql
     ```
   - В этом скрипте содержатся команды, которые изменяют объекты базы данных для перехода на новую версию. Например:
     ```sql
     ALTER TABLE units ADD COLUMN unit_class TEXT DEFAULT 'length';
     INSERT INTO units (unit_name, conversion_factor, unit_class)
     VALUES ('gram', 0.001, 'mass'),
            ('kilogram', 1.0, 'mass'),
            ('ton', 1000.0, 'mass');
     ```

3. **Цепочка обновлений**:
   - Если пользователь хочет перейти с версии 1.0 на версию 1.2, а прямого пути нет, PostgreSQL автоматически выполняет цепочку обновлений:
     ```
     1.0 -> 1.1 -> 1.2
     ```
   - Это достигается за счет наличия скриптов для каждой пары версий.

4. **Прямые обновления**:
   - Если разработчик создает файл для прямого обновления (например, `units_of_magic--1.0--1.2.sql`), PostgreSQL выберет его вместо цепочки обновлений.
   - В этом случае файл должен содержать все необходимые изменения для перехода с начальной версии на конечную.

#### Система версионирования
1. **Текстовые строки версий**:
   - Версии расширений представлены текстовыми строками, которые не имеют строгой числовой интерпретации. Например:
     - "1.0" может быть как следующей, так и предыдущей версией относительно "0.9".
   - Разработчики могут использовать любые форматы версий, например:
     - "v1.0-alpha"
     - "2023-01-01"

2. **Параметр `default_version`**:
   - В управляющем файле можно указать параметр `default_version`, который определяет версию, устанавливаемую по умолчанию при выполнении команды `CREATE EXTENSION`.
   - При выпуске новых версий рекомендуется обновлять этот параметр, чтобы пользователи сразу устанавливали последнюю версию.

#### Обновление параметров
1. **Изменение параметров в управляющем файле**:
   - Если необходимо изменить параметры расширения (например, `default_version`), можно создать дополнительный управляющий файл с именем `<имя_расширения>--<версия>.control`.
   - Этот файл будет иметь приоритет над основным управляющим файлом для указанной версии.
   - Пример содержимого дополнительного управляющего файла:
     ```
     default_version = '1.2'
     comment = 'Добавлена поддержка единиц массы'
     ```

2. **Рекомендации по изменению параметров**:
   - Изменение параметров должно быть минимальным, чтобы избежать конфликтов с существующими установками.
   - Например, изменение параметра `relocatable` после выпуска первой версии может привести к проблемам при переносе объектов между схемами.

#### Переход между версиями
1. **Возможность отката**:
   - PostgreSQL не предоставляет встроенного механизма для автоматического отката на предыдущую версию.
   - Если требуется поддержка отката, разработчик должен создать соответствующие скрипты (например, `units_of_magic--1.1--1.0.sql`).

2. **Проверка доступных путей обновления**:
   - Для проверки доступных путей обновления можно использовать функцию:
     ```sql
     SELECT * FROM pg_available_extension_versions WHERE name = 'units_of_magic';
     ```
   - Эта функция показывает, какие версии доступны для установки и какие пути обновления поддерживаются.

#### Пример практического применения
1. **Добавление нового функционала**:
   - Предположим, что в текущей версии расширения поддерживается только конвертация единиц длины. В новой версии добавляется поддержка единиц массы.
   - Для этого:
     - Добавляется новый столбец `unit_class` в таблицу `units`.
     - Добавляются новые записи для единиц массы.
     - Функция `convert` модифицируется для проверки совместимости классов единиц измерения.

2. **Выпуск новой версии**:
   - Создается скрипт обновления `units_of_magic--1.0--1.1.sql`:
     ```sql
     ALTER TABLE units ADD COLUMN unit_class TEXT DEFAULT 'length';
     INSERT INTO units (unit_name, conversion_factor, unit_class)
     VALUES ('gram', 0.001, 'mass'),
            ('kilogram', 1.0, 'mass'),
            ('ton', 1000.0, 'mass');

     CREATE OR REPLACE FUNCTION convert(value DOUBLE PRECISION, from_unit TEXT, to_unit TEXT)
     RETURNS DOUBLE PRECISION AS $$
     DECLARE
         from_factor DOUBLE PRECISION;
         to_factor DOUBLE PRECISION;
         from_class TEXT;
         to_class TEXT;
     BEGIN
         SELECT conversion_factor, unit_class INTO from_factor, from_class FROM units WHERE unit_name = from_unit;
         SELECT conversion_factor, unit_class INTO to_factor, to_class FROM units WHERE unit_name = to_unit;

         IF from_class <> to_class THEN
             RAISE EXCEPTION 'Невозможно конвертировать единицы разных классов';
         END IF;

         RETURN value * (from_factor / to_factor);
     END;
     $$ LANGUAGE plpgsql;
     ```

3. **Обновление установленного расширения**:
   - После установки скрипта обновления пользователь может выполнить команду:
     ```sql
     ALTER EXTENSION units_of_magic UPDATE TO '1.1';
     ```

---

Если вы готовы, можем перейти к следующей части — "Практическая реализация расширения".