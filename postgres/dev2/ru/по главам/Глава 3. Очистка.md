# Глава 3. Очистка

## Содержание

- [[1. Введение в процесс очистки таблиц и индексов]] [1. Введение в процесс очистки таблиц и индексов](../полный/3. Очистка/1. Введение в процесс очистки таблиц и индексов.md)
- [[2. Этапы выполнения очистки]] [2. Этапы выполнения очистки](../полный/3. Очистка/2. Этапы выполнения очистки.md)
- [[3. Практический пример работы VACUUM]] [3. Практический пример работы VACUUM](../полный/3. Очистка/3. Практический пример работы VACUUM.md)
- [[4. Сбор статистики и полная очистка]] [4. Сбор статистики и полная очистка](../полный/3. Очистка/4. Сбор статистики и полная очистка.md)
- [[5. Заморозка версий строк и управление счетчиком транзакций]] [5. Заморозка версий строк и управление счетчиком транзакций](../полный/3. Очистка/5. Заморозка версий строк и управление счетчиком транзакций.md)
- [[6. Оптимизация работы с таблицами и индексами]] [6. Оптимизация работы с таблицами и индексами](../полный/3. Очистка/6. Оптимизация работы с таблицами и индексами.md)

---

## Введение в процесс очистки таблиц и индексов

Из-за механизма MVCC старые версии строк остаются в файле таблицы, даже если они больше не нужны. Это приводит к разрастанию таблиц и снижению производительности. Процесс `VACUUM` находит старые версии строк, которые больше не видны ни одной транзакции, помечает их как свободное место и обновляет служебную информацию о транзакциях.

PostgreSQL имеет встроенный процесс автоматической очистки (`autovacuum`), который работает в фоновом режиме и сам выполняет `VACUUM`. Автоматическая очистка запускается периодически и обрабатывает таблицы, в которых накопилось много "мертвых" строк.

## Этапы выполнения очистки

Процесс `VACUUM` выполняет несколько этапов: находит старые версии строк, которые больше не видны ни одной транзакции, помечает их как свободное место, обновляет служебную информацию о транзакциях и обновляет статистику для оптимизатора запросов.

Разница между `VACUUM` и `VACUUM FULL`: `VACUUM` удаляет старые версии строк, освобождая место внутри таблицы, но не уменьшает размер файла; `VACUUM FULL` полностью пересоздает таблицу, уменьшая её размер, но блокирует её на время выполнения.

## Заморозка версий строк и управление счетчиком транзакций

Счетчик транзакций в PostgreSQL имеет ограниченный диапазон значений. Когда счетчик приближается к своему пределу, необходимо выполнять заморозку (freeze) старых версий строк, чтобы предотвратить переполнение счетчика.

Заморозка версий строк — это процесс, при котором старые версии строк помечаются как "замороженные" и больше не требуют отслеживания через счетчик транзакций. Это позволяет системе продолжать работу даже при приближении к пределу счетчика транзакций.

**Подробнее:** [[3. Очистка]] [3. Очистка](../полный/3. Очистка/1. Введение в процесс очистки таблиц и индексов.md)

