# Глава 2. Внутреннее устройство

## Содержание

- [[1. Введение в устройство страниц данных]] [1. Введение в устройство страниц данных](../полный/2. Внутреннее устройство/1. Введение в устройство страниц данных.md)
- [[2. Версии строк и их хранение]] [2. Версии строк и их хранение](../полный/2. Внутреннее устройство/2. Версии строк и их хранение.md)
- [[3. Журнал транзакций и механизм фиксации изменений]] [3. Журнал транзакций и механизм фиксации изменений](../полный/2. Внутреннее устройство/3. Журнал транзакций и механизм фиксации изменений.md)
- [[4. Операции с данными]] [4. Операции с данными](../полный/2. Внутреннее устройство/4. Операции с данными.md)
- [[5. Снимки данных и видимость строк]] [5. Снимки данных и видимость строк](../полный/2. Внутреннее устройство/5. Снимки данных и видимость строк.md)
- [[6. Практические аспекты и оптимизация]] [6. Практические аспекты и оптимизация](../полный/2. Внутреннее устройство/6. Практические аспекты и оптимизация.md)

---

## Введение в устройство страниц данных

Страницы данных — основной строительный блок для хранения информации в PostgreSQL. Они могут быть как табличными, так и индексными. Размер страницы по умолчанию составляет 8 КБ (8192 байта). Этот размер можно изменить только при сборке PostgreSQL из исходного кода (доступны варианты 16 КБ и 32 КБ).

Структура табличной страницы включает заголовок страницы (первые 28 байт, содержит служебную информацию), массив указателей (хранит указатели на версии строк, расположенные в конце страницы), свободное место (находится между заголовком и данными) и данные (версии строк, располагаются с конца страницы).

Для оптимизации доступа к данным используется выравнивание по границам машинных слов. Это приводит к тому, что некоторые типы данных занимают больше места, чем фактически требуется.

## Версии строк и их хранение

PostgreSQL использует механизм MVCC (многоверсионный контроль параллельности), который позволяет хранить несколько версий одной строки. Каждая версия строки содержит метаданные: `xmin` (номер транзакции, которая создала эту версию строки) и `xmax` (номер транзакции, которая сделала строку невидимой).

Операция `UPDATE` фактически является комбинацией `DELETE + INSERT`: создается новая версия строки, а старая версия остается в истории, но становится невидимой для новых транзакций. Операция `DELETE` не уничтожает строку сразу, а просто делает её невидимой для будущих транзакций, изменяя `xmax`.

## Журнал транзакций и механизм фиксации изменений

Журнал транзакций (WAL) является критически важным компонентом системы, обеспечивающим надежность хранения данных. Все изменения сначала фиксируются в WAL, и только потом применяются к самим данным в буферном кэше.

Механизм фиксации изменений гарантирует, что даже в случае аварийного завершения работы системы все изменения могут быть восстановлены путем проигрывания записей WAL.

## Снимки данных и видимость строк

Снимок данных (Snapshot) — это логический срез базы данных на момент начала транзакции. Снимок данных создается при начале транзакции и состоит из номера текущей транзакции, списка активных транзакций и диапазона видимых `xmin` и `xmax`.

При построении снимка система отбрасывает невидимые версии строк, используя `xmin` и `xmax`. Каждая транзакция видит только те версии строк, которые соответствуют правилам видимости на момент её начала.

**Подробнее:** [[2. Внутреннее устройство]] [2. Внутреннее устройство](../полный/2. Внутреннее устройство/1. Введение в устройство страниц данных.md)

