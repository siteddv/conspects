# Глава 16. Агрегатные и оконные функции

## Содержание

- [[1. Введение и базовые понятия]] [1. Введение и базовые понятия](../полный/16. Агрегатные и оконные функции/1. Введение и базовые понятия.md)
- [[2. Создание пользовательских агрегатных функций]] [2. Создание пользовательских агрегатных функций](../полный/16. Агрегатные и оконные функции/2. Создание пользовательских агрегатных функций.md)
- [[3. Работа с оконными функциями]] [3. Работа с оконными функциями](../полный/16. Агрегатные и оконные функции/3.  Работа с оконными функциями.md)
- [[4. Расширенные возможности оконных функций]] [4. Расширенные возможности оконных функций](../полный/16. Агрегатные и оконные функции/4. Расширенные возможности оконных функций.md)
- [[5. Параллельная обработка и оптимизация]] [5. Параллельная обработка и оптимизация](../полный/16. Агрегатные и оконные функции/5. Параллельная обработка и оптимизация.md)
- [[6. Практическое применение и задачи]] [6. Практическое применение и задачи](../полный/16. Агрегатные и оконные функции/6. Практическое применение и задачи.md)

---

## Введение и базовые понятия

Агрегатные функции — это стандартные функции, такие как `COUNT`, `MIN`, `MAX` и другие, которые используются для выполнения вычислений на множестве строк и возвращают одно значение. Эти функции "схлопывают" множество строк в одну, то есть результатом является единственное значение.

Механизм работы агрегатных функций: состояние (для работы агрегатной функции необходимо определить состояние, которое будет хранить промежуточные данные), начальное состояние (перед началом обработки устанавливается начальное состояние), функция перехода (для каждой строки из выборки вызывается специальная функция перехода, которая изменяет текущее состояние) и функция финализации (после обработки всех строк вызывается функция финализации, которая преобразует последнее состояние в окончательный результат).

## Создание пользовательских агрегатных функций

Создание пользовательской агрегатной функции включает определение типа состояния, функции перехода, функции финализации и начального значения. Команда `CREATE AGGREGATE` объединяет все компоненты в единую агрегатную функцию.

## Работа с оконными функциями

Оконные функции позволяют выполнять вычисления над набором строк, связанных с текущей строкой. В отличие от агрегатных функций, оконные функции не "схлопывают" строки, а возвращают значение для каждой строки в результате запроса.

Оконные функции используют предложение `OVER`, которое определяет окно (window) — набор строк, над которыми выполняется вычисление. Окно может быть определено с помощью `PARTITION BY` (разделение на группы) и `ORDER BY` (упорядочивание внутри окна).

## Параллельная обработка и оптимизация

PostgreSQL поддерживает параллельное выполнение агрегатных функций, что позволяет ускорить обработку больших объемов данных. Параллельная обработка требует определения функции объединения состояний, которая объединяет состояния из разных параллельных процессов.

**Подробнее:** [[16. Агрегатные и оконные функции]] [16. Агрегатные и оконные функции](../полный/16. Агрегатные и оконные функции/1. Введение и базовые понятия.md)

