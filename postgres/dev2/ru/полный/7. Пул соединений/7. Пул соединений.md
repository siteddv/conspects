# 7. Пул соединений

## Описание

Эта глава посвящена пулу соединений в PostgreSQL. Мы рассмотрим введение в проблему производительности соединений с базой данных, пул соединений как решение проблемы, режимы работы пула соединений, аутентификацию и безопасность, особенности разработки приложений, практические задания и примеры, управление и мониторинг пула соединений, а также заключение и рекомендации.

## Части главы

- [[части/1. Введение в проблему производительности соединений с базой данных|1. Введение в проблему производительности соединений с базой данных]] [1. Введение в проблему производительности соединений с базой данных](части/1. Введение в проблему производительности соединений с базой данных.md)
- [[части/2. Пул соединений как решение проблемы|2. Пул соединений как решение проблемы]] [2. Пул соединений как решение проблемы](части/2. Пул соединений как решение проблемы.md)
- [[части/3. Режимы работы пула соединений|3. Режимы работы пула соединений]] [3. Режимы работы пула соединений](части/3. Режимы работы пула соединений.md)
- [[части/4. Аутентификация и безопасность при использовании пула соединений|4. Аутентификация и безопасность при использовании пула соединений]] [4. Аутентификация и безопасность при использовании пула соединений](части/4. Аутентификация и безопасность при использовании пула соединений.md)
- [[части/5. Особенности разработки приложений с использованием пула соединений|5. Особенности разработки приложений с использованием пула соединений]] [5. Особенности разработки приложений с использованием пула соединений](части/5. Особенности разработки приложений с использованием пула соединений.md)
- [[части/6. Практические задания и примеры|6. Практические задания и примеры]] [6. Практические задания и примеры](части/6. Практические задания и примеры.md)
- [[части/7. Управление и мониторинг пула соединений|7. Управление и мониторинг пула соединений]] [7. Управление и мониторинг пула соединений](части/7. Управление и мониторинг пула соединений.md)
- [[части/8. Заключение и рекомендации|8. Заключение и рекомендации]] [8. Заключение и рекомендации](части/8. Заключение и рекомендации.md)

---

PostgreSQL использует процессную модель для обработки клиентских запросов. Это означает, что каждый клиентский запрос обрабатывается отдельным обслуживающим процессом на стороне сервера. Такая архитектура имеет несколько ограничений: создание соединений — дорогостоящая операция, особенно для коротких запросов; при большом количестве процессов создание "снимков данных" (snapshots) становится узким местом из-за блокировки структуры ProcArray; каждое соединение потребляет оперативную память.

Пул соединений — это промежуточный слой между клиентами и базой данных, который решает проблему большого количества клиентских соединений. Он открывает и поддерживает ограниченное количество соединений с базой данных на длительное время и перенаправляет запросы клиентов в уже открытые соединения, минимизируя накладные расходы на их создание. С точки зрения PostgreSQL, кажется, что к базе данных подключено небольшое количество клиентов, которые постоянно работают.

Пул соединений можно разместить в разных местах системы: ближе к клиентам (на стороне сервера приложений), ближе к СУБД (на стороне базы данных) или использовать комбинированный подход. Популярные решения для реализации пула соединений включают PgBouncer (легковесный пул соединений, фактически стандарт де-факто), PgPool-II (более функциональное решение с возможностью распределения запросов) и Yandex Odyssey (для высокопроизводительных многопоточных сред).

Пул соединений может работать в нескольких режимах: режим пула сеансов (один сеанс клиента соответствует одному сеансу между пулом и базой данных), режим пула транзакций (наиболее распространённый, каждая транзакция перенаправляется на одно из открытых соединений) и режим пула операторов (запрещает транзакции, состоящие из нескольких операций). Каждое соединение с базой данных устанавливается для конкретной базы данных и конкретной роли, поэтому для каждой уникальной пары "база данных + роль" пул вынужден открывать новое соединение.

При использовании пула соединений возникает проблема повторного использования уже открытых соединений. Чтобы избежать проблем безопасности, пул соединений должен самостоятельно выполнять аутентификацию клиентов. PgBouncer может использовать локальный файл `userlist.txt` для хранения учётных данных или запрашивать пароли из системного каталога PostgreSQL через параметр `auth_query`.

При использовании пула соединений важно учитывать, что сеансы работы клиентов могут быть распределены между несколькими обслуживающими процессами PostgreSQL. Это вызывает проблемы с функционалом, который зависит от состояния сеанса: подготовленные операторы (хранятся в памяти конкретного процесса), временные таблицы (созданные на уровне сеанса становятся недоступными при переключении соединения), функции `CURRVAL` и `NEXTVAL` (значение последовательности может быть потеряно), параметры сеанса (теряются при переключении соединения), рекомендательные блокировки (теряются при переключении соединения), курсоры (теряются при переключении соединения).

PgBouncer предоставляет специальную консоль для управления и мониторинга пула соединений. Основные команды включают `SHOW POOLS` (показывает состояние пулов), `SHOW CLIENTS` (список активных клиентских соединений), `SHOW SERVERS` (список серверных соединений), `PAUSE` (приостанавливает обработку новых запросов), `RESUME` (возобновляет обработку), `RELOAD` (перечитывает конфигурационный файл) и `SHUTDOWN` (останавливает работу PgBouncer). Регулярный мониторинг помогает выявлять проблемы и оптимизировать производительность системы.

