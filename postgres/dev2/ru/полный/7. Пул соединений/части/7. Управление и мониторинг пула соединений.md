### **Пятая логическая часть: Управление и мониторинг пула соединений**

#### **1. Консоль управления PgBouncer**
PgBouncer предоставляет специальную консоль для управления и мониторинга пула соединений. Эта консоль позволяет выполнять различные команды, которые помогают контролировать состояние пула, изменять его конфигурацию "на лету" и выполнять диагностические действия.

---

#### **2. Как подключиться к консоли управления PgBouncer**
Для подключения к консоли управления используется команда `psql` с указанием специальной базы данных `pgbouncer`. Например:
```bash
psql -h localhost -p 6432 -U student -d pgbouncer
```
- Здесь:
  - `-h localhost` — хост, где запущен PgBouncer.
  - `-p 6432` — порт PgBouncer (по умолчанию 6432).
  - `-U student` — имя пользователя, который имеет административные права.
  - `-d pgbouncer` — специальная база данных для управления PgBouncer.

---

#### **3. Основные команды PgBouncer**
В консоли управления доступны следующие команды:

1. **SHOW POOLS:**
   - Показывает текущее состояние пулов соединений.
   - Пример вывода:
     ```
     database  | user  | cl_active | cl_waiting | sv_active | sv_idle | sv_used | sv_tested | maxwait
     ----------+-------+-----------+------------+-----------+---------+---------+-----------+---------
     mydb      | alice | 1         | 0          | 1         | 0       | 0       | 0         | 0
     ```
   - Здесь:
     - `cl_active` — количество активных клиентских соединений.
     - `sv_active` — количество активных серверных соединений.
     - `sv_idle` — количество простаивающих серверных соединений.

2. **SHOW CLIENTS:**
   - Показывает список активных клиентских соединений.
   - Пример вывода:
     ```
     type | user  | database | state  | addr        | port  | local_addr | local_port
     -----+-------+----------+--------+-------------+-------+------------+-----------
     C    | alice | mydb     | active | 127.0.0.1   | 54321 | 127.0.0.1  | 6432
     ```

3. **SHOW SERVERS:**
   - Показывает список серверных соединений.
   - Пример вывода:
     ```
     type | user  | database | state  | addr        | port  | local_addr | local_port
     -----+-------+----------+--------+-------------+-------+------------+-----------
     S    | alice | mydb     | idle   | 127.0.0.1   | 5432  | 127.0.0.1  | 6432
     ```

4. **PAUSE:**
   - Приостанавливает обработку новых запросов в пуле.
   - Полезно при выполнении обслуживания базы данных.

5. **RESUME:**
   - Возобновляет обработку запросов после команды `PAUSE`.

6. **RELOAD:**
   - Перечитывает конфигурационный файл без перезапуска PgBouncer.
   - Полезно для применения изменений в настройках.

7. **SHUTDOWN:**
   - Полностью останавливает работу PgBouncer.

---

#### **4. Пример использования консоли**
Рассмотрим пример работы с консолью управления PgBouncer:

8. **Подключение к консоли:**
   ```bash
   psql -h localhost -p 6432 -U student -d pgbouncer
   ```

9. **Просмотр состояния пулов:**
   ```sql
   SHOW POOLS;
   ```
   Вывод покажет текущее распределение соединений между клиентами и сервером.

10. **Приостановка обработки запросов:**
   ```sql
   PAUSE;
   ```
   После этой команды новые клиентские запросы будут поставлены в очередь.

11. **Выполнение обслуживания базы данных:**
   - Например, можно выполнить перезагрузку PostgreSQL:
     ```bash
     systemctl restart postgresql
     ```

12. **Возобновление обработки запросов:**
   ```sql
   RESUME;
   ```
   После этой команды все поставленные в очередь запросы будут обработаны.

---

#### **5. Мониторинг производительности**
PgBouncer предоставляет статистику, которая помогает анализировать производительность пула соединений. Основные метрики включают:
- Количество активных и простаивающих соединений.
- Время ожидания клиентов.
- Количество запросов, обработанных через пул.

Эти данные можно использовать для оптимизации настроек пула, например:
- Увеличение или уменьшение максимального количества соединений.
- Настройка времени жизни соединений.

---

#### **6. Изменение конфигурации "на лету"**
Одним из преимуществ PgBouncer является возможность изменения конфигурации без перезапуска сервиса. Для этого используется команда `RELOAD`. Например:
13. Внесите изменения в конфигурационный файл `pgbouncer.ini`:
   ```ini
   max_client_conn = 200
   default_pool_size = 20
```
1. Выполните команду:
   ```sql
   RELOAD;
   ```
2. Новые настройки будут применены немедленно.

---

#### **7. Практические задания**
В видео предложены несколько практических заданий для закрепления материала:

3. **Задание 1: Анализ состояния пула**
   - Подключитесь к консоли управления PgBouncer.
   - Используйте команду `SHOW POOLS`, чтобы проанализировать текущее состояние пула.
   - Ответьте на вопросы:
     - Сколько активных клиентских соединений?
     - Сколько серверных соединений находится в состоянии `idle`?

4. **Задание 2: Приостановка и возобновление обработки запросов**
   - Выполните команду `PAUSE`.
   - Попробуйте подключиться к базе данных через PgBouncer. Что происходит?
   - Возобновите обработку запросов командой `RESUME`.

5. **Задание 3: Изменение конфигурации**
   - Увеличьте значение параметра `default_pool_size` в конфигурационном файле.
   - Примените изменения с помощью команды `RELOAD`.
   - Проверьте, как изменилось состояние пула.

---

#### **8. Заключение по пятой части**
Управление и мониторинг пула соединений — это важная часть работы с PgBouncer. Консоль управления предоставляет удобные инструменты для контроля состояния пула, изменения конфигурации и выполнения диагностических действий. Регулярный мониторинг помогает выявлять проблемы и оптимизировать производительность системы.

В следующей части мы рассмотрим заключение и рекомендации по использованию пула соединений. Если вы хотите продолжить, дайте знать!

