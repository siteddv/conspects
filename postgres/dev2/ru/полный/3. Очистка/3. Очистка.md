# 3. Очистка

## Описание

Эта глава посвящена процессу очистки таблиц и индексов в PostgreSQL. Мы рассмотрим введение в процесс очистки, этапы выполнения очистки, практический пример работы VACUUM, сбор статистики и полную очистку, заморозку версий строк и управление счетчиком транзакций, а также оптимизацию работы с таблицами и индексами.

## Части главы

- [[части/1. Введение в процесс очистки таблиц и индексов|1. Введение в процесс очистки таблиц и индексов]] [1. Введение в процесс очистки таблиц и индексов](части/1. Введение в процесс очистки таблиц и индексов.md)
- [[части/2. Этапы выполнения очистки|2. Этапы выполнения очистки]] [2. Этапы выполнения очистки](части/2. Этапы выполнения очистки.md)
- [[части/3. Практический пример работы VACUUM|3. Практический пример работы VACUUM]] [3. Практический пример работы VACUUM](части/3. Практический пример работы VACUUM.md)
- [[части/4. Сбор статистики и полная очистка|4. Сбор статистики и полная очистка]] [4. Сбор статистики и полная очистка](части/4. Сбор статистики и полная очистка.md)
- [[части/5. Заморозка версий строк и управление счетчиком транзакций|5. Заморозка версий строк и управление счетчиком транзакций]] [5. Заморозка версий строк и управление счетчиком транзакций](части/5. Заморозка версий строк и управление счетчиком транзакций.md)
- [[части/6. Оптимизация работы с таблицами и индексами|6. Оптимизация работы с таблицами и индексами]] [6. Оптимизация работы с таблицами и индексами](части/6. Оптимизация работы с таблицами и индексами.md)

---

Очистка таблиц и индексов — это ключевой процесс в управлении базами данных, который позволяет удалять ненужные версии строк, накапливающиеся со временем. Эти "мертвые" строки (устаревшие или удаленные версии данных) занимают место на диске и могут замедлять выполнение запросов. Для этого используется команда `VACUUM`, которая проходит по таблице, анализирует её содержимое и удаляет ненужные данные.

Одной из важнейших особенностей `VACUUM` является то, что она не блокирует операции чтения и изменения данных в таблице. Это означает, что приложение может продолжать работать с базой данных даже во время выполнения очистки. Для оптимизации процесса очистки используется карта видимости, которая помогает `VACUUM` определить, какие страницы таблицы уже были полностью очищены и не требуют повторной проверки. После завершения очистки `VACUUM` обновляет карту свободного пространства для таблицы и индексов.

Процесс очистки состоит из нескольких последовательных этапов: сканирование таблицы с использованием карты видимости, идентификация мертвых строк, очистка индексов и удаление мертвых строк из самой таблицы. Очистка индексов требует полного просмотра структуры индекса, что делает этот процесс более ресурсоёмким, чем работа с таблицами. `VACUUM` не возвращает освободившееся место операционной системе, а сохраняет его для будущего использования новыми данными.

Долгие транзакции могут "удерживать горизонт" (snapshot), что препятствует удалению старых версий строк. Это приводит к увеличению размера таблицы и индексов, а также к снижению производительности запросов. Для автоматизации процесса очистки в системе используется механизм `autovacuum`, который реализуется через два типа процессов: `autovacuum launcher` и `autovacuum worker`.

После выполнения очистки важно собрать актуальную статистику о данных в таблице с помощью команды `ANALYZE`. Эта статистика используется планировщиком запросов для построения наиболее оптимального плана выполнения запросов. Для реального уменьшения размера таблицы используется команда `VACUUM FULL`, которая полностью перестраивает таблицу, создавая новые файлы данных без пустых мест. Однако `VACUUM FULL` требует монопольной блокировки таблицы на всё время выполнения.

Счетчик транзакций в PostgreSQL имеет фиксированный размер — 4 байта (32 бита), что ограничивает общее количество уникальных номеров транзакций значением примерно 4 миллиарда. При достижении середины круга возникает риск конфликтов видимости. Для предотвращения конфликтов используется механизм заморозки версий строк, который помечает старые версии строк как "безусловно старые", чтобы их можно было игнорировать при проверке видимости.

Долгие транзакции являются одной из главных причин увеличения размера таблиц и индексов. Частичные обновления позволяют избежать значительного увеличения размера таблицы, но требуют больше времени на выполнение. Команда `TRUNCATE` является более эффективным способом удаления всех строк по сравнению с `DELETE`, так как она удаляет строки сразу, минуя механизм MVCC. Регулярная очистка и заморозка необходимы для поддержания оптимального состояния базы данных.

