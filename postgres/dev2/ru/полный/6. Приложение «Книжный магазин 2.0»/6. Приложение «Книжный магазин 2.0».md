# 6. Приложение «Книжный магазин 2.0»

## Описание

Эта глава посвящена обновлённому приложению "Книжный магазин 2.0", которое представляет собой расширенную версию приложения из курса Dev-1. Мы рассмотрим введение и теоретическую часть, обзор приложения, схему данных, интерфейс и систему аутентификации, функционал каталога и корзины, а также фоновые задачи и практические задания.

## Части главы

- [[части/1. Введение и теоретическая часть|1. Введение и теоретическая часть]] [1. Введение и теоретическая часть](части/1. Введение и теоретическая часть.md)
- [[части/2. Обзор приложения «Книжный магазин 2.0»|2. Обзор приложения «Книжный магазин 2.0»]] [2. Обзор приложения «Книжный магазин 2.0»](части/2. Обзор приложения «Книжный магазин 2.0».md)
- [[части/3. Схема данных приложения|3. Схема данных приложения]] [3. Схема данных приложения](части/3. Схема данных приложения.md)
- [[части/4. Интерфейс и система аутентификации|4. Интерфейс и система аутентификации]] [4. Интерфейс и система аутентификации](части/4. Интерфейс и система аутентификации.md)
- [[части/5. Функционал каталога и корзины|5. Функционал каталога и корзины]] [5. Функционал каталога и корзины](части/5. Функционал каталога и корзины.md)
- [[части/6. Фоновые задачи и практические задания|6. Фоновые задачи и практические задания]] [6. Фоновые задачи и практические задания](части/6. Фоновые задачи и практические задания.md)

---

Приложение "Книжный магазин 2.0" представляет собой обновлённую версию приложения из курса Dev-1 с расширенным функционалом для работы с большим количеством пользователей и книг. Основные моменты предыдущей лекции включают уровни изоляции и аномалии конкурентного доступа, горизонт транзакций и очистку, буферный кэш и блокировки. Понимание внутреннего устройства PostgreSQL помогает принимать обоснованные решения при разработке.

Приложение состоит из двух основных компонентов: интернет-магазина для покупателей и административной панели для сотрудников магазина. Интернет-магазин включает поиск книг, просмотр детальной информации, корзину для зарегистрированных пользователей и возможность покупки книг. Административная панель включает заказ книг у поставщиков, установку розничной цены на книги и функционал фоновых задач для выполнения длительных операций.

Схема данных приложения включает основные сущности: авторы (Authors), книги (Books), розничные цены (Retail Prices), пользователи (Users), сеансы (Sessions), корзина (Cart Items) и операции (Operations). Дополнительные таблицы включают фоновые задачи (Background Tasks) и программы (Programs). Поле `stock_count` в таблице `books` обновляется автоматически с помощью триггера и имеет ограничение: значение не может быть меньше нуля. Все функции объявлены с параметром `SECURITY DEFINER` и разделены по схемам: `web` для интернет-магазина и `admin` для админки.

Система аутентификации основана на токенах. Функция `register_user` добавляет новую запись в таблицу `users` и возвращает уникальный токен. Функция `login` создаёт новую запись в таблице `sessions` и генерирует уникальный токен (UUID) для сеанса. Функция `check_token` проверяет наличие токена в таблице `sessions` и возвращает имя пользователя. Функция `logout` удаляет запись о текущем сеансе. При входе пользователя в систему автоматически удаляются все его предыдущие сеансы.

Каталог книг включает функцию `get_catalog`, которая возвращает список книг на основе поискового запроса с учётом морфологии слов. Функция `get_image` возвращает обложку книги и вызывается отдельно для оптимизации загрузки списка книг. Функция `cast_vote` увеличивает или уменьшает рейтинг книги и требует аутентификации. Функция `set_retail_price` устанавливает новую розничную цену на книгу. Функция `receive_books` создаёт запись о поступлении книг.

Корзина включает функции `add_to_cart` (добавление книги в корзину), `remove_from_cart` (удаление книги из корзины), `get_cart` (просмотр содержимого корзины) и `checkout` (покупка всех книг в корзине). Каждое действие с корзиной выполняется в отдельной транзакции, что позволяет избежать длительных блокировок. Проверка наличия книг на складе происходит только в момент покупки.

Система фоновых задач включает программы (Programs) и задачи (Tasks). Функции для работы с фоновыми задачами включают `get_programs` (возвращает список доступных программ), `run_program` (запускает новую задачу), `get_task_result` (возвращает результат выполнения задачи) и `register_program` (регистрирует новую фоновую программу). Фоновые задачи выполняются асинхронно, что позволяет сотрудникам запускать длительные операции и проверять их результаты позже.

