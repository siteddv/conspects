### Часть 5: Подсистема больших объектов (Large Objects)

#### 1. Сравнение с TOAST
- **Основное отличие**:
  - **TOAST**: Данные хранятся в служебных таблицах, создаваемых для каждой основной таблицы.
  - **Large Objects**: Все большие объекты хранятся в единой системной таблице `pg_largeobject`.

- **Интерфейс**:
  - **TOAST**: Прозрачный интерфейс, работа с данными происходит через стандартные SQL-запросы.
  - **Large Objects**: Требует использования специального интерфейса, который может не поддерживаться всеми драйверами.

#### 2. Интерфейс работы
- **Создание и загрузка**:
  - **Функция `lo_import`**: Загружает файл в базу данных и возвращает OID (идентификатор объекта).
  - **Пример**:
    ```sql
    INSERT INTO demo_table (file_name, data_oid)
    VALUES ('bookstore2.sql', lo_import('/home/student/bookstore2.sql'));
    ```

- **Чтение данных**:
  - **Функция `lo_get`**: Читает часть данных по указанному OID.
  - **Пример**:
    ```sql
    SELECT lo_get(data_oid, 1, 16) FROM demo_table;
    ```

- **Удаление данных**:
  - Удаление записи из пользовательской таблицы не удаляет сам большой объект из `pg_largeobject`.
  - Для очистки потерянных объектов используется утилита `vacuumlo`.

#### 3. Преимущества
- **Размер значения**:
  - Максимальный размер объекта: до 4 ТБ.
- **Потоковое чтение и запись**:
  - Возможность изменять отдельные фрагменты данных без загрузки всего объекта.
- **Интерфейс**:
  - Набор специальных функций для работы с большими объектами.

#### 4. Ограничения
- **Увеличение размера базы данных**:
  - Как и в случае с TOAST, увеличивается объем WAL-логов.
- **Скорость работы**:
  - Медленнее, чем работа с файловой системой.
- **Ограничение на количество объектов**:
  - Идентификатор типа OID ограничивает общее количество объектов (до ~4 миллиардов).

#### 5. Практические примеры использования
- **Создание таблицы**:
  - Создается таблица с двумя столбцами: `file_name` и `data_oid` (тип OID).
- **Загрузка данных**:
  - Файл загружается в базу данных с помощью функции `lo_import`.
- **Чтение данных**:
  - Чтение части данных с использованием функции `lo_get`.

#### 6. Управление потерянными объектами
- **Проблема потерянных объектов**:
  - При удалении записи из пользовательской таблицы большой объект остается в `pg_largeobject`.
- **Решение**:
  - **Утилита `vacuumlo`**:
    - Сканирует таблицы базы данных и удаляет объекты, на которые нет ссылок.
    - Пример использования:
      ```bash
      vacuumlo -v bookstore2
      ```
  - **Расширение `lo`**:
    - Предоставляет тип данных и триггерную функцию для автоматического удаления объектов при удалении строк.
    - Пример создания таблицы и триггера:
      ```sql
      CREATE TABLE demo_lo (
          file_name text,
          data_oid oid
      );

      CREATE TRIGGER remove_lo
      BEFORE UPDATE OR DELETE ON demo_lo
      FOR EACH ROW EXECUTE FUNCTION lo_manage(data_oid);
      ```

Эта часть конспекта подробно охватывает подсистему больших объектов, включая сравнение с TOAST, интерфейс работы, преимущества, ограничения и практические примеры использования.

