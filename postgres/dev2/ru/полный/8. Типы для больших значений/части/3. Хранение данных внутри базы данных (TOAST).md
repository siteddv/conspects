### Часть 3: Хранение данных внутри базы данных (TOAST)

#### 1. Типы данных bytea и text
- **bytea**:
  - Предназначен для хранения двоичных данных.
  - Данные выводятся в шестнадцатеричном формате по умолчанию (параметр `bytea_output`).
  - Возможность использования различных операторов и функций для работы с двоичными данными, например, конкатенация строк.

- **text**:
  - Предназначен для хранения символьных данных.
  - Нет особых ограничений на размер строки, если она помещается в основную таблицу.

#### 2. Механизм работы TOAST
- **Создание служебной таблицы**:
  - При создании таблицы с потенциально большими атрибутами автоматически создается служебная таблица TOAST.
  - Служебная таблица находится в отдельной схеме `pg_toast`.

- **Структура служебной таблицы**:
  - **chunk_id**: Идентификатор длинного значения.
  - **chunk_seq**: Порядковый номер фрагмента значения.
  - **chunk_data**: Значение фрагмента данных.

- **Уникальный индекс**:
  - Уникальный индекс по первым двум столбцам (`chunk_id`, `chunk_seq`) для быстрого получения всех фрагментов значения.

#### 3. Стратегии хранения данных
- **extended**:
  - Использует сжатие данных перед выносом в служебную таблицу.
  - Подходит для данных, которые хорошо сжимаются.

- **main**:
  - Переносится в последнюю очередь.
  - Также использует сжатие данных.

- **external**:
  - Не допускает сжатия данных.
  - Подходит для уже сжатых данных (например, изображения, видео).

- **plain**:
  - Только для столбцов фиксированной ширины.
  - Всегда остаются в основной таблице.

#### 4. Особенности работы с большими атрибутами
- **Вынос данных**:
  - Если значение не помещается на странице основной таблицы, оно выносится в служебную таблицу TOAST.
  - Вынос происходит только при необходимости.

- **Чтение данных**:
  - При обращении к длинному атрибуту данные собираются из фрагментов в служебной таблице.
  - Возможна частичная декомпрессия данных (начиная с версии 12 PostgreSQL).

- **Изменение данных**:
  - При изменении строки в основной таблице новая версия строки ссылается на предыдущее значение, если длинные атрибуты не менялись.
  - Это позволяет экономить ресурсы при обновлениях.

#### 5. Преимущества и недостатки TOAST
- **Преимущества**:
  - Возможность хранения больших данных (до 1 ГБ).
  - Прозрачное управление данными для приложения.
  - Возможность использования транзакционных механизмов и управления доступом средствами СУБД.

- **Недостатки**:
  - Увеличение размера базы данных.
  - Увеличение объема WAL-логов.
  - Более медленная работа по сравнению с файловой системой.
  - При изменении даже небольшого фрагмента данных весь атрибут загружается в буферный кэш и изменяется целиком.

Эта часть конспекта подробно охватывает механизм работы TOAST, стратегии хранения данных, особенности работы с большими атрибутами, а также преимущества и недостатки использования TOAST.

