### Часть 4: Настройка и конфигурация полнотекстового поиска

#### Параметризация и использование разных словарей для разных типов фрагментов
Полнотекстовый поиск предоставляет возможность настраивать процесс обработки текста с высокой степенью гибкости. Основным инструментом настройки является **конфигурация**, которая определяет, какой анализатор и какие словари будут использоваться для каждого типа фрагмента.

1. **Цепочки словарей**:
   - Каждый тип фрагмента (например, слова, числа, email-адреса) может быть обработан через свою собственную цепочку словарей.
   - Например, для слов можно использовать стеммер, который приводит слова к их базовой форме, а для email-адресов или URL-адресов словари вообще не нужны.
   - Цепочка словарей работает следующим образом:
     - Первый словарь в цепочке пытается распознать фрагмент. Если он успешно распознал фрагмент, то результат передается дальше, и последующие словари уже не вызываются.
     - Если первый словарь не смог распознать фрагмент, то он передается следующему словарю в цепочке.
     - Например, если мы имеем дело со словом на английском языке, то сначала может быть вызван словарь стеммера, который приведет слово к его базовой форме. Если же слово не было распознано стеммером, то оно может быть передано в словарь синонимов или другой словарь.

2. **Настройка конфигураций для различных языков**:
   - PostgreSQL предоставляет предопределенные конфигурации для разных языков (например, `english`, `russian`, `french` и т.д.). Эти конфигурации содержат настройки для работы с конкретным языком, включая использование соответствующих словарей и анализаторов.
   - Вы можете создавать свои собственные конфигурации, изменяя цепочки словарей или добавляя новые словари. Например, можно настроить конфигурацию так, чтобы для английских слов использовался словарь, который удаляет критические знаки (например, точки или запятые).

3. **Пример изменения конфигурации**:
   - Предположим, что мы хотим, чтобы для английских слов удалялись критические знаки. Для этого нам нужно создать новую конфигурацию, где первым словарем будет словарь, удаляющий критические знаки, а вторым — стеммер.
   - Пример команды для изменения конфигурации:
     ```sql
     ALTER TEXT SEARCH CONFIGURATION english
     ALTER MAPPING FOR word WITH unaccent, english_stem;
     ```
   - Здесь `unaccent` — это словарь, который удаляет акценты и другие критические знаки, а `english_stem` — это стеммер для английского языка.

#### Создание и использование индексов для ускорения поиска
Индексы играют ключевую роль в ускорении полнотекстового поиска. В PostgreSQL есть несколько типов индексов, которые могут быть использованы для этой цели:

4. **GIN (Generalized Inverted Index)**:
   - GIN — это наиболее часто используемый тип индекса для полнотекстового поиска. Он позволяет индексировать составные значения, такие как массивы лексем.
   - Преимущества GIN:
     - Высокая точность поиска.
     - Компактный размер по сравнению с другими типами индексов.
   - Недостатки GIN:
     - Медленное обновление при добавлении новых документов, особенно если документы состоят из большого количества фрагментов.

5. **GiST (Generalized Search Tree)**:
   - GiST — это еще один тип индекса, который может быть использован для полнотекстового поиска. Он менее точен, чем GIN, но быстрее обновляется.
   - Преимущества GiST:
     - Быстрое обновление при частых изменениях документов.
   - Недостатки GiST:
     - Точность поиска ниже, чем у GIN.
     - Все найденные значения требуют перепроверки.

6. **Расширение pg_trgm**:
   - Расширение `pg_trgm` предоставляет дополнительные возможности для полнотекстового поиска, такие как поддержка триграмм (трехсимвольных последовательностей).
   - Преимущества `pg_trgm`:
     - Позволяет выполнять более сложные операции, такие как поиск ближайших соседей.
     - Может использоваться для ранжирования результатов.
   - Недостатки `pg_trgm`:
     - Требует больше места для хранения данных.
     - Может работать медленнее, чем GIN, при больших объемах данных.

7. **Создание индекса**:
   - Для создания индекса используется команда `CREATE INDEX`. Например, для создания GIN-индекса:
     ```sql
     CREATE INDEX idx_fts ON documents USING GIN(to_tsvector('english', text));
     ```
   - Здесь `to_tsvector` — это функция, которая преобразует текст в `tsvector`, а `'english'` — это конфигурация полнотекстового поиска.

8. **Использование индексов для ускорения запросов**:
   - После создания индекса запросы выполняются значительно быстрее, так как система может использовать индекс для быстрого поиска нужных лексем.
   - Пример запроса с использованием индекса:
     ```sql
     SELECT * FROM documents
     WHERE to_tsvector('english', text) @@ to_tsquery('magic & time');
     ```

#### Дополнительные настройки
- **Вычисление релевантности**:
  - Функция `ts_rank` может использоваться для вычисления релевантности документов. Она принимает `tsvector` и `tsquery` и возвращает значение, которое можно использовать для сортировки результатов.
  - Пример использования `ts_rank`:
    ```sql
    SELECT *, ts_rank(to_tsvector(text), to_tsquery('magic & time')) AS rank
    FROM documents
    WHERE to_tsvector(text) @@ to_tsquery('magic & time')
    ORDER BY rank DESC
    LIMIT 10;
    ```

- **Ограничение результатов**:
  - Для ограничения количества возвращаемых результатов используется оператор `LIMIT`. Например, чтобы получить только 10 самых релевантных документов:
    ```sql
    SELECT * FROM documents
    WHERE to_tsvector(text) @@ to_tsquery('magic & time')
    ORDER BY ts_rank(to_tsvector(text), to_tsquery('magic & time')) DESC
    LIMIT 10;
    ```

#### Итоги
Настройка и конфигурация полнотекстового поиска — это мощный инструмент, который позволяет адаптировать систему под конкретные задачи. Основные шаги включают:
9. Настройку цепочек словарей для разных типов фрагментов.
10. Создание и использование индексов для ускорения поиска.
11. Вычисление релевантности и сортировка результатов.

Эта часть конспекта подробно описывает настройку и конфигурацию полнотекстового поиска. В следующей части мы рассмотрим практическое применение полнотекстового поиска на примере книжного магазина.

