### **8. Заключение и практические задания**

#### **Итоги**
1. **Расширяемость PostgreSQL**:
   - PostgreSQL предоставляет мощные инструменты для расширения функциональности, включая создание пользовательских типов данных, классов операторов и методов доступа.
   - Методы доступа (табличные и индексные) обеспечивают гибкость при работе с данными.

2. **Классы операторов**:
   - Классы операторов служат связующим звеном между методами доступа и типами данных.
   - Они позволяют методам доступа работать с новыми типами данных, реализуя необходимые операции сравнения и другие функции.

3. **Методы доступа**:
   - B-tree: Используется для упорядоченных данных.
   - GiST: Обобщённое дерево поиска, которое работает с произвольными предикатами.
   - Другие методы доступа (GIN, Hash и т.д.) имеют свои области применения.

---

#### **Практические задания**

##### **Задание 1: Ограничение целостности для пересекающихся интервалов**
4. **Цель**:
   - Добавить ограничение целостности в таблицу с ценами на книжки, чтобы запретить создание пересекающихся интервалов действия цены для одной книги.

5. **Шаги выполнения**:
   - Создайте таблицу, если она еще не существует:
     ```sql
     CREATE TABLE book_prices (
         book_id integer,
         price_range tsrange,
         EXCLUDE USING gist (book_id WITH =, price_range WITH &&)
     );
     ```
   - Проверьте, что индекс, созданный автоматически для поддержки ограничения, используется в запросах.

6. **Проверка**:
   - Вставьте данные с пересекающимися интервалами и убедитесь, что возникает ошибка:
     ```sql
     INSERT INTO book_prices VALUES (1, '[2023-01-01, 2023-06-01)');
     INSERT INTO book_prices VALUES (1, '[2023-05-01, 2023-12-01)');
     ```

---

##### **Задание 2: Создание класса операторов для правильной сортировки**
7. **Цель**:
   - Написать класс операторов для типа данных "формат издания", чтобы сортировка выполнялась по площади листа, а не лексикографически.

8. **Шаги выполнения**:
   - Создайте функцию, которая вычисляет площадь листа для каждого формата:
     ```sql
     CREATE FUNCTION format_area(format_type) RETURNS numeric AS $$
     BEGIN
         RETURN width($1) * height($1);
     END;
     $$ LANGUAGE plpgsql;
     ```
   - Создайте операторы сравнения (`<`, `<=`, `=`, `>=`, `>`) на основе этой функции.
   - Создайте класс операторов для метода доступа B-tree:
     ```sql
     CREATE OPERATOR CLASS format_ops
     DEFAULT FOR TYPE format_type USING btree AS
     OPERATOR 1 <,
     OPERATOR 2 <=,
     OPERATOR 3 =,
     OPERATOR 4 >=,
     OPERATOR 5 >,
     FUNCTION 1 format_cmp;
     ```

9. **Проверка**:
   - Отсортируйте данные по формату издания и убедитесь, что сортировка выполняется корректно:
     ```sql
     SELECT * FROM formats ORDER BY format_column;
     ```

---

##### **Дополнительные задания**
10. **Оптимизация запросов с оператором `LIKE`**:
   - Изучите расширение `pg_trgm`, которое добавляет поддержку триграмм для работы с текстовыми данными.
   - Создайте GiST-индекс для столбца с текстовыми данными:
     ```sql
     CREATE EXTENSION pg_trgm;
     CREATE INDEX ON table USING gist (column gist_trgm_ops);
     ```
   - Проверьте, как индекс ускоряет запросы с оператором `LIKE`, где шаблон начинается с `%`.

11. **Поиск ближайших соседей**:
   - Используйте оператор расстояния (`<->`) для поиска ближайших точек:
     ```sql
     SELECT * FROM points
     ORDER BY location <-> point(0, 0)
     LIMIT 5;
     ```

---

#### **Заключение**
PostgreSQL предлагает широкие возможности для расширения функциональности, включая создание пользовательских типов данных, классов операторов и методов доступа. Эти инструменты позволяют решать сложные задачи, такие как работа с пересекающимися интервалами времени, поиск ближайших соседей и оптимизация запросов с оператором `LIKE`. 

Это завершает конспект видео. Если у вас есть дополнительные вопросы или требуется уточнение, пожалуйста, дайте знать!

