### Часть 1: Введение в устройство страниц данных

#### 1.1 Общая структура страниц данных
- **Страницы данных** — основной строительный блок для хранения информации в PostgreSQL. Они могут быть как табличными, так и индексными.
- Размер страницы по умолчанию составляет **8 КБ** (8192 байта). Этот размер можно изменить только при сборке PostgreSQL из исходного кода (доступны варианты 16 КБ и 32 КБ).
- Страницы разных типов (табличные и индексные) имеют схожую структуру, что упрощает их обработку в **буферном кэше**.

#### 1.2 Структура табличной страницы
- **Заголовок страницы**:
  - Расположен в начале страницы.
  - Содержит служебную информацию о странице.
  - Занимает первые **28 байт**.
- **Массив указателей**:
  - Следует за заголовком.
  - Хранит указатели на версии строк, расположенные в конце страницы.
  - Указатели содержат:
    - Адрес начала строки.
    - Смещение внутри страницы.
    - Длину строки.
- **Свободное место**:
  - Находится между заголовком и данными.
  - Размер свободного места зависит от количества данных на странице.
  - Например, в примере свободное место начинается с **8160 байта**.
- **Данные (версии строк)**:
  - Располагаются с конца страницы.
  - Каждая версия строки имеет свой заголовок и данные.
  - Заголовок строки занимает **24 байта** (с учетом выравнивания).

#### 1.3 Особенности хранения данных
- **Выравнивание данных**:
  - Для оптимизации доступа к данным используется выравнивание по границам машинных слов.
  - Например, столбец типа `CHAR(1)` занимает **4 байта**, хотя фактически требуется только 1 байт.
  - Это приводит к "пустым" пропускам в структуре данных.
- **Пример структуры таблицы**:
  - Если таблица содержит столбцы типа `CHAR(1)` и `INTEGER`, то:
    - `CHAR(1)` займет 4 байта (вместо 1).
    - `INTEGER` займет 4 байта.
    - Общее использование памяти будет больше, чем фактический объем данных.

#### 1.4 Структура индексной страницы
- Индексные страницы имеют схожую структуру с табличными:
  - Заголовок.
  - Массив указателей.
  - Специальная область (зависит от типа индекса).
- **Особенности индексных строк**:
  - Содержат индексируемое значение.
  - Содержат указатель на соответствующую строку в табличной странице.
  - Например, если таблица содержит три строки и создан индекс, то в индексной странице будут три строки, каждая из которых ссылается на соответствующую строку в таблице.

#### 1.5 Косвенная адресация
- **Косвенная адресация** используется для ссылок из индексных страниц на табличные строки:
  - Индексная строка содержит указатель на строку в табличной странице, а не напрямую на данные.
  - Это позволяет:
    - Реорганизовывать данные в табличной странице без изменения индексов.
    - Обновлять только указатели в индексах, а не сами индексные строки.

#### 1.6 Буферный кэш
- **Буферный кэш** — это область оперативной памяти, где хранятся страницы данных.
- Страницы читаются с диска в буферный кэш без преобразования.
- Из-за платформозависимых особенностей (например, размер машинного слова) данные нельзя напрямую переносить между разными платформами.

#### 1.7 Практический пример
- Создана таблица `t` с двумя столбцами:
  - `id` (числовой).
  - `c` (строковый).
- Создан индекс по столбцу `c`.
- Добавлена одна строка: `(42, 'foo')`.
- Использовано расширение `pageinspect` для анализа структуры страниц:
  - Функция `get_raw_page` показывает "сырой" вид страницы.
  - Можно получить информацию о заголовке страницы и массиве указателей.

---

Это завершает первую часть конспекта. Хотите продолжить со второй части?

