# 2. Внутреннее устройство

## Описание

Эта глава посвящена внутреннему устройству PostgreSQL. Мы рассмотрим введение в устройство страниц данных, версии строк и их хранение, журнал транзакций и механизм фиксации изменений, операции с данными, снимки данных и видимость строк, а также практические аспекты и оптимизацию.

## Части главы

- [[части/1. Введение в устройство страниц данных|1. Введение в устройство страниц данных]] [1. Введение в устройство страниц данных](части/1. Введение в устройство страниц данных.md)
- [[части/2. Версии строк и их хранение|2. Версии строк и их хранение]] [2. Версии строк и их хранение](части/2. Версии строк и их хранение.md)
- [[части/3. Журнал транзакций и механизм фиксации изменений|3. Журнал транзакций и механизм фиксации изменений]] [3. Журнал транзакций и механизм фиксации изменений](части/3. Журнал транзакций и механизм фиксации изменений.md)
- [[части/4. Операции с данными|4. Операции с данными]] [4. Операции с данными](части/4. Операции с данными.md)
- [[части/5. Снимки данных и видимость строк|5. Снимки данных и видимость строк]] [5. Снимки данных и видимость строк](части/5. Снимки данных и видимость строк.md)
- [[части/6. Практические аспекты и оптимизация|6. Практические аспекты и оптимизация]] [6. Практические аспекты и оптимизация](части/6. Практические аспекты и оптимизация.md)

---

Страницы данных являются основным строительным блоком для хранения информации в PostgreSQL. Они могут быть как табличными, так и индексными. Размер страницы по умолчанию составляет 8 КБ (8192 байта), и этот размер можно изменить только при сборке PostgreSQL из исходного кода. Страницы разных типов имеют схожую структуру, что упрощает их обработку в буферном кэше.

Структура табличной страницы включает заголовок страницы (первые 28 байт), массив указателей на версии строк, свободное место и данные (версии строк), которые располагаются с конца страницы. Каждая версия строки имеет заголовок, который занимает 24 байта с учетом выравнивания. Для оптимизации доступа к данным используется выравнивание по границам машинных слов, что может приводить к "пустым" пропускам в структуре данных.

Индексные страницы имеют схожую структуру с табличными, но их содержимое зависит от типа индекса. Косвенная адресация используется для ссылок из индексных страниц на табличные строки, что позволяет реорганизовывать данные в табличной странице без изменения индексов.

Каждая версия строки имеет заголовок, содержащий поля xmin и xmax. Поле xmin хранит номер транзакции, которая создала данную версию строки, а поле xmax хранит номер транзакции, которая удалила или изменила данную версию строки. В PostgreSQL существует специальный журнал транзакций (clog), который хранит статус каждой транзакции. Помимо номеров транзакций, в заголовке строки хранятся биты, которые помогают определить статус транзакций.

При выполнении команды COMMIT изменения фиксируются в журнале транзакций, а не в самих данных таблицы или индекса. Это позволяет избежать массовых обновлений данных при фиксации транзакции. Задача обновления битов в заголовках строк перекладывается на следующую читающую транзакцию, что оптимизирует работу с журналом.

При выполнении команды INSERT новая строка добавляется в таблицу, и одновременно создается соответствующая запись в индексе, если он существует. В поле xmin новой строки записывается номер текущей транзакции, а поле xmax устанавливается в значение 0. При выполнении команды DELETE текущая транзакция записывает свой номер в поле xmax строки. При выполнении команды UPDATE создается новая версия строки, а старая версия помечается как удаленная.

Если обновление не затрагивает индексируемые столбцы, PostgreSQL использует оптимизацию HOT-обновление (Heap-Only Tuple), что позволяет избежать создания новых записей в индексе. Это снижает нагрузку на индексы и уменьшает объем данных, которые нужно обрабатывать при последующих операциях.

Снимок данных — это согласованная картина состояния базы данных на определенный момент времени. Ось времени в PostgreSQL измеряется не в секундах или миллисекундах, а в номерах транзакций. Горизонт событий — это граница, за которой находятся только завершенные (зафиксированные) транзакции. Для базы данных горизонт событий определяется минимальным значением xmin среди всех активных транзакций.

Правила видимости строк определяют, какие данные доступны для чтения в рамках текущей транзакции. Версия строки видима, если транзакция, создавшая строку (xmin), завершена и зафиксирована до момента создания снимка данных, и транзакция, удалившая строку (xmax), еще не завершена или была отменена. На уровне READ COMMITTED снимок данных создается в начале каждого оператора, что может приводить к аномалии "неповторяемого чтения". На уровнях REPEATABLE READ и SERIALIZABLE снимок данных создается один раз в начале первого оператора транзакции.

Все страницы данных загружаются в буферный кэш без преобразований. Буферный кэш уменьшает количество операций чтения/записи на диск и оптимизирует производительность. PostgreSQL автоматически удаляет устаревшие версии строк через процесс очистки (VACUUM). Длительные транзакции могут удерживать горизонт событий, что предотвращает удаление устаревших версий строк, поэтому рекомендуется минимизировать время выполнения транзакций.

