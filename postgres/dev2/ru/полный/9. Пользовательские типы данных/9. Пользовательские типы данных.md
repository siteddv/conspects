# 9. Пользовательские типы данных

## Описание

Эта глава посвящена работе с пользовательскими типами данных в PostgreSQL. Мы рассмотрим введение и обзор типов данных, составные типы и перечисления, диапазонные типы и интервалы, домены и пользовательские типы, а также операторы и приведение типов.

## Части главы

- [[части/1. Введение и обзор типов данных|1. Введение и обзор типов данных]] [1. Введение и обзор типов данных](части/1. Введение и обзор типов данных.md)
- [[части/2. Составные типы и перечисления|2. Составные типы и перечисления]] [2. Составные типы и перечисления](части/2. Составные типы и перечисления.md)
- [[части/3. Диапазонные типы и интервалы|3. Диапазонные типы и интервалы]] [3. Диапазонные типы и интервалы](части/3. Диапазонные типы и интервалы.md)
- [[части/4. Домены и пользовательские типы|4. Домены и пользовательские типы]] [4. Домены и пользовательские типы](части/4. Домены и пользовательские типы.md)
- [[части/5. Операторы и приведение типов|5. Операторы и приведение типов]] [5. Операторы и приведение типов](части/5. Операторы и приведение типов.md)

---

PostgreSQL позволяет расширять систему типов без пересборки ядра. Это одна из ключевых особенностей PostgreSQL — возможность добавлять новые типы данных "на лету". Основные категории типов данных включают традиционные типы (числа, строки, даты), слабо структурированные данные (JSON, XML), специализированные типы (геометрические данные, диапазоны, интервалы, домены, перечисления) и массивы (для любого базового типа автоматически поддерживается массив этого типа).

Составной тип состоит из набора именованных атрибутов, каждый из которых имеет свой тип. По сути, составной тип представляет собой строку таблицы. При создании таблицы автоматически создается соответствующий составной тип, который можно использовать в функциях, указывая имя таблицы как тип данных.

Типы перечислений (ENUM) представляют собой упорядоченный набор значений. Значения хранятся как строки, но занимают всего 4 байта в базе данных. Упорядоченность означает, что значения можно сравнивать. Новые значения можно добавить с помощью команды `ALTER TYPE`, но удаление значений из перечисления невозможно — для этого нужно создать новый тип перечисления.

Диапазонный тип основан на каком-либо базовом скалярном типе, который должен быть упорядоченным. Он представляет собой интервал значений от начальной точки до конечной и может быть открытый, закрытый или неограниченный. PostgreSQL предоставляет несколько встроенных диапазонных типов: `int4range`, `int8range` (для целых чисел), `numrange` (для чисел с плавающей точкой), `tsrange`, `tstzrange` (для временных меток) и `daterange` (для дат). Для создания нового диапазонного типа необходимо базовый тип данных и функция разности двух значений, которая возвращает значение типа `double precision`.

Интервал представляет собой промежуток времени, выраженный в единицах времени (дни, месяцы, годы и т.д.). Интервалы могут иметь разную фактическую длину в зависимости от контекста. Например, `INTERVAL '1 month'` может означать 28 дней (февраль) или 31 день (март).

Домен — это объект базы данных, который позволяет для существующего типа данных дополнительно ограничить диапазон возможных значений. Можно задать ограничение `NOT NULL`, значения по умолчанию и ограничение проверки (`CHECK`), которое автоматически проверяет значения базового типа. Все операции выполняются над значениями базового типа, а не над самим доменом, что означает, что домены не препятствуют выполнению операций, которые могут быть логически некорректными.

Приведение типов позволяет преобразовать значение одного типа в другой. Для создания пользовательского преобразования используется команда `CREATE CAST`. Можно указать, что преобразование должно выполняться неявно (без явного приведения). Пользовательские операторы позволяют упростить вызов функций и сделать код более наглядным. Операторы могут быть унарными (префиксными или постфиксными) или бинарными. Начиная с PostgreSQL 14, поддержка постфиксных операторов будет запрещена, за исключением оператора факториала (`!`).

