### Часть 2: Технические аспекты реализации репликации

#### Механизм работы с WAL (Write-Ahead Logging)
Физическая репликация основана на передаче журнальных записей (WAL - Write-Ahead Logging) с основного сервера на резервный. WAL представляет собой механизм, который фиксирует все изменения в базе данных до их фактического применения к данным. Это обеспечивает возможность восстановления после сбоев.

- **Процесс записи WAL**:
  - На основном сервере все изменения записываются в WAL.
  - Эти записи затем транслируются на резервный сервер (реплику).
  - Реплика находится в режиме восстановления и постоянно применяет полученные записи.

- **Режим восстановления**:
  - Процесс `startup` на реплике постоянно работает, применяя записи WAL.
  - Это гарантирует, что реплика всегда актуальна и является точной копией основного сервера.

#### Требования к совместимости серверов
Для успешной работы физической репликации необходима двоичная совместимость между основным сервером и репликой:

- **Платформенная совместимость**:
  - Основной сервер и реплика должны работать на одной и той же платформе (например, Linux x86_64).

- **Версии PostgreSQL**:
  - Оба сервера должны использовать одну и ту же основную версию PostgreSQL. Например, если основной сервер использует версию 12, то и реплика должна быть версии 12.

#### Ограничения физической репликации
Физическая репликация имеет несколько важных ограничений, которые необходимо учитывать при её использовании:

- **Однонаправленный поток данных**:
  - Данные всегда передаются только от основного сервера (мастера) к резервному (реплике). Обратная передача данных невозможна.

- **Полная репликация кластера**:
  - Невозможно реплицировать отдельные базы данных или объекты. Репликация всегда охватывает весь кластер баз данных.

- **Уровень журнала WAL**:
  - Для репликации требуется уровень журнала `replica`, который записывает больший объем информации по сравнению с уровнем `minimal`.
  - Уровень `minimal` может не записывать некоторые команды, такие как `CREATE INDEX CONCURRENTLY`, что недопустимо для репликации.

#### Архитектура взаимодействия процессов
- **Процессы на основном сервере**:
  - `wal sender`: Отправляет WAL-записи на реплику.
  
- **Процессы на резервном сервере**:
  - `wal receiver`: Получает WAL-записи от основного сервера.
  - `startup`: Применяет полученные записи к данным.

#### Сценарии отказа и восстановления
- **Прерывание соединения**:
  - Если соединение между серверами прерывается, реплика может временно использовать архивированные сегменты WAL для продолжения работы.
  - После восстановления соединения процесс `wal receiver` снова начинает получать данные напрямую от `wal sender`.

- **Отложенная репликация**:
  - Можно настроить реплику так, чтобы она намеренно отставала от основного сервера на определенный интервал времени (например, 3 часа). Это полезно для восстановления данных на момент времени до возникновения ошибки.

#### Параметры конфигурации
- **Основные параметры postgresql.conf**:
  - `wal_level = replica`: Устанавливает уровень журналирования, необходимый для репликации.
  - `max_wal_senders`: Определяет максимальное количество процессов `wal sender`, которые могут быть запущены на основном сервере.

- **Права доступа**:
  - В файле `pg_hba.conf` должны быть настроены соответствующие разрешения для подключения по протоколу репликации.

#### Заключение
Технические аспекты реализации физической репликации включают в себя сложные механизмы работы с WAL, строгие требования к совместимости серверов и ряд ограничений, которые необходимо учитывать при проектировании системы. Понимание этих аспектов позволяет эффективно использовать репликацию для обеспечения высокой доступности и масштабируемости баз данных.

Хотите перейти к следующей части, где мы рассмотрим настройку и конфигурацию репликации?

