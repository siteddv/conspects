# 18. Физическая репликация

## Описание

Эта глава посвящена физической репликации в PostgreSQL. Мы рассмотрим введение в физическую репликацию, технические аспекты реализации репликации, настройку и конфигурацию репликации, работу с репликой и её возможности, продвинутые темы и особенности использования, а также переключение на реплику и аварийное восстановление.

## Части главы

- [[части/1. Введение в физическую репликацию|1. Введение в физическую репликацию]] [1. Введение в физическую репликацию](части/1. Введение в физическую репликацию.md)
- [[части/2. Технические аспекты реализации репликации|2. Технические аспекты реализации репликации]] [2. Технические аспекты реализации репликации](части/2. Технические аспекты реализации репликации.md)
- [[части/3. Настройка и конфигурация репликации|3. Настройка и конфигурация репликации]] [3. Настройка и конфигурация репликации](части/3. Настройка и конфигурация репликации.md)
- [[части/4. Работа с репликой и её возможности|4. Работа с репликой и её возможности]] [4. Работа с репликой и её возможности](части/4. Работа с репликой и её возможности.md)
- [[части/5. Продвинутые темы и особенности использования|5. Продвинутые темы и особенности использования]] [5. Продвинутые темы и особенности использования](части/5. Продвинутые темы и особенности использования.md)
- [[части/6. Переключение на реплику и аварийное восстановление|6. Переключение на реплику и аварийное восстановление]] [6. Переключение на реплику и аварийное восстановление](части/6. Переключение на реплику и аварийное восстановление.md)

---

Физическая репликация — это процесс синхронизации нескольких кластеров баз данных, при котором один сервер (основной или мастер) передает все изменения на другой сервер (реплику). Реплика является полной копией основного сервера, и все изменения, происходящие на основном сервере, автоматически применяются к реплике. Физическая репликация работает на уровне журнальных записей (WAL - Write-Ahead Logging), что обеспечивает точное копирование всех изменений. Основные цели использования физической репликации включают обеспечение высокой доступности и отказоустойчивости (если основной сервер выходит из строя, можно быстро переключиться на реплику) и масштабируемость (реплика допускает подключение для выполнения читающих запросов, что позволяет распределить нагрузку по разным серверам).

Физическая репликация имеет несколько важных особенностей и ограничений. Данные всегда передаются только от основного сервера (мастера) к резервному (реплике). Обратная передача данных невозможна. Реплика должна работать на той же платформе и версии PostgreSQL, что и основной сервер. Невозможно реплицировать отдельные базы данных или объекты. Репликация всегда охватывает весь кластер баз данных. Для репликации требуется уровень журнала `replica`, который записывает больший объем информации по сравнению с уровнем `minimal`. Уровень `minimal` может не записывать некоторые команды, такие как `CREATE INDEX CONCURRENTLY`, что недопустимо для репликации.

Физическая репликация основана на передаче журнальных записей (WAL) с основного сервера на резервный. На основном сервере все изменения записываются в WAL. Эти записи затем транслируются на резервный сервер (реплику). Реплика находится в режиме восстановления и постоянно применяет полученные записи. Процесс `startup` на реплике постоянно работает, применяя записи WAL. Это гарантирует, что реплика всегда актуальна и является точной копией основного сервера. Архитектура взаимодействия процессов включает `wal sender` на основном сервере (отправляет WAL-записи на реплику), `wal receiver` на резервном сервере (получает WAL-записи от основного сервера) и `startup` на резервном сервере (применяет полученные записи к данным).

Настройка физической репликации требует корректной конфигурации основного сервера PostgreSQL. Ключевые параметры включают `wal_level = replica` (определяет уровень детализации записей WAL, для физической репликации требуется значение `replica`), `max_wal_senders` (задает максимальное количество процессов `wal sender`, которые могут быть запущены на основном сервере) и `hot_standby` (позволяет выполнять читающие запросы на реплике во время восстановления). Создание резервного сервера включает использование утилиты `pg_basebackup` с ключом `-R` для автоматического добавления необходимых конфигурационных параметров. В файле `pg_hba.conf` на основном сервере должны быть настроены соответствующие правила для подключения по протоколу репликации.

Реплика PostgreSQL, работающая в режиме физической репликации, имеет определенные ограничения на выполняемые операции. Можно выполнять команды `SELECT`, работать с курсорами, устанавливать конфигурационные параметры и управлять транзакциями (например, открывать транзакции с уровнем изоляции `REPEATABLE READ`). Однако нельзя выполнять команды, изменяющие данные (`INSERT`, `UPDATE`, `DELETE`), создавать или изменять таблицы, использовать блокировки и выполнять команды `VACUUM`. Физическая репликация может работать в двух основных режимах: асинхронный режим (транзакция на основном сервере завершается до того, как изменения достигнут реплики, обеспечивает более высокую производительность, но существует риск потери данных в случае сбоя) и синхронный режим (транзакция на основном сервере дожидается подтверждения от реплики о том, что изменения применены, обеспечивает более высокую надежность, но может снижать производительность).

Каскадная репликация — это схема, при которой одна реплика может передавать данные дальше на другие реплики. Это позволяет создавать цепочку реплик, уменьшая нагрузку на основной сервер и экономя сетевой трафик. Однако синхронная репликация возможна только между основным сервером и первой репликой. Чем длиннее цепочка, тем больше возможное отставание данных. Отложенная репликация позволяет намеренно задерживать применение изменений на реплике, что полезно для восстановления данных на момент времени до возникновения ошибки. Обратная связь позволяет реплике информировать мастер о необходимости сохранения определенных записей WAL, предотвращая конфликты при выполнении долгих запросов на реплике.

Переключение на реплику может происходить по двум основным сценариям: плановое переключение (выполняется вручную, может использоваться для проведения регламентных работ на основном сервере) и аварийное переключение (выполняется при сбое основного сервера, может быть как ручным, так и автоматическим при наличии соответствующего программного обеспечения). Для автоматизации процесса переключения используются специальные инструменты, такие как Patroni (популярный инструмент для управления кластерами PostgreSQL, обеспечивает автоматическое переключение при сбоях), Pgpool-II (прокси-сервер, который может выполнять автоматическое переключение) и Repmgr (инструмент для управления репликацией и failover процессом). При переключении критически важно остановить старый основной сервер перед началом записи на новую реплику, чтобы избежать расхождений данных.

