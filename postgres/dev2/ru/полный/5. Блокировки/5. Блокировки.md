# 5. Блокировки

## Описание

Эта глава посвящена блокировкам в PostgreSQL. Мы рассмотрим введение в блокировки и их назначение, блокировки объектов, блокировки строк, управление блокировками и ожиданиями, практические аспекты и наблюдение за блокировками, а также итоги и практические задания.

## Части главы

- [[части/1. Введение в блокировки и их назначение|1. Введение в блокировки и их назначение]] [1. Введение в блокировки и их назначение](части/1. Введение в блокировки и их назначение.md)
- [[части/2. Блокировки объектов|2. Блокировки объектов]] [2. Блокировки объектов](части/2. Блокировки объектов.md)
- [[части/3. Блокировки строк|3. Блокировки строк]] [3. Блокировки строк](части/3. Блокировки строк.md)
- [[части/4. Управление блокировками и ожиданиями|4. Управление блокировками и ожиданиями]] [4. Управление блокировками и ожиданиями](части/4. Управление блокировками и ожиданиями.md)
- [[части/5. Практические аспекты и наблюдение за блокировками|5. Практические аспекты и наблюдение за блокировками]] [5. Практические аспекты и наблюдение за блокировками](части/5. Практические аспекты и наблюдение за блокировками.md)
- [[части/6. Итоги и практические задания|6. Итоги и практические задания]] [6. Итоги и практические задания](части/6. Итоги и практические задания.md)

---

Блокировки — это механизм, который позволяет упорядочить конкурентный доступ к разделяемым ресурсам. Для того чтобы использовать разделяемый ресурс, процесс обязан захватить блокировку перед обращением к данным и освободить её после завершения работы с данными (обычно в конце транзакции). Блокировки могут быть двух основных типов: монопольные (исключительные) — могут удерживаться только одним процессом, и разделяемые — могут удерживаться несколькими процессами одновременно. Для управления совместимостью используется матрица совместимости блокировок, которая показывает, какие режимы блокировок могут сосуществовать.

Каждая транзакция в PostgreSQL имеет уникальный номер (или виртуальный номер), который используется для отслеживания изменений. Виртуальный номер транзакции выдается каждой транзакции на этапе чтения данных, а настоящий номер транзакции выдается только тогда, когда транзакция начинает изменять данные. Транзакция всегда удерживает исключительную блокировку собственного номера. Блокировка номера транзакции позволяет дождаться завершения другой транзакции.

PostgreSQL поддерживает 8 режимов блокировок отношений, которые позволяют различным командам работать одновременно, если это возможно: от самого слабого `AccessShareLock` (используется командой `SELECT`) до самого строгого `AccessExclusiveLock` (требуется для операций, таких как `DROP TABLE`). Очередь ожидания блокировок в PostgreSQL является честной: если одна транзакция удерживает блокировку, другие транзакции встают в очередь и ожидают освобождения блокировки, даже если их режим совместим с текущей блокировкой.

Блокировки строк в PostgreSQL имеют свои особенности. Информация о блокировках строк не хранится в оперативной памяти, а хранится непосредственно в страницах данных на диске. Для реализации блокировок строк используется поле `xmax` в строках данных, в которое записывается номер блокирующей транзакции. В PostgreSQL существует четыре режима блокировок строк: `FOR UPDATE` (самый строгий), `FOR NO KEY UPDATE`, `FOR SHARE` (разделяемый режим) и `FOR KEY SHARE` (наименее строгий). Для решения проблемы ограничения поля `xmax`, которое может содержать только один номер транзакции, PostgreSQL использует механизм мультитранзакций, который позволяет хранить несколько номеров транзакций в одном поле `xmax`.

В PostgreSQL существует возможность отказаться от ожидания освобождения блокировки с помощью ключевого слова `NOWAIT`, которое используется для немедленного получения ошибки, если блокировка не может быть захвачена. Механизм `SKIP LOCKED` позволяет пропустить уже заблокированные строки и перейти к тем, которые еще свободны, что особенно полезно в сценариях конкурентной обработки данных. Параметр `lock_timeout` позволяет установить максимальное время ожидания освобождения блокировки. Очередь ожидания блокировок строк организована с использованием блокировок объектов типа `tuple`, что делает её менее "честной", чем очередь блокировок объектов.

Представление `pg_locks` предоставляет информацию о текущих блокировках в системе и является основным инструментом для диагностики проблем с блокировками. Представление `pg_stat_activity` позволяет отслеживать текущие запросы, их состояние и возможные блокировки. Активное обновление одной и той же строки может привести к проблемам производительности, поэтому рекомендуется минимизировать такие "горячие точки" в системе.

