### Часть 3: Практическая настройка репликации

#### Создание публикаций
Для начала работы с логической репликацией необходимо создать **публикацию** на стороне сервера-источника. Это делается с помощью команды `CREATE PUBLICATION`. Публикация определяет, какие таблицы будут участвовать в репликации.

- **Создание публикации**:  
  ```sql
  CREATE PUBLICATION имя_публикации FOR TABLE имя_таблицы;
  ```
  Например:
  ```sql
  CREATE PUBLICATION my_publication FOR TABLE test_table;
  ```

- **Просмотр существующих публикаций**:  
  После создания публикации можно проверить её наличие с помощью команды:
  ```sql
  \dRp+
  ```
  Эта команда покажет все доступные публикации и их параметры.

#### Настройка подписок
На стороне подписчика создаётся **подписка**, которая указывает на публикацию, к которой нужно подключиться. Подписка создаётся с помощью команды `CREATE SUBSCRIPTION`.

- **Создание подписки**:  
  ```sql
  CREATE SUBSCRIPTION имя_подписки CONNECTION 'строка_подключения' PUBLICATION имя_публикации;
  ```
  Пример:
  ```sql
  CREATE SUBSCRIPTION my_subscription CONNECTION 'host=server1 dbname=testdb user=repuser' PUBLICATION my_publication;
  ```

- **Автоматическая начальная синхронизация**:  
  При создании подписки происходит автоматическая начальная синхронизация данных. Если таблица на стороне подписчика пустая, она будет заполнена данными из таблицы на стороне публикации. Это позволяет избежать ручной синхронизации данных перед началом репликации.

#### Начальная синхронизация данных
Одним из важных аспектов логической репликации является начальная синхронизация данных. PostgreSQL автоматически выполняет эту операцию при создании подписки, если таблица на стороне подписчика пустая.

- **Ручная синхронизация**:  
  Если таблица на стороне подписчика уже содержит данные, можно указать параметр `COPY DATA` при создании подписки, чтобы выполнить начальную синхронизацию:
  ```sql
  CREATE SUBSCRIPTION my_subscription CONNECTION 'host=server1 dbname=testdb user=repuser' PUBLICATION my_publication WITH (copy_data = true);
  ```

#### Работа со слотами репликации
При создании подписки на стороне публикующего сервера автоматически создаётся **слот репликации**. Этот объект отвечает за хранение информации о позиции WAL, до которой данные были переданы подписчику.

- **Значение слотов репликации**:  
  Слот репликации гарантирует, что WAL-записи не будут удалены до тех пор, пока они не будут применены на стороне подписчика. Это особенно важно при временных задержках или обрывах связи между серверами.

- **Удаление слота репликации**:  
  Если подписка больше не нужна, важно не забыть её удалить вместе со слотом репликации. Это освобождает ресурсы на стороне публикующего сервера:
  ```sql
  DROP SUBSCRIPTION имя_подписки;
  ```

#### Пример практической настройки
1. **Создание таблицы на обоих серверах**:  
   Перед настройкой репликации необходимо создать таблицу с одинаковой структурой на обоих серверах. Логическая репликация не передаёт команды DDL, поэтому структура таблиц должна быть создана вручную.

2. **Добавление данных на сервере-источнике**:  
   После настройки публикации и подписки можно добавлять данные на сервере-источнике. Эти изменения автоматически передаются на сервер-подписчик.

3. **Обработка конфликтов**:  
   Если на стороне подписчика уже есть данные, которые конфликтуют с данными из публикации, процесс репликации приостанавливается. Разрешить конфликт можно либо путём изменения данных на стороне подписчика, либо пропуском конфликтующей записи с помощью специальных функций.

---

Это завершает третью часть конспекта. Хотите продолжить с четвёртой частью?

