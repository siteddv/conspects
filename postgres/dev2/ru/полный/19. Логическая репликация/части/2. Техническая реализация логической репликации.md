### Часть 2: Техническая реализация логической репликации

#### Механизм передачи данных
Логическая репликация в PostgreSQL основана на механизме **WAL (Write-Ahead Logging)**, но с важным отличием от физической репликации. В процессе логической репликации WAL-записи декодируются для выделения информации о конкретных изменениях строк таблиц, которые участвуют в публикации. Этот процесс позволяет передавать не бинарные данные, а именно изменения строк.

Основной механизм передачи данных можно разбить на несколько этапов:
1. **Создание публикации**: На сервере-источнике (публикации) создаётся публикация для одной или нескольких таблиц. Это определяет, какие таблицы будут участвовать в репликации.
2. **Декодирование WAL-записей**: Процесс `wal sender` на стороне публикующего сервера читает WAL-записи и декодирует их, чтобы вычленить информацию об изменениях только тех таблиц, которые включены в публикацию.
3. **Передача изменений**: После завершения транзакции изменения передаются подписчику. Эти изменения передаются построчно, а не в виде SQL-команд.
4. **Применение изменений**: На стороне подписчика процесс `logical replication worker` принимает эти изменения и применяет их к соответствующим таблицам.

#### Работа с WAL (Write-Ahead Logging)
Для работы логической репликации требуется установка параметра `wal_level` на уровень `logical`. Это обеспечивает запись в WAL дополнительной информации, которая необходима для декодирования изменений конкретных таблиц. Без этой настройки логическая репликация работать не сможет.

- **Уровень `replica`** (который используется для физической репликации) недостаточен для логической репликации, так как он не содержит детальной информации о изменениях строк.
- Установка `wal_level = logical` требует перезагрузки сервера, что важно учитывать при планировании внедрения логической репликации.

#### Настройки и требования к системе
Для успешной работы логической репликации необходимо соблюдать следующие требования:
- **Совместимость протоколов**: Логическая репликация не требует совместимости на уровне бинарных данных, но требует совместимости на уровне протокола. Это позволяет организовать репликацию между серверами, работающими на разных платформах или даже разных версиях PostgreSQL.
- **Структура таблиц**: Структура таблиц должна быть предварительно создана на стороне подписчика. Логическая репликация не передаёт команды DDL (например, `CREATE TABLE`), поэтому структура таблиц должна быть одинаковой или совместимой на обоих серверах.
- **Идентификация строк**: Для корректного применения изменений строки должны быть однозначно идентифицируемы. По умолчанию используется первичный ключ, но можно настроить использование уникальных индексов или всех столбцов таблицы.

#### Процессы sender и receiver
В логической репликации участвуют два основных процесса:
1. **`wal sender`**:
   - Запускается на стороне публикующего сервера.
   - Читает WAL-записи, декодирует их и передаёт изменения подписчику.
   - Работает построчно и транзакционно, то есть изменения передаются только после завершения транзакции.

2. **`logical replication worker`**:
   - Запускается на стороне подписчика.
   - Принимает изменения от `wal sender` и применяет их к таблицам.
   - Работает от имени суперпользователя, что позволяет применять изменения к любым таблицам, независимо от прав доступа.

#### Особенности работы с большими транзакциями
Если транзакция на стороне публикующего сервера изменяет большое количество данных, это может привести к задержкам в репликации. Причина заключается в том, что `wal sender` ждёт завершения транзакции, сортирует данные по транзакциям и только затем передаёт их подписчику. Это может вызвать временные всплески нагрузки и задержки в передаче данных.

---

Это завершает вторую часть конспекта. Хотите продолжить с третьей частью?

