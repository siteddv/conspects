# 20. Внешние данные

PostgreSQL предоставляет возможность работать с внешними данными через специальные объекты, называемые **Foreign Data Wrappers (FDW)** или обёртки сторонних данных. Этот механизм позволяет обращаться к внешним источникам данных как к обычным таблицам внутри базы данных. Основная цель — обеспечение прозрачного доступа к данным из других баз данных, файлов или даже веб-ресурсов. Ключевые возможности включают выполнение стандартных SQL-команд (`SELECT`, `INSERT`, `UPDATE`, `DELETE`) над внешними данными, возможность использования триггеров на внешних таблицах и управление правами доступа через команды `GRANT`/`REVOKE`. Этот функционал стандартизирован и регламентируется спецификацией SQL/MED (Management of External Data).

PostgreSQL поставляется с двумя основными обёртками: **postgres_fdw** (для взаимодействия с другими экземплярами PostgreSQL) и **file_fdw** (для работы с файловой системой, например, CSV-файлами). Помимо этих двух, существует множество сторонних обёрток для различных источников данных: Oracle, MySQL, Microsoft SQL Server, NoSQL базы данных (MongoDB, Redis), файлы различных форматов (JSON, XML, Parquet), научные данные и веб-ресурсы. Обёртки сторонних данных могут использоваться для миграции данных (подключение к исходной базе данных для переноса данных в PostgreSQL), sharding и секционирования (доступ к удалённым секциям таблиц) и интеграции с файловой системой (использование `file_fdw` для чтения данных из CSV-файлов напрямую как из таблиц).

Для работы с внешними данными через `postgres_fdw` необходимо выполнить несколько шагов. Сначала устанавливается расширение `postgres_fdw` через команду `CREATE EXTENSION postgres_fdw`. Затем создаётся внешний сервер, который определяет конкретный экземпляр PostgreSQL, к которому мы будем подключаться, с указанием параметров подключения (хост, порт и имя базы данных). После этого необходимо определить сопоставление ролей, то есть какая локальная роль будет соответствовать удалённой роли на внешнем сервере. Затем можно создавать внешние таблицы, которые будут отображать структуру таблиц на удалённом сервере. Для удобства можно импортировать сразу всю схему или отдельные таблицы с удалённого сервера с помощью команды `IMPORT FOREIGN SCHEMA`.

Работа с внешними данными через `postgres_fdw` предполагает управление соединениями между локальной и удалённой базами данных. Соединение с внешним сервером открывается автоматически при первом обращении к внешней таблице и остаётся открытым для текущего сеанса. Соединение закрывается автоматически при завершении сеанса пользователя. Если в рамках одного сеанса выполняется несколько запросов к одной и той же внешней таблице, соединение повторно используется, что повышает производительность. При работе с внешними таблицами транзакции на локальном и удалённом серверах синхронизируются. Команда `COMMIT` на локальном сервере автоматически передаётся на удалённый сервер, завершая транзакцию там. По умолчанию, уровень изоляции транзакций на удалённом сервере устанавливается как `READ COMMITTED`. Если на локальном сервере используется более строгий уровень изоляции (например, `SERIALIZABLE`), то он также применяется на удалённом сервере. Однако важно помнить, что согласованность данных между локальной и удалённой базами не гарантируется. PostgreSQL не поддерживает двухфазную фиксацию транзакций (2PC) для внешних таблиц. Это означает, что если транзакция успешно завершена на локальном сервере, но произошла ошибка на удалённом сервере, данные могут оказаться несогласованными.

`postgres_fdw` и `dblink` — это два механизма, которые позволяют взаимодействовать с удалёнными экземплярами PostgreSQL. Однако они имеют существенные различия в подходах и возможностях. `postgres_fdw` предназначен для работы с конкретными внешними таблицами и позволяет выполнять стандартные SQL-операции (`SELECT`, `INSERT`, `UPDATE`, `DELETE`) над внешними таблицами как над локальными. Соединения управляются автоматически, открываются при первом обращении к внешней таблице и закрываются при завершении сеанса. Транзакции также управляются автоматически. `postgres_fdw` использует стандартный SQL-синтаксис для работы с внешними таблицами и поддерживает передачу условий фильтрации (`WHERE`) на удалённый сервер, что минимизирует объём передаваемых данных. Планировщик PostgreSQL может эффективно оптимизировать запросы. `dblink` позволяет выполнять произвольные SQL-запросы на удалённом сервере и подходит для выполнения сложных операций, таких как вызов функций или выполнение админских команд. Однако `dblink` требует ручного управления соединениями и транзакциями, а также использования специальных функций для выполнения запросов. Все данные загружаются полностью, независимо от условий фильтрации, и оптимизация запросов ограничена.

`file_fdw` — это встроенное расширение PostgreSQL, которое позволяет работать с файлами на локальной файловой системе сервера как с таблицами базы данных. Это особенно полезно для импорта данных из CSV-файлов или других текстовых форматов. Для использования `file_fdw` необходимо сначала установить соответствующее расширение через команду `CREATE EXTENSION file_fdw`. Затем создаётся внешний сервер, но в отличие от `postgres_fdw`, для работы с файлами не требуется указывать хост, порт или имя базы данных. При работе с `file_fdw` сопоставление ролей не требуется, так как доступ к файлам осуществляется под правами пользователя операционной системы, от имени которого запущен PostgreSQL. После создания файла можно создать внешнюю таблицу, которая будет читать данные из этого файла, указав путь к файлу, формат данных и наличие заголовка. После создания внешней таблицы данные можно читать как из обычной таблицы. `file_fdw` поддерживает текстовые форматы, такие как CSV и TSV. Файлы должны находиться на том же сервере, где запущен PostgreSQL. Права доступа к файлам определяются правами пользователя операционной системы, от имени которого работает PostgreSQL. Импорт данных из файла в локальную таблицу можно выполнить с помощью команды `INSERT`, а экспорт данных из таблицы в файл выполняется с помощью команды `COPY`.

- [[части/1. Введение в работу с внешними данными и обёртки сторонних данных|1. Введение в работу с внешними данными и обёртки сторонних данных]] [1. Введение в работу с внешними данными и обёртки сторонних данных](части/1. Введение в работу с внешними данными и обёртки сторонних данных.md)
- [[части/2. Работа с PostgreSQL Foreign Data Wrapper (postgres_fdw)|2. Работа с PostgreSQL Foreign Data Wrapper (postgres_fdw)]] [2. Работа с PostgreSQL Foreign Data Wrapper (postgres_fdw)](части/2. Работа с PostgreSQL Foreign Data Wrapper (postgres_fdw).md)
- [[части/3. Управление соединениями и транзакциями|3. Управление соединениями и транзакциями]] [3. Управление соединениями и транзакциями](части/3. Управление соединениями и транзакциями.md)
- [[части/4. Сравнение postgres_fdw и dblink|4. Сравнение postgres_fdw и dblink]] [4. Сравнение postgres_fdw и dblink](части/4. Сравнение postgres_fdw и dblink.md)
- [[части/5. Работа с файлами через file_fdw|5. Работа с файлами через file_fdw]] [5. Работа с файлами через file_fdw](части/5. Работа с файлами через file_fdw.md)
- [[части/6. Практические примеры и задания|6. Практические примеры и задания]] [6. Практические примеры и задания](части/6. Практические примеры и задания.md)

