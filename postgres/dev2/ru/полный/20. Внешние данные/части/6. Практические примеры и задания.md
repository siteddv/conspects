### Часть 6: Практические примеры и задания

#### 6.1 Работа с файлами поставщиков
Одним из практических применений `file_fdw` является работа с файлами, которые предоставляют поставщики данных. Например, предположим, что у нас есть CSV-файл `2020.csv`, содержащий информацию о новых книгах от поставщика. Этот файл находится в определённой директории на сервере.

1. **Чтение данных из файла**:
   - Мы можем создать внешнюю таблицу для чтения данных из этого файла:
     ```sql
     CREATE FOREIGN TABLE supplier_books (
         id INT,
         title TEXT,
         author TEXT,
         year INT
     )
     SERVER file_server
     OPTIONS (filename '/path/to/2020.csv', format 'csv', header 'true');
     ```
   - После создания внешней таблицы данные можно читать как из обычной таблицы:
     ```sql
     SELECT * FROM supplier_books;
     ```

2. **Обработка опечаток**:
   - Если в файле есть опечатки (например, неправильное название книги), можно использовать функции для очистки данных:
     ```sql
     SELECT TRIM(title), LOWER(author) FROM supplier_books;
     ```

3. **Интеграция с локальными данными**:
   - Можно объединить данные из файла с локальной таблицей, чтобы проверить, нет ли дубликатов:
     ```sql
     SELECT * FROM supplier_books
     EXCEPT
     SELECT * FROM local_books;
     ```

#### 6.2 Сравнение данных между таблицами
Другой распространённой задачей является сравнение данных между двумя таблицами. Предположим, у нас есть две таблицы с одинаковой структурой, и мы хотим найти строки, которые присутствуют в одной таблице, но отсутствуют в другой.

4. **Использование `postgres_fdw`**:
   - Если одна из таблиц находится на удалённом сервере, можно использовать `postgres_fdw` для сравнения:
     ```sql
     SELECT * FROM local_table
     EXCEPT
     SELECT * FROM foreign_table;
     ```

5. **Использование `dblink`**:
   - Если используется `dblink`, запрос будет выглядеть сложнее:
     ```sql
     SELECT * FROM dblink('host=remote_host dbname=remote_db', 'SELECT * FROM remote_table') AS t(id int, name text)
     EXCEPT
     SELECT * FROM local_table;
     ```

6. **Анализ результатов**:
   - Результаты сравнения можно использовать для обновления данных или выявления несоответствий.

#### 6.3 Практические аспекты управления соединениями
7. **Мониторинг соединений**:
   - Для мониторинга открытых соединений можно использовать системные представления PostgreSQL:
     ```sql
     SELECT * FROM pg_stat_activity WHERE query LIKE '%foreign%';
     ```

8. **Управление транзакциями**:
   - При использовании `postgres_fdw` транзакции управляются автоматически, но важно помнить об ограничениях согласованности данных.
   - При использовании `dblink` необходимо явно управлять транзакциями:
     ```sql
     BEGIN;
     SELECT * FROM dblink('host=remote_host dbname=remote_db', 'SELECT * FROM remote_table') AS t(id int, name text);
     COMMIT;
     ```

9. **Оптимизация производительности**:
   - Для оптимизации запросов к внешним таблицам можно использовать команду `EXPLAIN` с опцией `VERBOSE`:
     ```sql
     EXPLAIN VERBOSE SELECT * FROM foreign_table WHERE id = 1;
     ```
   - Это позволит увидеть, какие условия передаются на удалённый сервер.

---
1. **Вопросы для дальнейшего изучения**:
   - Какие существуют инструменты для автоматической синхронизации данных между локальной и удалённой базами?
   - Как настроить автоматическое обновление данных из внешних источников?

Это завершает подробный конспект видео. Хотите что-то уточнить или добавить?

