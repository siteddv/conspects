### Часть 2: Работа с PostgreSQL Foreign Data Wrapper (postgres_fdw)

#### 2.1 Настройка и установка расширения
Для работы с внешними данными через `postgres_fdw` необходимо выполнить несколько шагов:

1. **Установка расширения**:
   - Расширение `postgres_fdw` устанавливается через команду:
     ```sql
     CREATE EXTENSION postgres_fdw;
     ```
   - После установки появляется обёртка сторонних данных (`foreign-data wrapper`), которая позволяет работать с внешними серверами PostgreSQL.

2. **Создание внешнего сервера**:
   - Внешний сервер определяет конкретный экземпляр PostgreSQL, к которому мы будем подключаться.
   - Команда создания внешнего сервера:
     ```sql
     CREATE SERVER foreign_server_name
     FOREIGN DATA WRAPPER postgres_fdw
     OPTIONS (host 'hostname', port '5432', dbname 'database_name');
     ```
   - Здесь указываются параметры подключения: хост, порт и имя базы данных.

3. **Сопоставление ролей**:
   - Необходимо определить, какая локальная роль будет соответствовать удалённой роли на внешнем сервере.
   - Команда для сопоставления ролей:
     ```sql
     CREATE USER MAPPING FOR local_user
     SERVER foreign_server_name
     OPTIONS (user 'remote_user', password 'remote_password');
     ```

#### 2.2 Создание внешних таблиц
После настройки внешнего сервера можно создавать внешние таблицы, которые будут отображать структуру таблиц на удалённом сервере.

4. **Команда создания внешней таблицы**:
   ```sql
   CREATE FOREIGN TABLE foreign_table_name (
       column1 datatype,
       column2 datatype,
       ...
   )
   SERVER foreign_server_name
   OPTIONS (schema_name 'public', table_name 'remote_table_name');
   ```
   - Здесь указывается структура таблицы, сервер и опции для сопоставления с удалённой таблицей.

5. **Сопоставление столбцов**:
   - Если имена столбцов на локальной и удалённой таблицах различаются, это можно указать в опциях:
     ```sql
     OPTIONS (column_name 'remote_column_name');
     ```

6. **Ограничения**:
   - Можно добавлять ограничения (`NOT NULL`, `CHECK`) для внешних таблиц, но их выполнение не гарантировано, так как данные находятся на удалённом сервере.
   - Эти ограничения полезны для:
     - Локального контроля изменений.
     - Оптимизации запросов планировщиком.

#### 2.3 Механизм сопоставления ролей и аутентификации
- **Сопоставление ролей**:
  - Каждый пользователь локальной базы данных должен быть сопоставлен с пользователем на удалённом сервере.
  - Это обеспечивает безопасность и контроль доступа к данным.

- **Аутентификация**:
  - При подключении к внешнему серверу используется информация о пользователе и пароле, указанная в сопоставлении ролей.
  - Если сопоставление не настроено, подключение невозможно.

#### 2.4 Особенности работы с внешними таблицами
7. **Оптимизация запросов**:
   - PostgreSQL может передавать условия фильтрации (`WHERE`) на удалённый сервер, минимизируя объём передаваемых данных.
   - Пример:
     ```sql
     SELECT * FROM foreign_table WHERE id = 1;
     ```
     - Условие `id = 1` передаётся на удалённый сервер, и только одна строка возвращается.

8. **Объединение данных**:
   - Внешние таблицы можно использовать вместе с локальными таблицами в одном запросе.
   - Пример:
     ```sql
     SELECT * FROM local_table JOIN foreign_table ON local_table.id = foreign_table.id;
     ```

9. **Импорт схемы**:
   - Для удобства можно импортировать сразу всю схему или отдельные таблицы с удалённого сервера:
     ```sql
     IMPORT FOREIGN SCHEMA remote_schema
     LIMIT TO (table1, table2)
     FROM SERVER foreign_server_name
     INTO local_schema;
     ```

10. **Изменение данных**:
   - Через внешние таблицы можно выполнять операции `INSERT`, `UPDATE`, `DELETE`.
   - Однако гарантии согласованности данных между локальной и удалённой базами отсутствуют.

---

1. **Вопросы для дальнейшего изучения**:
   - Как настроить двухфазную фиксацию транзакций для внешних таблиц?
   - Какие ограничения накладываются на использование индексов для внешних таблиц?

Хотите продолжить с подробным пересказом третьей части?

