### Часть 5: Работа с файлами через file_fdw

#### 5.1 Настройка и использование file_fdw
`file_fdw` — это встроенное расширение PostgreSQL, которое позволяет работать с файлами на локальной файловой системе сервера как с таблицами базы данных. Это особенно полезно для импорта данных из CSV-файлов или других текстовых форматов.

1. **Установка расширения**:
   - Для использования `file_fdw` необходимо сначала установить соответствующее расширение:
     ```sql
     CREATE EXTENSION file_fdw;
     ```
   - После установки появляется обёртка сторонних данных (`foreign-data wrapper`), которая позволяет работать с файлами.

2. **Создание внешнего сервера**:
   - В отличие от `postgres_fdw`, для работы с файлами не требуется указывать хост, порт или имя базы данных.
   - Команда создания внешнего сервера:
     ```sql
     CREATE SERVER file_server
     FOREIGN DATA WRAPPER file_fdw;
     ```

3. **Сопоставление ролей**:
   - При работе с `file_fdw` сопоставление ролей не требуется, так как доступ к файлам осуществляется под правами пользователя операционной системы, от имени которого запущен PostgreSQL.

#### 5.2 Примеры работы с CSV-файлами
4. **Создание файла данных**:
   - Данные можно экспортировать из таблицы в CSV-файл с помощью команды `COPY`:
     ```sql
     COPY users TO '/path/to/users.csv' WITH (FORMAT csv, DELIMITER ',', HEADER true);
     ```
   - Этот файл будет содержать данные таблицы `users` в текстовом формате.

5. **Создание внешней таблицы**:
   - После создания файла можно создать внешнюю таблицу, которая будет читать данные из этого файла:
     ```sql
     CREATE FOREIGN TABLE foreign_users (
         id INT,
         name TEXT,
         email TEXT
     )
     SERVER file_server
     OPTIONS (filename '/path/to/users.csv', format 'csv', header 'true');
     ```
   - Здесь указывается путь к файлу, формат данных и наличие заголовка.

6. **Чтение данных**:
   - После создания внешней таблицы данные можно читать как из обычной таблицы:
     ```sql
     SELECT * FROM foreign_users;
     ```

#### 5.3 Особенности импорта/экспорта данных
7. **Форматы файлов**:
   - `file_fdw` поддерживает текстовые форматы, такие как CSV и TSV.
   - Можно указать разделитель, наличие заголовка и другие параметры формата.

8. **Ограничения**:
   - Файлы должны находиться на том же сервере, где запущен PostgreSQL.
   - Права доступа к файлам определяются правами пользователя операционной системы, от имени которого работает PostgreSQL.

9. **Импорт данных**:
   - Импорт данных из файла в локальную таблицу можно выполнить с помощью команды `INSERT`:
     ```sql
     INSERT INTO local_table SELECT * FROM foreign_users;
     ```

10. **Экспорт данных**:
   - Экспорт данных из таблицы в файл выполняется с помощью команды `COPY`:
     ```sql
     COPY local_table TO '/path/to/export.csv' WITH (FORMAT csv, DELIMITER ',', HEADER true);
     ```

#### 5.4 Практические примеры
11. **Обработка опечаток**:
   - Если в файле есть опечатки, можно использовать функции для очистки данных перед импортом:
     ```sql
     SELECT TRIM(name), LOWER(email) FROM foreign_users;
     ```

12. **Сравнение данных**:
   - Можно сравнивать данные из файла с данными в локальной таблице:
     ```sql
     SELECT * FROM foreign_users
     EXCEPT
     SELECT * FROM local_table;
     ```

---

15. **Вопросы для дальнейшего изучения**:
   - Как настроить работу с файлами других форматов (например, JSON или XML)?
   - Какие существуют ограничения на размер файлов при использовании `file_fdw`?

Хотите продолжить с подробным пересказом шестой части?

