# 12. Фоновые процессы

## Описание

Эта глава посвящена фоновым процессам в PostgreSQL. Мы рассмотрим введение в фоновые процессы PostgreSQL, механизм работы фоновых процессов, практическое применение фоновых процессов, расширение pg_background, а также практические задания и сравнение инструментов.

## Части главы

- [[части/1. Введение в фоновые процессы PostgreSQL|1. Введение в фоновые процессы PostgreSQL]] [1. Введение в фоновые процессы PostgreSQL](части/1. Введение в фоновые процессы PostgreSQL.md)
- [[части/2. Механизм работы фоновых процессов|2. Механизм работы фоновых процессов]] [2. Механизм работы фоновых процессов](части/2. Механизм работы фоновых процессов.md)
- [[части/3. Практическое применение фоновых процессов|3. Практическое применение фоновых процессов]] [3. Практическое применение фоновых процессов](части/3. Практическое применение фоновых процессов.md)
- [[части/4. Расширение pg_background|4. Расширение pg_background]] [4. Расширение pg_background](части/4. Расширение pg_background.md)
- [[части/5. Практические задания и сравнение инструментов|5. Практические задания и сравнение инструментов]] [5. Практические задания и сравнение инструментов](части/5. Практические задания и сравнение инструментов.md)

---

Фоновые процессы в PostgreSQL представляют собой специальные служебные процессы, которые работают постоянно или запускаются при определенных условиях. Они делятся на постоянные процессы (такие как `postmaster`, `walwriter`, `autovacuum launcher`) и временные процессы (запускаются для выполнения конкретных задач и завершаются после их выполнения). При выключении экземпляра PostgreSQL необходимо соблюдать определенный порядок остановки процессов: сначала должна быть выполнена контрольная точка (`checkpoint`), затем записан журнал, и только после этого можно останавливать `walwriter`.

PostgreSQL поддерживает динамическое создание фоновых процессов, которые могут поработать и завершиться. Эти процессы запускаются процессом `postmaster` и имеют доступ к выделенной памяти сервера и базам данных, минуя стандартные клиент-серверные протоколы. Все фоновые процессы запускаются процессом `postmaster`, который является главным процессом PostgreSQL. Фоновые процессы работают в контексте уже существующей базы данных, что позволяет им устанавливать соединение с этой базой данных напрямую, без использования стандартных клиент-серверных протоколов.

Фоновые процессы используются для параллельного выполнения запросов (запрос может выполняться не только последовательно, но и параллельно, что ускоряет обработку больших объемов данных), выполнения служебных команд (например, создание индексов или выполнение команды `VACUUM` может быть распараллелено) и логической репликации (процесс, принимающий сообщения от `wal sender`, также работает как фоновый процесс). Количество фоновых процессов ограничено параметром `max_worker_processes` (по умолчанию 8). Параллельное выполнение запросов управляется параметром `max_parallel_workers_per_gather`.

При выполнении запроса, который считает общее количество строк в таблице, можно увидеть использование параллельных процессов. План выполнения может включать операцию `Parallel Seq Scan`, которая выполняется несколькими процессами. Каждый процесс выполняет частичную агрегацию данных, после чего результаты собираются лидером процессом, который выполняет окончательную агрегацию. Начиная с версии PostgreSQL 12, команда `CREATE INDEX` для B-деревьев поддерживает параллельное выполнение. В версии 13 появилась возможность параллельного выполнения команды `VACUUM`, что позволяет использовать дополнительные процессы для ускорения работы.

Расширение `pg_background` позволяет использовать механизм фоновых процессов для выполнения любых SQL-команд. Оно не является стандартным, но широко используется. Функции расширения включают `background_launch` (запускает фоновый процесс с переданным SQL-запросом), `pg_background_result` (получает результат выполнения фонового процесса) и `pg_background_detach` (отключает текущий процесс от ожидания результатов фонового процесса). Взаимодействие между основным и фоновым процессами происходит через межпроцессные буферы. Если фоновый процесс порождает большое количество данных, это может привести к заполнению буфера и остановке работы.

Практические задания включают расчет рейтинга книг на основе голосов "за" и "против" с пакетным обновлением таблицы (чтобы избежать значительного увеличения размера таблицы), сравнение накладных расходов и производительности `pg_background` и `dblink`, а также написание обертки для `pg_background`, которая будет пытаться запустить процесс, если он не смог запуститься сразу из-за превышения лимита фоновых процессов. Преимущества `pg_background` включают производительность (быстрее, так как использует внутренние механизмы PostgreSQL) и экономию ресурсов (не требует установки полноценного соединения с базой данных). Преимущества `dblink` включают гибкость (может подключаться к другим серверам) и стандартность (входит в состав PostgreSQL, не требует дополнительной установки).

