# 11. Слабоструктурированные данные

## Описание

Эта глава посвящена работе со слабо структурированными данными в PostgreSQL. Мы рассмотрим введение в слабо структурированные данные, работу с XML, работу с JSON, индексирование JSON, а также практическое применение.

## Части главы

- [[части/1. Введение в слабо структурированные данные|1. Введение в слабо структурированные данные]] [1. Введение в слабо структурированные данные](части/1. Введение в слабо структурированные данные.md)
- [[части/2. Работа с XML|2. Работа с XML]] [2. Работа с XML](части/2. Работа с XML.md)
- [[части/3. Работа с JSON|3. Работа с JSON]] [3. Работа с JSON](части/3. Работа с JSON.md)
- [[части/4. Индексирование JSON|4. Индексирование JSON]] [4. Индексирование JSON](части/4. Индексирование JSON.md)
- [[части/5. Практическое применение|5. Практическое применение]] [5. Практическое применение](части/5. Практическое применение.md)

---

Слабо структурированные данные — это тип данных, которые не укладываются в традиционную реляционную структуру баз данных. Они представляют собой текст с определенной разметкой, которая добавляет структуру, но эта структура менее строгая по сравнению с реляционными данными. Основные характеристики включают гибкость (данные могут иметь переменную структуру), иерархичность (элементы могут быть вложенными) и самодостаточность (документ сам описывает свою структуру через разметку).

XML (eXtensible Markup Language) — это язык разметки, появившийся в контексте веба в 1998 году. Он используется для структурирования данных с помощью тегов, атрибутов и вложенных элементов. Для работы с XML существуют специализированные языки: XPath (язык запросов для выбора частей XML-документа), XQuery (более мощный язык запросов, основанный на XPath) и XSLT (язык преобразования XML-документов). PostgreSQL поддерживает только XPath первой версии, что ограничивает возможности работы с XML. PostgreSQL предоставляет базовую поддержку XML через функции `xpath()` и `xmltable()`, но нет полноценной поддержки индексирования XML-документов.

JSON (JavaScript Object Notation) — это легковесный формат обмена данными, основанный на JavaScript. Он представляет собой набор пар ключ-значение и массивы, что делает его более простым и удобным для чтения человеком по сравнению с XML. PostgreSQL поддерживает два типа данных для работы с JSON: JSON (хранит данные как текстовую строку, при каждом запросе данные разбираются заново) и JSONB (хранит данные в бинарном формате с внутренней структурой, что позволяет быстрее выполнять запросы и поддерживать индексирование). Особенности JSONB включают эффективность (разбор происходит один раз при записи), потерю исходного форматирования (порядок ключей может измениться) и поддержку индексирования через GIN (Generalized Inverted Index).

Для работы с JSON в PostgreSQL используются следующие инструменты: JSONPath (стандартизированный язык запросов, похожий на XPath), стрелочная нотация (удобна для простых запросов) и функции (`jsonb_pretty()`, `jsonb_array_elements()`, `jsonb_each()` и другие). Для преобразования между JSON и реляционными данными используются функции `jsonb_to_recordset()` (для разбора JSONB и преобразования его в строки таблицы) и `jsonb_build_object()` (для создания JSONB из таблиц).

Для ускорения работы с JSON-документами в PostgreSQL используются специализированные методы индексирования. Основной метод — это GIN (Generalized Inverted Index), который позволяет индексировать части JSON-документа. GIN — это обратный индекс (аналог предметного указателя в книгах), где каждая часть документа (ключ или значение) связана с документом, где она встречается. Для JSONB поддерживаются два основных класса операторов: `jsonb_ops` (индексирует все ключи и значения JSONB-документа, универсален, но менее точен) и `jsonb_path_ops` (индексирует не только значения, но и пути к ним, более точный поиск, но поддерживает меньшее количество операций).

Практическое применение слабо структурированных данных включает оптимизацию хранения данных (объединение нескольких столбцов в один JSONB-столбец для упрощения схемы и повышения гибкости), использование JSON как транспортного формата (хранение переводов интерфейса в JSONB-формате для поддержки нескольких языков) и рефакторинг функций (обновление функций для работы с новой структурой данных, что упрощает код и повышает скорость выполнения).

