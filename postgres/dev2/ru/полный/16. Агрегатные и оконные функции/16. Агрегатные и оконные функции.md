# 16. Агрегатные и оконные функции

## Описание

Эта глава посвящена созданию собственных агрегатных и оконных функций в PostgreSQL. Мы рассмотрим введение и базовые понятия, создание пользовательских агрегатных функций, работу с оконными функциями, расширенные возможности оконных функций, параллельную обработку и оптимизацию, а также практическое применение и задачи.

## Части главы

- [[части/1. Введение и базовые понятия|1. Введение и базовые понятия]] [1. Введение и базовые понятия](части/1. Введение и базовые понятия.md)
- [[части/2. Создание пользовательских агрегатных функций|2. Создание пользовательских агрегатных функций]] [2. Создание пользовательских агрегатных функций](части/2. Создание пользовательских агрегатных функций.md)
- [[части/3. Работа с оконными функциями|3. Работа с оконными функциями]] [3. Работа с оконными функциями](части/3. Работа с оконными функциями.md)
- [[части/4. Расширенные возможности оконных функций|4. Расширенные возможности оконных функций]] [4. Расширенные возможности оконных функций](части/4. Расширенные возможности оконных функций.md)
- [[части/5. Параллельная обработка и оптимизация|5. Параллельная обработка и оптимизация]] [5. Параллельная обработка и оптимизация](части/5. Параллельная обработка и оптимизация.md)
- [[части/6. Практическое применение и задачи|6. Практическое применение и задачи]] [6. Практическое применение и задачи](части/6. Практическое применение и задачи.md)

---

Агрегатные функции — это стандартные функции, такие как `COUNT`, `MIN`, `MAX` и другие, которые используются для выполнения вычислений на множестве строк и возвращают одно значение. Эти функции "схлопывают" множество строк в одну, то есть результатом является единственное значение. Для работы агрегатной функции необходимо определить состояние, которое будет хранить промежуточные данные. Это состояние может быть значением произвольного типа. Перед началом обработки устанавливается начальное состояние. Для каждой строки из выборки вызывается специальная функция перехода, которая изменяет текущее состояние. Эта функция принимает текущее состояние и значение из строки, а затем возвращает новое состояние. После обработки всех строк вызывается функция финализации, которая преобразует последнее состояние в окончательный результат.

Для создания пользовательской агрегатной функции используется команда `CREATE AGGREGATE`, которая объединяет все компоненты: функцию перехода (`SFUNC`), тип состояния (`STYPE`), начальное условие (`INITCOND`) и функцию финализации (`FINALFUNC`). Функция работает аналогично стандартным агрегатным функциям при использовании `GROUP BY`. Для каждой группы создается отдельное состояние.

Оконные функции отличаются от агрегатных тем, что они вычисляют значения для каждой строки, не изменяя количество строк в результате. Для использования оконной функции добавляется ключевое слово `OVER` после вызова функции. В скобках после `OVER` можно указать рамки (`frame`), внутри которых будет выполняться вычисление. Если указано просто `OVER ()`, то рамка охватывает всю выборку. Аналогично `GROUP BY`, но строки не объединяются, используется конструкция `PARTITION BY`. Функция вычисляется отдельно для каждой группы, но все строки остаются в результате. Можно задавать рамки, которые меняются от строки к строке, например, `ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW` или `ROWS BETWEEN 2 PRECEDING AND CURRENT ROW` для реализации скользящих средних.

При использовании изменяющихся рамок возникает необходимость удалять значения из состояния. Стандартная функция перехода не подходит, так как она только добавляет значения. Для удаления значений из состояния создается специальная функция инверсии (`inverse function`). Эта функция принимает текущее состояние и значение, которое нужно удалить, и возвращает новое состояние. Для использования функции инверсии необходимо обновить определение агрегатной функции, добавив параметр `MINVFUNC`. Использование функции инверсии позволяет экономить ресурсы, так как не требуется пересчитывать все значения заново.

Встроенные агрегатные функции могут вычисляться в параллельных запросах. Это позволяет ускорить обработку больших объемов данных за счет распределения нагрузки между несколькими процессами. Для работы с параллельными процессами нужна специальная функция, которая сможет объединить два состояния. Эта функция принимает два состояния и возвращает объединенное состояние. Для использования параллельной обработки необходимо обновить определение агрегатной функции, добавив параметры `COMBINEFUNC` и `PARALLEL = SAFE`. Оконные функции не поддерживают параллельную обработку. Это относится как к стандартным, так и к собственным оконным функциям.

