### Часть 3: Анализ существующих систем очередей (10:01 - 15:00)

#### 3.1. Рассмотрение pgq/skytools

- **Обзор pgq/skytools**:
  - **Описание**: Это система очередей, которая существует давно и широко используется.
  - **История**: Изначально разработана для старых версий PostgreSQL, позже передана в поддержку сообществу.

- **Преимущества**:
  - **Готовое решение**: Уже протестировано и используется многими.
  - **Документация и туториалы**: Большое количество материалов для изучения и использования.

- **Недостатки**:
  - **Работа с пакетами**: Сообщения обрабатываются только пакетами, что может привести к повторной обработке всего пакета в случае ошибки.
    - Пример: Если один из элементов пакета не обработан, весь пакет придется обрабатывать снова.
  - **Сложность настройки**: Требует внешней программы-демона для периодического вызова.
  - **Мониторинг**: Необходимо следить за работой демона и его состоянием.
  - **Устаревшая реализация**: Разработана для старых версий PostgreSQL и может быть избыточной для современных задач.

#### 3.2. Характеристики работы с пакетами сообщений

- **Обработка пакетами**:
  - **Плюсы**:
    - Эффективность при обработке большого количества сообщений.
    - Уменьшение накладных расходов на управление отдельными сообщениями.
  - **Минусы**:
    - Повторная обработка: Если одно сообщение в пакете не обработано, весь пакет придется обрабатывать снова.
    - Сложность отладки: Трудно определить, какое именно сообщение вызвало ошибку.

- **Пример обработки пакета**:
  ```sql
  SELECT * FROM queue
  WHERE process_id IS NULL
  ORDER BY id
  LIMIT 10
  FOR UPDATE SKIP LOCKED;
  ```
  - **LIMIT 10**: Выбирает 10 сообщений для обработки.
  - **FOR UPDATE SKIP LOCKED**: Блокирует выбранные строки для других процессов, но позволяет другим процессам пропустить заблокированные строки.

#### 3.3. Требования к мониторингу

- **Мониторинг демона**:
  - **Необходимость**: Демон должен быть постоянно запущен и работать корректно.
  - **Инструменты**: Использование систем мониторинга, таких как Prometheus, Grafana.
  - **Проверки**:
    - Проверка статуса демона.
    - Логирование ошибок и предупреждений.
    - Уведомления о сбоях.

- **Мониторинг состояния очереди**:
  - **Метрики**:
    - Количество сообщений в очереди.
    - Время обработки сообщений.
    - Количество зависших сообщений.
  - **Инструменты**: Использование SQL-запросов для получения метрик.
    ```sql
    SELECT COUNT(*) AS total_messages,
           COUNT(CASE WHEN process_id IS NOT NULL THEN 1 END) AS processing_messages,
           COUNT(CASE WHEN process_id IS NULL THEN 1 END) AS pending_messages
    FROM queue;
    ```

#### 3.4. Реализация собственной системы очередей

- **Преимущества самописных решений**:
  - **Простота**: Можно написать простую реализацию, если требования не слишком сложные.
  - **Отсутствие внешних зависимостей**: Все находится внутри базы данных.

- **Минусы самописных решений**:
  - **Тестирование и отладка**: Требуется тщательное тестирование и отладка.
  - **Сложность**: По мере усложнения требований реализация может стать сложной и трудно поддерживаемой.
  - **Риск ошибок**: Высокий риск возникновения ошибок при неправильной реализации.

- **Базовая структура таблицы очереди**:
  - **Столбцы**:
    - `id`: Идентификатор события (первичный ключ).
    - `payload`: Полезная нагрузка события (например, JSON).
    - `process_id`: Идентификатор процесса, который обрабатывает событие (по умолчанию NULL).

- **Механизмы блокировки и обработки сообщений**:
  - **Выбор сообщения для обработки**:
    ```sql
    SELECT * FROM queue
    WHERE process_id IS NULL
    ORDER BY id
    LIMIT 1
    FOR UPDATE SKIP LOCKED;
    ```
    - **FOR UPDATE SKIP LOCKED**: Блокирует выбранную строку для других процессов, но позволяет другим процессам пропустить заблокированные строки и взять следующие.

  - **Обновление состояния сообщения**:
    ```sql
    UPDATE queue
    SET process_id = current_process_id
    WHERE id = selected_id;
    ```

- **Проблемы с индексацией и блокировками**:
  - **Индексация**:
    - Необходимо создавать индексы для эффективного выбора сообщений.
    - Пример индекса: `CREATE INDEX idx_queue_process_id ON queue(process_id);`
  - **Блокировки**:
    - Нужно следить за тем, чтобы блокировки не мешали параллельной обработке.
    - Использование `SKIP LOCKED` помогает избежать блокировок.

---

Это завершает третью часть конспекта. Если вы готовы, мы можем перейти к следующей части, где рассмотрим более детальную реализацию обработчиков и механизмы управления транзакциями.

