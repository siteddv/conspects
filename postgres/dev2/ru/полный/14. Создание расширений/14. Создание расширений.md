# 14. Создание расширений

## Описание

Эта глава посвящена созданию расширений в PostgreSQL. Мы рассмотрим введение в расширения PostgreSQL (Extensions), создание и установку расширений, работу с версиями расширений, практическую реализацию расширения, взаимодействие с pg_dump, а также практические задания.

## Части главы

- [[части/1. Введение в расширения PostgreSQL (Extensions)|1. Введение в расширения PostgreSQL (Extensions)]] [1. Введение в расширения PostgreSQL (Extensions)](части/1. Введение в расширения PostgreSQL (Extensions).md)
- [[части/2. Создание и установка расширений|2. Создание и установка расширений]] [2. Создание и установка расширений](части/2. Создание и установка расширений.md)
- [[части/3. Работа с версиями расширений|3. Работа с версиями расширений]] [3. Работа с версиями расширений](части/3. Работа с версиями расширений.md)
- [[части/4. Практическая реализация расширения|4. Практическая реализация расширения]] [4. Практическая реализация расширения](части/4. Практическая реализация расширения.md)
- [[части/5. Взаимодействие с pg_dump|5. Взаимодействие с pg_dump]] [5. Взаимодействие с pg_dump](части/5. Взаимодействие с pg_dump.md)
- [[части/6. Практические задания|6. Практические задания]] [6. Практические задания](части/6. Практические задания.md)

---

Расширение в PostgreSQL представляет собой группу взаимосвязанных объектов базы данных. Преимущества использования расширений включают удобство установки (для установки всех объектов расширения достаточно выполнить одну команду `CREATE EXTENSION`), целостность (расширение устанавливается целиком со всеми своими объектами или не устанавливается вообще) и сохранение связей при выгрузке (при использовании `pg_dump` сохраняется связь между объектами расширения, что позволяет корректно восстановить их при загрузке дампа).

Для создания расширения в PostgreSQL требуется подготовить несколько ключевых файлов: управляющий файл (control file) с именем `<имя_расширения>.control`, который содержит метаданные расширения (например, `default_version`, `relocatable`, `encoding`), и SQL-скрипт расширения с именем `<имя_расширения>--<версия>.sql`, который содержит команды SQL для создания объектов расширения. Первая строка скрипта должна содержать специальный маркер, который предотвращает случайное выполнение файла вне контекста расширения.

Файлы расширения должны быть помещены в специальный каталог `SHAREDIR/extension`, который можно найти с помощью команды `pg_config --sharedir`. Для установки файлов используется команда `make install` с правами суперпользователя. Makefile упрощает процесс копирования файлов в каталог расширений. После размещения файлов в каталоге `extension` расширение становится доступным для установки в базе данных через команду `CREATE EXTENSION`. По умолчанию объекты расширения создаются в схеме `public`, если не указана другая схема.

PostgreSQL поддерживает механизм обновления расширений с одной версии на другую. Для каждой пары версий (например, от 1.0 до 1.1) создается отдельный SQL-скрипт обновления с именем `<имя_расширения>--<старая_версия>--<новая_версия>.sql`. Если пользователь хочет перейти с версии 1.0 на версию 1.2, а прямого пути нет, PostgreSQL автоматически выполняет цепочку обновлений (1.0 -> 1.1 -> 1.2). Версии расширений представлены текстовыми строками, которые не имеют строгой числовой интерпретации.

При выполнении логической выгрузки базы данных (`pg_dump`) объекты, принадлежащие расширению, не выгружаются по отдельности. Вместо этого сохраняется только команда `CREATE EXTENSION`, которая при восстановлении заново создает все объекты расширения. Если пользователь добавил данные в таблицы расширения, эти данные не будут автоматически сохранены при выгрузке. Для сохранения пользовательских данных используется функция `pg_extension_config_dump`, которая позволяет указать, какие данные из таблиц расширения должны быть выгружены. Для разделения предопределенных и пользовательских данных можно добавить столбец `is_predefined` и настроить выгрузку только пользовательских данных.

