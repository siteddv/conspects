# 1. Изоляция

## Описание

Эта глава посвящена изоляции транзакций в PostgreSQL. Мы рассмотрим введение в транзакции и их основные свойства (ACID), свойства согласованности и изоляции транзакций, уровни изоляции транзакций, демонстрацию работы уровней изоляции, особые случаи и нюансы, а также практические задания и выводы.

## Части главы

- [[части/1. Введение в транзакции и их основные свойства (ACID)|1. Введение в транзакции и их основные свойства (ACID)]] [1. Введение в транзакции и их основные свойства (ACID)](части/1. Введение в транзакции и их основные свойства (ACID).md)
- [[части/2. Свойства согласованности и изоляции транзакций|2. Свойства согласованности и изоляции транзакций]] [2. Свойства согласованности и изоляции транзакций](части/2. Свойства согласованности и изоляции транзакций.md)
- [[части/3. Уровни изоляции транзакций|3. Уровни изоляции транзакций]] [3. Уровни изоляции транзакций](части/3. Уровни изоляции транзакций.md)
- [[части/4. Демонстрация работы уровней изоляции|4. Демонстрация работы уровней изоляции]] [4. Демонстрация работы уровней изоляции](части/4. Демонстрация работы уровней изоляции.md)
- [[части/5. Особые случаи и нюансы|5. Особые случаи и нюансы]] [5. Особые случаи и нюансы](части/5. Особые случаи и нюансы.md)
- [[части/6. Практические задания и выводы|6. Практические задания и выводы]] [6. Практические задания и выводы](части/6. Практические задания и выводы.md)

---

Транзакция — это множество операций, которые переводят базу данных из одного корректного состояния в другое. Главная особенность транзакции заключается в том, что все операции внутри неё должны выполняться полностью или не выполняться вообще. Это означает, что если одна из операций завершается с ошибкой, то все предыдущие изменения откатываются (отменяются), чтобы сохранить целостность данных.

Транзакции в PostgreSQL характеризуются четырьмя основными свойствами, известными как ACID: атомарность (Atomicity), согласованность (Consistency), изоляция (Isolation) и долговечность (Durability). Атомарность гарантирует, что транзакция выполняется как единое неделимое действие. Согласованность обеспечивает, что транзакция переводит базу данных из одного согласованного состояния в другое, соблюдая все ограничения целостности и семантику приложения. Изоляция гарантирует, что транзакции выполняются независимо друг от друга, даже если они работают с одними и теми же данными одновременно. Долговечность обеспечивает, что после успешного завершения транзакции её изменения сохраняются в базе данных, даже если произойдет сбой системы.

Согласованность — это не только соблюдение ограничений целостности (например, уникальности значений или внешних ключей), но и логическая корректность данных с точки зрения бизнес-логики приложения. Некоторые ограничения целостности могут быть проверены не сразу, а отложены до окончания транзакции, что позволяет временно нарушать ограничения внутри транзакции, но гарантирует их выполнение после завершения.

Изоляция транзакций — сложная задача, особенно в многопользовательских системах. Стандарт SQL предложил несколько уровней изоляции, каждый из которых допускает определенные "ослабления" изоляции, называемые аномалиями. К основным аномалиям относятся: потерянные обновления, грязное чтение, неповторяющееся чтение и фантомное чтение.

PostgreSQL поддерживает четыре уровня изоляции: Read Uncommitted, Read Committed, Repeatable Read и Serializable. Read Uncommitted — самый слабый уровень, но в PostgreSQL он фактически работает так же, как Read Committed. Read Committed — это уровень изоляции по умолчанию в PostgreSQL, на котором транзакция не может видеть незафиксированные изменения других транзакций, но допускается неповторяющееся чтение. Repeatable Read гарантирует, что одна и та же строка всегда возвращается с одинаковыми значениями при повторном чтении внутри одной транзакции, и в PostgreSQL также предотвращает фантомное чтение, что делает его более строгим, чем требует стандарт SQL. Serializable — самый строгий уровень изоляции, который гарантирует полную изоляцию транзакций, но возможны конфликты сериализации.

Особые случаи и нюансы реализации уровней изоляции в PostgreSQL требуют внимательного подхода. Функции с категорией изменчивости VOLATILE могут видеть изменения, произведённые другими транзакциями, даже на уровне Read Committed. Для предотвращения этого можно изменить категорию изменчивости функции на STABLE или IMMUTABLE. На уровне Read Committed возможны потерянные обновления, если операция разбивается на чтение и запись. Чтобы избежать этого, следует использовать уровень Repeatable Read или выше, либо выполнять операции обновления в одном запросе. На уровне Serializable транзакции могут завершаться с ошибкой сериализации, если невозможно выстроить их выполнение в правильном порядке, в этом случае транзакцию нужно повторить.

Практические задания помогают закрепить понимание работы уровней изоляции. Эксперименты с уровнями изоляции демонстрируют, что на уровне Read Committed фантомное чтение не предотвращается. Изменение функций и видимость изменений показывает, как транзакция видит изменения, сделанные с функциями в системном каталоге PostgreSQL. Момент видимости изменений помогает понять, в какой момент транзакция начинает видеть зафиксированные изменения состояния базы данных.

Изучение уровней изоляции транзакций в PostgreSQL помогает понять, как управлять параллелизмом и предотвращать аномалии. Каждый уровень изоляции имеет свои преимущества и ограничения, и выбор уровня зависит от требований приложения. Чем выше уровень изоляции, тем меньше вероятность возникновения аномалий, но тем больше накладные расходы на блокировки и управление параллелизмом.

