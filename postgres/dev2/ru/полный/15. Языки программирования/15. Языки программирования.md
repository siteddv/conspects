# 15. Языки программирования

## Описание

Эта глава посвящена языкам программирования для серверных подпрограмм в PostgreSQL. Мы рассмотрим введение в языки программирования для серверных подпрограмм, доверенные и недоверенные языки, подключение новых языков, преобразование типов данных, интерфейсы и интеграцию языков, практические примеры и задачи, а также заключение о возможностях и ограничениях.

## Части главы

- [[части/1. Введение. Языки программирования для серверных подпрограмм|1. Введение. Языки программирования для серверных подпрограмм]] [1. Введение. Языки программирования для серверных подпрограмм](части/1. Введение. Языки программирования для серверных подпрограмм.md)
- [[части/2. Доверенные и недоверенные языки|2. Доверенные и недоверенные языки]] [2. Доверенные и недоверенные языки](части/2. Доверенные и недоверенные языки.md)
- [[части/3. Подключение новых языков|3. Подключение новых языков]] [3. Подключение новых языков](части/3. Подключение новых языков.md)
- [[части/4. Преобразование типов данных|4. Преобразование типов данных]] [4. Преобразование типов данных](части/4. Преобразование типов данных.md)
- [[части/5. Интерфейсы и интеграция языков|5. Интерфейсы и интеграция языков]] [5. Интерфейсы и интеграция языков](части/5. Интерфейсы и интеграция языков.md)
- [[части/6. Практические примеры и задачи|6. Практические примеры и задачи]] [6. Практические примеры и задачи](части/6. Практические примеры и задачи.md)
- [[части/7. Заключение. Возможности и ограничения|7. Заключение. Возможности и ограничения]] [7. Заключение. Возможности и ограничения](части/7. Заключение. Возможности и ограничения.md)

---

Серверные подпрограммы — это функции или процедуры, которые выполняются непосредственно на стороне сервера базы данных. Они позволяют обрабатывать данные "на месте", минимизируя сетевые задержки и уменьшая нагрузку на клиентскую часть приложения. PostgreSQL поддерживает множество языков, как доверенных (например, PL/pgSQL), так и недоверенных (например, Python). Каждый язык имеет свои преимущества и ограничения, которые необходимо учитывать при выборе.

Доверенные языки — это языки, которые ограничены в своих возможностях взаимодействия с внешними ресурсами (операционной системой, файловой системой, процессами). Они работают в "песочнице" (sandbox), что делает их безопасными для использования. Доверенные языки доступны для всех пользователей базы данных по умолчанию и чаще всего применяются для задач, связанных непосредственно с обработкой данных внутри базы данных. Недоверенные языки предоставляют полный доступ к функциональности языка, включая возможность взаимодействия с операционной системой, файловой системой и процессами. По умолчанию доступ к недоверенным языкам есть только у суперпользователей (администраторов базы данных). Недоверенные языки подходят для задач, которые выходят за рамки базы данных, например, отправка почты, выполнение команд операционной системы, обработка файлов.

Подключение нового языка для написания серверных подпрограмм требует выполнения определенных шагов и соблюдения технических требований. Язык должен быть интерпретируемым, то есть иметь интерпретатор, который может принимать текст программы и выполнять его. Интерпретатор должен быть установлен в операционной системе, где работает база данных. Большинство языков подключаются через механизм расширений PostgreSQL (`CREATE EXTENSION`). Для успешного подключения нового языка необходимо определить три основных компонента: обработчик (Handler) — функция на языке C, которая отвечает за выполнение кода на подключенном языке, валидатор (Validator) — функция, которая выполняет статическую проверку кода при создании функции, и функция для анонимных блоков — если язык поддерживает выполнение анонимных блоков.

Преобразование типов данных — это ключевой аспект работы с серверными подпрограммами, особенно когда данные передаются между базой данных и языком программирования. Преобразование происходит дважды: на входе типы данных базы данных преобразуются в типы данных языка, на выходе результат выполнения функции преобразуется обратно в типы данных базы данных. Тип `json` в базе данных может некорректно преобразовываться в язык программирования. Например, в Python JSON может интерпретироваться как строка (`str`), а не как словарь (`dict`). Начиная с определенной версии PostgreSQL (не раньше 10-й), появилась возможность добавлять пользовательские трансформации типов. Трансформация позволяет указать, как именно преобразовывать типы данных.

SPI (Server Programming Interface) — это низкоуровневый интерфейс PostgreSQL, который позволяет выполнять SQL-запросы, управлять транзакциями, блокировками и другими аспектами работы с базой данных. Этот интерфейс используется движком PostgreSQL для выполнения запросов, поступающих от клиентов. SPI является низкоуровневым интерфейсом, что делает его сложным для использования. Для большинства языков программирования (например, Python, Perl) используются обертки над SPI. Например, в Python используется модуль `plpy`, который предоставляет удобные функции для выполнения запросов.

Практические примеры демонстрируют широкий спектр возможностей, которые предоставляют серверные подпрограммы. Мы рассмотрели несколько практических задач, таких как отправка писем, разложение строки на слова и определение типа файла. Хранимые процедуры выполняются на стороне сервера, что минимизирует сетевые задержки. Запросы компилируются один раз и могут быть переиспользованы. Хранимые процедуры ограничивают доступ к данным, обеспечивая безопасность. Однако отладка хранимых процедур может быть сложной, особенно для языков, не предназначенных для работы с базой данных. Использование хранимых процедур может усложнить миграцию на другую СУБД. Для задач, связанных с обработкой данных внутри базы данных, лучше использовать доверенные языки (например, PL/pgSQL). Для задач, выходящих за рамки базы данных, можно использовать недоверенные языки (например, Python).

