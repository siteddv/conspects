# 4. Журналирование

## Описание

Эта глава посвящена журналированию в PostgreSQL. Мы рассмотрим буферный кэш, работу с буферным кэшем, временные таблицы, журнал предзаписи (WAL), восстановление после сбоя, режимы журналирования и практическую часть.

## Части главы

- [[части/1. Буферный кэш|1. Буферный кэш]] [1. Буферный кэш](части/1. Буферный кэш.md)
- [[части/2. Работа с буферным кэшем|2. Работа с буферным кэшем]] [2. Работа с буферным кэшем](части/2. Работа с буферным кэшем.md)
- [[части/3. Временные таблицы|3. Временные таблицы]] [3. Временные таблицы](части/3. Временные таблицы.md)
- [[части/4. Журнал предзаписи (WAL)|4. Журнал предзаписи (WAL)]] [4. Журнал предзаписи (WAL)](части/4. Журнал предзаписи (WAL).md)
- [[части/5. Восстановление после сбоя|5. Восстановление после сбоя]] [5. Восстановление после сбоя](части/5. Восстановление после сбоя.md)
- [[части/6. Режимы журналирования|6. Режимы журналирования]] [6. Режимы журналирования](части/6. Режимы журналирования.md)
- [[части/7. Практическая часть|7. Практическая часть]] [7. Практическая часть](части/7. Практическая часть.md)

---

Буферный кэш — это механизм, который служит для сглаживания разницы в производительности между оперативной памятью (быстрой, но маленькой) и диском (медленным, но большим). Он выделяет часть оперативной памяти под хранение страниц данных, которые часто используются, чтобы минимизировать обращения к диску. Размер буферного кэша определяется параметром `shared_buffers`. Для быстрого нахождения нужной страницы в буферном кэше используется хэш-таблица, разделенная на 128 фрагментов, каждый из которых имеет свою блокировку. Для предотвращения конфликтов используются механизмы блокировок и закрепления буферов (pin).

Когда свободные буферы в буферном кэше заканчиваются, система использует алгоритм вытеснения CLOCK. Все буферы организованы в виде кругового списка, и у каждого буфера есть счетчик обращений. Алгоритм использует указатель, который движется по кругу и проверяет буферы. Если счетчик становится равным нулю и буфер не закреплен, он может быть вытеснен. Чтобы избежать задержек при вытеснении грязных страниц, PostgreSQL использует процесс фоновой записи (background writer), который предварительно записывает грязные страницы на диск.

Временные таблицы используют локальный буферный кэш, который выделяется в памяти обслуживающего процесса. Этот локальный кэш проще по устройству, чем общий буферный кэш, поскольку не требует блокировок и память выделяется только по мере необходимости. Временные таблицы работают быстрее, чем обычные таблицы, так как исключаются накладные расходы на управление блокировками и синхронизацию.

Журнал предзаписи (Write-Ahead Logging, WAL) — это механизм, который используется для обеспечения надёжности и восстановления данных после сбоя. Основная идея WAL заключается в том, что все изменения данных записываются в журнал до того, как они физически применяются к страницам данных на диске. Журнал WAL представляет собой непрерывный поток байтов, который логически разделён на записи. Каждая запись имеет уникальный номер LSN (Log Sequence Number), который является 64-битным числом, указывающим смещение записи от начала журнала.

Контрольные точки (checkpoints) позволяют ограничить объём журнальных записей, необходимых для восстановления после сбоя. На первой стадии контрольной точки система быстро проходит по всему буферному кэшу и помечает грязные страницы специальным флагом. На второй стадии система постепенно записывает помеченные страницы на диск. После завершения контрольной точки все журнальные записи, предшествующие её началу, могут быть удалены.

Когда происходит сбой, PostgreSQL использует журнал предзаписи для восстановления данных до согласованного состояния. Процесс `startup` определяет точку восстановления из управляющего файла (`pg_control`), который содержит информацию о последней успешно завершённой контрольной точке. Система последовательно читает записи WAL и применяет их к страницам данных. Все транзакции, которые не были зафиксированы, отменяются. После завершения восстановления выполняется финальная контрольная точка.

PostgreSQL предоставляет два основных режима работы с журналом предзаписи: синхронный и асинхронный. В синхронном режиме каждая команда `COMMIT` гарантирует, что все журнальные записи данной транзакции будут записаны на диск до завершения команды. В асинхронном режиме команда `COMMIT` завершается мгновенно, не дожидаясь записи журнальных записей на диск. Запись WAL на диск выполняется фоновым процессом `wal writer`, который периодически сбрасывает накопленные записи. Режим журналирования можно настраивать на уровне экземпляра или транзакции с помощью параметра `synchronous_commit`.

