### Часть 2: Работа с буферным кэшем

#### 2.1 Алгоритм вытеснения страниц (CLOCK)
Когда свободные буферы в буферном кэше заканчиваются, система должна освободить место для новых страниц. Для этого используется алгоритм вытеснения, называемый **CLOCK**.

- **Принцип работы CLOCK**:
  - Все буферы организованы в виде кругового списка (по аналогии с циферблатом часов).
  - У каждого буфера есть **счетчик обращений**, который увеличивается при каждом обращении к странице.
  - Алгоритм использует указатель (**"часовую стрелку"**), который движется по кругу и проверяет буферы.
  - Когда указатель достигает буфера, он уменьшает его счетчик обращений на единицу.
  - Если счетчик становится равным нулю, буфер считается "холодным" и может быть вытеснен.
  - Если буфер закреплен (pin), он пропускается, даже если счетчик равен нулю.

- **Ограничение счетчика обращений**:
  - Максимальное значение счетчика ограничено числом **5**. Это сделано для предотвращения слишком долгого поиска подходящего буфера.
  - Даже если страница используется очень часто, счетчик не будет расти выше 5, чтобы алгоритм мог быстрее найти "мусор".

- **Процесс вытеснения**:
  1. Указатель движется по кругу, уменьшая счетчики.
  2. Если счетчик становится равным нулю и буфер не закреплен, он выбирается для вытеснения.
  3. Если буфер содержит "грязную" страницу (измененные данные), она сначала записывается на диск.
  4. После записи или очистки буфер заменяется новой страницей.

#### 2.2 Процесс фоновой записи
Чтобы избежать задержек при вытеснении грязных страниц, PostgreSQL использует специальный процесс — **фоновую запись (background writer)**.

- **Задача фоновой записи**:
  - Фоновая запись работает параллельно с основными процессами и предварительно записывает грязные страницы на диск.
  - Это позволяет минимизировать вероятность того, что пользовательский запрос будет вынужден ждать записи данных на диск.

- **Логика работы**:
  - У фоновой записи есть собственный указатель, который движется немного впереди основного указателя CLOCK.
  - Она находит страницы, которые с большой вероятностью скоро будут вытеснены, и записывает их на диск.
  - Таким образом, когда основной процесс достигает этих страниц, они уже записаны, и их можно быстро вытеснить.

#### 2.3 Чтение данных и работа с грязными страницами
- **Чтение данных**:
  - При первом чтении страницы она загружается в буферный кэш через кэш операционной системы.
  - Если страница уже находится в буферном кэше, чтение происходит напрямую из оперативной памяти, что значительно быстрее.

- **Грязные страницы**:
  - Страница становится "грязной", если её содержимое изменено, но ещё не записано на диск.
  - Грязные страницы могут оставаться в кэше длительное время, так как это позволяет экономить операции записи на диск.
  - Однако, если требуется освободить буфер для новой страницы, грязная страница сначала записывается на диск.

---

Это завершает вторую часть конспекта, посвящённую работе с буферным кэшем. Хотите перейти к третьей части, где рассматриваются временные таблицы?

