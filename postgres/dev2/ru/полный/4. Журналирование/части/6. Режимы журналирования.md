### Часть 6: Режимы журналирования

#### 6.1 Синхронный и асинхронный режимы записи
PostgreSQL предоставляет два основных режима работы с журналом предзаписи (WAL): **синхронный** и **асинхронный**. Выбор режима зависит от того, какой компромисс между производительностью и надёжностью требуется в конкретной ситуации.

- **Синхронный режим**:
  - В этом режиме каждая команда `COMMIT` гарантирует, что все журнальные записи данной транзакции будут записаны на диск до завершения команды.
  - Это достигается за счёт вызова операционной системы для принудительной синхронизации данных с физическим носителем (например, через системный вызов `fsync`).
  - **Преимущества**:
    - Максимальная надёжность: если сервер упадёт сразу после успешного завершения транзакции, данные гарантированно сохранятся.
  - **Недостатки**:
    - Производительность страдает, так как каждый `COMMIT` связан с реальной работой с медленным устройством (диском).
    - Это особенно заметно при высокой нагрузке, когда выполняется много мелких транзакций.

- **Асинхронный режим**:
  - В этом режиме команда `COMMIT` завершается мгновенно, не дожидаясь записи журнальных записей на диск.
  - Запись WAL на диск выполняется фоновым процессом — **wal writer** (или `walwriter`), который периодически сбрасывает накопленные записи.
  - **Преимущества**:
    - Значительно более высокая производительность, так как нет задержек на синхронизацию с диском.
    - Фоновый процесс может эффективно группировать записи и записывать их на диск за один проход.
  - **Недостатки**:
    - Нет гарантии долговечности данных: если сервер упадёт до того, как wal writer успеет записать изменения на диск, последние транзакции могут быть потеряны.
    - После восстановления система может оказаться в состоянии, как будто этих транзакций никогда не было.

#### 6.2 Процесс wal writer
Процесс `wal writer` играет ключевую роль в асинхронном режиме работы с журналом.

- **Как работает wal writer**:
  - По умолчанию процесс просыпается примерно каждые **полсекунды** (точное значение можно настроить).
  - За это время накапливаются все журнальные записи, созданные транзакциями.
  - Wal writer записывает их на диск за один проход, что значительно эффективнее, чем запись каждой записи по отдельности.
  
- **Компромисс между производительностью и надёжностью**:
  - Если сервер упадёт в течение этого полусекундного интервала, последние изменения могут быть потеряны.
  - Однако, если потеря нескольких последних транзакций допустима (например, в аналитических системах или тестовых средах), этот режим позволяет значительно повысить производительность.

#### 6.3 Настройка режимов журналирования
Режим журналирования можно настраивать на разных уровнях:

- **На уровне экземпляра**:
  - Параметр `synchronous_commit` определяет, будет ли PostgreSQL использовать синхронный или асинхронный режим.
  - Значение `on` (по умолчанию) включает синхронный режим.
  - Значение `off` переключает систему в асинхронный режим.

- **На уровне транзакции**:
  - Параметр `synchronous_commit` можно изменять даже внутри одной транзакции.
  - Это позволяет гибко выбирать, какие транзакции должны быть максимально надёжными, а какие — быстрыми.

#### 6.4 Пример использования
- **Сценарий 1: Критичные данные**:
  - Например, финансовые операции или важные бизнес-процессы.
  - Здесь используется синхронный режим (`synchronous_commit = on`), чтобы гарантировать, что данные не будут потеряны ни при каких обстоятельствах.

- **Сценарий 2: Некритичные данные**:
  - Например, логирование событий или сбор аналитики.
  - Здесь можно использовать асинхронный режим (`synchronous_commit = off`), чтобы минимизировать накладные расходы на запись.

---

Это завершает шестую часть конспекта, посвящённую режимам журналирования. Хотите перейти к седьмой части, где рассматриваются практические задания?

