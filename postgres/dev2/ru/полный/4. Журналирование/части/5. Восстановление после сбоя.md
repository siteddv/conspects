### Часть 5: Восстановление после сбоя

#### 5.1 Процесс восстановления системы
Когда происходит сбой, PostgreSQL использует журнал предзаписи (WAL) для восстановления данных до согласованного состояния. Этот процесс выполняется специальным процессом — **startup**.

- **Запуск процесса startup**:
  - После сбоя PostgreSQL запускает процесс `startup`, который отвечает за восстановление данных.
  - Первым делом этот процесс проверяет, был ли сбой, и если да, начинает процесс восстановления.

- **Определение точки восстановления**:
  - Для начала восстановления система должна определить точку, с которой начинать чтение журнала WAL.
  - Эта точка берётся из управляющего файла (`pg_control`), который содержит информацию о последней успешно завершённой контрольной точке.
  - Управляющий файл записывается на диск после каждой контрольной точки, поэтому он всегда содержит актуальную информацию.

- **Чтение журнала WAL**:
  - Процесс `startup` начинает последовательно читать записи WAL, начиная с позиции, указанной в управляющем файле.
  - Каждая запись WAL имеет уникальный номер LSN (Log Sequence Number), который используется для определения, нужно ли применять изменения к страницам данных.

#### 5.2 Обработка незавершенных транзакций
После применения всех записей WAL система может обнаружить транзакции, которые были начаты, но не завершены на момент сбоя. Эти транзакции должны быть отменены.

- **Отмена незавершенных транзакций**:
  - Все транзакции, которые не были зафиксированы (COMMIT), считаются прерванными.
  - Система обновляет таблицу состояний транзакций, помечая такие транзакции как отменённые.
  - Это гарантирует, что база данных остаётся в согласованном состоянии, даже если сбой произошёл в середине выполнения транзакции.

- **Очистка временных данных**:
  - Если в системе были временные таблицы или другие временные данные, они автоматически удаляются, так как их состояние не может быть восстановлено.
  - В таблице состояний транзакций временные данные заменяются "пустышками", чтобы избежать ошибок при дальнейшей работе.

#### 5.3 Финальная контрольная точка
После завершения восстановления выполняется финальная контрольная точка.

- **Цель финальной контрольной точки**:
  - Поскольку все изменения во время восстановления происходят в буферном кэше, их необходимо зафиксировать на диске.
  - Финальная контрольная точка записывает все грязные страницы на диск, чтобы гарантировать, что восстановленное состояние сохранено.

- **Готовность к работе**:
  - После завершения финальной контрольной точки система считается восстановленной и готовой к работе.
  - Пользователи могут продолжать работу с базой данных, как будто сбой никогда не происходил.

---

Это завершает пятую часть конспекта, посвящённую восстановлению после сбоя. Хотите перейти к шестой части, где рассматриваются режимы журналирования?

