### Часть 1: Буферный кэш

#### 1.1 Основное назначение и устройство буферного кэша
Буферный кэш — это механизм, который служит для сглаживания разницы в производительности между оперативной памятью (быстрой, но маленькой) и диском (медленным, но большим). Он выделяет часть оперативной памяти под хранение страниц данных, которые часто используются, чтобы минимизировать обращения к диску.

- **Параметр `shared_buffers`**: Определяет размер буферного кэша. В примере используется значение по умолчанию — 128 МБ, что считается скромным для современных серверов. Обычно этот параметр увеличивают в зависимости от доступной оперативной памяти.
- **Структура буфера**: Каждый буфер содержит:
  - **Место для хранения страницы данных** (обычно 8 КБ).
  - **Головку буфера** — служебную информацию, которая включает:
    - Имя файла, из которого была прочитана страница.
    - Номер страницы внутри файла.
  
#### 1.2 Хэш-таблица для быстрого поиска страниц
Для быстрого нахождения нужной страницы в буферном кэше используется **хэш-таблица**. 

- **Ключи хэш-таблицы**: Состоят из имени файла и смещения внутри файла (то есть уникального адреса страницы).
- **Процесс поиска**:
  1. Вычисляется хэш-функция от ключа.
  2. Полученная ячейка проверяется на наличие нужной страницы.
  3. Если найдена коллизия (несколько страниц имеют одинаковый хэш), выполняется дополнительная проверка.

Хэш-таблица разделена на **128 фрагментов** (на момент записи), каждый из которых имеет свою блокировку. Это позволяет минимизировать конфликты при одновременном доступе нескольких процессов. В будущем количество фрагментов может увеличиваться для повышения параллельности.

#### 1.3 Механизмы блокировок и закрепления буферов
Поскольку буферный кэш находится в разделяемой памяти, к нему могут одновременно обращаться несколько процессов. Для предотвращения конфликтов используются механизмы блокировок:

- **Блокировка хэш-таблицы**:
  - При чтении данных из хэш-таблицы используется **блокировка в режиме "разделяемого чтения"**, которая позволяет другим процессам также читать данные, но запрещает их изменение.
  - При записи или изменении данных используется **монопольная блокировка**, которая полностью блокирует доступ других процессов.
  
- **Закрепление буфера (pin)**:
  - Когда процесс начинает работать со страницей, он "закрепляет" её, чтобы другие процессы не могли её вытеснить.
  - Закрепление — это мягкая блокировка, которая позволяет другим процессам выполнять некоторые операции с страницей (например, добавлять новые версии строк), но запрещает её вытеснение.

- **Счетчик обращений**:
  - Каждая страница имеет счетчик обращений, который увеличивается при каждом обращении к ней.
  - Этот счетчик используется алгоритмом вытеснения для определения того, как часто страница используется.

---

Это завершает первую часть конспекта, посвящённую основам устройства буферного кэша. Хотите перейти ко второй части, где рассматривается работа с буферным кэшем?

