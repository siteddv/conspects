### Часть 2: Блокировки объектов

#### Блокировки номеров транзакций
Блокировки номеров транзакций — это важный механизм, который позволяет упорядочить доступ к данным и обеспечить их целостность. Каждая транзакция в PostgreSQL имеет уникальный номер (или виртуальный номер), который используется для отслеживания изменений.

- **Виртуальный номер транзакции**: Выдается каждой транзакции на этапе чтения данных. Этот номер не требует обращения к общей памяти и может повторяться в разных временных промежутках.
- **Настоящий номер транзакции**: Выдается только тогда, когда транзакция начинает изменять данные. Этот номер уникален в рамках всей системы.

Транзакция всегда удерживает **исключительную блокировку** собственного номера:
- Если у транзакции есть только виртуальный номер, она удерживает блокировку виртуального номера.
- Если транзакция получает настоящий номер, она также удерживает блокировку этого номера.

##### Пример работы с номерами транзакций:
1. Создание транзакции:
   - Транзакция начинается с виртуального номера.
   - В `pg_locks` можно увидеть строку с типом блокировки `virtualxid` и режимом `ExclusiveLock`.

2. Получение настоящего номера:
   - При выполнении команды, изменяющей данные (например, `UPDATE` или вызов функции `txid_current()`), транзакция получает настоящий номер.
   - В `pg_locks` добавляется новая строка с типом блокировки `transactionid` и режимом `ExclusiveLock`.

##### Практическое применение:
- Блокировка номера транзакции позволяет дождаться завершения другой транзакции. Например, если одна транзакция хочет получить разделяемую блокировку номера другой транзакции, она будет ждать, пока исключительная блокировка не освободится.

---

#### Блокировки отношений (таблиц и индексов)
Блокировки отношений используются для управления доступом к таблицам, индексам, последовательностям и другим объектам базы данных. Эти блокировки хранятся в оперативной памяти и видны через представление `pg_locks`.

##### Режимы блокировок отношений:
PostgreSQL поддерживает **8 режимов блокировок отношений**, которые позволяют различным командам работать одновременно, если это возможно:
1. **AccessShareLock**: Самый слабый режим, совместим со всеми другими режимами, кроме `AccessExclusiveLock`. Используется командой `SELECT`.
2. **RowShareLock**: Используется для блокировки строк при выполнении `SELECT FOR UPDATE`.
3. **RowExclusiveLock**: Используется для операций изменения данных (`INSERT`, `UPDATE`, `DELETE`).
4. **ShareUpdateExclusiveLock**: Используется для операций, таких как `VACUUM`.
5. **ShareLock**: Используется для операций, таких как `CREATE INDEX`.
6. **ShareRowExclusiveLock**: Сильный режим, используемый для операций, изменяющих структуру таблицы.
7. **ExclusiveLock**: Блокирует все изменения данных.
8. **AccessExclusiveLock**: Самый строгий режим, требуемый для операций, таких как `DROP TABLE`.

##### Примеры совместимости:
- Команда `SELECT` блокирует таблицу в режиме `AccessShareLock`, что не мешает другим командам выполнять чтение.
- Команда `DROP TABLE` требует режим `AccessExclusiveLock`, который несовместим ни с какими другими режимами.

##### Очередь ожидания блокировок:
Очередь ожидания блокировок в PostgreSQL является **честной**:
- Если одна транзакция удерживает блокировку, другие транзакции встают в очередь и ожидают освобождения блокировки.
- Даже команды с более слабыми режимами блокировок (например, `SELECT`) не могут "пролезть без очереди", даже если их режим совместим с текущей блокировкой.

##### Пример:
1. Транзакция A выполняет `UPDATE` таблицы, удерживая блокировку в режиме `RowExclusiveLock`.
2. Транзакция B пытается выполнить `DROP TABLE`, но ей требуется `AccessExclusiveLock`. Она встает в очередь.
3. Транзакция C выполняет `SELECT`, который требует `AccessShareLock`. Несмотря на совместимость режимов, она также встает в очередь за транзакцией B.

---

### Ключевые моменты для Obsidian:

#### Блокировки номеров транзакций
- **Виртуальный номер**: Легко выдается, не требует обращения к общей памяти.
- **Настоящий номер**: Выдается только при изменении данных.
- **Исключительная блокировка**: Удерживается для каждого номера транзакции.

#### Блокировки отношений
- **8 режимов блокировок**: От самого слабого (`AccessShareLock`) до самого строгого (`AccessExclusiveLock`).
- **Матрица совместимости**: Позволяет определить, какие режимы блокировок могут сосуществовать.
- **Честная очередь**: Все транзакции ожидают освобождения блокировки в порядке поступления.

#### Практические примеры
- **Чтение данных**: Использует `AccessShareLock`, совместимый с другими режимами.
- **Изменение данных**: Требует `RowExclusiveLock` или более строгие режимы.
- **Операции с таблицами**: `DROP TABLE` требует `AccessExclusiveLock`, который блокирует все остальные операции.

#### Важные термины
- **Виртуальный номер транзакции**: Уникальный номер внутри одной сессии.
- **Настоящий номер транзакции**: Глобально уникальный номер, выдаваемый при изменении данных.
- **Режимы блокировок**: Различные уровни доступа к данным, обеспечивающие совместимость операций.

---

Это завершает вторую часть конспекта. Хотите перейти к третьей части?