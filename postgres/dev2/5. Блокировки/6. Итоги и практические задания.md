### Часть 6: Итоги и практические задания

#### Итоги
В завершение темы блокировок, давайте подведем основные итоги:

1. **Блокировки для конкурентного доступа**:
   - Блокировки используются для организации конкурентного доступа к общим ресурсам.
   - Различные типы блокировок применяются в зависимости от типа объекта (отношения, строки, номера транзакций).

2. **Блокировки отношений**:
   - Хранятся в оперативной памяти сервера.
   - Видны через представление `pg_locks`.
   - Очередь ожидания блокировок является честной.

3. **Блокировки строк**:
   - Реализованы иначе из-за их большого количества.
   - Информация о блокировках строк хранится непосредственно в страницах данных.
   - Очередь организована с использованием блокировок объектов, что делает её менее "честной".

4. **Проблемы с горячими точками**:
   - Активное обновление одной и той же строки может привести к проблемам производительности.
   - Рекомендуется минимизировать такие "горячие точки" в системе.

#### Практические задания

1. **Чтение строки с использованием первичного ключа**:
   - **Задание**: Определите, какие блокировки создаются при чтении строки с использованием первичного ключа.
   - **Теоретический анализ**:
     - При чтении строки с использованием первичного ключа, PostgreSQL обычно не создает блокировок строк.
     - Однако, если используется команда `SELECT ... FOR UPDATE`, то создается блокировка строки в режиме `FOR UPDATE`.

   - **Практическая проверка**:
     ```sql
     BEGIN;
     SELECT * FROM accounts WHERE id = 1 FOR UPDATE;
     ```
     - Проанализируйте `pg_locks` для текущего процесса:
       ```sql
       SELECT locktype, relation::regclass, mode, granted
       FROM pg_locks
       WHERE pid = pg_backend_pid();
       ```

2. **Рекомендательные блокировки**:
   - **Задание**: Исследуйте, как работают рекомендательные блокировки (`pg_advisory_lock`).
   - **Теоретический анализ**:
     - Рекомендательные блокировки позволяют управлять пользовательскими блокировками.
     - Они видны через представление `pg_locks`.

   - **Практическая проверка**:
     ```sql
     BEGIN;
     SELECT pg_advisory_lock(1);
     -- В другом сеансе:
     SELECT pg_advisory_lock(1);
     ```
     - Проанализируйте `pg_locks` для обоих процессов.

3. **Проверка внешних ключей и обновление полей**:
   - **Задание**: Убедитесь, что проверка внешних ключей и обновление неключевых полей могут выполняться одновременно.
   - **Теоретический анализ**:
     - Проверка внешних ключей использует режим `FOR KEY SHARE`.
     - Обновление неключевых полей использует режим `FOR NO KEY UPDATE`.
     - Эти режимы совместимы.

   - **Практическая проверка**:
     ```sql
     -- Транзакция A:
     BEGIN;
     UPDATE accounts SET amount = amount + 100 WHERE id = 1;

     -- Транзакция B:
     BEGIN;
     SELECT * FROM accounts WHERE id = 1 FOR KEY SHARE;
     ```

4. **Взаимная блокировка**:
   - **Задание**: Воспроизведите ситуацию взаимной блокировки между двумя транзакциями.
   - **Теоретический анализ**:
     - Взаимная блокировка возникает, когда две транзакции удерживают ресурсы, необходимые друг другу.

   - **Практическая проверка**:
     ```sql
     -- Транзакция A:
     BEGIN;
     UPDATE accounts SET amount = amount + 100 WHERE id = 1;

     -- Транзакция B:
     BEGIN;
     UPDATE accounts SET amount = amount - 50 WHERE id = 2;

     -- Транзакция A:
     UPDATE accounts SET amount = amount + 100 WHERE id = 2;

     -- Транзакция B:
     UPDATE accounts SET amount = amount - 50 WHERE id = 1;
     ```

---

### Ключевые моменты для Obsidian:

#### Итоги
- **Конкурентный доступ**: Блокировки обеспечивают упорядоченный доступ к разделяемым ресурсам.
- **Блокировки отношений**: Хранятся в оперативной памяти, очередь честная.
- **Блокировки строк**: Хранятся в страницах данных, очередь менее честная.
- **Горячие точки**: Минимизируйте активное обновление одной строки.

#### Практические задания
- **Чтение строки**: Анализ блокировок при чтении с использованием первичного ключа.
- **Рекомендательные блокировки**: Исследование пользовательских блокировок.
- **Проверка внешних ключей**: Совместимость операций.
- **Взаимная блокировка**: Воспроизведение и анализ.

#### Важные термины
- **Горячая точка**: Часто обновляемая строка.
- **Рекомендательные блокировки**: Пользовательские блокировки.
- **Взаимная блокировка**: Ситуация, когда две транзакции блокируют друг друга.

---

Это завершает шестую часть конспекта. Хотите перейти к следующей части или завершить?