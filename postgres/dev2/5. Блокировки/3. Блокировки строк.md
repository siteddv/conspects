### Часть 3: Блокировки строк

#### Особенности реализации блокировок строк
Блокировки строк в PostgreSQL имеют свои особенности, которые отличают их от блокировок объектов. Основная сложность заключается в том, что количество строк в таблицах может быть огромным (миллиарды строк), и хранить информацию о блокировках каждой строки в оперативной памяти нереалистично.

- **Хранение информации о блокировках**: В отличие от блокировок объектов, информация о блокировках строк не хранится в оперативной памяти. Вместо этого она хранится непосредственно в страницах данных на диске.
- **Поле `xmax`**: Для реализации блокировок строк используется поле `xmax` в строках данных. Это поле обычно содержит номер транзакции, которая удалила или изменила строку. Однако при блокировке строки в это поле записывается номер блокирующей транзакции.

##### Пример работы с полем `xmax`:
1. Транзакция A изменяет строку:
   - В поле `xmax` записывается номер транзакции A.
   - Это указывает, что строка заблокирована транзакцией A.

2. Транзакция B пытается изменить ту же строку:
   - Она видит, что поле `xmax` уже занято, и понимает, что строка заблокирована другой транзакцией.
   - Транзакция B вынуждена ждать освобождения блокировки.

#### Режимы блокировок строк
В PostgreSQL существует **четыре режима блокировок строк**, которые позволяют различным командам работать с данными одновременно:

1. **`FOR UPDATE`**:
   - Самый строгий режим.
   - Блокирует строку для любых изменений.
   - Используется, когда нужно обновить все поля строки, включая ключевые.

2. **`FOR NO KEY UPDATE`**:
   - Менее строгий режим.
   - Блокирует строку только для изменений не ключевых полей.
   - Используется, когда нужно обновить только неключевые поля.

3. **`FOR SHARE`**:
   - Разделяемый режим.
   - Позволяет нескольким транзакциям читать строку, но запрещает её изменение.
   - Используется, например, при проверке внешних ключей.

4. **`FOR KEY SHARE`**:
   - Наименее строгий режим.
   - Позволяет изменять только неключевые поля.
   - Используется, когда нужно защитить только ключевые поля строки.

##### Совместимость режимов:
- `FOR SHARE` совместим с `FOR NO KEY UPDATE`.
- `FOR UPDATE` и `FOR NO KEY UPDATE` несовместимы друг с другом.
- Это позволяет выполнять одновременно проверку внешних ключей и обновление неключевых полей.

#### Механизм мультитранзакций
Одна из проблем блокировок строк — это ограничение поля `xmax`, которое может содержать только один номер транзакции. Для решения этой проблемы PostgreSQL использует механизм **мультитранзакций**.

- **Мультитранзакция**: Это специальная структура данных, которая позволяет хранить несколько номеров транзакций в одном поле `xmax`.
- **Расшифровка мультитранзакций**: Информация о мультитранзакциях хранится отдельно, и её можно расшифровать с помощью расширения `pgrowlocks`.

##### Пример использования мультитранзакций:
1. Транзакция A блокирует строку в режиме `FOR SHARE`.
2. Транзакция B также блокирует ту же строку в режиме `FOR SHARE`.
3. В поле `xmax` записывается специальный номер мультитранзакции, который указывает на обе транзакции.

#### Практические примеры работы с блокировками строк
4. **Обновление строки**:
   ```sql
   BEGIN;
   UPDATE accounts SET amount = amount + 100 WHERE id = 1;
   ```
   - В поле `xmax` записывается номер текущей транзакции.
   - Другие транзакции, пытающиеся изменить эту строку, будут ждать освобождения блокировки.

5. **Использование `SKIP LOCKED`**:
   ```sql
   SELECT * FROM accounts WHERE id = 1 FOR UPDATE SKIP LOCKED;
   ```
   - Если строка уже заблокирована, команда пропускает её и переходит к следующей доступной строке.

6. **Проверка внешних ключей**:
   - При проверке внешних ключей PostgreSQL автоматически использует режим `FOR KEY SHARE`, чтобы защитить ключевые поля строки.

---

### Ключевые моменты для Obsidian:

#### Особенности реализации блокировок строк
- **Хранение на диске**: Информация о блокировках строк хранится в страницах данных, а не в оперативной памяти.
- **Поле `xmax`**: Используется для хранения номера блокирующей транзакции.

#### Режимы блокировок строк
- **`FOR UPDATE`**: Блокирует строку для любых изменений.
- **`FOR NO KEY UPDATE`**: Блокирует строку только для изменений не ключевых полей.
- **`FOR SHARE`**: Разрешает чтение строки несколькими транзакциями.
- **`FOR KEY SHARE`**: Защищает только ключевые поля строки.

#### Механизм мультитранзакций
- **Мультитранзакция**: Позволяет хранить несколько номеров транзакций в одном поле `xmax`.
- **Расширение `pgrowlocks`**: Помогает анализировать блокировки строк.

#### Практические примеры
- **Обновление строки**: Использует поле `xmax` для блокировки.
- **`SKIP LOCKED`**: Пропускает заблокированные строки.
- **Проверка внешних ключей**: Автоматически использует режим `FOR KEY SHARE`.

#### Важные термины
- **Мультитранзакция**: Структура данных для хранения нескольких номеров транзакций.
- **Поле `xmax`**: Поле в строках данных, используемое для блокировок.
- **Режимы блокировок строк**: Различные уровни доступа к строкам данных.

---

Это завершает третью часть конспекта. Хотите перейти к четвертой части?