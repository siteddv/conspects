### Часть 4: Интерфейс и система аутентификации (18:44 - 28:02)

#### Организация ролей:
1. **Две основные роли**:
   - **`web`**: Используется для взаимодействия с интернет-магазином.
   - **`admin`**: Используется для работы с админкой.

2. **Схемы**:
   - **`web`**: Содержит функции, доступные только для интернет-магазина.
   - **`admin`**: Содержит функции, доступные только для админки.
   - **`public`**: Содержит все таблицы и внутренние функции. Роли `web` и `admin` не имеют прямого доступа к этой схеме.

3. **Безопасность**:
   - Все функции в схемах `web` и `admin` объявлены с параметром `SECURITY DEFINER`.
   - Это позволяет функциям обращаться к объектам, к которым у вызывающего пользователя нет прямого доступа.

---

#### Механизм работы с пользователями и сессиями:

4. **Регистрация пользователей**:
   - Функция `register_user`:
     - Добавляет новую запись в таблицу `users`.
     - Принимает параметры: имя пользователя и адрес электронной почты.
     - Пример использования:
       ```sql
       SELECT register_user('charlie', 'charlie@example.com');
       ```
     - Возвращает уникальный токен для нового пользователя.

5. **Вход в систему**:
   - Функция `login`:
     - Создаёт новую запись в таблице `sessions`.
     - Генерирует уникальный токен (UUID) для сеанса.
     - Пример использования:
       ```sql
       SELECT login('charlie');
       ```
     - Возвращает токен, который используется для всех последующих запросов, требующих аутентификации.

6. **Проверка токена**:
   - Функция `check_token`:
     - Проверяет наличие токена в таблице `sessions`.
     - Если токен найден, возвращает имя пользователя.
     - Если токен не найден, возвращает ошибку.
     - Пример использования:
       ```sql
       SELECT check_token('токен_пользователя');
       ```

7. **Завершение сеанса**:
   - Функция `logout`:
     - Удаляет запись о текущем сеансе из таблицы `sessions`.
     - Пример использования:
       ```sql
       SELECT logout('токен_пользователя');
       ```

---

#### Особенности реализации:

8. **Автоматическая очистка старых сеансов**:
   - При входе пользователя в систему автоматически удаляются все его предыдущие сеансы.
   - Реализовано через вызов функции `logout` для каждого старого токена.

9. **Пример работы с пользователями**:
   - **Регистрация**:
     ```sql
     SELECT register_user('new_user', 'new_user@example.com');
     ```
   - **Вход**:
     ```sql
     SELECT login('new_user');
     ```
   - **Проверка токена**:
     ```sql
     SELECT check_token('токен_пользователя');
     ```
   - **Выход**:
     ```sql
     SELECT logout('токен_пользователя');
     ```

---

#### Каталог книг:

10. **Функция `get_catalog`**:
   - Возвращает список книг на основе поискового запроса.
   - Параметры:
     - Поисковая строка.
     - Поле сортировки.
     - Порядок сортировки (по возрастанию или убыванию).
   - Пример использования:
     ```sql
     SELECT * FROM get_catalog('базы данных', 'price', 'ASC');
     ```

11. **Поиск книг**:
   - Поиск выполняется не только по названию, но и по авторам, аннотациям и другим полям.
   - Учитывает морфологию слов (например, "базы данных" находит книги с названием "основы базу данных").

12. **Функция `get_image`**:
   - Возвращает обложку книги.
   - Вызывается отдельно для оптимизации загрузки списка книг.
   - Пример использования:
     ```sql
     SELECT get_image(3); -- Получить обложку книги с ID = 3
     ```

13. **Голосование за книги**:
   - Функция `cast_vote`:
     - Увеличивает или уменьшает рейтинг книги.
     - Требует аутентификации.
     - Пример использования:
       ```sql
       SELECT cast_vote('токен_пользователя', 3, 1); -- Голос "за" книгу с ID = 3
       SELECT cast_vote('токен_пользователя', 3, -1); -- Голос "против" книги с ID = 3
       ```

14. **Установка розничной цены**:
   - Функция `set_retail_price`:
     - Устанавливает новую розничную цену на книгу.
     - Принимает параметры: идентификатор книги, цена, дата начала действия.
     - Пример использования:
       ```sql
       SELECT set_retail_price(3, 700, NOW());
       ```

15. **Поступление книг**:
   - Функция `receive_books`:
     - Создаёт запись о поступлении книг.
     - Принимает параметры: идентификатор книги, количество, цена.
     - Пример использования:
       ```sql
       SELECT receive_books(3, 50, 100);
       ```

---

#### Пример взаимодействия с каталогом:

16. **Поиск книг**:
   ```sql
   SELECT * FROM get_catalog('базы данных', 'price', 'ASC');
   ```

17. **Установка цены**:
   ```sql
   SELECT set_retail_price(3, 700, NOW());
   ```

18. **Поступление книг**:
   ```sql
   SELECT receive_books(3, 50, 100);
   ```

19. **Голосование за книгу**:
   ```sql
   SELECT cast_vote('токен_пользователя', 3, 1);
   ```

20. **Проверка голосов**:
   ```sql
   SELECT votes_up, votes_down FROM books WHERE id = 3;
   ```

---

### Подготовка к следующей части:
В следующей части мы рассмотрим функционал каталога и корзины, включая работу с корзиной, покупку книг и особенности транзакций при работе с корзиной. Хотите продолжить?