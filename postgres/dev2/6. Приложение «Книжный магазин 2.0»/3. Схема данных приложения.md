### Часть 3: Схема данных приложения (13:39 - 18:44)

#### ER-диаграмма и структура таблиц:
1. **Основные сущности**:
   - **Авторы (Authors)**:
     - Хранит информацию об авторах книг.
     - Основные поля: `id`, `name`.
     - Связана с книгами через отношение "многие ко многим" через таблицу `authorship`.

   - **Книги (Books)**:
     - Хранит информацию о книгах.
     - Основные поля:
       - `id`: Уникальный идентификатор книги.
       - `title`: Название книги.
       - `format`: Формат издания (например, твердый переплёт, мягкий переплёт).
       - `pages`: Количество страниц.
       - `rating`: Рейтинг книги (рассчитывается на основе голосов).
       - `votes_up`, `votes_down`: Количество положительных и отрицательных голосов.
       - `stock_count`: Текущее количество экземпляров книги на складе (обновляется триггером).
     - Связана с авторами через таблицу `authorship`.

   - **Розничные цены (Retail Prices)**:
     - Хранит историю изменения розничных цен на книги.
     - Основные поля:
       - `book_id`: Идентификатор книги.
       - `price`: Цена.
       - `valid_from`: Дата и время, с которых цена начинает действовать.
     - Отношение "один ко многим" с таблицей `books`.

   - **Пользователи (Users)**:
     - Хранит информацию о зарегистрированных пользователях.
     - Основные поля:
       - `id`: Уникальный идентификатор пользователя.
       - `name`: Имя пользователя.
       - `email`: Адрес электронной почты.
     - Связана с корзиной через таблицу `cart_items`.

   - **Сеансы (Sessions)**:
     - Хранит информацию о текущих сеансах пользователей.
     - Основные поля:
       - `token`: Уникальный идентификатор сеанса.
       - `user_id`: Идентификатор пользователя.
       - `created_at`: Время создания сеанса.

   - **Корзина (Cart Items)**:
     - Хранит информацию о книгах, добавленных в корзину.
     - Основные поля:
       - `user_id`: Идентификатор пользователя.
       - `book_id`: Идентификатор книги.
       - `quantity`: Количество экземпляров книги в корзине.
     - Отношение "многие ко многим" между пользователями и книгами.

   - **Операции (Operations)**:
     - Хранит информацию о всех операциях с книгами (поступления, покупки).
     - Основные поля:
       - `id`: Уникальный идентификатор операции.
       - `book_id`: Идентификатор книги.
       - `quantity`: Количество книг (положительное для поступлений, отрицательное для покупок).
       - `price`: Цена за единицу.
       - `date`: Дата операции.

2. **Взаимосвязи между таблицами**:
   - **Авторы и книги**:
     - Через таблицу `authorship` реализовано отношение "многие ко многим".
     - Поля: `author_id`, `book_id`.

   - **Книги и розничные цены**:
     - Отношение "один ко многим".
     - Одна книга может иметь несколько цен, действующих в разные периоды времени.

   - **Пользователи и корзина**:
     - Отношение "многие ко многим".
     - Пользователь может добавить несколько книг в корзину, а одна и та же книга может быть в корзинах разных пользователей.

   - **Пользователи и сеансы**:
     - Отношение "один ко многим".
     - Один пользователь может иметь несколько сеансов.

   - **Книги и операции**:
     - Отношение "один ко многим".
     - Одна книга может участвовать в нескольких операциях.

3. **Дополнительные таблицы**:
   - **Фоновые задачи (Background Tasks)**:
     - Хранит информацию о фоновых задачах.
     - Основные поля:
       - `id`: Уникальный идентификатор задачи.
       - `program_name`: Имя программы.
       - `parameters`: Параметры выполнения.
       - `start_time`: Время начала выполнения.
       - `end_time`: Время завершения.
       - `status`: Статус выполнения (например, "в процессе", "завершено", "ошибка").
       - `result`: Результат выполнения.

   - **Программы (Programs)**:
     - Хранит информацию о доступных фоновых программах.
     - Основные поля:
       - `id`: Уникальный идентификатор программы.
       - `name`: Имя программы.
       - `function_name`: Имя функции, реализующей программу.

#### Особенности реализации:
4. **Триггеры**:
   - Поле `stock_count` в таблице `books` обновляется автоматически с помощью триггера.
   - Триггер реагирует на изменения в таблице `operations` и корректирует количество книг на складе.

5. **Ограничения**:
   - Поле `stock_count` имеет ограничение: значение не может быть меньше нуля.
   - Это гарантирует, что система не позволит продать больше книг, чем есть на складе.

6. **Разделение схем**:
   - Все таблицы находятся в схеме `public`.
   - Интерфейсные функции разделены на две схемы:
     - `web`: Для работы с интернет-магазином.
     - `admin`: Для работы с админкой.

7. **Безопасность**:
   - Все функции объявлены с параметром `SECURITY DEFINER`.
   - Это позволяет функциям обращаться к объектам, к которым у вызывающего пользователя нет прямого доступа.

---

### Пример взаимодействия с таблицами:
8. **Добавление книги в корзину**:
   - Функция `add_to_cart` проверяет токен с помощью функции `check_token`.
   - Если книга уже есть в корзине, обновляет количество.
   - Если книги нет, создаёт новую запись в таблице `cart_items`.

9. **Установка розничной цены**:
   - Функция `set_retail_price` добавляет новую запись в таблицу `retail_prices`.
   - Цена начинает действовать с указанного времени.

10. **Покупка книг**:
   - Функция `checkout` проверяет наличие книг на складе.
   - Если все книги доступны, создаёт записи в таблице `operations` с отрицательным количеством.
   - Обновляет поле `stock_count` через триггер.

---

### Подготовка к следующей части:
В следующей части мы рассмотрим интерфейс и систему аутентификации, включая механизмы работы с пользователями и сессиями. Хотите продолжить?