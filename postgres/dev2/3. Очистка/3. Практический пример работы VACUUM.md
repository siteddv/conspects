### **Часть 3: Практический пример работы `VACUUM`**

#### **1. Подготовка таблицы для эксперимента**
Для демонстрации работы команды `VACUUM` создадим таблицу с определенной структурой:
- Таблица содержит два столбца: числовой идентификатор (`id`) и числовой столбец.
- Автоматическая очистка (`autovacuum`) отключена, чтобы управлять процессом вручную.

Таблица заполняется 200 000 строками данных. После этого её размер составляет около **4–6 МБ**.

---

#### **2. Открытие долгой транзакции**
Важным аспектом эксперимента является создание долгой транзакции, которая будет "удерживать горизонт". Это необходимо для демонстрации того, как такие транзакции влияют на процесс очистки:
- В отдельном сеансе открывается новая транзакция с уровнем изоляции `REPEATABLE READ`.
- Этот уровень изоляции создаёт снимок (snapshot) базы данных на момент начала транзакции, который остаётся актуальным до её завершения.
- Горизонт транзакции фиксируется, например, значением `xmin = 603`.

---

#### **3. Обновление всех строк таблицы**
В основном сеансе выполняется обновление всех строк таблицы:
- Каждая строка получает новую версию, что приводит к удвоению количества строк в таблице.
- Размер таблицы увеличивается примерно в два раза (до **8–12 МБ**).

При этом старые версии строк становятся "мертвыми", так как они больше не нужны. Однако из-за долгой транзакции, удерживающей горизонт, эти строки пока нельзя удалить.

---

#### **4. Запуск `VACUUM`**
После обновления строк запускается команда `VACUUM` с опцией `VERBOSE`, чтобы получить подробный отчёт о её работе:
- `VACUUM` сканирует таблицу и обнаруживает **200 000 мертвых строк**.
- Однако из-за долгой транзакции, удерживающей горизонт, только **100 000 строк** могут быть удалены.
- Оставшиеся **100 000 строк** остаются недоступными для очистки, так как они всё ещё видимы для транзакции с `xmin = 603`.

Кроме того:
- Индексы также остаются без изменений, так как ссылки на мертвые строки не могут быть удалены.

---

#### **5. Завершение долгой транзакции**
После завершения долгой транзакции повторно запускается `VACUUM`:
- Теперь горизонт продвигается, и все мертвые строки становятся доступными для удаления.
- `VACUUM` успешно удаляет **100 000 строк**, которые ранее были заблокированы.
- Индексы также очищаются от ссылок на удалённые строки.

Результат:
- Размер таблицы остаётся прежним (**8–12 МБ**), так как освободившееся место сохраняется в карте свободного пространства для будущего использования.

---

#### **6. Анализ результатов**
Эксперимент наглядно демонстрирует следующие ключевые моменты:
1. **Влияние долгих транзакций**:  
   Долгие транзакции удерживают горизонт, препятствуя удалению мертвых строк. Это приводит к увеличению размера таблицы и индексов.

2. **Работа карты видимости**:  
   Карта видимости помогает `VACUUM` оптимизировать процесс очистки, пропуская уже очищенные страницы.

3. **Освобождение места**:  
   `VACUUM` не возвращает освободившееся место операционной системе, а сохраняет его для будущего использования.

4. **Очистка индексов**:  
   Индексы требуют полного просмотра для удаления ссылок на мертвые строки, что делает их очистку более ресурсоёмкой.

---

#### **7. Ключевые выводы третьей части**
1. **Долгие транзакции** могут серьёзно мешать процессу очистки, удерживая горизонт и препятствуя удалению мертвых строк.  
2. **Карта видимости** играет важную роль в оптимизации работы `VACUUM`, позволяя пропускать уже очищенные страницы.  
3. **Освобождение места** происходит только внутри таблицы, без возврата дискового пространства операционной системе.  
4. **Очистка индексов** требует больше ресурсов, так как индексы хранятся в упорядоченном виде и не поддерживают карту видимости.  
5. **Пример с обновлением строк** наглядно показывает, как работает `VACUUM` и как влияют долгие транзакции на процесс очистки.

---

Если вы готовы, давайте перейдём к четвертой части конспекта, где разберём сбор статистики и полную очистку.