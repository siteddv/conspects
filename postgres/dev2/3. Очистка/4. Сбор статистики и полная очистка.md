### **Часть 4: Сбор статистики и полная очистка**

#### **1. Сбор статистики (`ANALYZE`)**
- **Цель сбора статистики**:  
  После выполнения очистки (`VACUUM`) важно собрать актуальную статистику о данных в таблице. Эта статистика используется планировщиком запросов для построения наиболее оптимального плана выполнения запросов. Без актуальной статистики планировщик может выбрать неэффективный план, что приведёт к снижению производительности.

- **Команда `ANALYZE`**:  
  Для сбора статистики используется команда `ANALYZE`. Она анализирует распределение данных в таблице и записывает результаты в системные каталоги. Эти данные включают информацию о количестве строк, уникальных значений, частоте значений и других параметрах.

- **Автоматический режим**:  
  Как и `VACUUM`, сбор статистики может выполняться автоматически с помощью механизма `autovacuum`. Однако администратор может настроить частоту и условия запуска `ANALYZE` в зависимости от нагрузки на базу данных.

- **Комбинированная команда**:  
  Для удобства можно выполнять очистку и сбор статистики одной командой:  
  ```sql
  VACUUM ANALYZE имя_таблицы;
  ```
  Это позволяет одновременно удалить мертвые строки и обновить статистику.

---

#### **2. Полная очистка (`VACUUM FULL`)**
- **Проблема обычного `VACUUM`**:  
  Обычный `VACUUM` удаляет мертвые строки, но освобождённое место сохраняется внутри таблицы для будущего использования. Это означает, что размер таблицы на диске не уменьшается, даже если значительная часть данных была удалена.

- **Команда `VACUUM FULL`**:  
  Для реального уменьшения размера таблицы используется команда `VACUUM FULL`. Она полностью перестраивает таблицу, создавая новые файлы данных без пустых мест. После завершения операции старые файлы данных удаляются.

- **Как работает `VACUUM FULL`**:  
  1. Читает текущие файлы данных таблицы.  
  2. Создаёт новые файлы данных, содержащие только актуальные строки.  
  3. Удаляет старые файлы данных.  

- **Блокировка таблицы**:  
  В отличие от обычного `VACUUM`, `VACUUM FULL` требует монопольной блокировки таблицы на всё время выполнения. Это означает, что во время работы команды таблица недоступна для чтения и записи. Поэтому `VACUUM FULL` следует использовать с осторожностью, особенно в production-средах.

- **Перестроение индексов**:  
  `VACUUM FULL` также перестраивает все индексы таблицы. Это гарантирует, что индексы будут содержать только ссылки на актуальные строки.

---

#### **3. Альтернативы `VACUUM FULL`**
- **Команда `REINDEX`**:  
  Если требуется перестроить только индексы, можно использовать команду `REINDEX`. Она создаёт новые файлы индексов, удаляя старые.  
  - **Режимы работы**:  
    - `REINDEX INDEX`: Перестраивает один конкретный индекс.  
    - `REINDEX TABLE`: Перестраивает все индексы таблицы.  

- **Конкурентный режим (`CONCURRENTLY`)**:  
  Начиная с версии PostgreSQL 12, команда `REINDEX` поддерживает режим `CONCURRENTLY`. В этом режиме перестроение индексов происходит без блокировки таблицы для записи. Однако процесс занимает больше времени, так как выполняется в несколько этапов.

---

#### **4. Пример работы `VACUUM FULL`**
Рассмотрим пример таблицы с двумя мертвыми строками:
1. **Исходное состояние**:  
   Таблица содержит три строки, две из которых являются мертвыми. Размер таблицы — 8–12 МБ.

2. **Запуск `VACUUM FULL`**:  
   После выполнения команды `VACUUM FULL` таблица перестраивается. Результат:  
   - Остаётся только одна актуальная строка.  
   - Размер таблицы уменьшается до первоначального значения (4–6 МБ).  

3. **Возврат места операционной системе**:  
   В отличие от обычного `VACUUM`, `VACUUM FULL` возвращает освободившееся место операционной системе.

---

#### **5. Заморозка версий строк**
- **Проблема закольцованного счетчика транзакций**:  
  Счетчик транзакций в PostgreSQL имеет ограниченный размер (4 байта или 32 бита). Это означает, что номера транзакций "закольцованы" и начинают повторяться после достижения максимального значения (примерно 2 миллиарда).  

- **Опасность конфликтов видимости**:  
  Когда счетчик транзакций приближается к середине круга, старые версии строк могут быть неверно интерпретированы как "будущие". Это приводит к конфликтам видимости и потенциальным ошибкам в работе базы данных.

- **Механизм заморозки**:  
  Для решения этой проблемы используется механизм заморозки версий строк. Заморозка помечает старые версии строк как "безусловно старые", чтобы их можно было игнорировать при проверке видимости.  

- **Как работает заморозка**:  
  1. Процесс очистки (`VACUUM`) помечает старые версии строк специальным образом.  
  2. В заголовке строки добавляется информация, указывающая, что номер транзакции можно игнорировать.  
  3. Это позволяет повторно использовать номера транзакций без риска конфликтов.

- **Управление заморозкой администратором**:  
  Администратор может настраивать параметры заморозки, такие как частота выполнения и пороговые значения. Однако важно соблюдать баланс:  
  - Слишком ранняя заморозка может привести к лишней работе, если строки вскоре изменятся.  
  - Слишком поздняя заморозка увеличивает риск конфликтов видимости.

- **Аварийное завершение работы сервера**:  
  Если заморозка не выполняется вовремя и система приближается к критическому значению счетчика транзакций, сервер аварийно завершает работу. В этом случае администратор должен выполнить принудительную заморозку всех старых версий строк в монопольном режиме.

---

#### **6. Ключевые выводы четвертой части**
4. **Сбор статистики** (`ANALYZE`) необходим для оптимизации планов выполнения запросов.  
5. **Полная очистка** (`VACUUM FULL`) уменьшает размер таблицы, но требует монопольной блокировки.  
6. **Перестроение индексов** (`REINDEX`) может выполняться отдельно от таблицы, включая конкурентный режим.  
7. **Заморозка версий строк** решает проблему закольцованного счетчика транзакций, предотвращая конфликты видимости.  
8. **Администрирование** заморозки требует внимания к настройкам и своевременному выполнению, чтобы избежать аварийного завершения работы сервера.

---

Если вы готовы, давайте перейдём к пятой части конспекта, где разберём заморозку версий строк и управление счетчиком транзакций.