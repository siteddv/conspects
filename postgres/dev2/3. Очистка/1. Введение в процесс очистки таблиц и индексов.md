### **Часть 1: Введение в процесс очистки таблиц и индексов**

#### **1. Основная задача очистки**
Очистка таблиц и индексов — это ключевой процесс в управлении базами данных, который позволяет удалять ненужные версии строк, накапливающиеся со временем. Эти "мертвые" строки (устаревшие или удаленные версии данных) занимают место на диске и могут замедлять выполнение запросов. Для этого используется команда `VACUUM`, которая проходит по таблице, анализирует её содержимое и удаляет ненужные данные.

#### **2. Особенности работы команды `VACUUM`**
- **Параллельная работа с приложением**:  
  Одной из важнейших особенностей `VACUUM` является то, что она не блокирует операции чтения и изменения данных в таблице. Это означает, что приложение может продолжать работать с базой данных даже во время выполнения очистки. Если какая-то страница таблицы изменяется в момент работы `VACUUM`, то эта страница пропускается, а её обработка откладывается на следующий проход.
  
- **Карта видимости**:  
  Для оптимизации процесса очистки используется карта видимости. Она помогает `VACUUM` определить, какие страницы таблицы уже были полностью очищены и не требуют повторной проверки. Это позволяет пропустить такие страницы в следующий раз, что значительно ускоряет работу команды.

- **Обновление карты свободного пространства**:  
  После завершения очистки `VACUUM` обновляет карту свободного пространства для таблицы и индексов. Карта свободного пространства указывает, где находятся пустые области, которые можно использовать для новых данных. Это особенно важно для предотвращения фрагментации данных.

#### **3. Работа с индексами**
`VACUUM` также очищает ненужные версии строк в индексах. Индексы, как и таблицы, содержат ссылки на старые версии строк, которые больше не нужны. Поскольку индексы хранятся в упорядоченном виде (например, B-деревья), их очистка требует полного просмотра структуры индекса. Это более ресурсоёмкий процесс, чем работа с таблицами, где можно использовать карту видимости для оптимизации.

#### **4. Автоматическая очистка (`autovacuum`)**
Для автоматизации процесса очистки в системе используется механизм `autovacuum`. Он реализуется через два типа процессов:
- **`autovacuum launcher`**: Этот процесс работает постоянно и периодически запускает рабочие процессы очистки.
- **`autovacuum worker`**: Эти процессы выполняют очистку для конкретных таблиц в базе данных. Они выбирают таблицы, в которых накопилось наибольшее количество мертвых строк, и выполняют очистку.

Настройка автоматической очистки зависит от администратора. Администратор может задать параметры, определяющие, как часто должна выполняться очистка в зависимости от количества мертвых строк в таблице. Чем больше мертвых строк, тем чаще будет запускаться `autovacuum`.

#### **5. Проблемы с долгими транзакциями**
Одним из факторов, влияющих на эффективность очистки, являются долгие транзакции. Долгие транзакции могут "удерживать горизонт" (snapshot), что препятствует удалению старых версий строк. Например, если транзакция с уровнем изоляции `REPEATABLE READ` или `SERIALIZABLE` открыта, то все версии строк, созданные до начала этой транзакции, не могут быть удалены, даже если они больше никому не нужны. Это приводит к увеличению размера таблицы и индексов, а также к снижению производительности запросов.

#### **6. Практический пример**
Рассмотрим пример таблицы с 200 000 строк. Если мы обновим все строки в таблице, то каждая строка получит новую версию, а старые версии останутся в таблице как "мертвые". Размер таблицы увеличится примерно в два раза. При этом, если в системе есть долгая транзакция, удерживающая горизонт, то `VACUUM` не сможет удалить старые версии строк. Только после завершения этой транзакции очистка станет возможной.

---

### **Ключевые выводы первой части**
1. **Основная цель `VACUUM`** — удаление ненужных версий строк для освобождения места и оптимизации работы базы данных.
2. **Параллельная работа** с приложением делает `VACUUM` безопасным для использования в production-средах.
3. **Карта видимости** и карта свободного пространства играют важную роль в оптимизации процесса очистки.
4. **Автоматическая очистка** (`autovacuum`) помогает администраторам поддерживать базу данных в актуальном состоянии, но её эффективность зависит от правильной настройки.
5. **Долгие транзакции** могут серьёзно мешать процессу очистки, удерживая горизонт и препятствуя удалению мертвых строк.

---

Если вы готовы, давайте перейдём ко второй части конспекта, где разберём этапы выполнения очистки.