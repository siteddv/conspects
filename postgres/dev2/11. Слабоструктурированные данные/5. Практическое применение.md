### Часть 5: Практическое применение

#### 5.1 Задачи по оптимизации хранения данных
Одной из ключевых задач при работе со слабо структурированными данными является оптимизация их хранения. Рассмотрим пример, где данные о книгах хранятся в отдельных столбцах таблицы, но фактически используются только для передачи клиенту. В таком случае можно реорганизовать структуру базы данных, объединив эти столбцы в один JSONB-столбец.

##### Пример рефакторинга:
Исходная таблица:
```sql
CREATE TABLE books (
    id SERIAL PRIMARY KEY,
    title TEXT,
    author TEXT,
    description TEXT,
    annotation TEXT,
    tags TEXT[]
);
```

Рефакторинг:
```sql
CREATE TABLE books (
    id SERIAL PRIMARY KEY,
    title TEXT,
    details JSONB
);
```

Здесь `details` содержит все дополнительные данные, такие как описание, аннотация и теги:
```json
{
  "description": "Описание книги",
  "annotation": "Аннотация",
  "tags": ["фантастика", "приключения"]
}
```

##### Преимущества:
- **Упрощение схемы**: Уменьшение количества столбцов.
- **Гибкость**: Возможность добавлять новые поля без изменения схемы.
- **Производительность**: Оптимизация запросов через индексирование JSONB.

#### 5.2 Использование JSON как транспортного формата
JSON широко используется для обмена данными между клиентом и сервером. Например, если интерфейс приложения поддерживает несколько языков, переводы могут храниться в JSONB-формате.

##### Пример хранения переводов:
```json
{
  "en": {
    "title": "Book Title",
    "description": "Book Description"
  },
  "ru": {
    "title": "Название книги",
    "description": "Описание книги"
  }
}
```

##### Преимущества:
- **Компактность**: Все переводы хранятся в одном поле.
- **Простота доступа**: Легко извлекать переводы для конкретного языка.
- **Масштабируемость**: Добавление новых языков не требует изменения схемы.

#### 5.3 Рефакторинг функций
После реорганизации таблицы необходимо обновить функции, которые работают с данными. Например, функция `get_catalog`, которая ранее формировалась на основе отдельных столбцов, теперь может просто возвращать JSONB-поле.

##### Пример функции:
```sql
CREATE OR REPLACE FUNCTION get_catalog(detailed BOOLEAN)
RETURNS TABLE(id INT, title TEXT, details JSONB) AS $$
BEGIN
    IF detailed THEN
        RETURN QUERY SELECT id, title, details FROM books;
    ELSE
        RETURN QUERY SELECT id, title, NULL::JSONB FROM books;
    END IF;
END;
$$ LANGUAGE plpgsql;
```

##### Преимущества:
- **Упрощение кода**: Сокращение количества операций по сборке данных.
- **Скорость выполнения**: Уменьшение числа запросов к базе данных.

#### 5.4 Практические задания
Для закрепления материала предлагаются следующие задачи:
1. **Рефакторинг таблицы книг**:
   - Объедините дополнительные данные о книгах в один JSONB-столбец.
   - Обновите функцию `get_catalog` для работы с новой структурой.

2. **Использование JSON для локализации**:
   - Создайте таблицу для хранения переводов интерфейса в формате JSONB.
   - Реализуйте функцию для получения переводов на указанный язык.

---

Это завершающая часть конспекта, посвященная практическому применению слабо структурированных данных. Если у вас есть вопросы или вы хотите уточнить какие-либо детали, дайте знать!