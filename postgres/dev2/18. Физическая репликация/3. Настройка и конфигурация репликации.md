### Часть 3: Настройка и конфигурация репликации

#### Необходимые параметры postgresql.conf
Настройка физической репликации требует корректной конфигурации основного сервера PostgreSQL. Рассмотрим ключевые параметры:

- **wal_level**:
  - Определяет уровень детализации записей WAL.
  - Для физической репликации требуется значение `replica`.
  - Уровень `minimal` недостаточен, так как не записывает некоторые команды (например, `CREATE INDEX CONCURRENTLY`).

- **max_wal_senders**:
  - Задает максимальное количество процессов `wal sender`, которые могут быть запущены на основном сервере.
  - Даже одно соединение достаточно для базовой репликации.

- **hot_standby**:
  - Позволяет выполнять читающие запросы на реплике во время восстановления.
  - Важный параметр для использования реплики в режиме "только чтение".

#### Процесс создания резервного сервера
Создание резервного сервера включает несколько последовательных шагов:

1. **Подготовка окружения**:
   - Убедитесь, что версии PostgreSQL на основном и резервном серверах совместимы.
   - Очистите каталог данных на резервном сервере.

2. **Создание резервной копии**:
   - Используйте утилиту `pg_basebackup` с ключом `-R` для автоматического добавления необходимых конфигурационных параметров.
   - Ключ `-R` добавляет параметр `primary_conninfo` в файл `postgresql.auto.conf`.

3. **Конфигурационные файлы**:
   - **postgresql.auto.conf**:
     - Содержит автоматически добавленные параметры подключения к мастеру.
     - Например: `primary_conninfo = 'host=master_host port=5432 user=replication_user'`
   - **postgresql.conf**:
     - Убедитесь, что параметр `hot_standby` установлен в `on`.

4. **Настройка доступа**:
   - В файле `pg_hba.conf` на основном сервере должны быть соответствующие правила для подключения по протоколу репликации.
   - Пример записи: `host replication replication_user replica_ip/32 md5`

#### Особенности подключения replica к master
После настройки конфигурации происходит процесс подключения реплики к мастеру:

- **Процессы на основном сервере**:
  - `wal sender`: Отправляет WAL-записи на реплику.
  
- **Процессы на резервном сервере**:
  - `wal receiver`: Получает WAL-записи от мастера.
  - `startup`: Применяет полученные записи.

- **Проверка состояния репликации**:
  - На основном сервере можно использовать представление `pg_stat_replication`:
    ```sql
    SELECT * FROM pg_stat_replication;
    ```
  - Это покажет информацию о подключенных репликах и состоянии передачи данных.

#### Дополнительные настройки
- **Архивация WAL**:
  - Можно настроить архивацию сегментов WAL для дополнительной надежности.
  - Полезно при временных сбоях связи между мастером и репликой.

- **Мониторинг задержек**:
  - Важно отслеживать возможные задержки репликации.
  - Используйте функцию `pg_is_in_recovery()` для проверки статуса реплики.

#### Пример практической настройки
```bash
# На основном сервере
# postgresql.conf
wal_level = replica
max_wal_senders = 10
wal_keep_segments = 32

# pg_hba.conf
host replication replication_user replica_ip/32 md5

# Создание резервной копии
pg_basebackup -h master_host -U replication_user -D /path/to/replica/data -R

# На резервном сервере
# postgresql.conf
hot_standby = on
```

#### Возможные проблемы при настройке
- **Проблемы с подключением**:
  - Проверьте настройки файервола.
  - Убедитесь в корректности параметров `primary_conninfo`.

- **Несовместимость версий**:
  - Версии PostgreSQL на мастере и реплике должны быть одинаковыми.

- **Недостаточное место для WAL**:
  - Настройте параметры `wal_keep_segments` или используйте архивацию.

#### Заключение
Настройка физической репликации требует внимательного подхода к конфигурации и понимания взаимодействия различных компонентов системы. Корректная настройка обеспечивает надежную работу репликации и возможность использования реплики для различных задач, таких как распределение нагрузки и обеспечение отказоустойчивости.

Хотите перейти к следующей части, где мы рассмотрим работу с репликой и её возможности?