### **4. Практический пример: создание нового типа данных и индекса**

#### **Создание пользовательского типа данных**
1. **Определение типа данных**:
   - Создается новый тип данных `capacity`, представляющий объем данных с единицами измерения.
   - Тип данных включает числовое значение и единицу измерения (например, байты, килобайты, мегабайты).

2. **Пример создания типа данных**:
   ```sql
   CREATE TYPE capacity AS (
       value numeric,
       unit text
   );
   ```

3. **Заполнение таблицы случайными данными**:
   - Генерируются случайные значения для тестирования.
   - Пример:
     ```sql
     INSERT INTO test_table (capacity_column)
     SELECT (random() * 1000, ('byte', 'kilobyte', 'megabyte', 'gigabyte', 'terabyte')[floor(random() * 5) + 1])
     FROM generate_series(1, 1000);
     ```

---

#### **Проблема сортировки**
4. **Лексикографическая сортировка**:
   - По умолчанию данные сортируются лексикографически.
   - Пример:
     ```sql
     SELECT * FROM test_table ORDER BY capacity_column;
     ```
   - Результат: сначала сортируются по первому полю (`value`), затем по второму полю (`unit`).

5. **Неправильный порядок**:
   - Например, "15 килобайт" считается больше, чем "14 терабайт", что нелогично.

---

#### **Решение: создание класса операторов**
6. **Функция сравнения**:
   - Преобразует значения типа `capacity` в байты для корректного сравнения.
   - Пример:
     ```sql
     CREATE FUNCTION capacity_cmp(capacity, capacity) RETURNS integer AS $$
     BEGIN
         RETURN compare(to_bytes($1), to_bytes($2));
     END;
     $$ LANGUAGE plpgsql;
     ```

7. **Операторы сравнения**:
   - Определяются операторы `<`, `<=`, `=`, `>=`, `>` на основе функции сравнения.
   - Пример:
     ```sql
     CREATE OPERATOR < (
         LEFTARG = capacity,
         RIGHTARG = capacity,
         PROCEDURE = capacity_lt
     );
     ```

8. **Создание класса операторов**:
   - Пример:
     ```sql
     CREATE OPERATOR CLASS capacity_ops
     DEFAULT FOR TYPE capacity USING btree AS
     OPERATOR 1 <,
     OPERATOR 2 <=,
     OPERATOR 3 =,
     OPERATOR 4 >=,
     OPERATOR 5 >,
     FUNCTION 1 capacity_cmp;
     ```

---

#### **Использование класса операторов**
9. **Правильная сортировка**:
   - После создания класса операторов данные сортируются корректно.
   - Пример:
     ```sql
     SELECT * FROM test_table ORDER BY capacity_column;
     ```

10. **Создание индекса**:
   - Индекс создается для столбца типа `capacity`.
   - Пример:
     ```sql
     CREATE INDEX ON test_table USING btree (capacity_column);
     ```

11. **Условия использования индекса**:
   - Индекс используется только в выражениях вида:
     ```sql
     column_name operator expression
     ```
   - Оператор должен входить в класс операторов для соответствующего типа данных.

---

#### **Проверка работы индекса**
12. **Запрос с использованием индекса**:
   - Пример:
     ```sql
     EXPLAIN SELECT * FROM test_table WHERE capacity_column < '10 MB';
     ```
   - Результат: индекс используется, если оператор `<` входит в класс операторов `capacity_ops`.

13. **Поиск ближайших соседей**:
   - Для поиска ближайших соседей можно использовать оператор расстояния.
   - Пример:
     ```sql
     SELECT * FROM test_table
     ORDER BY capacity_column <-> '5 MB'
     LIMIT 5;
     ```

---

Это завершает четвертую часть конспекта. Если вы хотите продолжить с подробным пересказом пятой части, пожалуйста, дайте знать!