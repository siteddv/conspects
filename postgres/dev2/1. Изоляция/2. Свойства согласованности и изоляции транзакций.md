### Часть 2: Свойства согласованности и изоляции транзакций

#### Понятие согласованности
Согласованность — одно из ключевых свойств транзакций, которое гарантирует, что база данных переходит из одного корректного состояния в другое. Однако важно понимать, что согласованность — это не только соблюдение ограничений целостности (например, уникальности значений или внешних ключей), но и логическая корректность данных с точки зрения бизнес-логики приложения.

##### Ограничения целостности:
1. **Ограничения на уровне базы данных**: Это правила, которые определяют допустимые значения для данных в таблицах. Например:
   - Уникальность значений в столбце.
   - Проверка диапазона значений (например, возраст должен быть положительным числом).
   - Внешние ключи, обеспечивающие ссылочную целостность.

2. **Семантика приложения**: Это правила, которые задаются логикой работы приложения. Например:
   - При переводе денег сумма на счетах должна остаться неизменной.
   - Если одна операция выполнена, то должна быть выполнена и вторая операция, чтобы сохранить баланс.

##### Примеры нарушений согласованности:
Рассмотрим пример перевода денег между счетами:
- **Шаг 1**: Списание денег с одного счета.
- **Шаг 2**: Зачисление денег на другой счет.

Если первый шаг выполнен успешно, но второй завершился ошибкой, то состояние базы данных становится **несогласованным**, потому что деньги были списаны, но не зачислены. Это нарушение согласованности, даже если все ограничения целостности соблюдены.

##### Особенности проверки ограничений целостности:
Важно отметить, что некоторые ограничения целостности могут быть проверены не сразу, а отложены до окончания транзакции. Например:
- Можно указать, что проверка уникальности значений в столбце должна выполняться только после завершения всех операций транзакции.
- Это позволяет временно нарушать ограничения целостности внутри транзакции, но гарантирует их выполнение после завершения.

---

#### Изоляция транзакций
Изоляция — это свойство, которое гарантирует, что транзакции выполняются независимо друг от друга, даже если они работают с одними и теми же данными одновременно. Это означает, что изменения одной транзакции не должны влиять на выполнение другой до тех пор, пока транзакция не зафиксирована (commit).

##### Реализация полной изоляции:
Полная изоляция транзакций — сложная задача, особенно в многопользовательских системах, где несколько транзакций могут одновременно обращаться к одним и тем же данным. Поэтому стандарт SQL предложил несколько уровней изоляции, каждый из которых допускает определенные "ослабления" изоляции.

Эти "ослабления" называются **аномалиями**. На разных уровнях изоляции допускаются разные типы аномалий:
1. **Потерянные обновления**: Когда две транзакции одновременно изменяют одни и те же данные, и одна из них перезаписывает изменения другой.
2. **Грязное чтение**: Когда транзакция видит незафиксированные изменения другой транзакции.
3. **Неповторяющееся чтение**: Когда одна и та же строка возвращается с разными значениями при повторном чтении внутри одной транзакции.
4. **Фантомное чтение**: Когда между двумя запросами появляются новые строки, которые удовлетворяют условию запроса.

##### Уровни изоляции:
1. **Read Uncommitted**:
   - Самый слабый уровень изоляции.
   - Допускает **грязное чтение**, то есть транзакция может видеть незафиксированные изменения других транзакций.
   - Это опасно, так как если другая транзакция откатится, то текущая транзакция будет основываться на данных, которых никогда не существовало.

2. **Read Committed**:
   - Транзакция не может видеть незафиксированные изменения других транзакций.
   - Однако допускается **неповторяющееся чтение**: одна и та же строка может возвращаться с разными значениями при повторном чтении внутри одной транзакции.

3. **Repeatable Read**:
   - Гарантирует, что одна и та же строка всегда возвращается с одинаковыми значениями при повторном чтении внутри одной транзакции.
   - Однако допускается **фантомное чтение**: новые строки, которые появились между запросами, могут быть видны.

4. **Serializable**:
   - Самый строгий уровень изоляции.
   - Гарантирует полную изоляцию транзакций, как будто они выполняются последовательно, одна за другой.
   - Не допускает ни одну из аномалий.

---

#### Особые случаи и нюансы реализации
1. **Функции в PostgreSQL**:
   - Если функция имеет категорию изменчивости `VOLATILE`, то она может видеть изменения, произведённые другими транзакциями, даже если сама транзакция работает на уровне `Read Committed`.
   - Чтобы избежать этого, можно изменить категорию изменчивости функции на `STABLE` или `IMMUTABLE`.

2. **Потерянные обновления**:
   - Возникают, когда две транзакции одновременно изменяют одни и те же данные, и одна из них перезаписывает изменения другой.
   - На уровне `Read Committed` это возможно, если транзакция разбивает операцию обновления на два шага: сначала чтение, затем обновление.

3. **Конфликты сериализации**:
   - На уровне `Serializable` транзакции могут завершаться с ошибкой сериализации, если невозможно выстроить их выполнение в правильном порядке.
   - В этом случае транзакцию нужно повторить.

---

Это завершает вторую часть конспекта. Хотите перейти к третьей части — "Уровни изоляции транзакций"?