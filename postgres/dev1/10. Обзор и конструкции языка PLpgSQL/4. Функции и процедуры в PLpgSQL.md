### **–ö–æ–Ω—Å–ø–µ–∫—Ç –≤–∏–¥–µ–æ: –ß–∞—Å—Ç—å 3 ‚Äì –§—É–Ω–∫—Ü–∏–∏ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≤ PL/pgSQL**

---

### **3.1. –§—É–Ω–∫—Ü–∏–∏ –≤ PL/pgSQL**

–í **PL/pgSQL** —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é **`CREATE FUNCTION`**.  
–§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ **–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ**.

#### **–ü—Ä–æ—Å—Ç–µ–π—à–∞—è —Ñ—É–Ω–∫—Ü–∏—è:**

```sql
CREATE FUNCTION add_numbers(a INTEGER, b INTEGER) RETURNS INTEGER AS $$
BEGIN
  RETURN a + b;
END $$ LANGUAGE plpgsql;
```

#### **–ö–∞–∫ –≤—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é:**

```sql
SELECT add_numbers(10, 20);
```

**–í—ã—Ö–æ–¥:**

```
30
```

‚úÖ **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–π –≤ PL/pgSQL:**

- –§—É–Ω–∫—Ü–∏—è **–æ–±—è–∑–∞–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ** (`RETURNS`).
- **–¢–µ–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏** –æ—Ñ–æ—Ä–º–ª—è–µ—Ç—Å—è –∫–∞–∫ **PL/pgSQL –±–ª–æ–∫** (`BEGIN ... END`).
- –ö–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ PostgreSQL.

---

### **3.2. –í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö**

–í PL/pgSQL —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å:

1. **–û–¥–∏–Ω–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (`RETURNS type`)**
2. **–ù–∞–±–æ—Ä —Å—Ç—Ä–æ–∫ (`RETURNS TABLE(...)`)**
3. **–ó–Ω–∞—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `OUT` –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**

#### **3.2.1. –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (`RETURNS type`)**

–§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–æ–¥–∏–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç**.

```sql
CREATE FUNCTION square(x INTEGER) RETURNS INTEGER AS $$
BEGIN
  RETURN x * x;
END $$ LANGUAGE plpgsql;
```

**–í—ã–∑–æ–≤:**

```sql
SELECT square(5);
```

**–í—ã—Ö–æ–¥:**

```
25
```

---

#### **3.2.2. –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–∞–±–æ—Ä–∞ —Å—Ç—Ä–æ–∫ (`RETURNS TABLE`)**

–§—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å **—Ç–∞–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**.

```sql
CREATE FUNCTION get_users() RETURNS TABLE(id INTEGER, name TEXT) AS $$
BEGIN
  RETURN QUERY SELECT id, name FROM users;
END $$ LANGUAGE plpgsql;
```

**–í—ã–∑–æ–≤:**

```sql
SELECT * FROM get_users();
```

‚úÖ **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:**

- –í–º–µ—Å—Ç–æ `RETURN` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **`RETURN QUERY`**.
- –ü–æ–∑–≤–æ–ª—è–µ—Ç **–≤—ã–ø–æ–ª–Ω—è—Ç—å SELECT –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏**.

---

#### **3.2.3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `OUT` –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**

–ú–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ **`OUT` –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**, –±–µ–∑ `RETURN`.

```sql
CREATE FUNCTION divide_numbers(a NUMERIC, b NUMERIC, OUT result NUMERIC) AS $$
BEGIN
  result := a / b;
END $$ LANGUAGE plpgsql;
```

**–í—ã–∑–æ–≤:**

```sql
SELECT divide_numbers(10, 2);
```

**–í—ã—Ö–æ–¥:**

```
5
```

‚úÖ **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:**

- –ó–Ω–∞—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ `OUT` –ø–∞—Ä–∞–º–µ—Ç—Ä.
- –ù–µ—Ç `RETURN`, —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å—Ç–æ –∏–∑–º–µ–Ω—è–µ—Ç –≤—ã—Ö–æ–¥–Ω–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä.

---

### **3.3. –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `STRICT`, `IMMUTABLE`, `STABLE`, `VOLATILE`**

PL/pgSQL –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **—Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π.

|–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|
|`STRICT`|–ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `NULL`, —Ñ—É–Ω–∫—Ü–∏—è **–Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è**, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `NULL`.|
|`IMMUTABLE`|–§—É–Ω–∫—Ü–∏—è –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç** –ø—Ä–∏ –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.|
|`STABLE`|–§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞**.|
|`VOLATILE`|–§—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å **—Ä–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `RANDOM()`).|

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `STRICT`**

```sql
CREATE FUNCTION safe_divide(a NUMERIC, b NUMERIC) RETURNS NUMERIC  
STRICT LANGUAGE plpgsql AS $$
BEGIN
  RETURN a / b;
END $$;
```

- –ï—Å–ª–∏ `b = NULL`, —Ñ—É–Ω–∫—Ü–∏—è **–Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è**, –≤–µ—Ä–Ω–µ—Ç `NULL`.

‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**

- **`IMMUTABLE`** ‚Äì –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è **–º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `abs()`).
- **`STABLE`** ‚Äì –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è **—Ñ—É–Ω–∫—Ü–∏–π, —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `NOW()`).
- **`VOLATILE`** ‚Äì –Ω—É–∂–µ–Ω –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π, **–≥–µ–Ω–µ—Ä–∏—Ä—É—é—â–∏—Ö —Å–ª—É—á–∞–π–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** (`RANDOM()`).

---

### **3.4. –ü—Ä–∏–º–µ—Ä —Å–ª–æ–∂–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏**

–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —á–∏—Å–ª–æ **–ø—Ä–æ—Å—Ç—ã–º**.

```sql
CREATE FUNCTION is_prime(n INTEGER) RETURNS BOOLEAN AS $$
DECLARE
  i INTEGER;
BEGIN
  IF n < 2 THEN
    RETURN FALSE;
  END IF;

  FOR i IN 2..n/2 LOOP
    IF n % i = 0 THEN
      RETURN FALSE;
    END IF;
  END LOOP;

  RETURN TRUE;
END $$ LANGUAGE plpgsql;
```

**–í—ã–∑–æ–≤:**

```sql
SELECT is_prime(7);
```

**–í—ã—Ö–æ–¥:**

```
true
```

‚úÖ **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è:**

- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–µ–ª–∏—Ç—Å—è –ª–∏ `n` –Ω–∞ —á–∏—Å–ª–∞ –æ—Ç `2` –¥–æ `n/2`.
- –ï—Å–ª–∏ –¥–∞ ‚Üí **—á–∏—Å–ª–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ–µ** (`FALSE`).
- –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí **—á–∏—Å–ª–æ –ø—Ä–æ—Å—Ç–æ–µ** (`TRUE`).

---

### **3.5. –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º–∏**

|**–§—É–Ω–∫—Ü–∏—è (`FUNCTION`)**|**–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ (`PROCEDURE`)**|
|---|---|
|–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ (`RETURNS`)|–ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ|
|–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ `SELECT`|–í—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `CALL`|
|–ú–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å `RETURN QUERY`|–ú–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å `INSERT`, `UPDATE`, `DELETE`|
|–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π|–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ë–î|

‚úÖ **–ü—Ä–∏–º–µ—Ä –ø—Ä–æ—Ü–µ–¥—É—Ä—ã:**

```sql
CREATE PROCEDURE delete_user(uid INTEGER) AS $$
BEGIN
  DELETE FROM users WHERE id = uid;
END $$ LANGUAGE plpgsql;
```

**–í—ã–∑–æ–≤:**

```sql
CALL delete_user(10);
```

‚úÖ **–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ, –Ω–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.**

---

### **–í—ã–≤–æ–¥ –ø–æ —á–∞—Å—Ç–∏ 3:**

- **–§—É–Ω–∫—Ü–∏–∏ (`FUNCTION`)** –≤ PL/pgSQL –ø–æ–∑–≤–æ–ª—è—é—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.
- **–ü—Ä–æ—Ü–µ–¥—É—Ä—ã (`PROCEDURE`)** –≤—ã–ø–æ–ª–Ω—è—é—Ç **–¥–µ–π—Å—Ç–≤–∏—è**, –Ω–æ **–Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –∑–Ω–∞—á–µ–Ω–∏—è**.
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è **—Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –≤–æ–∑–≤—Ä–∞—Ç–∞ –∑–Ω–∞—á–µ–Ω–∏–π** (`RETURNS`, `OUT`, `TABLE`).
- –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã **(`STRICT`, `IMMUTABLE`, `STABLE`, `VOLATILE`)** –ø–æ–º–æ–≥–∞—é—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥.

‚è≠ **–°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å** ‚Äì **–£—Å–ª–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –≤ PL/pgSQL** (`IF`, `CASE`, –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ª–æ–≤–∏–π). –ì–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? üöÄ