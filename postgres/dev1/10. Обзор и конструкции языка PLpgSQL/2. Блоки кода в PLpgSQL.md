### **–ö–æ–Ω—Å–ø–µ–∫—Ç –≤–∏–¥–µ–æ: –ß–∞—Å—Ç—å 2 ‚Äì –ë–ª–æ–∫–∏ –∫–æ–¥–∞ –≤ PL/pgSQL**

---

### **2.1. –û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –±–ª–æ–∫–∞ PL/pgSQL**

–ö–∞–∂–¥–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–∞ **PL/pgSQL** —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ **–±–ª–æ–∫–æ–≤ –∫–æ–¥–∞**, –∫–æ—Ç–æ—Ä—ã–µ –≤–∫–ª—é—á–∞—é—Ç:

1. **–ú–µ—Ç–∫–∞ –±–ª–æ–∫–∞** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
2. **–°–µ–∫—Ü–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (`DECLARE`)**
3. **–°–µ–∫—Ü–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ (`BEGIN ... END`)**
4. **–°–µ–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π (`EXCEPTION`)** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–∏–º–µ—Ä —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –±–ª–æ–∫–∞ PL/pgSQL:**

```sql
<<block_label>>
DECLARE
  my_var TEXT := 'Hello, World!';
BEGIN
  RAISE NOTICE '%', my_var;
EXCEPTION
  WHEN others THEN
    RAISE NOTICE 'An error occurred!';
END;
```

- **–ú–µ—Ç–∫–∞ –±–ª–æ–∫–∞ (`block_label`)** –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ –±–ª–æ–∫ –≤–Ω—É—Ç—Ä–∏ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.
- **–°–µ–∫—Ü–∏—è `DECLARE`** —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –±–ª–æ–∫–µ.
- **–°–µ–∫—Ü–∏—è `BEGIN ... END`** ‚Äì –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥.
- **–°–µ–∫—Ü–∏—è `EXCEPTION`** ‚Äì –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Ö.

---

### **2.2. –ê–Ω–æ–Ω–∏–º–Ω—ã–µ –±–ª–æ–∫–∏ PL/pgSQL**

PL/pgSQL –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **–∞–Ω–æ–Ω–∏–º–Ω—ã–µ –±–ª–æ–∫–∏ –∫–æ–¥–∞**, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ **–∑–∞–ø—É—Å–∫–∞—Ç—å –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏**.

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–æ–ø–µ—Ä–∞—Ç–æ—Ä `DO`**.
- –ö–æ–¥ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **—Ä–∞–∑–æ–≤–æ**.

**–ü—Ä–∏–º–µ—Ä –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –±–ª–æ–∫–∞:**

```sql
DO $$
DECLARE
  message TEXT := 'Hello from an anonymous block!';
BEGIN
  RAISE NOTICE '%', message;
END $$;
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1. **`DO $$`** ‚Äì –Ω–∞—á–∞–ª–æ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –±–ª–æ–∫–∞.
2. **`DECLARE`** ‚Äì –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π.
3. **`RAISE NOTICE`** ‚Äì –≤—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è.
4. **`END $$;`** ‚Äì –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–ª–æ–∫–∞.

‚úÖ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –±–ª–æ–∫–æ–≤:**

- –ü–æ–∑–≤–æ–ª—è—é—Ç **–±—ã—Å—Ç—Ä–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥** –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏.
- –£–¥–æ–±–Ω—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è **—Ä–∞–∑–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**.

---

### **2.3. –û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞**

–í **PL/pgSQL** –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª—è—é—Ç—Å—è –≤ —Å–µ–∫—Ü–∏–∏ **`DECLARE`**.

#### **2.3.1. –°–∏–Ω—Ç–∞–∫—Å–∏—Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:**

```sql
DECLARE
  my_text TEXT := 'Hello';
  my_number INTEGER DEFAULT 42;
  my_bool BOOLEAN NOT NULL := TRUE;
```

- **–¢–∏–ø –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π** ‚Äì –ª—é–±–æ–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π PostgreSQL.
- **–ó–Ω–∞—á–µ–Ω–∏–µ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å** —á–µ—Ä–µ–∑ `:=` –∏–ª–∏ `DEFAULT`.
- **`NOT NULL`** ‚Äì –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±—è–∑–∞–Ω–∞ –∏–º–µ—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ.

#### **2.3.2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö PostgreSQL**

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ **PL/pgSQL** –∏—Å–ø–æ–ª—å–∑—É—é—Ç **—Ç–µ –∂–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö**, —á—Ç–æ –∏ PostgreSQL:

- **–ß–∏—Å–ª–∞:** `INTEGER`, `BIGINT`, `NUMERIC`
- **–°—Ç—Ä–æ–∫–∏:** `TEXT`, `VARCHAR`
- **–ë—É–ª–µ–≤—ã –∑–Ω–∞—á–µ–Ω–∏—è:** `BOOLEAN`
- **–ú–∞—Å—Å–∏–≤—ã:** `INTEGER[]`, `TEXT[]`
- **JSON:** `JSONB`

**–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:**

```sql
DO $$
DECLARE
  my_int INTEGER := 10;
  my_text TEXT := 'PL/pgSQL';
  my_result TEXT;
BEGIN
  my_result := my_text || ' is fun!';
  RAISE NOTICE '%', my_result;
END $$;
```

**–í—ã—Ö–æ–¥:**

```
PL/pgSQL is fun!
```

---

### **2.4. –í–∏–¥–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏**

- **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤—É—é—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞, –≥–¥–µ –æ–±—ä—è–≤–ª–µ–Ω—ã.**
- –ú–æ–∂–Ω–æ –æ–±—ä—è–≤–ª—è—Ç—å **–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –±–ª–æ–∫–∞—Ö**.
- –ß—Ç–æ–±—ã –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏–∑ **–≤–Ω–µ—à–Ω–µ–≥–æ –±–ª–æ–∫–∞**, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–º–µ—Ç–∫–∞ –±–ª–æ–∫–∞**.

**–ü—Ä–∏–º–µ—Ä —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –±–ª–æ–∫–∞–º–∏:**

```sql
DO $$
DECLARE
  outer_var TEXT := 'Outer';
BEGIN
  DECLARE
    inner_var TEXT := 'Inner';
  BEGIN
    RAISE NOTICE 'Outer: %, Inner: %', outer_var, inner_var;
  END;
END $$;
```

**–í—ã—Ö–æ–¥:**

```
Outer: Outer, Inner: Inner
```

---

### **2.5. –†–∞–±–æ—Ç–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ (`EXCEPTION`)**

PL/pgSQL –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º **–æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫**.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ–∫—Ü–∏–∏ `EXCEPTION`:**

```sql
BEGIN
  -- –ö–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É
EXCEPTION
  WHEN some_error THEN
    -- –î–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
END;
```

#### **–û–±—â–∏–µ –æ—à–∏–±–∫–∏ –≤ PL/pgSQL:**

- `division_by_zero` ‚Äì –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ 0
- `undefined_column` ‚Äì –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —Å—Ç–æ–ª–±—Ü—É
- `raise_exception` ‚Äì –Ω–∞–º–µ—Ä–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ –æ—à–∏–±–∫–∏

**–ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:**

```sql
DO $$
BEGIN
  RAISE EXCEPTION 'Custom error!';
EXCEPTION
  WHEN others THEN
    RAISE NOTICE 'An error occurred!';
END $$;
```

**–í—ã—Ö–æ–¥:**

```
An error occurred!
```

‚úÖ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ `EXCEPTION`:**

- –ü–æ–∑–≤–æ–ª—è–µ—Ç **–ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏** –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã.
- –ú–æ–∂–Ω–æ **–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏** —Å –ø–æ–º–æ—â—å—é `RAISE NOTICE`.

---

### **–í—ã–≤–æ–¥ –ø–æ —á–∞—Å—Ç–∏ 2:**

- **–ë–ª–æ–∫–∏ PL/pgSQL** —Å–æ—Å—Ç–æ—è—Ç –∏–∑ —Å–µ–∫—Ü–∏–π `DECLARE`, `BEGIN`, `EXCEPTION`.
- **–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –±–ª–æ–∫–∏ (`DO`)** –ø–æ–∑–≤–æ–ª—è—é—Ç —Ä–∞–∑–æ–≤–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–¥.
- **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–∏–ø—ã PostgreSQL** –∏ –∏–º–µ—é—Ç –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏.
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (`EXCEPTION`)** –≤–∞–∂–Ω–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞.

‚è≠ **–°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å** ‚Äì **–§—É–Ω–∫—Ü–∏–∏ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≤ PL/pgSQL** (—Å–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π, –≤–æ–∑–≤—Ä–∞—Ç –∑–Ω–∞—á–µ–Ω–∏–π, –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã). –ì–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? üöÄ