# **–ö–æ–Ω—Å–ø–µ–∫—Ç –≤–∏–¥–µ–æ: –ß–∞—Å—Ç—å 6 ‚Äì –í—ã—á–∏—Å–ª–µ–Ω–∏—è –≤—ã—Ä–∞–∂–µ–Ω–∏–π –≤ PL/pgSQL**

## **6.1. –ö–∞–∫ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤ PL/pgSQL**

PL/pgSQL **–Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ**.  
–í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ **–∫–∞–∂–¥–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ SQL-–∑–∞–ø—Ä–æ—Å**.

### **–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç?**

- –õ—é–±–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `a + b`) –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ `SELECT a + b`.
- PostgreSQL –≤—ã–ø–æ–ª–Ω—è–µ—Ç —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
- PL/pgSQL –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ.

‚úÖ **–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏—è—Ö:**

- –ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (`+`, `-`, `*`, `/`, `%`).
- –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã (`AND`, `OR`, `NOT`).
- –ü–æ–¥–∑–∞–ø—Ä–æ—Å—ã (`SELECT ... FROM ...`).

---

## **6.2. –ö–∞–∫ –ø—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç—Å—è –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ SQL-–∑–∞–ø—Ä–æ—Å**

–ü—Ä–∏–º–µ—Ä –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ PL/pgSQL:

```sql
DO $$
DECLARE
  a INTEGER := 10;
  b INTEGER := 20;
  result INTEGER;
BEGIN
  result := a + b;
  RAISE NOTICE '–†–µ–∑—É–ª—å—Ç–∞—Ç: %', result;
END $$;
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç PL/pgSQL "–ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º"?**

1. –û–Ω **—Å–æ–∑–¥–∞–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å**:
    
    ```sql
    SELECT 10 + 20;
    ```
    
2. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ —Å–µ—Ä–≤–µ—Ä—É PostgreSQL.**
3. **–ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (`30`) –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ `result`.**
4. **–í—ã–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ**:
    
    ```
    –†–µ–∑—É–ª—å—Ç–∞—Ç: 30
    ```
    

‚úÖ **–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å:**

- –î–∞–∂–µ –ø—Ä–æ—Å—Ç—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ SQL-–∑–∞–ø—Ä–æ—Å—ã.
- –≠—Ç–æ **–º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ**, —á–µ–º –≤ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–∞—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è.
- –ù–æ **–ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQL-—Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä—è–º–æ –≤ –∫–æ–¥–µ PL/pgSQL**.

---

## **6.3. –ö–∞–∫ —ç—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å?**

–ú—ã –º–æ–∂–µ–º **—Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É** –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å, –∫–∞–∫–æ–π SQL-–∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.

### **–ü—Ä–∏–º–µ—Ä (–æ—à–∏–±–∫–∞ –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏–∏):**

```sql
DO $$
DECLARE
  a INTEGER := 10;
  result INTEGER;
BEGIN
  result := a / 0;  -- –î–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É
END $$;
```

‚úÖ **PostgreSQL –≤—ã–¥–∞—Å—Ç –æ—à–∏–±–∫—É:**

```
ERROR: division by zero
SQL state: 22012
```

‚ö†Ô∏è **–ó–∞–º–µ—Ç—å:**  
–í –æ—à–∏–±–∫–µ –Ω–∞–ø–∏—Å–∞–Ω–æ, —á—Ç–æ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è SQL-–∑–∞–ø—Ä–æ—Å! –≠—Ç–æ –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ **PL/pgSQL –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ SQL**.

---

## **6.4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SQL-—Ñ—É–Ω–∫—Ü–∏–π –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏—è—Ö**

–ü–æ—Å–∫–æ–ª—å–∫—É **PL/pgSQL –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ SQL-–∑–∞–ø—Ä–æ—Å—ã**, –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ SQL-—Ñ—É–Ω–∫—Ü–∏–∏**.

### **–ü—Ä–∏–º–µ—Ä:**

```sql
DO $$
DECLARE
  a NUMERIC := 9;
  sqrt_a NUMERIC;
BEGIN
  sqrt_a := sqrt(a);  -- –ò—Å–ø–æ–ª—å–∑—É–µ–º SQL-—Ñ—É–Ω–∫—Ü–∏—é sqrt()
  RAISE NOTICE '–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å: %', sqrt_a;
END $$;
```

‚úÖ **–í—ã—Ö–æ–¥:**

```
–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å: 3.0
```

‚úÖ **–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?**

1. `sqrt(a)` –±—ã–ª –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ SQL-–∑–∞–ø—Ä–æ—Å:
    
    ```sql
    SELECT sqrt(9);
    ```
    
2. PostgreSQL **–≤—ã–ø–æ–ª–Ω–∏–ª –∑–∞–ø—Ä–æ—Å –∏ –≤–µ—Ä–Ω—É–ª `3.0`**.
3. **PL/pgSQL –ø–æ–ª—É—á–∏–ª –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å–∞–ª –≤ `sqrt_a`**.

üöÄ **–í—ã–≤–æ–¥:**  
PL/pgSQL **–º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±—ã–µ SQL-—Ñ—É–Ω–∫—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–π**.

---

## **6.5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏—è—Ö**

–ü–æ—Å–∫–æ–ª—å–∫—É **PL/pgSQL –≤—Å–µ —Ä–∞–≤–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç SQL**, –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å **–ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã –ø—Ä—è–º–æ –≤ –∫–æ–¥**.

### **–ü—Ä–∏–º–µ—Ä (–ø–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ)**

```sql
DO $$
DECLARE
  user_count INTEGER;
BEGIN
  user_count := (SELECT COUNT(*) FROM users);
  RAISE NOTICE '–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: %', user_count;
END $$;
```

‚úÖ **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?**

4. PL/pgSQL **—Å–æ–∑–¥–∞–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å**:
    
    ```sql
    SELECT COUNT(*) FROM users;
    ```
    
5. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ PostgreSQL**.
6. **–ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç** –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ `user_count`.
7. **–í—ã–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ**.

üöÄ **–í—ã–≤–æ–¥:**  
PL/pgSQL –ø–æ–∑–≤–æ–ª—è–µ—Ç **–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã –ø—Ä—è–º–æ –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏—è—Ö**.

---

## **6.6. –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `:=` –∏ `SELECT INTO`**

–í PL/pgSQL –µ—Å—Ç—å **–¥–≤–∞ —Å–ø–æ—Å–æ–±–∞ –∑–∞–ø–∏—Å–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é**:

8. **`:=`** ‚Äì –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π.
9. **`SELECT INTO`** ‚Äì –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å **—Ä–µ–∑—É–ª—å—Ç–∞—Ç SQL-–∑–∞–ø—Ä–æ—Å–∞**.

---

### **6.6.1. `:=` (–¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π)**

```sql
DO $$
DECLARE
  result INTEGER;
BEGIN
  result := 10 + 5;  -- –ü—Ä–æ—Å—Ç–æ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
  RAISE NOTICE '–†–µ–∑—É–ª—å—Ç–∞—Ç: %', result;
END $$;
```

‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π, –Ω–æ –Ω–µ –¥–ª—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤.**

---

### **6.6.2. `SELECT INTO` (–¥–ª—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤)**

```sql
DO $$
DECLARE
  total_orders INTEGER;
BEGIN
  SELECT COUNT(*) INTO total_orders FROM orders;
  RAISE NOTICE '–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: %', total_orders;
END $$;
```

‚úÖ **–ù—É–∂–Ω–æ, –µ—Å–ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å.**

üöÄ **–í—ã–≤–æ–¥:**

- `:=` ‚Äì –¥–ª—è –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∏ (`a := b + c`).
- `SELECT INTO` ‚Äì –¥–ª—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ (`SELECT COUNT(*) INTO x`).

---

## **6.7. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–ª–æ–∂–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π**

–ú–æ–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å **–∞—Ä–∏—Ñ–º–µ—Ç–∏–∫—É, SQL-–∑–∞–ø—Ä–æ—Å—ã –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è**.

### **–ü—Ä–∏–º–µ—Ä:**

```sql
DO $$
DECLARE
  total NUMERIC;
BEGIN
  total := (SELECT SUM(price) FROM orders) * 0.9;  -- 10% —Å–∫–∏–¥–∫–∞
  RAISE NOTICE '–°—É–º–º–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π: %', total;
END $$;
```

‚úÖ **–í—ã—Ö–æ–¥ (–µ—Å–ª–∏ —Å—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤ –±—ã–ª–∞ 1000):**

```
–°—É–º–º–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π: 900.00
```

üöÄ **–í—ã–≤–æ–¥:**  
PL/pgSQL –ø–æ–∑–≤–æ–ª—è–µ—Ç **–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã –≤–Ω—É—Ç—Ä–∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π**.

---

## **6.8. –ü—Ä–∏–º–µ—Ä —Å–ª–æ–∂–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è–º–∏**

–°–æ–∑–¥–∞–¥–∏–º **—Ñ—É–Ω–∫—Ü–∏—é —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–ª–æ–≥–∞ –Ω–∞ —Ç–æ–≤–∞—Ä**.

```sql
CREATE FUNCTION calculate_tax(price NUMERIC, tax_rate NUMERIC)
RETURNS NUMERIC AS $$
BEGIN
  RETURN price * (1 + tax_rate / 100);
END $$ LANGUAGE plpgsql;
```

**–í—ã–∑–æ–≤:**

```sql
SELECT calculate_tax(100, 18);
```

‚úÖ **–í—ã—Ö–æ–¥:**

```
118.00
```

üöÄ **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?**

10. `price * (1 + tax_rate / 100)` **–ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ SQL-–∑–∞–ø—Ä–æ—Å**.
11. PostgreSQL **–≤—ã—á–∏—Å–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ**.
12. –§—É–Ω–∫—Ü–∏—è **–æ—Ç–¥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç**.

---

## **–í—ã–≤–æ–¥ –ø–æ —á–∞—Å—Ç–∏ 6**

- **PL/pgSQL –ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å–∞–º ‚Äì –æ–Ω –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏—Ö –≤ SQL-–∑–∞–ø—Ä–æ—Å—ã.**
- **–õ—é–±—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è (`a + b`, `sqrt(x)`, `COUNT(*)`) –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å–µ—Ä–≤–µ—Ä—É –∫–∞–∫ SQL.**
- **–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQL-—Ñ—É–Ω–∫—Ü–∏–∏ (`sqrt()`, `count()`, `sum()`) –≤–Ω—É—Ç—Ä–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–π.**
- **–î–ª—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `SELECT INTO`, –¥–ª—è –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∏ ‚Äì `:=`.**
- **–ú–æ–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã –∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è.**

‚è≠ **–°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å** ‚Äì **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è –∏ –∫–µ–π—Å—ã (–æ–±—Ä–µ–∑–∫–∞ —Å—Ç—Ä–æ–∫, —Å–∏–º—É–ª—è—Ü–∏—è –∏–≥—Ä—ã ¬´–ù–∞–ø–µ—Ä—Å—Ç–∫–∏¬ª –∏ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–º–µ—Ä—ã). –ì–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? üöÄ**