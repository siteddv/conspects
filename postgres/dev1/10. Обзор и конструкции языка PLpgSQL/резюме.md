### Конспект по PL/pgSQL: Полное руководство

#### Часть 1: Введение в язык PL/pgSQL

**История создания PL/pgSQL**

PL/pgSQL был создан в 1998 году с целью предоставления пользователям PostgreSQL возможности писать функции на более высокоуровневом языке, чем C. До этого момента единственным способом написания пользовательских функций в PostgreSQL был язык C, который является низкоуровневым и сложным для использования в прикладных задачах. С версии 9.0 PL/pgSQL стал доступен по умолчанию.

**Цели разработки PL/pgSQL**

Основная цель создания PL/pgSQL заключалась в том, чтобы предложить язык программирования, который будет проще, чем C, но достаточно мощным для выполнения сложных операций. Этот язык должен был поддерживать управляющие конструкции (такие как условные операторы и циклы), быть полностью совместимым с типами данных PostgreSQL и упростить работу с хранимыми процедурами и триггерами.

**Отличия от других языков**

PL/pgSQL основан на языке PL/SQL от Oracle, что делает его синтаксис схожим с PL/SQL. Он использует структурные блоки, аналогичные тем, что можно найти в языках Ada и Pascal. Основное отличие между SQL и PL/pgSQL заключается в том, что SQL выполняет единичные запросы, тогда как PL/pgSQL расширяет возможности SQL, добавляя переменные, условия, циклы и обработку ошибок (`EXCEPTION`).

**Аналогия с PL/SQL (Oracle)**

Хотя PL/pgSQL и PL/SQL имеют много общего, существуют некоторые различия. Например, в PostgreSQL функции используются чаще, чем процедуры, тогда как в Oracle процедуры выполняются без возврата значений (`PROCEDURE`). В PL/pgSQL можно использовать только `FUNCTION`, но есть возможность использовать `RETURN VOID` для процедурного поведения.

**Структура кода на PL/pgSQL**

Основной единицей кода в PL/pgSQL является блок. Каждый блок состоит из трех основных частей:
1. **Секция объявления переменных (`DECLARE`)**
2. **Секция операторов (`BEGIN ... END`)**
3. **Секция обработки исключений (`EXCEPTION`)** (необязательная)

Пример минимального блока кода:

```sql
DO $$
BEGIN
  RAISE NOTICE 'Hello, PL/pgSQL!';
END $$;
```

- **`DO $$ ... $$`** – выполнение анонимного блока PL/pgSQL.
- **`BEGIN ... END`** – обязательный исполняемый блок.
- **`RAISE NOTICE`** – выводит сообщение в лог.

#### Часть 2: Блоки кода в PL/pgSQL

**Основные элементы блока PL/pgSQL**

Каждая программа на PL/pgSQL строится на основе блоков кода, которые включают:
4. **Метка блока** (опционально)
5. **Секция объявления переменных (`DECLARE`)**
6. **Секция операторов (`BEGIN ... END`)**
7. **Секция обработки исключений (`EXCEPTION`)** (опционально)

Пример стандартного блока PL/pgSQL:

```sql
<>
DECLARE
  my_var TEXT := 'Hello, World!';
BEGIN
  RAISE NOTICE '%', my_var;
EXCEPTION
  WHEN others THEN
    RAISE NOTICE 'An error occurred!';
END;
```

**Анонимные блоки PL/pgSQL**

PL/pgSQL поддерживает анонимные блоки кода, которые можно запускать без создания функции. Используется оператор `DO`. Код не сохраняется в базе данных, выполняется разово.

Пример анонимного блока:

```sql
DO $$
DECLARE
  message TEXT := 'Hello from an anonymous block!';
BEGIN
  RAISE NOTICE '%', message;
END $$;
```

**Объявление переменных внутри блока**

Переменные объявляются в секции `DECLARE`. Пример объявления переменных:

```sql
DO $$
DECLARE
  my_int INTEGER := 10;
  my_text TEXT := 'PL/pgSQL';
  my_result TEXT;
BEGIN
  my_result := my_text || ' is fun!';
  RAISE NOTICE '%', my_result;
END $$;
```

**Видимость переменных и вложенные блоки**

Переменные действуют только внутри блока, где они объявлены. Можно объявлять переменные с одинаковыми именами в разных блоках. Чтобы обратиться к переменной из внешнего блока, используется метка блока.

**Работа с обработкой ошибок (`EXCEPTION`)**

PL/pgSQL поддерживает механизм обработки ошибок. Пример обработки ошибок:

```sql
DO $$
BEGIN
  RAISE EXCEPTION 'Custom error!';
EXCEPTION
  WHEN others THEN
    RAISE NOTICE 'An error occurred!';
END $$;
```

#### Часть 3: Объявление переменных и работа с типами данных в PL/pgSQL

**Объявление переменных в PL/pgSQL**

Переменные объявляются в секции `DECLARE`, которая должна идти до блока `BEGIN`.

**Использование типов данных PostgreSQL**

Переменные могут использовать любые типы данных, поддерживаемые PostgreSQL, такие как числа, строки, логические значения, даты и время, JSON/XML и массивы.

**Переменные с начальным значением**

Переменные могут иметь начальное значение, задаваемое через `:=` или `DEFAULT`.

**Константы (`CONSTANT`)**

Переменные можно сделать константами, если они не должны изменяться.

**`NOT NULL` для переменных**

Переменная может быть обязательной (не `NULL`).

**Автоматическое определение типа (`%TYPE`)**

Можно автоматически задать тип переменной, используя `table.column%TYPE`.

#### Часть 4: Функции и процедуры в PL/pgSQL

**Функции в PL/pgSQL**

Функции создаются с помощью `CREATE FUNCTION` и выполняют определенные операции, возвращая значение.

**Возвращаемые значения в функциях**

Функции могут возвращать одиночное значение, набор строк или значение через `OUT` параметры.

**Разница между `STRICT`, `IMMUTABLE`, `STABLE`, `VOLATILE`**

Эти модификаторы помогают оптимизировать выполнение функций.

**Пример сложной функции**

Пример функции проверяет, является ли число простым.

**Разница между функциями и процедурами**

Функции возвращают значение, тогда как процедуры выполняют действия, но не возвращают результат.

#### Часть 5: Условные операторы в PL/pgSQL

**Основные условные операторы**

Поддерживаются две основные конструкции: `IF ... THEN ... ELSE` и `CASE`.

**Оператор `IF ... THEN ... ELSE`**

Используется для разветвления логики.

**Оператор `CASE`**

Аналог `switch` в других языках.

**Разница между `IF` и `CASE`**

`IF` используется для сложных условий, а `CASE` удобнее для проверки одного значения.

**Объединение `IF` и `CASE` в функциях**

Пример функции, использующей `IF` и `CASE`.

#### Часть 6: Циклы в PL/pgSQL

**Введение в циклы**

Поддерживаются три типа циклов: `FOR`, `WHILE` и `LOOP`.

**Цикл `FOR`**

Перебирает значения в заданном диапазоне.

**Цикл `WHILE`**

Выполняется пока выполняется условие.

**Бесконечный цикл `LOOP`**

Выполняется бесконечно, пока не будет `EXIT`.

**Управление итерациями (`EXIT` и `CONTINUE`)**

Можно принудительно выходить (`EXIT`) или пропускать итерации (`CONTINUE`).

**Вложенные циклы**

Можно использовать циклы внутри циклов.

#### Часть 7: Вычисления выражений в PL/pgSQL

**Как выполняются вычисления в PL/pgSQL**

PL/pgSQL не выполняет вычисления самостоятельно, а преобразует их в SQL-запросы.

**Как преобразуются выражения в SQL-запрос**

Любое выражение превращается в SQL-запрос, который выполняется сервером PostgreSQL.

**Использование SQL-функций в выражениях**

Можно использовать встроенные SQL-функции прямо в коде PL/pgSQL.

**Использование подзапросов в выражениях**

Можно вставлять подзапросы прямо в код.

**Разница между `:=` и `SELECT INTO`**

`:=` используется для простых выражений, а `SELECT INTO` для SQL-запросов.

**Поддержка сложных выражений**

Можно комбинировать арифметику, SQL-запросы и логические выражения.

**Пример сложной функции с вычислениями**

Пример функции расчета налога на товар.

#### Часть 8: Практические задания и кейсы в PL/pgSQL

**Обрезка строки с добавлением `...`**

Функция обрезает строку и добавляет `...` в конце.

**Обрезка строки по последнему слову перед лимитом**

Функция обрезает строку по последнему полному слову.

**Генерация случайной строки заданной длины**

Функция генерирует строку длины `n`, состоящую из случайных символов.

**Симуляция игры «Наперстки» (анализ вероятностей)**

Симуляция показывает, что лучше менять выбор.

### Заключение

PL/pgSQL — это мощный инструмент для написания пользовательских функций и процедур в PostgreSQL. Он предоставляет широкие возможности для работы с данными, включая управление потоком выполнения, обработку ошибок, работу с типами данных и выполнение сложных вычислений.