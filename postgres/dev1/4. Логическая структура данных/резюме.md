### Подробный конспект по логической организации данных в PostgreSQL

#### Введение в логическую организацию данных
Видео, которое легло в основу данного конспекта, подробно рассматривает логическую организацию данных в реляционных базах данных, с акцентом на PostgreSQL. Основное внимание уделяется работе с базами данных, схемами, системным каталогом и путём поиска объектов. Материал разделён на две крупные части: логическая организация данных (структурирование внутри СУБД) и физическая организация данных (хранение файлов баз данных на диске). Этот конспект охватывает первую часть — логическую организацию.

Основные понятия, которые будут разобраны, включают:
- Базы данных и их шаблоны (`template0` и `template1`).
- Схемы в базах данных, включая предопределённые схемы (`public`, `pg_catalog`, `information_schema`).
- Путь поиска (`search_path`) — механизм, который определяет, как СУБД ищет объекты внутри базы данных.
- Системный каталог (`pg_catalog`) — хранилище метаданных базы данных.

Ключевые вопросы, на которые отвечает материал:
1. Как логически организована база данных?
2. Что такое схемы и зачем они нужны?
3. Как базы данных работают с объектами, если их имена совпадают?
4. Как СУБД находит таблицы, схемы и другие объекты?
5. Какие есть предопределённые схемы и что они делают?
6. Как получать информацию о структуре базы через системный каталог?

---

#### Кластер баз данных и шаблонные базы
**Кластер баз данных** — это группа баз данных, управляемых одним экземпляром сервера PostgreSQL. При инициализации кластера автоматически создаются три базы данных:
1. **`postgres`** — стандартная база данных для работы с сервером.
2. **`template0`** — чистый шаблон, который всегда остаётся неизменным.
3. **`template1`** — основной шаблон, из которого по умолчанию создаются новые базы данных.

**Шаблонные базы данных** играют важную роль при создании новых баз данных:
- **`template1`**: Все новые базы данных создаются путём копирования `template1`. Его можно модифицировать, добавляя объекты (например, расширения, схемы, таблицы). Если добавить нужные настройки в `template1`, они автоматически появятся во всех новых базах.
- **`template0`**: Это чистая база данных, которую нельзя изменять. Она используется, когда нужно создать базу данных с другой кодировкой или пустую базу для восстановления из бэкапа (`pg_restore`).

Создание базы данных выполняется с помощью команды:
```sql
CREATE DATABASE new_db;  -- Создаст копию `template1`
CREATE DATABASE new_db TEMPLATE template0;  -- Создаст копию `template0`
```

Обычная база данных (`postgres`) — это стандартная база данных, созданная при инициализации. Её можно удалить, если созданы другие базы. Удаление базы данных выполняется командой:
```sql
DROP DATABASE my_database;
```
Если база данных занята, перед удалением нужно переключиться на другую:
```sql
\c postgres  -- Переключиться в другую базу
DROP DATABASE my_database;
```

Число баз данных в PostgreSQL не ограничено. Решение о количестве баз зависит от архитектуры приложения:
- Одна база на проект.
- Разные базы для разных окружений (разработка, тест, продакшен).
- Отдельные базы для разных клиентов (multi-tenant архитектура).

В обучающих курсах часто создаётся новая база данных для каждой темы, чтобы изолировать настройки и избежать конфликтов между объектами.

---

#### Структура базы данных: схемы
**Схема** — это логическое пространство, в котором хранятся объекты базы данных (таблицы, представления, функции и т. д.). Схемы помогают разделять объекты внутри одной базы данных, избегая конфликтов.

**Зачем нужны схемы?**
4. **Избегать конфликтов имён**: Разные приложения или команды могут создать таблицы с одинаковыми именами. Например, в одной базе могут быть две таблицы `users`, но в разных схемах:
   ```
   app1.users
   app2.users
   ```
5. **Гибкость организации**: Можно разделять бизнес-логические модули по схемам. Например:
   ```
   orders_schema.orders
   customers_schema.customers
   ```
6. **Безопасность и доступ**: Можно назначать права доступа для разных схем. Например, одна схема доступна только для чтения (`read_only`), другая — для изменения (`write_access`).
7. **Упрощение разработки**: Легко переносить объекты между схемами и изолировать разные версии приложения в одной базе.

Создание схемы выполняется командой:
```sql
CREATE SCHEMA my_schema;
```
Проверить список схем можно в `psql`:
```sh
\dn
```
Создание таблицы в схеме:
```sql
CREATE TABLE my_schema.users (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL
);
```

Работа со схемами:
- Обращение к объектам внутри схемы выполняется с использованием квалифицированного имени:
  ```sql
  SELECT * FROM my_schema.users;
  ```
- Если схему не указать, PostgreSQL будет искать объект в схемах, указанных в `search_path`.

Перемещение таблицы в другую схему:
```sql
ALTER TABLE users SET SCHEMA new_schema;
```
Удаление схемы (с объектами внутри):
```sql
DROP SCHEMA my_schema CASCADE;
```

Особенности схем в PostgreSQL:
- В PostgreSQL схемы и пользователи — разные сущности.
- В некоторых других СУБД (например, Oracle) схема = пользователь.

---

#### Специальные схемы в PostgreSQL
PostgreSQL создаёт несколько специальных схем автоматически при инициализации базы данных. Они предназначены для системных объектов, временных таблиц и стандартных SQL-метаданных.

8. **`public`** — схема по умолчанию:
   - Создаётся в каждой базе данных.
   - Если не указывать схему при создании объектов, они помещаются в `public`.
   - Все пользователи имеют права на создание объектов в `public`.

9. **`pg_catalog`** — системный каталог PostgreSQL:
   - Главная системная схема, содержащая служебные таблицы, описание всех объектов в базе, стандартные SQL-функции и встроенные типы данных.
   - Включена в `search_path` по умолчанию.

10. **`information_schema`** — стандартный SQL-каталог:
   - Содержит метаданные о таблицах, схемах, колонках и т. д.
   - Полностью соответствует стандарту SQL.

11. **`pg_temp`** — схема для временных объектов:
   - Используется для хранения временных таблиц.
   - Создаётся автоматически в каждом сеансе при создании временных объектов.
   - Удаляется при завершении сеанса.

12. **Другие служебные схемы**:
   - `pg_toast`: Хранит "раздутые" данные (`TEXT`, `BYTEA`, `JSONB`).
   - `pg_statistic`: Хранит статистику о данных, которая используется оптимизатором запросов.

---

#### Путь поиска (`search_path`)
`search_path` — это список схем, которые PostgreSQL просматривает в определённом порядке при поиске объектов. Когда мы выполняем запрос без явного указания схемы, система ищет объект в первой найденной схеме из `search_path`.

Алгоритм поиска:
13. Проверяет, указано ли полное имя (`схема.объект`).
14. Перебирает схемы в порядке из `search_path`.
15. Если объект не найден в указанных схемах — выдаёт ошибку.

Просмотр текущего пути поиска:
```sql
SHOW search_path;
```

Настройка `search_path`:
- Временно изменить в текущем сеансе:
  ```sql
  SET search_path TO my_schema, public;
  ```
- Постоянно изменить для пользователя:
  ```sql
  ALTER ROLE my_user SET search_path TO my_schema, public;
  ```
- Установить для всей базы данных:
  ```sql
  ALTER DATABASE my_db SET search_path TO my_schema, public;
  ```

---

#### Системный каталог PostgreSQL (`pg_catalog`)
Системный каталог PostgreSQL (`pg_catalog`) — это встроенная схема, в которой хранятся метаданные о всех объектах базы данных. Основные таблицы:
- `pg_database`: Список баз данных.
- `pg_namespace`: Список схем.
- `pg_class`: Информация о таблицах, индексах, представлениях.
- `pg_attribute`: Информация о столбцах таблиц.
- `pg_proc`: Список функций.
- `pg_index`: Информация об индексах.
- `pg_statistic`: Статистика для оптимизатора запросов.

---

#### Удаление объектов и схем
Удаление объектов в PostgreSQL имеет свои особенности:
- Прямое удаление запрещено, если у объекта есть зависимости.
- Можно удалять с каскадным удалением (`CASCADE`).
- Нельзя удалить базу данных с активными подключениями.

Примеры:
- Удаление схемы:
  ```sql
  DROP SCHEMA my_schema CASCADE;
  ```
- Удаление таблицы:
  ```sql
  DROP TABLE users CASCADE;
  ```
- Удаление базы данных:
  ```sql
  \c postgres
  DROP DATABASE my_database;
  ```

---

Этот конспект охватывает все ключевые аспекты логической организации данных в PostgreSQL, предоставляя детальное понимание работы с базами данных, схемами, системным каталогом и путём поиска объектов.