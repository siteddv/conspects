Продолжаем со второй части: **Как работает подключение к серверу: конфигурация в pg_hba.conf**.

---

### 2. Как работает подключение к серверу: конфигурация в pg_hba.conf

#### Файл **pg_hba.conf** и процесс подключения

Файл **pg_hba.conf** играет ключевую роль в определении, кто и как может подключаться к серверу базы данных PostgreSQL. Он задает правила для аутентификации пользователей в зависимости от типа подключения, базы данных, пользователя и других параметров.

Этот файл представляет собой текстовый файл с набором строк, каждая из которых описывает одно правило для подключения. Строки в файле читаются сверху вниз, и при подключении сервер проверяет, подходит ли текущее подключение под каждое правило. Если ни одно правило не подходит, подключение отклоняется.

#### Структура файла **pg_hba.conf**

Каждая строка в **pg_hba.conf** имеет следующий формат:

- **Тип подключения**: указывает, какой тип подключения разрешен. Например, `local` для локальных подключений, `host` для подключений через сеть.
- **База данных**: определяет, к каким базам данных разрешено подключение. Могут быть указаны конкретные базы данных, либо использоваться ключевое слово `all` для всех баз данных.
- **Пользователь**: указывает роль (пользователя), для которой разрешено подключение.
- **Адрес**: определяет, с каких адресов разрешены подключения. Например, для локальных подключений будет указан `127.0.0.1` (localhost), для удаленных — диапазоны IP-адресов.
- **Метод аутентификации**: указывает, каким образом будет происходить аутентификация пользователя. Методы могут быть разные, такие как `trust`, `md5`, `password`, `peer`, и другие.

#### Пример строки в **pg_hba.conf**

Пример строки в файле, разрешающей подключение локального пользователя `student` к любой базе данных:

```
local   all             student                                trust
```

Здесь:

- **local**: тип подключения (локальные подключения).
- **all**: доступ ко всем базам данных.
- **student**: имя пользователя, который может подключаться.
- **trust**: метод аутентификации, означающий полное доверие (пользователь может подключаться без пароля).

#### Принцип работы процесса подключения

Когда клиент подключается к серверу, PostgreSQL проверяет строки в файле **pg_hba.conf** в следующем порядке:

1. Проверяется тип подключения (например, `local`, `host`).
2. Сравнивается база данных, к которой пытается подключиться пользователь, с указанными в файле.
3. Затем проверяется имя пользователя.
4. Проверяется адрес, с которого происходит подключение.
5. Наконец, сервер проверяет метод аутентификации.

Если сервер находит строку, которая соответствует всем этим параметрам, оно разрешает подключение, используя указанный метод аутентификации.

#### Роль метода аутентификации

Метод аутентификации определяет, каким образом будет проверяться идентичность пользователя:

- **trust**: доверительный метод, который не требует пароля. Используется для локальных соединений или в безопасных окружениях.
- **md5**: аутентификация через пароль с хешированием MD5. Это один из самых распространенных методов для удаленных подключений.
- **password**: аутентификация с использованием открытого пароля, который передается в текстовом виде (не рекомендуется использовать для удаленных соединений без шифрования).
- **peer**: используется для аутентификации на основе имени пользователя операционной системы (только для локальных подключений).
- **reject**: отклонение всех подключений, которые соответствуют текущей строке.

#### Пример поиска строки подключения

Когда пользователь подключается, сервер анализирует файл **pg_hba.conf** и проверяет, существует ли строка, которая подходит для его подключения. Пример:

- Если пользователь подключается как `student` с локального компьютера и пытается подключиться к базе данных, сервер найдет строку с типом подключения `local`, с указанием базы данных `all`, с пользователем `student`, и методом `trust`.

Если строка найдена, подключение разрешается. Если подходящей строки нет, подключение отклоняется.

---

Это была вторая часть, в которой мы разобрали работу файла **pg_hba.conf** и принцип работы с подключениями. Переходим к третьей части?