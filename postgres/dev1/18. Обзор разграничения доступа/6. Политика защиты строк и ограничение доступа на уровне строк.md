Продолжаем с шестой части: **Политика защиты строк и ограничение доступа на уровне строк**.

---

### 6. Политика защиты строк и ограничение доступа на уровне строк

#### Что такое политика защиты строк?

Политика защиты строк (Row-Level Security, RLS) в PostgreSQL позволяет ограничить доступ к строкам таблицы в зависимости от роли пользователя или других условий. Это означает, что даже если пользователю разрешено подключаться к таблице и выполнять определенные операции, он будет видеть только те строки, к которым у него есть доступ, в зависимости от настроенных политик.

Политика защиты строк дает возможность настраивать безопасность на более детальном уровне, чем стандартные привилегии на таблицы и столбцы. Это может быть полезно в случаях, когда нужно обеспечить различные уровни доступа к данным для разных пользователей, например, для разных департаментов в организации или для разных ролей в приложении.

#### Как работает политика защиты строк?

По умолчанию в PostgreSQL политика защиты строк отключена для всех таблиц. Чтобы включить ее, необходимо явно активировать RLS для конкретной таблицы. После включения политики для таблицы можно настроить правила, которые определяют, какие строки будут видны пользователю.

Политика защиты строк может быть настроена для:

- **Просмотра** строк (SELECT).

- **Вставки** новых строк (INSERT).

- **Обновления** существующих строк (UPDATE).

- **Удаления** строк (DELETE).

#### Включение политики защиты строк

Чтобы включить политику защиты строк для таблицы, используется команда **ALTER TABLE**:

```sql

ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;

```

Эта команда включает RLS для таблицы **table_name**. После этого можно настроить конкретные политики для пользователей или ролей.

#### Настройка политики

Политики настраиваются с помощью команд **CREATE POLICY**. Каждая политика может включать различные условия, которые определяют, какие строки будут доступны для пользователей.

Пример создания политики для выборки строк:

```sql

CREATE POLICY policy_name

ON table_name

FOR SELECT

USING (user_id = current_user_id());

```

В этом примере создается политика **policy_name**, которая разрешает пользователям видеть только те строки таблицы **table_name**, где значение столбца **user_id** совпадает с текущим пользователем (функция `current_user_id()` возвращает ID текущего пользователя).

#### Типы политик

Политики могут быть двух типов:

- **PERMISSIVE (разрешительная)**: Разрешает доступ к строкам, если хотя бы одна разрешительная политика позволяет это.

- **RESTRICTIVE (запрещающая)**: Запрещает доступ к строкам, если хотя бы одна запрещающая политика блокирует его.

По умолчанию PostgreSQL создает разрешительные политики, что означает, что доступ к строкам разрешается, если хотя бы одна разрешительная политика разрешает его. Однако можно использовать запрещающие политики для более строгого контроля.

#### Пример: Ограничение доступа на основе роли

Предположим, у нас есть таблица сотрудников, и мы хотим, чтобы менеджеры могли видеть только своих сотрудников. Мы создадим политику для этой таблицы, которая будет ограничивать доступ только тем пользователям, чьи **user_id** соответствуют данным в таблице:

1. Включаем политику защиты строк:

```sql

ALTER TABLE employees ENABLE ROW LEVEL SECURITY;

```

2. Создаем политику для выборки данных:

```sql

CREATE POLICY view_policy

ON employees

FOR SELECT

USING (manager_id = current_user_id());

```

1. После этого пользователи, которые не являются менеджерами, не смогут увидеть строки, которые им не принадлежат.

#### Пример: Ограничение доступа на уровне вставки

Политику можно настроить не только для чтения данных, но и для вставки. Например, можно создать политику, которая разрешает пользователям вставлять только свои собственные записи в таблицу:

```sql

CREATE POLICY insert_policy

ON employees

FOR INSERT

USING (user_id = current_user_id());

```

Этот запрос разрешает вставку данных в таблицу **employees** только тем пользователям, чье **user_id** совпадает с их собственным идентификатором.

#### Пример: Ограничение доступа на уровне обновления и удаления

Точно так же, как для чтения и вставки, можно настроить политику для обновления и удаления строк:

```sql

CREATE POLICY update_policy

ON employees

FOR UPDATE

USING (user_id = current_user_id());

CREATE POLICY delete_policy

ON employees

FOR DELETE

USING (user_id = current_user_id());

```

Эти политики будут ограничивать обновление и удаление строк только теми пользователями, которые являются владельцами данных (или имеют соответствующие привилегии).

#### Применение политики

После создания политик необходимо активировать их для таблицы. Для этого используется команда **ALTER TABLE** с параметром **ENABLE ROW LEVEL SECURITY**:

```sql

ALTER TABLE employees ENABLE ROW LEVEL SECURITY;

```

Эта команда активирует политику защиты строк для таблицы, и все последующие запросы, в зависимости от роли пользователя, будут проверяться на наличие соответствующих политик.

#### Исключение владельца и суперпользователей

Политика защиты строк не применяется к владельцам объектов, суперпользователям и ролям с атрибутом **BYPASSRLS**. Это позволяет администраторам базы данных иметь полный доступ ко всем строкам, независимо от установленных политик.

#### Пример использования политики для ограничений доступа

Допустим, у нас есть таблица с заказами, и мы хотим, чтобы каждый пользователь мог видеть только те заказы, которые он сделал. В этом случае мы создаем политику, которая будет проверять соответствие **user_id** в строке с текущим пользователем:

```sql

CREATE POLICY order_policy

ON orders

FOR SELECT

USING (user_id = current_user_id());

```

---

Это была шестая часть, в которой мы разобрали политику защиты строк и ограничение доступа на уровне строк. Готовы перейти к седьмой части?