### **–ß–∞—Å—Ç—å 6: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ PL/pgSQL**

–í —ç—Ç–æ–π —á–∞—Å—Ç–∏ —Ä–∞–∑–±–∏—Ä–∞—é—Ç—Å—è:

- **–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ (`GET DIAGNOSTICS ROW_COUNT`)**
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `FOUND` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞**
- **–†–∞–±–æ—Ç–∞ —Å `SQLSTATE` –∏ `SQLERRM` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫**
- **–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤**
- **–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ**

---

## **1. –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ (`GET DIAGNOSTICS ROW_COUNT`)**

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `INSERT`, `UPDATE`, `DELETE` –∏–ª–∏ `SELECT`, –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å, **—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –±—ã–ª–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ**.  
–î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `GET DIAGNOSTICS`.

üìå **–ü—Ä–∏–º–µ—Ä –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫:**

```plpgsql
DECLARE 
    affected_rows INT;
BEGIN
    UPDATE users SET status = 'inactive' WHERE last_login < now() - INTERVAL '1 year';
    GET DIAGNOSTICS affected_rows = ROW_COUNT;
    
    RAISE NOTICE '–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫: %', affected_rows;
END;
```

üìå **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?**  
‚úÖ `ROW_COUNT` —Ö—Ä–∞–Ω–∏—Ç —á–∏—Å–ª–æ —Å—Ç—Ä–æ–∫, –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –ø–æ—Å–ª–µ–¥–Ω–∏–º SQL-–∑–∞–ø—Ä–æ—Å–æ–º.  
‚úÖ `GET DIAGNOSTICS` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —ç—Ç–æ —á–∏—Å–ª–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `affected_rows`.  
‚úÖ –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥.

---

## **2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `FOUND` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞**

–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `FOUND` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `TRUE`, –µ—Å–ª–∏ **–ø—Ä–µ–¥—ã–¥—É—â–∏–π SQL-–∑–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–æ—Ç–∞–ª —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É**.

üìå **–ü—Ä–∏–º–µ—Ä —Å `SELECT INTO`:**

```plpgsql
DECLARE 
    user_name TEXT;
BEGIN
    SELECT name INTO user_name FROM users WHERE id = 5;
    
    IF FOUND THEN
        RAISE NOTICE '–ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: %', user_name;
    ELSE
        RAISE NOTICE '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
    END IF;
END;
```

üìå **–ü—Ä–∏–º–µ—Ä —Å `UPDATE`:**

```plpgsql
BEGIN
    UPDATE users SET status = 'inactive' WHERE last_login < now() - INTERVAL '1 year';

    IF FOUND THEN
        RAISE NOTICE '–û–±–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–ø–∏—Å–∏ –æ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö';
    ELSE
        RAISE NOTICE '–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏';
    END IF;
END;
```

‚úÖ **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `FOUND`?**

- –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ `SELECT`, `UPDATE`, `DELETE`, `INSERT`.
- –î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –∑–∞–ø—Ä–æ—Å **–Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏**.
- –í —Ü–∏–∫–ª–∞—Ö (`LOOP`, `FOR`, `WHILE`) ‚Äì –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –ª–∏ —Ü–∏–∫–ª —Ö–æ—Ç—è –±—ã —Ä–∞–∑.

---

## **3. –†–∞–±–æ—Ç–∞ —Å `SQLSTATE` –∏ `SQLERRM` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫**

–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –æ—à–∏–±–∫–∏.  
PostgreSQL –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **`SQLSTATE` –∏ `SQLERRM` –¥–ª—è –æ—Ç–ª–æ–≤–∞ –æ—à–∏–±–æ–∫**.

üìå **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å `EXCEPTION` –∏ `SQLSTATE`**

```plpgsql
BEGIN
    INSERT INTO users (id, name) VALUES (1, 'John');  -- –î–æ–ø—É—Å—Ç–∏–º, id=1 —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
EXCEPTION
    WHEN unique_violation THEN
        RAISE NOTICE '–û—à–∏–±–∫–∞: —ç—Ç–æ—Ç ID —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!';
END;
```

üìå **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `SQLSTATE` –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫**

```plpgsql
BEGIN
    INSERT INTO users (id, name) VALUES (1, 'John');
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '–û—à–∏–±–∫–∞: –∫–æ–¥ % - %', SQLSTATE, SQLERRM;
END;
```

‚úÖ `SQLSTATE` ‚Äì –∫–æ–¥ –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `23505` –¥–ª—è `UNIQUE VIOLATION`).  
‚úÖ `SQLERRM` ‚Äì —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏.  
‚úÖ `WHEN OTHERS THEN` ‚Äì –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç **–ª—é–±—ã–µ –æ—à–∏–±–∫–∏**.

---

## **4. –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤**

üìå **–ü—Ä–æ–±–ª–µ–º–∞: `SELECT INTO` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫**  
–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–±–æ–ª–µ–µ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏**, –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –æ—à–∏–±–∫–∞.

üî¥ **–û—à–∏–±–∫–∞:**

```plpgsql
DECLARE 
    user_name TEXT;
BEGIN
    SELECT name INTO user_name FROM users WHERE status = 'active';  -- –û–®–ò–ë–ö–ê, –µ—Å–ª–∏ >1 —Å—Ç—Ä–æ–∫–∏
END;
```

‚úÖ **–†–µ—à–µ–Ω–∏–µ:**  
1Ô∏è‚É£ **–î–æ–±–∞–≤–∏—Ç—å `LIMIT 1`**

```plpgsql
SELECT name INTO user_name FROM users WHERE status = 'active' LIMIT 1;
```

2Ô∏è‚É£ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `EXCEPTION` –¥–ª—è –æ—Ç–ª–æ–≤–∞ –æ—à–∏–±–∫–∏**

```plpgsql
BEGIN
    SELECT name INTO user_name FROM users WHERE status = 'active';
EXCEPTION
    WHEN TOO_MANY_ROWS THEN
        RAISE NOTICE '–û—à–∏–±–∫–∞: SELECT INTO –≤–µ—Ä–Ω—É–ª –±–æ–ª–µ–µ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏!';
END;
```

---

üìå **–ü—Ä–æ–±–ª–µ–º–∞: `DELETE` –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Å—Ç—Ä–æ–∫–∏**  
–ï—Å–ª–∏ `DELETE` –Ω–µ –Ω–∞—à–µ–ª –Ω–∏ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏, –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç.

‚úÖ **–†–µ—à–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä—è—Ç—å `ROW_COUNT` –∏–ª–∏ `FOUND`**

```plpgsql
BEGIN
    DELETE FROM users WHERE id = 100;

    IF NOT FOUND THEN
        RAISE NOTICE '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID 100 –Ω–µ –Ω–∞–π–¥–µ–Ω';
    END IF;
END;
```

---

üìå **–ü—Ä–æ–±–ª–µ–º–∞: `NULL` –≤–º–µ—Å—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è**  
–ï—Å–ª–∏ `SELECT INTO` –Ω–∏—á–µ–≥–æ –Ω–µ –≤–µ—Ä–Ω—É–ª, –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ–ª—É—á–∏—Ç `NULL`, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–∞–º.

‚úÖ **–†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `COALESCE` –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `FOUND`**

```plpgsql
DECLARE 
    user_name TEXT;
BEGIN
    SELECT name INTO user_name FROM users WHERE id = 100;
    
    IF user_name IS NULL THEN
        RAISE NOTICE '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
    END IF;
END;
```

---

## **5. –ü–æ–ª–µ–∑–Ω—ã–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏**

üìå **–í—ã–≤–µ—Å—Ç–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"**

```plpgsql
DECLARE 
    user_name TEXT;
BEGIN
    SELECT name INTO user_name FROM users WHERE id = 5;
    
    RAISE NOTICE '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: %', COALESCE(user_name, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
END;
```

üìå **–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é –≤—Å—Ç–∞–≤–∫—É**

```plpgsql
BEGIN
    INSERT INTO orders (user_id, amount) VALUES (10, 100);
    RAISE NOTICE '–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ (user_id: 10, —Å—É–º–º–∞: 100)';
END;
```

üìå **–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö**

```plpgsql
BEGIN
    UPDATE users SET status = 'active' WHERE id = 5;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: % - %', SQLSTATE, SQLERRM;
END;
```

---

## **–í—ã–≤–æ–¥—ã**

‚úÖ **`GET DIAGNOSTICS ROW_COUNT`** –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–∑–Ω–∞—Ç—å, —Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ.  
‚úÖ **`FOUND`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —É—Å–ø–µ—à–Ω–æ –ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω `SELECT`, `INSERT`, `UPDATE`, `DELETE`.  
‚úÖ **`SQLSTATE` –∏ `SQLERRM`** –ø–æ–∑–≤–æ–ª—è—é—Ç –æ—Ç–ª–∞–≤–ª–∏–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏—Ö.  
‚úÖ **–ü—Ä–∏ `SELECT INTO` –≤–∞–∂–Ω–æ –∏–∑–±–µ–≥–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏–π, –∫–æ–≥–¥–∞ –∑–∞–ø—Ä–æ—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–æ–ª–µ–µ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏.**  
‚úÖ **–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏**:

- –ü—Ä–æ–≤–µ—Ä—è—Ç—å `FOUND` –ø–æ—Å–ª–µ `UPDATE`, `DELETE`, `SELECT`.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `EXCEPTION` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `COALESCE` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å `NULL`.

---

–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –∑–∞–ø—Ä–æ—Å–∏—Ç—å **—Å–µ–¥—å–º—É—é —á–∞—Å—Ç—å**, –∏ —è —Ä–∞—Å—Å–∫–∞–∂—É, –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (`RETURNS TABLE`) –∏ —Ä–∞–±–æ—Ç–∞—Ç—å —Å `RETURN QUERY` –≤ PL/pgSQL. üöÄ