### **–ß–∞—Å—Ç—å 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SQL –≤ PL/pgSQL**

PL/pgSQL –ø–æ–∑–≤–æ–ª—è–µ—Ç **–Ω–∞–ø—Ä—è–º—É—é** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã –≤ –∫–æ–¥–µ, –∫–æ–º–±–∏–Ω–∏—Ä—É—è –∏—Ö —Å –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–π –ª–æ–≥–∏–∫–æ–π. –í —ç—Ç–æ–π —á–∞—Å—Ç–∏ —Ä–∞–∑–±–∏—Ä–∞—é—Ç—Å—è:

- **–ö–∞–∫ SQL-–∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤–Ω—É—Ç—Ä–∏ PL/pgSQL**
- **–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã** –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- **–ö–∞–∫–∏–µ SQL-–∫–æ–º–∞–Ω–¥—ã –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ SQL –≤–Ω—É—Ç—Ä–∏ PL/pgSQL**

---

## **1. –ö–∞–∫ SQL-–∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ PL/pgSQL**

PL/pgSQL –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã **–±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ API**, –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤–ª—è—è –∏—Ö –≤ –∫–æ–¥, –Ω–∞–ø—Ä–∏–º–µ—Ä:

```plpgsql
DECLARE 
    user_count INT;
BEGIN
    SELECT COUNT(*) INTO user_count FROM users;
END;
```

–í —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ:

- `SELECT COUNT(*)` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –∫–∞–∫ –æ–±—ã—á–Ω—ã–π SQL-–∑–∞–ø—Ä–æ—Å.
- `INTO user_count` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é.
- –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—É—Ä—Å–æ—Ä—ã –∏–ª–∏ –¥—Ä—É–≥–∏–µ API-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏.

**–í–∞–∂–Ω–æ:**  
–í—Å–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –≤–Ω—É—Ç—Ä–∏ PL/pgSQL **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–º–ø–∏–ª–∏—Ä—É—é—Ç—Å—è –≤ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã (prepared statements)**.  
–≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ PostgreSQL **–Ω–µ –ø–∞—Ä—Å–∏—Ç –∏—Ö –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∑–∞–Ω–æ–≤–æ**, –∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é, —á—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

---

## **2. –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**

PostgreSQL –≤—Å–µ–≥–¥–∞ **–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã** (`prepared statements`) –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ PL/pgSQL.  
–≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è **–∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞**, –∞ –Ω–µ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ —Å—Ç—Ä–æ–∫—É.

–ü—Ä–∏–º–µ—Ä:

```plpgsql
DECLARE 
    user_id INT := 5;
    user_name TEXT;
BEGIN
    SELECT name INTO user_name FROM users WHERE id = user_id;
END;
```

–ó–¥–µ—Å—å:

- `user_id` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä, **–∞ –Ω–µ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ SQL-–∫–æ–¥**.
- PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω—è–µ—Ç –µ–≥–æ –Ω–∞ `?` –∏ **–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å**, —á—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π.

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:  
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äì –∑–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π.  
‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äì –∑–∞–ø—Ä–æ—Å –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.

---

## **3. –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ SQL-–∫–æ–º–∞–Ω–¥—ã**

–í PL/pgSQL –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ SQL-–∫–æ–º–∞–Ω–¥—ã**:

‚úÖ `SELECT` ‚Äì –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.  
‚úÖ `INSERT`, `UPDATE`, `DELETE` ‚Äì –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö.  
‚úÖ `EXECUTE` ‚Äì –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL-–∫–æ–¥–∞.  
‚úÖ `RETURNING` ‚Äì –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ `INSERT` –∏–ª–∏ `UPDATE`.

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `RETURNING`:

```plpgsql
DECLARE 
    new_user_id INT;
BEGIN
    INSERT INTO users (name, email) 
    VALUES ('John Doe', 'john@example.com')
    RETURNING id INTO new_user_id;
END;
```

–ó–¥–µ—Å—å:

- **–ü–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏** `INSERT` —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `id` –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –≠—Ç–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ, —á–µ–º `SELECT id FROM users WHERE email = 'john@example.com'`.

---

## **4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è SQL –≤ PL/pgSQL**

–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —à–∏—Ä–æ–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É SQL, –µ—Å—Ç—å **–Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π**:

üö´ **–ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã, —Ç–∞–∫–∏–µ –∫–∞–∫**:

- `VACUUM`
- `ANALYZE`
- `REINDEX`
- `CREATE INDEX`

üö´ **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏:**

- **–í —Ñ—É–Ω–∫—Ü–∏—è—Ö –Ω–µ–ª—å–∑—è –≤—ã–ø–æ–ª–Ω—è—Ç—å `COMMIT` –∏ `ROLLBACK`.**
- **–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `COMMIT` –∏ `ROLLBACK` —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö (`PROCEDURE`).**

```plpgsql
CREATE FUNCTION test_function() RETURNS VOID AS $$
BEGIN
    COMMIT;  -- –û–®–ò–ë–ö–ê! –í —Ñ—É–Ω–∫—Ü–∏—è—Ö –Ω–µ–ª—å–∑—è —É–ø—Ä–∞–≤–ª—è—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
END;
$$ LANGUAGE plpgsql;
```

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏, **–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã (`PROCEDURE`) –≤–º–µ—Å—Ç–æ —Ñ—É–Ω–∫—Ü–∏–π**:

```plpgsql
CREATE PROCEDURE test_procedure() AS $$
BEGIN
    INSERT INTO users (name) VALUES ('Test User');
    COMMIT;  -- –ó–¥–µ—Å—å —ç—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
END;
$$ LANGUAGE plpgsql;
```

üö´ **–ó–∞–ø—Ä–æ—Å—ã, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫, –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å `SELECT INTO`**

```plpgsql
DECLARE 
    user_name TEXT;
BEGIN
    SELECT name INTO user_name FROM users;  -- –û–®–ò–ë–ö–ê, –µ—Å–ª–∏ –≤–µ—Ä–Ω–µ—Ç—Å—è >1 —Å—Ç—Ä–æ–∫–∏
END;
```

**–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫**, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `RETURN QUERY` –∏–ª–∏ **—Ü–∏–∫–ª —Å –∫—É—Ä—Å–æ—Ä–æ–º**.

---

### **–í—ã–≤–æ–¥—ã**

1Ô∏è‚É£ –í PL/pgSQL –º–æ–∂–Ω–æ **–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã –Ω–∞–ø—Ä—è–º—É—é**.  
2Ô∏è‚É£ PostgreSQL **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã**, —á—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –∏ –±—ã—Å—Ç—Ä–µ–µ.  
3Ô∏è‚É£ –ú–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å **–≤—Å–µ DML-–∫–æ–º–∞–Ω–¥—ã (SELECT, INSERT, UPDATE, DELETE)**.  
4Ô∏è‚É£ **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**: –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `VACUUM`, `ANALYZE`, `COMMIT`/`ROLLBACK` –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö.

---

–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –∑–∞–ø—Ä–æ—Å–∏—Ç—å **—Ç—Ä–µ—Ç—å—é —á–∞—Å—Ç—å**, –∏ —è –ø—Ä–æ–¥–æ–ª–∂—É –¥–µ—Ç–∞–ª—å–Ω–æ —Ä–∞–∑–±–∏—Ä–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –≤ PL/pgSQL. üöÄ