### **–ß–∞—Å—Ç—å 7: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –≤ PL/pgSQL**

–í —ç—Ç–æ–π —á–∞—Å—Ç–∏ —Ä–∞–∑–±–∏—Ä–∞—é—Ç—Å—è:

- **–ß—Ç–æ —Ç–∞–∫–æ–µ —Ç–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∑–∞—á–µ–º –æ–Ω–∏ –Ω—É–∂–Ω—ã**
- **–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `RETURNS TABLE` –∏ `RETURNS SETOF`**
- **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `RETURN NEXT` –∏ `RETURN QUERY`**
- **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –≤–Ω—É—Ç—Ä–∏ —Ç–∞–±–ª–∏—á–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏**
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã —Ç–∞–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π**

---

## **1. –ß—Ç–æ —Ç–∞–∫–æ–µ —Ç–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ PL/pgSQL?**

–¢–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ **–≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –Ω–µ –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ, –∞ –Ω–∞–±–æ—Ä —Å—Ç—Ä–æ–∫**.  
–û–Ω–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç:  
‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≤ `SELECT`, –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã.  
‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏.  
‚úÖ –£–ø—Ä–æ—â–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –≤—ã–±–æ—Ä–∫–∏, –∑–∞–º–µ–Ω—è—è –≥—Ä–æ–º–æ–∑–¥–∫–∏–µ `JOIN`.

üìå **–ü—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä —Ç–∞–±–ª–∏—á–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏**

```plpgsql
CREATE FUNCTION get_active_users() RETURNS TABLE(id INT, name TEXT) AS $$
BEGIN
    RETURN QUERY SELECT id, name FROM users WHERE status = 'active';
END;
$$ LANGUAGE plpgsql;
```

üìå **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ `SELECT`**

```sql
SELECT * FROM get_active_users();
```

–§—É–Ω–∫—Ü–∏—è –≤–µ–¥–µ—Ç —Å–µ–±—è –∫–∞–∫ —Ç–∞–±–ª–∏—Ü–∞, –Ω–æ –¥–∞–Ω–Ω—ã–µ **–≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏**.

---

## **2. –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `RETURNS TABLE` –∏ `RETURNS SETOF`**

PostgreSQL –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Å–ø–æ—Å–æ–±–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:  
1Ô∏è‚É£ `RETURNS TABLE(...)` ‚Äì –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ —Å—Ç–æ–ª–±—Ü–∞–º–∏.  
2Ô∏è‚É£ `RETURNS SETOF RECORD` ‚Äì –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ **–±–µ–∑ –∂–µ—Å—Ç–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã**.

üìå **–ü—Ä–∏–º–µ—Ä `RETURNS TABLE`**

```plpgsql
CREATE FUNCTION get_books() RETURNS TABLE(id INT, title TEXT) AS $$
BEGIN
    RETURN QUERY SELECT id, title FROM books;
END;
$$ LANGUAGE plpgsql;
```

üìå **–ü—Ä–∏–º–µ—Ä `RETURNS SETOF RECORD`**

```plpgsql
CREATE FUNCTION get_books_dynamic() RETURNS SETOF RECORD AS $$
BEGIN
    RETURN QUERY EXECUTE 'SELECT id, title FROM books';
END;
$$ LANGUAGE plpgsql;
```

üìå **–†–∞–∑–ª–∏—á–∏—è:**

|–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å|`RETURNS TABLE`|`RETURNS SETOF RECORD`|
|---|---|---|
|–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö|–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∂–µ—Å—Ç–∫–æ|–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è|
|–ù—É–∂–Ω–æ –ª–∏ —É–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–æ–ª–±—Ü—ã –≤ `SELECT`|–ù–µ—Ç|–î–∞ (`SELECT * FROM function() AS (col1 TYPE, col2 TYPE)`)|
|–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å|–ß—É—Ç—å –≤—ã—à–µ|–ß—É—Ç—å –Ω–∏–∂–µ (–∏–∑-–∑–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Ç–∏–ø–∞)|

üìå **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SETOF RECORD`?**

- –ö–æ–≥–¥–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏.
- –ö–æ–≥–¥–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏.

---

## **3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `RETURN NEXT` –∏ `RETURN QUERY`**

PostgreSQL –ø–æ–∑–≤–æ–ª—è–µ—Ç **–≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ** –∏–ª–∏ **—Å—Ä–∞–∑—É –≤–µ—Å—å –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö**.

üìå **–°–ø–æ—Å–æ–± 1: `RETURN QUERY` (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ä–∞–∑—É –≤–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞)**

```plpgsql
CREATE FUNCTION get_high_sales() RETURNS TABLE(id INT, total NUMERIC) AS $$
BEGIN
    RETURN QUERY SELECT id, SUM(amount) FROM sales GROUP BY id HAVING SUM(amount) > 1000;
END;
$$ LANGUAGE plpgsql;
```

üìå **–°–ø–æ—Å–æ–± 2: `RETURN NEXT` (–ø–æ—Å—Ç—Ä–æ—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –¥–∞–Ω–Ω—ã—Ö)**

```plpgsql
CREATE FUNCTION generate_series_example(start INT, stop INT) RETURNS TABLE(num INT) AS $$
DECLARE 
    i INT;
BEGIN
    FOR i IN start..stop LOOP
        RETURN NEXT i;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

üìå **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```sql
SELECT * FROM generate_series_example(1, 5);
```

üìå **–†–µ–∑—É–ª—å—Ç–∞—Ç:**

```
 num  
-----
  1
  2
  3
  4
  5
```

üìå **–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `RETURN NEXT` –∏ `RETURN QUERY`**

|–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å|`RETURN NEXT`|`RETURN QUERY`|
|---|---|---|
|–ö–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ|–ü–æ—Å—Ç—Ä–æ—á–Ω–æ, –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è|–í—Å–µ —Å—Ä–∞–∑—É, –≤ –∫–æ–Ω—Ü–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è|
|–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å|–¶–∏–∫–ª–∞–º–∏ (`FOR`, `LOOP`)|`SELECT`, `EXECUTE`|
|–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å|–ú–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ –≥–∏–±—á–µ|–ë—ã—Å—Ç—Ä–µ–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö|

---

## **4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö**

–§—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç **–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –±–µ–∑ —Ç–∞–±–ª–∏—Ü**.

üìå **–ü—Ä–∏–º–µ—Ä –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏:**

```plpgsql
CREATE FUNCTION get_weekdays() RETURNS TABLE(day_name TEXT) AS $$
BEGIN
    RETURN NEXT 'Monday';
    RETURN NEXT 'Tuesday';
    RETURN NEXT 'Wednesday';
    RETURN NEXT 'Thursday';
    RETURN NEXT 'Friday';
END;
$$ LANGUAGE plpgsql;
```

üìå **–ü—Ä–∏–º–µ—Ä —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è–º–∏:**

```plpgsql
CREATE FUNCTION fibonacci(n INT) RETURNS TABLE(fib_num INT) AS $$
DECLARE 
    a INT := 0;
    b INT := 1;
    temp INT;
BEGIN
    RETURN NEXT a;
    RETURN NEXT b;

    FOR i IN 3..n LOOP
        temp := a + b;
        a := b;
        b := temp;
        RETURN NEXT temp;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

üìå **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```sql
SELECT * FROM fibonacci(10);
```

üìå **–†–µ–∑—É–ª—å—Ç–∞—Ç:**

```
 fib_num 
---------
  0
  1
  1
  2
  3
  5
  8
  13
  21
  34
```

---

## **5. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–∞–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π**

üö´ **–¢–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é**

- PostgreSQL **—Å–Ω–∞—á–∞–ª–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –≤–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç**, –∞ –∑–∞—Ç–µ–º –ø–µ—Ä–µ–¥–∞–µ—Ç –µ–≥–æ –∫–ª–∏–µ–Ω—Ç—É.
- –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è **–æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö**.

‚úÖ **–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `LIMIT`, —á—Ç–æ–±—ã —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö —Å—Ç—Ä–æ–∫**

```plpgsql
CREATE FUNCTION get_top_books() RETURNS TABLE(id INT, title TEXT) AS $$
BEGIN
    RETURN QUERY SELECT id, title FROM books ORDER BY rating DESC LIMIT 10;
END;
$$ LANGUAGE plpgsql;
```

üö´ **–ù–µ–ª—å–∑—è –≤—ã–ø–æ–ª–Ω—è—Ç—å `COMMIT` –∏ `ROLLBACK` –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π**

- –§—É–Ω–∫—Ü–∏–∏ **–≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**.
- –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ ‚Äì **–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `PROCEDURE` –≤–º–µ—Å—Ç–æ `FUNCTION`**.

‚úÖ **–§—É–Ω–∫—Ü–∏–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ `JOIN` –∏ `CROSS JOIN`**

```sql
SELECT * FROM users CROSS JOIN get_weekdays();
```

---

## **–í—ã–≤–æ–¥—ã**

‚úÖ **–¢–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –Ω–∞–±–æ—Ä—ã —Å—Ç—Ä–æ–∫ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –≤ `SELECT`.**  
‚úÖ **–î–≤–∞ —Ç–∏–ø–∞ —Ñ—É–Ω–∫—Ü–∏–π:** `RETURNS TABLE` (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞) –∏ `RETURNS SETOF RECORD` (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞).  
‚úÖ **–î–≤–∞ —Å–ø–æ—Å–æ–±–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö:** `RETURN QUERY` (–≤—Å–µ —Å—Ä–∞–∑—É) –∏ `RETURN NEXT` (–ø–æ—Å—Ç—Ä–æ—á–Ω–æ).  
‚úÖ **–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ü–∏–∫–ª—ã (`FOR`, `LOOP`) –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö.**  
‚úÖ **–¢–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ (`COMMIT`, `ROLLBACK`).**

---

–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –∑–∞–ø—Ä–æ—Å–∏—Ç—å **–≤–æ—Å—å–º—É—é —á–∞—Å—Ç—å**, –∏ —è —Ä–∞—Å—Å–∫–∞–∂—É –ø—Ä–æ **–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö**. üöÄ