### **–ß–∞—Å—Ç—å 8: –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –≤ PL/pgSQL**

–í —ç—Ç–æ–π —á–∞—Å—Ç–∏ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è:

- **–ö–∞–∫ —Ç–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–º–æ–≥–∞—é—Ç —É–ø—Ä–æ—Å—Ç–∏—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**
- **–ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–æ–≤**
- **–ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–∫—É–ø–æ–∫ –∫–Ω–∏–≥**
- **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ –∏–≥—Ä—ã "–£–≥–∞–¥–∞–π –∂–∏–≤–æ—Ç–Ω–æ–µ" —Å –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π –≤ PostgreSQL**

---

## **1. –ö–∞–∫ —Ç–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–æ—â–∞—é—Ç —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**

–¢–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–ª–µ–∑–Ω—ã, –∫–æ–≥–¥–∞:  
‚úÖ –ù—É–∂–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª—è—Ç—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.  
‚úÖ SQL-–∑–∞–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã–π, –∏ –µ–≥–æ –Ω—É–∂–Ω–æ —Ä–∞–∑–±–∏—Ç—å –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —á–∞—Å—Ç–∏.  
‚úÖ –•–æ—Ç–∏—Ç–µ –∏–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏).  
‚úÖ –ù—É–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö.

üìå **–ü—Ä–∏–º–µ—Ä: –±–µ–∑ —Ç–∞–±–ª–∏—á–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏**

```sql
SELECT id, name 
FROM users 
WHERE last_login > now() - INTERVAL '1 month' 
AND status = 'active' 
AND email_verified = TRUE;
```

üìå **–° —Ç–∞–±–ª–∏—á–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π**

```plpgsql
CREATE FUNCTION get_recent_active_users() RETURNS TABLE(id INT, name TEXT) AS $$
BEGIN
    RETURN QUERY 
    SELECT id, name 
    FROM users 
    WHERE last_login > now() - INTERVAL '1 month'
    AND status = 'active' 
    AND email_verified = TRUE;
END;
$$ LANGUAGE plpgsql;
```

–¢–µ–ø–µ—Ä—å —ç—Ç–æ—Ç –∫–æ–¥ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

```sql
SELECT * FROM get_recent_active_users();
```

---

## **2. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–æ–≤**

üìå **–ó–∞–¥–∞—á–∞:** –ù–∞–ø–∏—Å–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–≥–æ –∞–≤—Ç–æ—Ä–∞ –≤ —Ç–∞–±–ª–∏—Ü—É `authors` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ `id`.

```plpgsql
CREATE FUNCTION add_author(first_name TEXT, last_name TEXT) RETURNS INT AS $$
DECLARE 
    new_author_id INT;
BEGIN
    INSERT INTO authors (first_name, last_name) 
    VALUES (first_name, last_name)
    RETURNING id INTO new_author_id;

    RETURN new_author_id;
END;
$$ LANGUAGE plpgsql;
```

üìå **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```sql
SELECT add_author('Leo', 'Tolstoy');
```

‚úÖ –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –µ–≥–æ `id`.  
‚úÖ –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥—É–±–ª–∏–∫–∞—Ç), –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∏—Å–∫–ª—é—á–µ–Ω–∏–π (`EXCEPTION`).

---

## **3. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–∫—É–ø–∫–∏ –∫–Ω–∏–≥–∏**

üìå **–ó–∞–¥–∞—á–∞:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è —É–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –∫–Ω–∏–≥–∏ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ.

```plpgsql
CREATE FUNCTION buy_book(book_id INT) RETURNS BOOLEAN AS $$
DECLARE 
    stock_count INT;
BEGIN
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–Ω–∏–≥–∞ –≤ –Ω–∞–ª–∏—á–∏–∏
    SELECT stock INTO stock_count FROM books WHERE id = book_id;
    
    IF stock_count IS NULL THEN
        RAISE NOTICE '–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!';
        RETURN FALSE;
    END IF;
    
    IF stock_count = 0 THEN
        RAISE NOTICE '–ö–Ω–∏–≥–∏ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏!';
        RETURN FALSE;
    END IF;

    -- –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
    UPDATE books SET stock = stock - 1 WHERE id = book_id;

    RETURN TRUE;
END;
$$ LANGUAGE plpgsql;
```

üìå **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```sql
SELECT buy_book(10);
```

‚úÖ –ï—Å–ª–∏ –∫–Ω–∏–≥–∞ –∫—É–ø–ª–µ–Ω–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `TRUE`.  
‚úÖ –ï—Å–ª–∏ –∫–Ω–∏–≥–∏ –Ω–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ ‚Äì –≤—ã–≤–æ–¥–∏—Ç—Å—è `NOTICE` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `FALSE`.

---

## **4. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ –∏–≥—Ä—ã "–£–≥–∞–¥–∞–π –∂–∏–≤–æ—Ç–Ω–æ–µ" –≤ PL/pgSQL**

üìå **–ó–∞–¥–∞—á–∞:** –ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –∏–≥—Ä—ã **"–£–≥–∞–¥–∞–π –∂–∏–≤–æ—Ç–Ω–æ–µ"**, –∏—Å–ø–æ–ª—å–∑—É—è –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

üìå **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π**

```sql
CREATE TABLE animals (
    id SERIAL PRIMARY KEY,
    question TEXT,      -- –í–æ–ø—Ä–æ—Å –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–£ –Ω–µ–≥–æ –µ—Å—Ç—å —à–µ—Ä—Å—Ç—å?")
    yes_answer INT,     -- ID —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞/–æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏ "–î–ê"
    no_answer INT       -- ID —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞/–æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏ "–ù–ï–¢"
);
```

üìå **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**

```sql
INSERT INTO animals (question, yes_answer, no_answer) VALUES 
('–£ –Ω–µ–≥–æ –µ—Å—Ç—å —à–µ—Ä—Å—Ç—å?', 2, 3),  -- –í–æ–ø—Ä–æ—Å 1
('–≠—Ç–æ –∫–æ—à–∫–∞?', NULL, NULL),     -- –í–æ–ø—Ä–æ—Å 2 (–æ—Ç–≤–µ—Ç "–î–ê")
('–≠—Ç–æ –∑–º–µ—è?', NULL, NULL);      -- –í–æ–ø—Ä–æ—Å 3 (–æ—Ç–≤–µ—Ç "–ù–ï–¢")
```

üìå **–§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ—Ç–≤–µ—Ç–∞ –≤ –∏–≥—Ä–µ**

```plpgsql
CREATE FUNCTION guess_animal(start_id INT) RETURNS TEXT AS $$
DECLARE 
    current_id INT := start_id;
    question_text TEXT;
    user_answer TEXT;
BEGIN
    LOOP
        -- –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å
        SELECT question INTO question_text FROM animals WHERE id = current_id;

        -- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π, –∑–Ω–∞—á–∏—Ç, —ç—Ç–æ –æ—Ç–≤–µ—Ç
        IF question_text IS NULL THEN
            RETURN '–û—Ç–≤–µ—Ç –Ω–∞–π–¥–µ–Ω!';
        END IF;

        -- –í—ã–≤–æ–¥–∏–º –≤–æ–ø—Ä–æ—Å
        RAISE NOTICE '% (–¥–∞/–Ω–µ—Ç):', question_text;
        
        -- –û–∂–∏–¥–∞–µ–º –≤–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ frontend)
        user_answer := '–¥–∞';  -- –ó–¥–µ—Å—å –∏–º–∏—Ç–∏—Ä—É–µ–º –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        -- –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π ID –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ç–≤–µ—Ç–∞
        IF user_answer = '–¥–∞' THEN
            SELECT yes_answer INTO current_id FROM animals WHERE id = current_id;
        ELSE
            SELECT no_answer INTO current_id FROM animals WHERE id = current_id;
        END IF;

        -- –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ NULL, –∑–Ω–∞—á–∏—Ç, –Ω–µ –Ω–∞—à–ª–∏ –æ—Ç–≤–µ—Ç
        IF current_id IS NULL THEN
            RETURN '–Ø –Ω–µ –∑–Ω–∞—é, –∫—Ç–æ —ç—Ç–æ!';
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

üìå **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```sql
SELECT guess_animal(1);
```

üìå **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?**

1. –ù–∞—á–∏–Ω–∞–µ–º —Å **–ø–µ—Ä–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞**: `"–£ –Ω–µ–≥–æ –µ—Å—Ç—å —à–µ—Ä—Å—Ç—å?"`
2. –ï—Å–ª–∏ `–¥–∞` ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ **"–≠—Ç–æ –∫–æ—à–∫–∞?"`**
3. –ï—Å–ª–∏ `–Ω–µ—Ç` ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ **"–≠—Ç–æ –∑–º–µ—è?"`**
4. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞–π–¥–µ–Ω, –æ–Ω –≤—ã–≤–æ–¥–∏—Ç—Å—è. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äì –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `"–Ø –Ω–µ –∑–Ω–∞—é, –∫—Ç–æ —ç—Ç–æ!"`.

‚úÖ –§—É–Ω–∫—Ü–∏—é –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å, –¥–æ–±–∞–≤–ª—è—è –Ω–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –≤ —Ç–∞–±–ª–∏—Ü—É `animals`.

---

## **–í—ã–≤–æ–¥—ã**

‚úÖ **–¢–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—É—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –≤–Ω—É—Ç—Ä–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.**  
‚úÖ **–§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Ç–æ–≤–∞—Ä–∞–º–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã.**  
‚úÖ **–ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ "–£–≥–∞–¥–∞–π –∂–∏–≤–æ—Ç–Ω–æ–µ" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PostgreSQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.**  
‚úÖ **–¢–∞–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö, —Å–æ–∫—Ä–∞—â–∞—è –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ API.**

---

–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –∑–∞–ø—Ä–æ—Å–∏—Ç—å **–¥–µ–≤—è—Ç—É—é —á–∞—Å—Ç—å**, –∏ —è —Ä–∞—Å—Å–∫–∞–∂—É –æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞–Ω–∏—è—Ö –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è PL/pgSQL. üöÄ