# Глава 15. Обработка ошибок

## Содержание

- [[1. Введение в обработку ошибок]] [1. Введение в обработку ошибок](../полный/15. Обработка ошибок/1. Введение в обработку ошибок.md)
- [[2. Типы ошибок и их классификация]] [2. Типы ошибок и их классификация](../полный/15. Обработка ошибок/2. Типы ошибок и их классификация.md)
- [[3. Блоки обработки ошибок (EXCEPTION)]] [3. Блоки обработки ошибок (EXCEPTION)](../полный/15. Обработка ошибок/3. Блоки обработки ошибок (EXCEPTION).md)
- [[4. Обработка конкретных типов ошибок]] [4. Обработка конкретных типов ошибок](../полный/15. Обработка ошибок/4. Обработка конкретных типов ошибок.md)
- [[5. Логирование ошибок]] [5. Логирование ошибок](../полный/15. Обработка ошибок/5. Логирование ошибок.md)
- [[6. Практические примеры]] [6. Практические примеры](../полный/15. Обработка ошибок/6. Практические примеры.md)

---

## Введение в обработку ошибок

Обработка ошибок в PL/pgSQL — это важнейший аспект написания надежного кода для PostgreSQL. Она позволяет контролировать выполнение программы при возникновении исключительных ситуаций и предотвращать некорректное завершение работы.

Основные причины использования обработки ошибок: предотвращение аварийного завершения программы, корректная обработка сценариев с ошибками, логирование проблем для последующего анализа и управление транзакциями и поддержание целостности данных.

## Типы ошибок и их классификация

Ошибки в PostgreSQL имеют структурированную систему классификации: имя ошибки (например, `no_data_found`), код ошибки (5-значный SQLSTATE) и текстовое описание.

Код ошибки состоит из двух частей: первые 2 символа — категория ошибки, последние 3 символа — конкретная ошибка. Если последние три символа "000" — это код категории.

Примеры распространенных ошибок: `no_data_found` (P0002) — данные не найдены, `division_by_zero` (22012) — деление на ноль, `unique_violation` (23505) — нарушение уникальности, `transaction_rollback` (40001) — откат транзакции.

## Блоки обработки ошибок (EXCEPTION)

Механизм обработки ошибок работает следующим образом: при входе в блок BEGIN создается точка сохранения (SAVEPOINT), если возникает ошибка — отменяются все изменения в текущем блоке и ищется подходящий обработчик в секции EXCEPTION, обработчики проверяются сверху вниз, если обработчик найден — выполняется его код, если нет — ошибка передается на уровень выше.

Использование EXCEPTION имеет накладные расходы: создание SAVEPOINT даже без ошибок замедляет выполнение, при ошибке требуется время на откат. Поэтому иногда лучше использовать альтернативные методы проверки: CASE/COALESCE/NULLIF для проверок перед выполнением, INSERT ON CONFLICT вместо перехвата unique_violation, SELECT FOR UPDATE NOWAIT вместо обработки блокировок.

**Подробнее:** [[15. Обработка ошибок]] [15. Обработка ошибок](../полный/15. Обработка ошибок/резюме.md)

