# Глава 4. Логическая структура данных

## Содержание

- [[1. Введение]] [1. Введение](../полный/4. Логическая структура данных/1. Введение.md)
- [[2. Кластер баз данных и шаблонные базы]] [2. Кластер баз данных и шаблонные базы](../полный/4. Логическая структура данных/2. Кластер баз данных и шаблонные базы.md)
- [[3. Структура базы данных. схемы]] [3. Структура базы данных. схемы](../полный/4. Логическая структура данных/3. Структура базы данных. схемы.md)
- [[4. Специальные схемы]] [4. Специальные схемы](../полный/4. Логическая структура данных/4. Специальные схемы.md)
- [[5. Путь поиска (search_path)]] [5. Путь поиска (search_path)](../полный/4. Логическая структура данных/5. Путь поиска (search_path).md)
- [[6. Системный каталог]] [6. Системный каталог](../полный/4. Логическая структура данных/6. Системный каталог.md)
- [[7. Удаление объектов и схем]] [7. Удаление объектов и схем](../полный/4. Логическая структура данных/7. Удаление объектов и схем.md)

---

## Введение в логическую организацию данных

PostgreSQL предоставляет два уровня организации данных: логический и физический. Логическая организация включает базы данных, схемы, таблицы, индексы и представления. Это то, с чем взаимодействует пользователь через SQL-запросы. Физическая организация определяет, где и как данные хранятся в файловой системе.

Основные понятия логической организации данных включают базы данных и их шаблоны (`template0` и `template1`), схемы в базах данных, включая предопределённые схемы (`public`, `pg_catalog`, `information_schema`), путь поиска (`search_path`) — механизм, который определяет, как СУБД ищет объекты внутри базы данных, и системный каталог (`pg_catalog`) — хранилище метаданных базы данных.

## Кластер баз данных и шаблонные базы

Кластер баз данных — это группа баз данных, управляемых одним экземпляром сервера PostgreSQL. При инициализации кластера автоматически создаются три базы данных: `postgres` (стандартная база данных для работы с сервером), `template0` (чистый шаблон, который всегда остаётся неизменным) и `template1` (основной шаблон, из которого по умолчанию создаются новые базы данных).

Шаблонные базы данных играют важную роль при создании новых баз данных. `template1`: все новые базы данных создаются путём копирования `template1`. Его можно модифицировать, добавляя объекты (например, расширения, схемы, таблицы). Если добавить нужные настройки в `template1`, они автоматически появятся во всех новых базах. `template0`: это чистая база данных, которую нельзя изменять. Она используется, когда нужно создать базу данных с другой кодировкой или пустую базу для восстановления из бэкапа (`pg_restore`).

Число баз данных в PostgreSQL не ограничено. Решение о количестве баз зависит от архитектуры приложения: одна база на проект, разные базы для разных окружений (разработка, тест, продакшен), отдельные базы для разных клиентов (multi-tenant архитектура).

## Структура базы данных: схемы

Схема — это логическое пространство, в котором хранятся объекты базы данных (таблицы, представления, функции и т. д.). Схемы помогают разделять объекты внутри одной базы данных, избегая конфликтов.

Зачем нужны схемы: избегать конфликтов имён (разные приложения или команды могут создать таблицы с одинаковыми именами в разных схемах), гибкость организации (можно разделять бизнес-логические модули по схемам), безопасность и доступ (можно назначать права доступа для разных схем) и упрощение разработки (легко переносить объекты между схемами и изолировать разные версии приложения в одной базе).

В PostgreSQL схемы и пользователи — разные сущности. В некоторых других СУБД (например, Oracle) схема = пользователь.

## Специальные схемы в PostgreSQL

PostgreSQL создаёт несколько специальных схем автоматически при инициализации базы данных. `public` — схема по умолчанию, создаётся в каждой базе данных. Если не указывать схему при создании объектов, они помещаются в `public`. Все пользователи имеют права на создание объектов в `public`.

`pg_catalog` — системный каталог PostgreSQL, главная системная схема, содержащая служебные таблицы, описание всех объектов в базе, стандартные SQL-функции и встроенные типы данных. Включена в `search_path` по умолчанию.

`information_schema` — стандартный SQL-каталог, содержит метаданные о таблицах, схемах, колонках и т. д. Полностью соответствует стандарту SQL.

`pg_temp` — схема для временных объектов, используется для хранения временных таблиц. Создаётся автоматически в каждом сеансе при создании временных объектов. Удаляется при завершении сеанса.

Другие служебные схемы: `pg_toast` (хранит "раздутые" данные `TEXT`, `BYTEA`, `JSONB`) и `pg_statistic` (хранит статистику о данных, которая используется оптимизатором запросов).

## Путь поиска (search_path)

`search_path` — это список схем, которые PostgreSQL просматривает в определённом порядке при поиске объектов. Когда мы выполняем запрос без явного указания схемы, система ищет объект в первой найденной схеме из `search_path`.

Алгоритм поиска: проверяет, указано ли полное имя (`схема.объект`), перебирает схемы в порядке из `search_path`, если объект не найден в указанных схемах — выдаёт ошибку.

Настройка `search_path`: временно изменить в текущем сеансе (`SET search_path TO my_schema, public;`), постоянно изменить для пользователя (`ALTER ROLE my_user SET search_path TO my_schema, public;`), установить для всей базы данных (`ALTER DATABASE my_db SET search_path TO my_schema, public;`).

## Системный каталог PostgreSQL (pg_catalog)

Системный каталог PostgreSQL (`pg_catalog`) — это встроенная схема, в которой хранятся метаданные о всех объектах базы данных. Основные таблицы: `pg_database` (список баз данных), `pg_namespace` (список схем), `pg_class` (информация о таблицах, индексах, представлениях), `pg_attribute` (информация о столбцах таблиц), `pg_proc` (список функций), `pg_index` (информация об индексах), `pg_statistic` (статистика для оптимизатора запросов).

## Удаление объектов и схем

Удаление объектов в PostgreSQL имеет свои особенности: прямое удаление запрещено, если у объекта есть зависимости, можно удалять с каскадным удалением (`CASCADE`), нельзя удалить базу данных с активными подключениями.

**Подробнее:** [[4. Логическая структура данных]] [4. Логическая структура данных](../полный/4. Логическая структура данных/резюме.md)

