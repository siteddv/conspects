# Глава 2. Изоляция и многоверсионность

## Содержание

- [[1. Введение в проблему многоверсионности и изоляции транзакций]] [1. Введение в проблему многоверсионности и изоляции транзакций](../полный/2. Изоляция и многоверсионность/1. Введение в проблему многоверсионности и изоляции транзакций.md)
- [[2. Как работает механизм многоверсионности (MVCC)]] [2. Как работает механизм многоверсионности (MVCC)](../полный/2. Изоляция и многоверсионность/2. Как работает механизм многоверсионности (MVCC).md)
- [[3. Снимки данных и согласованность]] [3. Снимки данных и согласованность](../полный/2. Изоляция и многоверсионность/3. Снимки данных и согласованность.md)
- [[4. Уровни изоляции транзакций]] [4. Уровни изоляции транзакций](../полный/2. Изоляция и многоверсионность/4. Уровни изоляции транзакций.md)
- [[5. Примеры работы с транзакциями в PostgreSQL]] [5. Примеры работы с транзакциями в PostgreSQL](../полный/2. Изоляция и многоверсионность/5. Примеры работы с транзакциями в PostgreSQL.md)
- [[6. Блокировки и их влияние на производительность]] [6. Блокировки и их влияние на производительность](../полный/2. Изоляция и многоверсионность/6. Блокировки и их влияние на производительность.md)
- [[7. Очистка старых версий данных и процесс VACUUM]] [7. Очистка старых версий данных и процесс VACUUM](../полный/2. Изоляция и многоверсионность/7. Очистка старых версий данных и процесс VACUUM.md)

---

## Проблема параллельного доступа к данным

Когда несколько транзакций работают с одной и той же базой данных, возникают ситуации, которые могут привести к несогласованности данных: две транзакции читают одну и ту же строку, одна транзакция читает строку, а другая пытается её изменить, обе транзакции пытаются изменить одну и ту же строку.

Для решения этой проблемы существуют два простых подхода: полная блокировка (первая транзакция блокирует строку, пока не завершится, что гарантирует согласованность, но снижает производительность) и разрешение чтения незавершенных изменений (читающая транзакция видит изменения, сделанные другой транзакцией, даже если они ещё не зафиксированы, что увеличивает производительность, но может привести к чтению несогласованных данных). Оба этих подхода имеют недостатки, поэтому PostgreSQL использует более сложный механизм — многоверсионность (MVCC).

## Как работает MVCC

В отличие от традиционных СУБД, которые перезаписывают данные в одной и той же строке, PostgreSQL хранит несколько версий одной строки. Это позволяет транзакциям читать данные без блокировки, видеть разные версии строки в зависимости от момента начала транзакции и гарантировать согласованность данных без потери производительности.

При выполнении `INSERT` создается новая строка с уникальным номером транзакции. При выполнении `UPDATE` PostgreSQL создает новую версию строки, а старая остается в истории. При выполнении `DELETE` строка не удаляется сразу, а становится невидимой для новых транзакций.

Каждая версия строки в PostgreSQL хранит два специальных параметра: `xmin` (номер транзакции, которая создала эту версию строки) и `xmax` (номер транзакции, которая сделала строку невидимой). Операция `UPDATE` фактически является комбинацией `DELETE + INSERT`: создается новая версия строки, а старая версия остается в истории, но становится невидимой для новых транзакций. Операция `DELETE` не уничтожает строку сразу, а просто делает её невидимой для будущих транзакций, изменяя `xmax`.

## Снимки данных и согласованность

Чтобы обеспечить согласованность данных, PostgreSQL использует механизм снимков данных (Snapshot). Это логический срез базы данных на момент начала транзакции. Снимок данных создается при начале транзакции и состоит из номера текущей транзакции, списка активных транзакций, которые начались, но ещё не завершились, и диапазона видимых `xmin` и `xmax`.

При построении снимка система отбрасывает невидимые версии строк, используя `xmin` и `xmax`. Каждая транзакция видит только те версии строк, которые соответствуют правилам видимости на момент её начала.

## Уровни изоляции транзакций

Стандарт SQL определяет четыре уровня изоляции: Read Uncommitted (минимальная изоляция, не используется в PostgreSQL), Read Committed (по умолчанию, видны только зафиксированные данные, возможны фантомные строки и неповторяющееся чтение), Repeatable Read (все `SELECT` в рамках одной транзакции видят один и тот же снимок данных, возможны фантомные строки) и Serializable (полная изоляция, транзакции выполняются так, будто они идут по очереди).

Read Committed использует новый снимок данных для каждого чтения, поэтому два одинаковых `SELECT` могут дать разные результаты. Repeatable Read фиксирует снимок данных на момент начала транзакции, поэтому результаты `SELECT` всегда одинаковы. Serializable предотвращает любые конфликты, но может приводить к откатам (`ROLLBACK`).

## Блокировки и их влияние на производительность

PostgreSQL использует разные уровни блокировок: Row-Level Lock (блокирует только изменяемые строки), Table-Level Lock (блокирует всю таблицу) и Exclusive Lock (полный эксклюзивный доступ). MVCC снижает блокировки: чтение (`SELECT`) не блокирует других пользователей, даже если кто-то обновляет данные (`UPDATE`), другие пользователи могут продолжать чтение, так как система возвращает старую версию строки из снимка данных.

## Очистка старых версий данных (VACUUM)

Из-за механизма MVCC старые версии строк остаются в файле таблицы, даже если они больше не нужны. Это приводит к разрастанию таблиц. Процесс `VACUUM` находит старые версии строк, которые больше не видны ни одной транзакции, помечает их как свободное место и обновляет служебную информацию о транзакциях.

Разница между `VACUUM` и `VACUUM FULL`: `VACUUM` удаляет старые версии строк, освобождая место внутри таблицы, но не уменьшает размер файла; `VACUUM FULL` полностью пересоздает таблицу, уменьшая её размер, но блокирует её. PostgreSQL имеет встроенный процесс автоматической очистки (`autovacuum`), который работает в фоновом режиме и сам выполняет `VACUUM`.

## Заключение

PostgreSQL использует мощные механизмы, такие как MVCC, уровни изоляции и автоматическую очистку данных, чтобы обеспечить высокую производительность и согласованность данных. Эти механизмы позволяют системе эффективно работать в условиях параллельного доступа к данным и предотвращать конфликты.

**Подробнее:** [[2. Изоляция и многоверсионность]] [2. Изоляция и многоверсионность](../полный/2. Изоляция и многоверсионность/резюме.md)

