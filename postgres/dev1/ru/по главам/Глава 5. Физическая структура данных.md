# Глава 5. Физическая структура данных

## Содержание

- [[1. Введение в физическую организацию данных в PostgreSQL]] [1. Введение в физическую организацию данных в PostgreSQL](../полный/5. Физическая структура данных/1. Введение в физическую организацию данных в PostgreSQL.md)
- [[2. Табличные пространства (Tablespaces)]] [2. Табличные пространства (Tablespaces)](../полный/5. Физическая структура данных/2. Табличные пространства (Tablespaces).md)
- [[3. Физическое расположение данных в файловой системе]] [3. Физическое расположение данных в файловой системе](../полный/5. Физическая структура данных/3. Физическое расположение данных в файловой системе.md)
- [[4. Страничная организация данных (8 KB Pages)]] [4. Страничная организация данных (8 KB Pages)](../полный/5. Физическая структура данных/4. Страничная организация данных (8 KB Pages).md)
- [[5. TOAST - хранение больших значений]] [5. TOAST - хранение больших значений](../полный/5. Физическая структура данных/5. TOAST - хранение больших значений.md)

---

## Введение в физическую организацию данных

PostgreSQL предоставляет два уровня организации данных: логический и физический. Логическая организация включает базы данных, схемы, таблицы, индексы и представления. Физическая организация определяет, где и как данные хранятся в файловой системе. Этот уровень важен для администраторов баз данных, так как он позволяет оптимизировать производительность и управление хранилищем.

Основной вопрос: где в файловой системе расположены наши данные? Физически данные PostgreSQL хранятся в каталогах на диске, внутри каталога данного кластера PostgreSQL (обычно `/var/lib/postgresql/data` или `/pgdata`), в подкаталогах, соответствующих различным базам данных и их объектам.

## Табличные пространства (Tablespaces)

Табличное пространство — это логическая сущность, которая указывает, в каком каталоге файловой системы хранятся объекты базы данных. Табличные пространства позволяют гибко управлять хранением данных (размещать данные на разных дисках, оптимизировать хранение с учётом скорости и стоимости дисков), разделять нагрузки (архивные данные на медленных HDD, "горячие" данные на быстрых SSD) и облегчать управление данными при миграции и обновлении PostgreSQL.

По умолчанию после инициализации кластера в PostgreSQL создаются два табличных пространства: `pg_global` (хранит глобальные объекты, которые относятся ко всему кластеру баз данных) и `pg_default` (основное табличное пространство, в котором размещаются объекты, если не указано другое).

## Физическое расположение данных в файловой системе

Данные в PostgreSQL организованы в несколько уровней: табличные пространства (указывают на каталог файловой системы), каталоги баз данных (для каждой базы данных создаётся каталог внутри соответствующего табличного пространства) и файлы таблиц и индексов (каждая таблица и индекс представляют собой набор файлов, расположенных в соответствующем каталоге).

В каталоге `base/` находятся файлы с таблицами и индексами по умолчанию. `pg_tblspc/` содержит символьные ссылки на внешние табличные пространства. Файл `pg_database` хранит информацию о базах данных.

## Страничная организация данных

В PostgreSQL каждый объект (таблица, индекс, материализованное представление и т. д.) разбивается на несколько слоев (forks), чтобы оптимизировать работу с диском: Main fork (основной файл данных, содержащий строки таблицы или индекса), Free Space Map (FSM) — карта свободного пространства, Visibility Map (VM) — карта видимости данных и TOAST — специальное хранилище для очень больших значений, если они не помещаются в стандартную страницу.

Страницы данных — основной строительный блок для хранения информации в PostgreSQL. Размер страницы по умолчанию составляет 8 КБ (8192 байта). Этот размер можно изменить только при сборке PostgreSQL из исходного кода (доступны варианты 16 КБ и 32 КБ).

## TOAST - хранение больших значений

TOAST (The Oversized-Attribute Storage Technique) — специальное хранилище для очень больших значений, если они не помещаются в стандартную страницу. TOAST автоматически сжимает и разбивает большие значения на части, храня их в отдельных таблицах. Это позволяет эффективно работать с большими текстовыми полями, JSONB и другими типами данных, которые могут превышать размер страницы.

**Подробнее:** [[5. Физическая структура данных]] [5. Физическая структура данных](../полный/5. Физическая структура данных/резюме.md)

