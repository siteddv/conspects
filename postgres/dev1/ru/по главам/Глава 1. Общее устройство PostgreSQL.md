# Глава 1. Общее устройство PostgreSQL

## Содержание

- [[1. Общий обзор Postgres и клиент-серверного взаимодействия]] [1. Общий обзор Postgres и клиент-серверного взаимодействия](../полный/1. Общее устройство PostgreSQL/1. Общий обзор Postgres и клиент-серверного взаимодействия.md)
- [[2. Транзакции в PostgreSQL]] [2. Транзакции в PostgreSQL](../полный/1. Общее устройство PostgreSQL/2. Транзакции в PostgreSQL.md)
- [[3. Обработка SQL-запросов в PostgreSQL]] [3. Обработка SQL-запросов в PostgreSQL](../полный/1. Общее устройство PostgreSQL/3. Обработка SQL-запросов в PostgreSQL.md)
- [[4. Работа с курсорами в PostgreSQL]] [4. Работа с курсорами в PostgreSQL](../полный/1. Общее устройство PostgreSQL/4. Работа с курсорами в PostgreSQL.md)
- [[5. Архитектура PostgreSQL. процессы и память]] [5. Архитектура PostgreSQL. процессы и память](../полный/1. Общее устройство PostgreSQL/5. Архитектура PostgreSQL. процессы и память.md)
- [[6. Хранение данных в PostgreSQL и журналирование WAL]] [6. Хранение данных в PostgreSQL и журналирование WAL](../полный/1. Общее устройство PostgreSQL/6. Хранение данных в PostgreSQL и журналирование WAL.md)
- [[7. Механизм многоверсионности (MVCC) и конкурентный доступ в PostgreSQL]] [7. Механизм многоверсионности (MVCC) и конкурентный доступ в PostgreSQL](../полный/1. Общее устройство PostgreSQL/7. Механизм многоверсионности (MVCC) и конкурентный доступ в PostgreSQL.md)
- [[8. Оптимизация работы с PostgreSQL]] [8. Оптимизация работы с PostgreSQL](../полный/1. Общее устройство PostgreSQL/8. Оптимизация работы с PostgreSQL.md)
- [[9. Расширяемость PostgreSQL]] [9. Расширяемость PostgreSQL](../полный/1. Общее устройство PostgreSQL/9. Расширяемость PostgreSQL.md)
- [[10. Выводы и итоги]] [10. Выводы и итоги](../полный/1. Общее устройство PostgreSQL/10. Выводы и итоги.md)

---

## Общий обзор PostgreSQL и клиент-серверное взаимодействие

PostgreSQL — это мощная объектно-реляционная СУБД с открытым исходным кодом, широко используемая для хранения и обработки данных. Она обеспечивает надежное хранение, масштабируемую работу с данными, поддержку сложных запросов и транзакций.

PostgreSQL работает по модели "клиент-сервер", где сервер управляет базами данных, выполняет запросы и обрабатывает транзакции, а клиентские приложения обращаются к серверу с запросами. Для взаимодействия используется клиент-серверный протокол, который поддерживает аутентификацию, выполнение SQL-запросов и управление транзакциями. PostgreSQL поддерживает множество языковых драйверов (Python, Java, C#, Node.js и др.), которые абстрагируют работу с сервером и упрощают выполнение SQL-запросов.

## Транзакции в PostgreSQL

Транзакции — основа надежной работы с базами данных. PostgreSQL поддерживает ACID-принципы: атомарность (транзакция выполняется полностью или не выполняется), согласованность (данные остаются в согласованном состоянии), изоляция (транзакции не мешают друг другу) и долговечность (изменения сохраняются даже при сбое).

По умолчанию PostgreSQL работает в режиме автофиксации (auto-commit), где каждая команда автоматически фиксируется. Для выполнения нескольких команд в рамках одной транзакции используются `BEGIN` и `COMMIT`. Точки сохранения (SAVEPOINT) позволяют откатывать часть транзакции, сохраняя остальные изменения.

PostgreSQL использует MVCC (многоверсионный контроль параллельности) для управления изоляцией. Доступны четыре уровня изоляции: Read Uncommitted (не используется в PostgreSQL), Read Committed (по умолчанию), Repeatable Read и Serializable.

## Обработка SQL-запросов

PostgreSQL является декларативной системой: мы описываем, что хотим получить, а сервер сам решает, как это сделать. Процесс обработки включает четыре этапа: разбор (проверка синтаксиса), анализ (определение таблиц и прав доступа), оптимизация (выбор наилучшего способа выполнения) и исполнение (получение и возврат данных).

Планировщик запросов анализирует статистику данных, выбирает методы сканирования (Seq Scan, Index Scan, Hash Join) и оптимизирует порядок соединений таблиц. Подготовленные операторы (PREPARE) позволяют разбирать и оптимизировать запрос один раз, а затем использовать с разными параметрами, что ускоряет выполнение повторяющихся запросов.

## Работа с курсорами

Курсоры позволяют поэтапно извлекать данные из запроса, а не загружать их все сразу. Это особенно полезно при работе с большими выборками. Курсоры работают только внутри транзакции и управляются с помощью `DECLARE`, `FETCH` и `CLOSE`. Персистентные курсоры с флагом `WITH HOLD` продолжают существовать после `COMMIT`, но хранят данные во временных файлах на диске.

## Архитектура PostgreSQL: процессы и память

PostgreSQL — многопроцессная система. Главный процесс (postmaster) управляет всеми остальными процессами: Background Writer (фоновая запись), WAL Writer (запись в журнал транзакций), Checkpointer (периодический сброс данных), Autovacuum (автоматическая очистка) и Client Backend (для каждого подключенного клиента).

PostgreSQL использует несколько уровней памяти: локальная память процесса, общая память сервера, буферный кэш (Shared Buffers) и кэш операционной системы. Данные сначала проверяются в буфере, затем загружаются с диска при необходимости. WAL (Write-Ahead Logging) гарантирует надежность: все изменения сначала записываются в журнал транзакций, затем применяются к файлам таблиц.

## Хранение данных и журналирование WAL

PostgreSQL хранит данные в файлах, организованных в каталоги. Каждая база данных хранится в каталоге `base/`, таблицы и индексы представлены отдельными файлами. Табличные пространства (tablespaces) позволяют хранить данные в разных местах файловой системы.

WAL — механизм, который позволяет PostgreSQL восстанавливать данные после сбоев. Все изменения сначала записываются в WAL, затем применяются к файлам таблиц. Контрольные точки (checkpoints) периодически сбрасывают данные из буфера на диск и удаляют старые WAL-файлы. Автоматическая очистка (Autovacuum) удаляет старые версии строк, освобождая место.

PostgreSQL поддерживает физическую репликацию (копирование WAL на резервный сервер) и логическую репликацию (копирование отдельных таблиц или изменений).

## Механизм многоверсионности (MVCC)

MVCC позволяет нескольким транзакциям работать одновременно без блокировок чтения. Каждая транзакция видит свою версию данных, независимо от изменений других транзакций. Изменения не перезаписывают старые строки, а создают новые версии. Старые версии остаются в таблице до очистки (VACUUM).

Каждая строка содержит скрытые поля: `xmin` (ID транзакции, создавшей строку), `xmax` (ID транзакции, удалившей строку) и `ctid` (физический адрес строки). Уровни изоляции управляют видимостью данных: Read Committed (видит только зафиксированные изменения), Repeatable Read (данные остаются неизменными с момента начала транзакции) и Serializable (полная изоляция, транзакции выполняются как будто по очереди).

## Оптимизация работы с PostgreSQL

PostgreSQL использует многопроцессную архитектуру, где каждое соединение создает отдельный процесс. Пул соединений (PgBouncer) помогает снизить нагрузку, переиспользуя соединения между клиентами.

Настройки памяти (`shared_buffers`, `work_mem`, `maintenance_work_mem`) ускоряют кеширование и операции. Индексы ускоряют поиск: B-Tree (для равенства и диапазонов), GIN (полнотекстовый поиск), GiST (геоданные), BRIN (очень большие таблицы). Параллельное выполнение запросов ускоряет сложные операции (COUNT, JOIN, GROUP BY).

Модуль `pg_stat_statements` помогает анализировать медленные запросы и оптимизировать производительность.

## Расширяемость PostgreSQL

PostgreSQL — одна из самых гибких и расширяемых реляционных СУБД. Она позволяет создавать пользовательские типы данных (составные типы, массивы, JSON), писать кастомные функции на SQL, PL/pgSQL, Python, C и других языках, создавать операторы и триггеры, использовать плагины и расширения (PostGIS, pgcrypto, pg_stat_statements и др.).

## Выводы и итоги

PostgreSQL — мощный инструмент, который можно гибко адаптировать под любые задачи: работать как классическая реляционная база, использовать для аналитики и больших данных, создавать REST API и NoSQL-решения на основе JSONB, разрабатывать геоинформационные системы и масштабировать под нагрузки тысяч пользователей. Главное — грамотная настройка и мониторинг для использования всех возможностей PostgreSQL.

**Подробнее:** [[1. Общее устройство PostgreSQL]] [1. Общее устройство PostgreSQL](../полный/1. Общее устройство PostgreSQL/резюме.md)

