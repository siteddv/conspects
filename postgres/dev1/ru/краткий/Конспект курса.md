# Конспект курса "PostgreSQL для разработчиков. Часть 1"

PostgreSQL — это мощная объектно-реляционная СУБД с открытым исходным кодом, которая широко используется для хранения и обработки данных. Курс посвящен изучению основ работы с PostgreSQL для разработчиков, начиная с архитектуры системы и заканчивая программированием на PL/pgSQL и работой с триггерами.

## Архитектура и основы PostgreSQL

PostgreSQL работает по модели "клиент-сервер", где сервер управляет базами данных, выполняет запросы и обрабатывает транзакции, а клиентские приложения обращаются к серверу с запросами. Для взаимодействия используется клиент-серверный протокол, который поддерживает аутентификацию, выполнение SQL-запросов и управление транзакциями. PostgreSQL поддерживает множество языковых драйверов (Python, Java, C#, Node.js и др.), которые абстрагируют работу с сервером и упрощают выполнение SQL-запросов.

PostgreSQL является многопроцессной системой. Главный процесс (postmaster) управляет всеми остальными процессами: Background Writer (фоновая запись), WAL Writer (запись в журнал транзакций), Checkpointer (периодический сброс данных), Autovacuum (автоматическая очистка) и Client Backend (для каждого подключенного клиента). Каждое соединение создает отдельный процесс, что может привести к перегрузке при большом количестве подключений. Решение — использование пула соединений (PgBouncer).

PostgreSQL использует несколько уровней памяти: локальная память процесса, общая память сервера, буферный кэш (Shared Buffers) и кэш операционной системы. Буферный кэш представляет собой массив буферов, где каждый буфер содержит одну страницу данных размером 8 КБ. Доступ к данным осуществляется постранично: если нужная страница уже находится в кэше, данные читаются напрямую из него; если нет — происходит обращение к операционной системе, которая проверяет свой файловый кэш, и только при отсутствии данных там выполняется физическое чтение с диска.

## Транзакции и ACID

Транзакции — основа надежной работы с базами данных. PostgreSQL поддерживает ACID-принципы: атомарность (транзакция выполняется полностью или не выполняется), согласованность (данные остаются в согласованном состоянии), изоляция (транзакции не мешают друг другу) и долговечность (изменения сохраняются даже при сбое).

По умолчанию PostgreSQL работает в режиме автофиксации (auto-commit), где каждая команда автоматически фиксируется. Для выполнения нескольких команд в рамках одной транзакции используются `BEGIN` и `COMMIT`. Точки сохранения (SAVEPOINT) позволяют откатывать часть транзакции, сохраняя остальные изменения.

## Механизм многоверсионности (MVCC)

PostgreSQL использует механизм MVCC (Multi-Version Concurrency Control), который позволяет нескольким транзакциям работать одновременно без блокировок чтения. В отличие от традиционных СУБД, которые перезаписывают данные в одной и той же строке, PostgreSQL хранит несколько версий одной строки. Это позволяет транзакциям читать данные без блокировки, видеть разные версии строки в зависимости от момента начала транзакции и гарантировать согласованность данных без потери производительности.

Каждая версия строки в PostgreSQL хранит два специальных параметра: `xmin` (номер транзакции, которая создала эту версию строки) и `xmax` (номер транзакции, которая сделала строку невидимой). Операция `UPDATE` фактически является комбинацией `DELETE + INSERT`: создается новая версия строки, а старая версия остается в истории, но становится невидимой для новых транзакций. Операция `DELETE` не уничтожает строку сразу, а просто делает её невидимой для будущих транзакций, изменяя `xmax`.

Чтобы обеспечить согласованность данных, PostgreSQL использует механизм снимков данных (Snapshot). Это логический срез базы данных на момент начала транзакции. Снимок данных создается при начале транзакции и состоит из номера текущей транзакции, списка активных транзакций, которые начались, но ещё не завершились, и диапазона видимых `xmin` и `xmax`.

Стандарт SQL определяет четыре уровня изоляции: Read Uncommitted (не используется в PostgreSQL), Read Committed (по умолчанию, видны только зафиксированные данные), Repeatable Read (все `SELECT` в рамках одной транзакции видят один и тот же снимок данных) и Serializable (полная изоляция, транзакции выполняются так, будто они идут по очереди).

Из-за механизма MVCC старые версии строк остаются в файле таблицы, даже если они больше не нужны. Это приводит к разрастанию таблиц. Процесс `VACUUM` находит старые версии строк, которые больше не видны ни одной транзакции, помечает их как свободное место и обновляет служебную информацию о транзакциях. PostgreSQL имеет встроенный процесс автоматической очистки (`autovacuum`), который работает в фоновом режиме и сам выполняет `VACUUM`.

## Обработка SQL-запросов

PostgreSQL является декларативной системой: мы описываем, что хотим получить, а сервер сам решает, как это сделать. Процесс обработки включает четыре этапа: разбор (проверка синтаксиса), анализ (определение таблиц и прав доступа), оптимизация (выбор наилучшего способа выполнения) и исполнение (получение и возврат данных).

Планировщик запросов анализирует статистику данных, выбирает методы сканирования (Seq Scan, Index Scan, Hash Join) и оптимизирует порядок соединений таблиц. Подготовленные операторы (PREPARE) позволяют разбирать и оптимизировать запрос один раз, а затем использовать с разными параметрами, что ускоряет выполнение повторяющихся запросов.

Курсоры позволяют поэтапно извлекать данные из запроса, а не загружать их все сразу. Это особенно полезно при работе с большими выборками. Курсоры работают только внутри транзакции и управляются с помощью `DECLARE`, `FETCH` и `CLOSE`. Персистентные курсоры с флагом `WITH HOLD` продолжают существовать после `COMMIT`, но хранят данные во временных файлах на диске.

## Буферный кэш и журнал предзаписи (WAL)

Буферный кэш представляет собой фундаментальный механизм в PostgreSQL, предназначенный для оптимизации работы с данными и уменьшения разницы в скорости между оперативной памятью и дисками. Основная задача буферного кэша заключается в временном хранении данных в оперативной памяти после их чтения с диска или перед записью на него. Это позволяет значительно сократить количество прямых обращений к дисковой подсистеме, что критически важно из-за существенной разницы в скорости доступа: оперативная память работает за ~100 наносекунд, SSD — за ~100 микросекунд, а HDD — за 5-10 миллисекунд.

Однако использование буферного кэша создает потенциальную проблему потери данных в случае сбоя системы, так как измененные страницы (грязные данные) могут находиться только в оперативной памяти и не быть записанными на диск. Для решения этой проблемы PostgreSQL использует механизм журнала предзаписи (Write-Ahead Logging, WAL).

Журнал предзаписи (WAL) является критически важным компонентом системы, обеспечивающим надежность хранения данных. Его основной принцип заключается в том, что любые изменения данных сначала фиксируются в WAL, и только потом применяются к самим данным в буферном кэше. Это гарантирует, что даже в случае аварийного завершения работы системы все изменения могут быть восстановлены путем проигрывания записей WAL.

Для управления объемом WAL и оптимизации процесса восстановления используются контрольные точки (Checkpoints). Эти точки фиксируют момент, когда все изменения из буферного кэша гарантированно записаны на диск, позволяя удалить старые записи WAL. По умолчанию контрольные точки создаются каждые 5 минут или при достижении размера WAL-логов в 1 ГБ.

PostgreSQL предоставляет гибкие возможности настройки режимов записи данных: синхронная запись (synchronous commit) обеспечивает максимальную надежность, но снижает скорость работы; асинхронная запись ускоряет работу, но создает риск потери данных при сбое. Журнал предзаписи (WAL) имеет дополнительные важные функции: Point-in-Time Recovery (PITR) — механизм восстановления базы данных до конкретного момента времени, и поддержка репликации — потоковая репликация (Streaming Replication) и логическая репликация.

## Логическая и физическая организация данных

PostgreSQL предоставляет два уровня организации данных: логический и физический. Логическая организация включает базы данных, схемы, таблицы, индексы и представления. Физическая организация определяет, где и как данные хранятся в файловой системе.

Кластер баз данных — это группа баз данных, управляемых одним экземпляром сервера PostgreSQL. При инициализации кластера автоматически создаются три базы данных: `postgres` (стандартная база данных для работы с сервером), `template0` (чистый шаблон, который всегда остаётся неизменным) и `template1` (основной шаблон, из которого по умолчанию создаются новые базы данных).

Схема — это логическое пространство, в котором хранятся объекты базы данных (таблицы, представления, функции и т. д.). Схемы помогают разделять объекты внутри одной базы данных, избегая конфликтов. PostgreSQL создаёт несколько специальных схем автоматически: `public` (схема по умолчанию), `pg_catalog` (системный каталог PostgreSQL), `information_schema` (стандартный SQL-каталог) и `pg_temp` (схема для временных объектов).

Путь поиска (`search_path`) — это список схем, которые PostgreSQL просматривает в определённом порядке при поиске объектов. Когда мы выполняем запрос без явного указания схемы, система ищет объект в первой найденной схеме из `search_path`.

Табличное пространство (tablespace) — это механизм PostgreSQL, который позволяет определять, в каком каталоге файловой системы хранить объекты базы данных. По умолчанию после инициализации кластера в PostgreSQL создаются два табличных пространства: `pg_global` (хранит глобальные объекты) и `pg_default` (основное табличное пространство).

Данные в PostgreSQL организованы в несколько уровней: табличные пространства, каталоги баз данных и файлы таблиц и индексов. Каждая таблица и индекс представляют собой набор файлов, расположенных в соответствующем каталоге. В PostgreSQL каждый объект разбивается на несколько слоев (forks): Main fork (основной файл данных), Free Space Map (FSM) — карта свободного пространства, Visibility Map (VM) — карта видимости данных и TOAST — специальное хранилище для очень больших значений.

## Программирование на PL/pgSQL

PL/pgSQL — это процедурный язык PostgreSQL, который тесно интегрирован с SQL и позволяет использовать переменные и сложную логику внутри SQL-запросов. Этот язык используется для создания функций и хранимых процедур, которые работают напрямую в PostgreSQL.

Основная единица кода в PL/pgSQL — блок. Каждый блок состоит из трех основных частей: секция объявления переменных (`DECLARE`), секция операторов (`BEGIN ... END`) и секция обработки исключений (`EXCEPTION`) (необязательная).

PL/pgSQL позволяет напрямую использовать SQL-запросы в коде, комбинируя их с процедурной логикой. Все SQL-запросы внутри PL/pgSQL автоматически компилируются в подготовленные операторы (prepared statements), что ускоряет выполнение и защищает от SQL-инъекций.

Разница между функциями и процедурами: функции (`FUNCTION`) не могут выполнять `COMMIT` и `ROLLBACK`, процедуры (`PROCEDURE`) могут управлять транзакциями. PL/pgSQL поддерживает условные операторы (`IF`, `CASE`), циклы (`LOOP`, `WHILE`, `FOR`), работу с массивами, обработку ошибок (`EXCEPTION`) и другие конструкции.

## Функции, процедуры и триггеры

PostgreSQL позволяет создавать пользовательские функции на различных языках: SQL, PL/pgSQL, Python, C и других. Функции могут возвращать различные типы данных, включая скалярные значения, таблицы и составные типы.

Процедуры (`PROCEDURE`) отличаются от функций тем, что могут управлять транзакциями (выполнять `COMMIT` и `ROLLBACK`). Процедуры полезны для выполнения сложных операций, требующих управления транзакциями.

Триггеры позволяют автоматически реагировать на изменения в таблице (например, логировать изменения). Триггеры могут быть привязаны к различным событиям (`INSERT`, `UPDATE`, `DELETE`) и могут выполняться до или после события. Функции триггеров могут проверять и модифицировать данные, а также выполнять дополнительные действия.

## Составные типы и массивы

PostgreSQL позволяет создавать пользовательские типы данных, включая составные типы (Composite Types), которые позволяют хранить структурированные данные в одной колонке. PostgreSQL также поддерживает массивы (`INT[]`, `TEXT[]` и т. д.) и JSON/JSONB (быстрый формат хранения структурированных данных).

## Обработка ошибок и отладка

PL/pgSQL предоставляет механизмы обработки ошибок через блоки `EXCEPTION`. Можно перехватывать различные типы ошибок и выполнять соответствующие действия. Для отладки используются различные инструменты, включая `RAISE NOTICE`, `RAISE WARNING` и специализированные расширения для отладки.

## Разграничение доступа и резервирование

PostgreSQL предоставляет гибкую систему разграничения доступа, позволяющую управлять правами пользователей на различные объекты базы данных. Логическое резервирование позволяет создавать резервные копии базы данных и восстанавливать их при необходимости.

## Заключение

PostgreSQL — мощный инструмент, который можно гибко адаптировать под любые задачи: работать как классическая реляционная база, использовать для аналитики и больших данных, создавать REST API и NoSQL-решения на основе JSONB, разрабатывать геоинформационные системы и масштабировать под нагрузки тысяч пользователей. Главное — грамотная настройка и мониторинг для использования всех возможностей PostgreSQL.

