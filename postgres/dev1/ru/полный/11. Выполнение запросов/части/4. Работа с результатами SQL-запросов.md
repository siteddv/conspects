### **–ß–∞—Å—Ç—å 4: –†–∞–±–æ—Ç–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ PL/pgSQL**

–í —ç—Ç–æ–π —á–∞—Å—Ç–∏ —Ä–∞–∑–±–∏—Ä–∞—é—Ç—Å—è:

- **–ö–∞–∫ –ø–æ–ª—É—á–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `SELECT INTO`, `RETURNING INTO` –∏ `EXECUTE INTO`**
- **–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `RECORD` –∏ `ROWTYPE`**
- **–ö–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ PL/pgSQL**
- **–û—à–∏–±–∫–∏ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `SELECT INTO` —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏**

---

## **1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**

–í PL/pgSQL SQL-–∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.  
–î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è `SELECT INTO`.

–ü—Ä–∏–º–µ—Ä:

```plpgsql
DECLARE 
    user_name TEXT;
BEGIN
    SELECT name INTO user_name FROM users WHERE id = 5;
END;
```

–ó–¥–µ—Å—å:

- `INTO user_name` ‚Äì —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `user_name`.
- –ï—Å–ª–∏ `SELECT` –Ω–∏—á–µ–≥–æ –Ω–µ –≤–µ—Ä–Ω–µ—Ç ‚Äì –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –±—É–¥–µ—Ç `NULL`.

---

## **2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `RETURNING INTO`**

`INSERT`, `UPDATE` –∏ `DELETE` –º–æ–≥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –ø–æ–º–æ—â—å—é `RETURNING`.  
–≠—Ç–æ —É–¥–æ–±–Ω–æ, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, `id` –≤–Ω–æ–≤—å –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏.

–ü—Ä–∏–º–µ—Ä:

```plpgsql
DECLARE 
    new_user_id INT;
BEGIN
    INSERT INTO users (name, email) 
    VALUES ('John Doe', 'john@example.com')
    RETURNING id INTO new_user_id;
END;
```

üìå **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ `RETURNING INTO`**:  
‚úÖ –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å `id`, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `SERIAL`/`UUID`.  
‚úÖ –ò–∑–±–µ–≥–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ `SELECT` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.  
‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º `SELECT id FROM users WHERE email = '...'`.

---

## **3. –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `RECORD` –∏ `ROWTYPE`**

PL/pgSQL –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **–¥–≤–∞ —Ç–∏–ø–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤**:  
1Ô∏è‚É£ `RECORD` ‚Äì —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç–∏–ø, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –ª—é–±—É—é —Å—Ç—Ä–æ–∫—É –∏–∑ `SELECT`.  
2Ô∏è‚É£ `ROWTYPE` ‚Äì —Ç–∏–ø, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Ç–∞–±–ª–∏—Ü—ã.

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `ROWTYPE`:**

```plpgsql
DECLARE 
    user_record users%ROWTYPE;  -- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∏–ø —Å—Ç—Ä–æ–∫–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users
BEGIN
    SELECT * INTO user_record FROM users WHERE id = 5;
END;
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `RECORD`:**

```plpgsql
DECLARE 
    some_record RECORD;
BEGIN
    SELECT id, name INTO some_record FROM users WHERE id = 5;
END;
```

üìå **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ROWTYPE`, –∞ –∫–æ–≥–¥–∞ `RECORD`?**  
‚úÖ `ROWTYPE` ‚Äì –µ—Å–ª–∏ —Ç–æ—á–Ω–æ –∑–Ω–∞–µ–º, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã.  
‚úÖ `RECORD` ‚Äì –µ—Å–ª–∏ `SELECT` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–∂–æ–∏–Ω –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü).

---

## **4. –û—à–∏–±–∫–∏ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö –≤ `SELECT INTO`**

–ï—Å–ª–∏ `SELECT INTO` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–±–æ–ª–µ–µ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏**, –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –æ—à–∏–±–∫–∞.

–ü—Ä–∏–º–µ—Ä –æ—à–∏–±–∫–∏:

```plpgsql
DECLARE 
    user_name TEXT;
BEGIN
    SELECT name INTO user_name FROM users WHERE status = 'active';  -- –û–®–ò–ë–ö–ê, –µ—Å–ª–∏ –±–æ–ª–µ–µ 1 —Å—Ç—Ä–æ–∫–∏
END;
```

üî¥ **–û—à–∏–±–∫–∞:** "more than one row returned by a subquery used as an expression".

üìå **–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏?**  
1Ô∏è‚É£ **–î–æ–±–∞–≤–∏—Ç—å `LIMIT 1`** (–Ω–æ —ç—Ç–æ –Ω–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ):

```plpgsql
SELECT name INTO user_name FROM users WHERE status = 'active' LIMIT 1;
```

2Ô∏è‚É£ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—É—Ä—Å–æ—Ä –∏–ª–∏ —Ü–∏–∫–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ç—Ä–æ–∫:**

```plpgsql
DECLARE 
    user_record RECORD;
BEGIN
    FOR user_record IN SELECT name FROM users WHERE status = 'active' LOOP
        RAISE NOTICE 'Active user: %', user_record.name;
    END LOOP;
END;
```

---

## **5. –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ (`GET DIAGNOSTICS`)**

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL-–∑–∞–ø—Ä–æ—Å–∞ –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å, **—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –æ–Ω –∏–∑–º–µ–Ω–∏–ª –∏–ª–∏ –≤—ã–±—Ä–∞–ª**.

üìå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `GET DIAGNOSTICS row_count = ROW_COUNT`:

```plpgsql
DECLARE 
    row_count INT;
BEGIN
    UPDATE users SET status = 'inactive' WHERE last_login < now() - INTERVAL '1 year';
    GET DIAGNOSTICS row_count = ROW_COUNT;
    RAISE NOTICE 'Updated % rows', row_count;
END;
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**  
‚úÖ –ú–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, –±—ã–ª–∏ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ.  
‚úÖ –ú–æ–∂–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫.

---

## **6. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `FOUND` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞**

`FOUND` ‚Äì —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, **–±—ã–ª–∏ –ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã —Å—Ç—Ä–æ–∫–∏** –ø–æ—Å–ª–µ–¥–Ω–∏–º SQL-–∑–∞–ø—Ä–æ—Å–æ–º.

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `FOUND` –ø–æ—Å–ª–µ `SELECT`:**

```plpgsql
DECLARE 
    user_name TEXT;
BEGIN
    SELECT name INTO user_name FROM users WHERE id = 5;
    
    IF FOUND THEN
        RAISE NOTICE 'User found: %', user_name;
    ELSE
        RAISE NOTICE 'User not found';
    END IF;
END;
```

**–ü—Ä–∏–º–µ—Ä `FOUND` –ø–æ—Å–ª–µ `UPDATE`:**

```plpgsql
BEGIN
    UPDATE users SET status = 'inactive' WHERE last_login < now() - INTERVAL '1 year';

    IF FOUND THEN
        RAISE NOTICE 'Users deactivated';
    ELSE
        RAISE NOTICE 'No users found for deactivation';
    END IF;
END;
```

üìå **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ `FOUND`:**  
‚úÖ –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å `NULL`, –µ—Å–ª–∏ `SELECT` –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–µ–ª.  
‚úÖ –£–¥–æ–±–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ `UPDATE`, `DELETE`, `INSERT`.  
‚úÖ –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ —Ü–∏–∫–ª–æ–≤ (`FOR`, `LOOP`).

---

## **7. –†–∞–∑–±–æ—Ä –æ—à–∏–±–∫–∏ "statement result type mismatch"**

–ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–∏–ø—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è, –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç –æ—à–∏–±–∫–∞:

```plpgsql
DECLARE 
    user_name TEXT;
BEGIN
    SELECT id INTO user_name FROM users WHERE id = 5;  -- –û–®–ò–ë–ö–ê: –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤
END;
```

üî¥ **–û—à–∏–±–∫–∞:** "statement result type mismatch"

üìå **–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?**  
‚úÖ –õ–∏–±–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π:

```plpgsql
DECLARE 
    user_id INT;
BEGIN
    SELECT id INTO user_id FROM users WHERE id = 5;
END;
```

‚úÖ –õ–∏–±–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ —Ç–∏–ø —è–≤–Ω–æ:

```plpgsql
DECLARE 
    user_name TEXT;
BEGIN
    SELECT CAST(id AS TEXT) INTO user_name FROM users WHERE id = 5;
END;
```

---

## **–í—ã–≤–æ–¥—ã**

‚úÖ –í PL/pgSQL –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å `SELECT INTO`.  
‚úÖ `RETURNING INTO` –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ `INSERT`, `UPDATE`, `DELETE`.  
‚úÖ `ROWTYPE` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü, `RECORD` ‚Äì –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.  
‚úÖ –ï—Å–ª–∏ `SELECT INTO` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ ‚Äì –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞.  
‚úÖ `GET DIAGNOSTICS` –∏ `FOUND` –ø–æ–º–æ–≥–∞—é—Ç –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤.  
‚úÖ –ù—É–∂–Ω–æ —Å–ª–µ–¥–∏—Ç—å –∑–∞ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º —Ç–∏–ø–æ–≤ –≤ `SELECT INTO`, –∏–Ω–∞—á–µ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞.

---

–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –∑–∞–ø—Ä–æ—Å–∏—Ç—å **–ø—è—Ç—É—é —á–∞—Å—Ç—å**, –∏ —è –ø—Ä–æ–¥–æ–ª–∂—É —Ä–∞–∑–±–∏—Ä–∞—Ç—å, –∫–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏–º–µ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ PL/pgSQL. üöÄ

