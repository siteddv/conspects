# 5. Физическая структура данных

## Содержание

- [[1. Введение в физическую организацию данных в PostgreSQL]] [1. Введение в физическую организацию данных в PostgreSQL](части/1. Введение в физическую организацию данных в PostgreSQL.md)
- [[2. Табличные пространства (Tablespaces)]] [2. Табличные пространства (Tablespaces)](части/2. Табличные пространства (Tablespaces).md)
- [[3. Физическое расположение данных в файловой системе]] [3. Физическое расположение данных в файловой системе](части/3. Физическое расположение данных в файловой системе.md)
- [[4. Страничная организация данных (8 KB Pages)]] [4. Страничная организация данных (8 KB Pages)](части/4. Страничная организация данных (8 KB Pages).md)
- [[5. Слои (Forks) данных в PostgreSQL]] [5. Слои (Forks) данных в PostgreSQL](части/5. Слои (Forks) данных в PostgreSQL.md)
- [[6. TOAST (хранение больших данных)]] [6. TOAST (хранение больших данных)](части/6. TOAST (хранение больших данных).md)
- [[7. Практическое задание и заключение]] [7. Практическое задание и заключение](части/7. Практическое задание и заключение.md)

---

### Подробный конспект по физической организации данных в PostgreSQL

PostgreSQL — это мощная реляционная СУБД с открытым исходным кодом, которая предлагает гибкие возможности для управления данными. Одной из ключевых особенностей PostgreSQL является её способность эффективно организовывать данные как на логическом, так и на физическом уровне. В этом конспекте мы подробно разберём все аспекты физической организации данных в PostgreSQL, начиная от табличных пространств и заканчивая механизмами хранения больших данных (TOAST).

PostgreSQL предоставляет два уровня организации данных: **логический** и **физический**.

- **Логическая организация** включает базы данных, схемы, таблицы, индексы и представления. Это то, с чем взаимодействует пользователь через SQL-запросы.
- **Физическая организация** определяет, где и как данные хранятся в файловой системе. Этот уровень важен для администраторов баз данных, так как он позволяет оптимизировать производительность и управление хранилищем.

Основной вопрос, который мы рассматриваем: **где в файловой системе расположены наши данные?**

**Табличное пространство** — это логическая сущность, которая указывает, в каком каталоге файловой системы хранятся объекты базы данных. Табличные пространства позволяют гибко управлять хранением данных, размещая их на разных дисках, оптимизировать хранение с учётом скорости и стоимости дисков, разделять нагрузки (архивные данные на медленных HDD, "горячие" данные на быстрых SSD), и облегчать управление данными при миграции и обновлении PostgreSQL.

По умолчанию после инициализации кластера в PostgreSQL создаются **два табличных пространства**:
- **`pg_global`**: хранит глобальные объекты, которые относятся ко всему кластеру баз данных.
- **`pg_default`**: основное табличное пространство, в котором размещаются объекты, если не указано другое.

Физически данные PostgreSQL хранятся в **каталогах на диске**, внутри каталога данного кластера PostgreSQL (обычно `/var/lib/postgresql/data` или `/pgdata`), в подкаталогах, соответствующих различным базам данных и их объектам.

Данные в PostgreSQL организованы в несколько уровней:
- **Табличные пространства** (`tablespaces`) – указывают на каталог файловой системы.
- **Каталоги баз данных** – для каждой базы данных создаётся каталог внутри соответствующего табличного пространства.
- **Файлы таблиц и индексов** – каждая таблица и индекс представляют собой **набор файлов**, расположенных в соответствующем каталоге.

В PostgreSQL каждый объект (таблица, индекс, материализованное представление и т. д.) разбивается на **несколько слоев (forks)**, чтобы оптимизировать работу с диском:
- **Main fork** – основной файл данных, содержащий строки таблицы или индекса.
- **Free Space Map (FSM)** – карта свободного пространства.
- **Visibility Map (VM)** – карта видимости данных.
- **TOAST** – специальное хранилище для **очень больших значений**, если они не помещаются в стандартную страницу.

PostgreSQL использует **страничную организацию данных**, где файл разделяется на блоки фиксированного размера (8 KB). Это помогает оптимизировать доступ к данным и эффективно работать с кэшем. Каждая страница PostgreSQL имеет фиксированную структуру, состоящую из заголовка (24 байта), таблицы смещений (Item IDs), данных строк (Tuples), свободного пространства и специальных метаданных (в индексе).

Если строка таблицы больше 8 KB, PostgreSQL применяет две стратегии: сжатие данных (LZ4, PGLZ) или использование TOAST (The Oversized-Attribute Storage Technique). TOAST-таблица хранит длинные атрибуты, а в основной таблице остаётся только ссылка на TOAST.

TOAST автоматически используется для столбцов типа TEXT, BYTEA, JSONB, VARCHAR, ARRAY, XML, HSTORE. Когда строка слишком длинная, PostgreSQL разбивает её на чанки (2 KB каждая) и хранит в отдельной TOAST-таблице. Если запрос не использует TOAST-колонки, PostgreSQL не загружает TOAST, что является важной оптимизацией производительности.

PostgreSQL по умолчанию сжимает большие значения перед отправкой в TOAST, используя PGLZ (PostgreSQL LZ) – встроенный алгоритм сжатия. Можно управлять TOAST-хранилищем с помощью `STORAGE` (`PLAIN`, `EXTERNAL`, `EXTENDED`).

Таким образом, PostgreSQL предоставляет комплексную систему физической организации данных, позволяющую эффективно управлять хранением, оптимизировать производительность и обеспечивать надёжность работы с данными различных размеров.

