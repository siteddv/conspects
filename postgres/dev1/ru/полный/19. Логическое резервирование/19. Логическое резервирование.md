# 19. Логическое резервирование

## Описание

Эта глава посвящена логическому резервному копированию в PostgreSQL. Мы рассмотрим введение в логическое резервное копирование, создание копии отдельной таблицы с помощью команды COPY, восстановление данных из резервной копии, использование утилиты pg_dump для создания резервной копии базы данных, форматы резервных копий и их особенности, использование параллельной загрузки и выгрузки в формате directory, копирование всего кластера баз данных, а также заключение и рекомендации.

## Части главы

- [[части/1. Введение в логическое резервное копирование|1. Введение в логическое резервное копирование]] [1. Введение в логическое резервное копирование](части/1. Введение в логическое резервное копирование.md)
- [[части/2. Создание копии отдельной таблицы с помощью команды COPY|2. Создание копии отдельной таблицы с помощью команды COPY]] [2. Создание копии отдельной таблицы с помощью команды COPY](части/2. Создание копии отдельной таблицы с помощью команды COPY.md)
- [[части/3. Восстановление данных из резервной копии с помощью команды COPY|3. Восстановление данных из резервной копии с помощью команды COPY]] [3. Восстановление данных из резервной копии с помощью команды COPY](части/3. Восстановление данных из резервной копии с помощью команды COPY.md)
- [[части/4. Использование утилиты pg_dump для создания резервной копии базы данных|4. Использование утилиты pg_dump для создания резервной копии базы данных]] [4. Использование утилиты pg_dump для создания резервной копии базы данных](части/4. Использование утилиты pg_dump для создания резервной копии базы данных.md)
- [[части/5. Форматы резервных копий и их особенности|5. Форматы резервных копий и их особенности]] [5. Форматы резервных копий и их особенности](части/5. Форматы резервных копий и их особенности.md)
- [[части/6. Использование параллельной загрузки и выгрузки в формате directory|6. Использование параллельной загрузки и выгрузки в формате directory]] [6. Использование параллельной загрузки и выгрузки в формате directory](части/6. Использование параллельной загрузки и выгрузки в формате directory.md)
- [[части/7. Копирование всего кластера баз данных|7. Копирование всего кластера баз данных]] [7. Копирование всего кластера баз данных](части/7. Копирование всего кластера баз данных.md)
- [[части/8. Заключение и рекомендации по использованию логического резервного копирования|8. Заключение и рекомендации по использованию логического резервного копирования]] [8. Заключение и рекомендации по использованию логического резервного копирования](части/8. Заключение и рекомендации по использованию логического резервного копирования.md)

---

Логическое резервное копирование в PostgreSQL представляет собой процесс создания резервных копий на уровне объектов базы данных, таких как таблицы, схемы, или целые базы данных. Оно выполняется с помощью SQL-скриптов, создающих необходимые объекты и выполняющих операции вставки данных. Важно отметить, что это текстовый формат, который можно редактировать и использовать на других версиях базы данных, даже если они работают на разных архитектурах.

В отличие от физического резервного копирования, при котором копируются все файлы, относящиеся к серверу базы данных, логическое копирование не требует полной двоичной совместимости между системами. Основные преимущества логического резервного копирования включают простоту использования, гибкость выбора объектов для копирования, текстовый формат, который можно редактировать, и отсутствие необходимости в двоичной совместимости. Однако оно имеет недостатки: низкая скорость работы, восстановление только на момент копирования и не подходит для восстановления после сбоев.

Команда COPY в PostgreSQL позволяет экспортировать данные из таблицы в файл или импортировать данные обратно. Она работает быстрее, чем стандартные INSERT, так как позволяет вставлять данные пакетами. COPY поддерживает различные форматы вывода: TEXT, CSV и BINARY. Можно экспортировать как всю таблицу, так и отдельные столбцы, а также использовать условия для фильтрации данных. Альтернативный способ - использование \COPY, которая работает на стороне клиента, если у пользователя нет прав на запись в файловую систему сервера.

Восстановление данных из резервной копии выполняется с помощью команды COPY ... FROM. При восстановлении важно учитывать обработку NULL-значений, предотвращение дубликатов и возможность восстановления только определенных столбцов. Для безопасной загрузки данных можно использовать временные таблицы и команду ON CONFLICT DO NOTHING.

Утилита pg_dump является стандартным инструментом PostgreSQL для логического резервного копирования баз данных. Она позволяет экспортировать данные и схему в SQL-скрипт или в другие форматы (custom, directory). pg_dump поддерживает создание резервных копий отдельных объектов (схем, таблиц, функций), копирование только схемы без данных или только данных без структуры, а также параллельное создание резервной копии в формате directory.

PostgreSQL поддерживает несколько форматов резервных копий: plain (SQL-скрипт), custom (двоичный формат), directory (каталог с отдельными файлами) и tar (архив). Формат plain читаемый человеком и можно редактировать, но медленный при восстановлении. Формат custom позволяет восстанавливать отдельные объекты и поддерживает параллельное восстановление. Формат directory обеспечивает очень быстрое резервное копирование и восстановление за счет многопоточной обработки. Формат tar удобен для архивации и передачи, но не поддерживает параллельное восстановление.

Параллельное резервное копирование и восстановление значительно ускоряет обработку больших баз данных. Для этого используется формат directory с параметром -j, который указывает количество потоков. Количество потоков не должно превышать количество ядер CPU, оптимально использовать 50-75% от числа ядер. Использование -j ускоряет процесс в 2-5 раз по сравнению с однопоточным режимом.

Утилита pg_dumpall предназначена для создания полной копии всего кластера PostgreSQL, включая все базы данных и глобальные объекты, такие как роли, привилегии и табличные пространства. В отличие от pg_dump, который копирует только одну базу данных, pg_dumpall создает резервную копию всего сервера. Это полезно для полного бэкапа кластера, но процесс может занимать значительное время.

Для эффективного использования логического резервного копирования рекомендуется использовать формат directory с параллельной обработкой для больших баз, хранить несколько копий бэкапов в разных местах, автоматизировать процесс резервного копирования и периодически проверять возможность восстановления бэкапов. Логическое резервное копирование отлично подходит для миграции данных между серверами, частичного восстановления и разработки, но для критически важного резервного копирования его нужно дополнять физическим копированием.

