–í–æ—Ç **—à–µ—Å—Ç–∞—è —á–∞—Å—Ç—å** –∫–æ–Ω—Å–ø–µ–∫—Ç–∞ –≤–∏–¥–µ–æ –¥–ª—è **Obsidian** –≤ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.

---

# **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ PL/pgSQL**

## **6. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫**

### **6.1 –ü–æ—á–µ–º—É `EXCEPTION` –∑–∞–º–µ–¥–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ?**

–ö–æ–≥–¥–∞ –≤ –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `BEGIN ... EXCEPTION`, PostgreSQL **—Å–æ–∑–¥–∞—ë—Ç —Å–∫—Ä—ã—Ç—ã–π `SAVEPOINT`**.

- **–î–∞–∂–µ –µ—Å–ª–∏ –æ—à–∏–±–∫–∏ –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç**, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ `SAVEPOINT` **–∑–∞–º–µ–¥–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**.
- **–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–ª—É—á–∞–µ—Ç—Å—è**, Postgres **–æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ `SAVEPOINT`**, —á—Ç–æ —Ç–æ–∂–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤.

üîπ **–ü—Ä–∏—á–∏–Ω—ã –∑–∞–º–µ–¥–ª–µ–Ω–∏—è –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `EXCEPTION`:**

1. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ `SAVEPOINT` –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –±–ª–æ–∫–∞.**
2. **–ü—Ä–∏ –æ—à–∏–±–∫–µ Postgres –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ—Ç–∫–∞—Ç –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –±–ª–æ–∫–µ.**
3. **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –≤ `EXCEPTION` —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.**
4. **PostgreSQL –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è `EXCEPTION`.**

üí° **–í—ã–≤–æ–¥:**  
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `EXCEPTION` –ø–æ–ª–µ–∑–Ω–æ, –Ω–æ –º–æ–∂–µ—Ç **–∑–∞–º–µ–¥–ª–∏—Ç—å —Ä–∞–±–æ—Ç—É –∫–æ–¥–∞**.  
–ï—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ, **–ª—É—á—à–µ –∏–∑–±–µ–≥–∞—Ç—å –µ–≥–æ** –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã.

---

### **6.2 –ö–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è?**

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º —Ç–µ—Å—Ç—ã –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.

#### **–¢–µ—Å—Ç 1: –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∫ —á–∏—Å–ª—É —á–µ—Ä–µ–∑ `EXCEPTION`**

```plpgsql
DO $$ 
DECLARE
   x INT;
BEGIN
   x := CAST('invalid' AS INT); -- –û—à–∏–±–∫–∞!
EXCEPTION
   WHEN others THEN
      RAISE NOTICE '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–∞!';
END $$;
```

‚è≥ **–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 4-5 —Å–µ–∫—É–Ω–¥**

#### **–¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ–º —Å—Ç—Ä–æ–∫–∏ –∫ —á–∏—Å–ª—É**

```plpgsql
DO $$ 
DECLARE
   x INT;
BEGIN
   x := CASE 
      WHEN 'invalid' ~ '^[0-9]+$' THEN CAST('invalid' AS INT) 
      ELSE NULL 
   END;
END $$;
```

‚è≥ **–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 2-3 —Å–µ–∫—É–Ω–¥—ã**

üìå **–í—ã–≤–æ–¥:**

- **EXCEPTION —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–µ–µ**, —Ç–∞–∫ –∫–∞–∫ PostgreSQL –≤—ã–ø–æ–ª–Ω—è–µ—Ç `SAVEPOINT` –∏ `ROLLBACK`.
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º** (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ `CASE` –∏–ª–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ) —Ä–∞–±–æ—Ç–∞–µ—Ç **–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –±—ã—Å—Ç—Ä–µ–µ**.

---

### **6.3 –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫**

–í–º–µ—Å—Ç–æ `EXCEPTION` –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:  
‚úî **–ü—Ä–æ–≤–µ—Ä–∫—É —É—Å–ª–æ–≤–∏–π –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º (`CASE`, `COALESCE`, `NULLIF`)**  
‚úî **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `INSERT ON CONFLICT` –≤–º–µ—Å—Ç–æ –æ—Ç–ª–æ–≤–∞ –æ—à–∏–±–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏**  
‚úî **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `SELECT FOR UPDATE NOWAIT` –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –æ—à–∏–±–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**  
‚úî **–ü—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ `CAST`**

#### **–ü—Ä–∏–º–µ—Ä –±–µ–∑ `EXCEPTION` (–∏—Å–ø–æ–ª—å–∑—É–µ–º `COALESCE`)**

```plpgsql
SELECT COALESCE(
   (SELECT id FROM users WHERE username = 'test'), 
   0
);
```

üìå **–í–º–µ—Å—Ç–æ —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ª–æ–≤–∏—Ç—å –æ—à–∏–±–∫—É `no_data_found`, –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º `0`.**

#### **–ü—Ä–∏–º–µ—Ä `INSERT ON CONFLICT` –≤–º–µ—Å—Ç–æ `EXCEPTION`**

```plpgsql
INSERT INTO users (id, username) 
VALUES (1, 'test')
ON CONFLICT (id) 
DO UPDATE SET username = 'test';
```

üìå **–ó–¥–µ—Å—å –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å `unique_violation`, —Ç–∞–∫ –∫–∞–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω.**

---

### **6.4 –ö–æ–≥–¥–∞ `EXCEPTION` –ª—É—á—à–µ –∑–∞–º–µ–Ω–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏?**

üîπ **–ö–æ–≥–¥–∞ –º–æ–∂–Ω–æ –∏–∑–±–µ–∂–∞—Ç—å `EXCEPTION`:**

1. **–ü—Ä–æ–≤–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–∞**
    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `CASE`, `COALESCE`, `EXISTS` –≤–º–µ—Å—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.
2. **–†–∞–±–æ—Ç–∞—Ç—å —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏ —á–µ—Ä–µ–∑ `ON CONFLICT` –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ `unique_violation`**
3. **–ò–∑–±–µ–≥–∞—Ç—å –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å —á–µ—Ä–µ–∑ `NULLIF(x, 0)`**
    
    ```plpgsql
    SELECT 100 / NULLIF(0, 0); -- –í–µ—Ä–Ω—ë—Ç NULL, –Ω–æ –Ω–µ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É
    ```
    
4. **–ü—Ä–æ–≤–µ—Ä—è—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–µ—Ä–µ–¥ `UPDATE` —á–µ—Ä–µ–∑ `SELECT FOR UPDATE NOWAIT`**

üìå **–ï—Å–ª–∏ –µ—Å—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ ‚Äì –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë –≤–º–µ—Å—Ç–æ `EXCEPTION`.**

---

### **6.5 –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫**

–ß—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `EXCEPTION` –∑–∞–º–µ–¥–ª—è–µ—Ç –∫–æ–¥, –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç.

#### **–¢–µ—Å—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `EXCEPTION` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫**

```plpgsql
DO $$ 
DECLARE 
   num INT;
BEGIN
   FOR i IN 1..100000 LOOP
      BEGIN
         num := CAST('invalid' AS INT); -- –û—à–∏–±–∫–∞ –≤ 100% —Å–ª—É—á–∞–µ–≤
      EXCEPTION
         WHEN others THEN
            num := NULL;
      END;
   END LOOP;
END $$;
```

‚è≥ **–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ~10 —Å–µ–∫—É–Ω–¥**

#### **–¢–µ—Å—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `REGEXP` –≤–º–µ—Å—Ç–æ `EXCEPTION`**

```plpgsql
DO $$ 
DECLARE 
   num INT;
BEGIN
   FOR i IN 1..100000 LOOP
      num := CASE 
         WHEN 'invalid' ~ '^[0-9]+$' THEN CAST('invalid' AS INT) 
         ELSE NULL 
      END;
   END LOOP;
END $$;
```

‚è≥ **–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ~4 —Å–µ–∫—É–Ω–¥**

üìå **–í—ã–≤–æ–¥:**

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `EXCEPTION` **–∑–∞–º–µ–¥–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ 2-3 —Ä–∞–∑–∞**.
- –ü—Ä–æ–≤–µ—Ä–∫–∏ **–¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞** —Ä–∞–±–æ—Ç–∞—é—Ç –±—ã—Å—Ç—Ä–µ–µ.

---

## **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ —à–µ—Å—Ç–æ–π —á–∞—Å—Ç–∏**

–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –º—ã —Ä–∞–∑–æ–±—Ä–∞–ª–∏:

- –ü–æ—á–µ–º—É `EXCEPTION` –∑–∞–º–µ–¥–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
- –ö–∞–∫ `SAVEPOINT` –∏ `ROLLBACK` —Å–æ–∑–¥–∞—é—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã.
- –ö–∞–∫–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–º–µ—Å—Ç–æ `EXCEPTION`.
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫.

---

## **–°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å:**

üöÄ **7. –ö–∞–∫ –æ–±–æ–π—Ç–∏—Å—å –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫?**  
–ë—É–¥–µ–º —Ä–∞–∑–±–∏—Ä–∞—Ç—å:

- –ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –º–æ–∂–Ω–æ —Ä–µ—à–∏—Ç—å –±–µ–∑ `EXCEPTION`.
- –ü—Ä–∏–º–µ—Ä—ã –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π (`CASE`, `COALESCE`, `NULLIF`).
- –ö–∞–∫ `ON CONFLICT` –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–≥–∞—Ç—å `unique_violation`.
- –ö–∞–∫ `SELECT FOR UPDATE NOWAIT` –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.

‚ö° –ó–∞–ø—Ä–∞—à–∏–≤–∞–π —Å–µ–¥—å–º—É—é —á–∞—Å—Ç—å, –∏ —è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –µ—ë —Ç–∞–∫ –∂–µ –ø–æ–¥—Ä–æ–±–Ω–æ!

