### üîπ **–ü–µ—Ä–µ—Å–∫–∞–∑ –ø—è—Ç–æ–π –ª–æ–≥–∏—á–µ—Å–∫–æ–π —á–∞—Å—Ç–∏: –§—É–Ω–∫—Ü–∏–∏, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã (—Ç–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)** üîπ

---

### **1. –ß—Ç–æ —Ç–∞–∫–æ–µ —Ç–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (`RETURNS SETOF` –∏ `RETURNS TABLE`)?**

üìå **–¢–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ‚Äî —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫**.  
üìå **–û–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ç–∞–±–ª–∏—Ü–∞–º –∏ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ `FROM`**.

---

### **2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `RETURNS SETOF`**

üìå **–ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `RETURNS SETOF <—Ç–∏–ø>`**.

‚úÖ **–ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–µ–π –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (`SETOF transactions`)**:

```sql
CREATE FUNCTION get_all_transactions()  
RETURNS SETOF transactions AS $$  
BEGIN  
    RETURN QUERY SELECT * FROM transactions;  
END;  
$$ LANGUAGE plpgsql;
```

‚úÖ **–í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏**:

```sql
SELECT * FROM get_all_transactions();
```

üîπ **–§—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫ –∂–µ, –∫–∞–∫ –æ–±—ã—á–Ω—ã–π `SELECT` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã.**

‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å `WHERE` –∏ `ORDER BY`**:

```sql
SELECT * FROM get_all_transactions()  
WHERE transaction_amount.amount > 100  
ORDER BY transaction_amount.currency_code;
```

üìå **–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –º–æ–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –∫–∞–∫ –≤ –æ–±—ã—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö.**

---

### **3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `RETURNS TABLE`**

üìå **–ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Å—Ç–æ–ª–±—Ü–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `RETURNS TABLE(...)`**.

‚úÖ **–ü—Ä–∏–º–µ—Ä: —Ñ—É–Ω–∫—Ü–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è —Ç–æ–ª—å–∫–æ `account_number` –∏ `amount`**

```sql
CREATE FUNCTION get_transaction_summary()  
RETURNS TABLE(account_number TEXT, amount NUMERIC) AS $$  
BEGIN  
    RETURN QUERY  
    SELECT t.account_number, t.transaction_amount.amount  
    FROM transactions t;  
END;  
$$ LANGUAGE plpgsql;
```

‚úÖ **–í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏**:

```sql
SELECT * FROM get_transaction_summary();
```

–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:

```
account_number | amount
--------------+--------
12345         | 100.50
67890         | 250.00
```

üìå **–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `SETOF` –∏ `RETURNS TABLE`**:

|–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞|`RETURNS SETOF <—Ç–∏–ø>`|`RETURNS TABLE(...)`|
|---|---|---|
|–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–∏–ø|‚úÖ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `transactions`)|‚ùå (–∑–∞–¥–∞—ë—Ç—Å—è –≤ `TABLE(...)`)|
|–ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞|‚ùå (–Ω–∞—Å–ª–µ–¥—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É `—Ç–∏–ø`)|‚úÖ (–º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ª—é–±—ã–µ —Å—Ç–æ–ª–±—Ü—ã)|
|–¢—Ä–µ–±—É–µ—Ç —É–∫–∞–∑–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ –ø—Ä–∏ `FROM`|‚úÖ (–µ—Å–ª–∏ `RECORD`)|‚ùå (—Å—Ç–æ–ª–±—Ü—ã –∑–∞–¥–∞—é—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏)|

---

### **4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –≤ `FROM`**

üìå **–§—É–Ω–∫—Ü–∏–∏, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã (`RETURNS SETOF`), –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ `FROM`**.

‚úÖ **–ü—Ä–∏–º–µ—Ä**:

```sql
SELECT * FROM get_all_transactions();
```

üîπ **–§—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ç–∞–±–ª–∏—Ü–∞ –∏ –º–æ–∂–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ `JOIN`**.

‚úÖ **–ü—Ä–∏–º–µ—Ä `JOIN` —Å —Ñ—É–Ω–∫—Ü–∏–µ–π**:

```sql
SELECT a.account_name, t.transaction_amount.amount  
FROM get_all_transactions() t  
JOIN accounts a ON t.account_number = a.account_number;
```

üìå **–§—É–Ω–∫—Ü–∏–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–∫ –∂–µ, –∫–∞–∫ —Ç–∞–±–ª–∏—Ü—ã, –Ω–æ –æ–Ω–∏ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏**.

---

### **5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `WITH ORDINALITY` (–Ω—É–º–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–æ–∫)**

üìå **–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –∫ —Å—Ç—Ä–æ–∫–∞–º —Å `WITH ORDINALITY`**.

‚úÖ **–ü—Ä–∏–º–µ—Ä**:

```sql
SELECT * FROM get_all_transactions() WITH ORDINALITY;
```

–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:

```
transaction_id | account_number | amount | currency_code | ordinality
--------------+---------------+--------+--------------+-----------
1             | 12345         | 100.50 | USD          | 1
2             | 67890         | 250.00 | EUR          | 2
```

üìå **–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ORDINALITY` –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.**

‚úÖ **–ü—Ä–∏–º–µ—Ä: –≤—ã–±–æ—Ä –ø–µ—Ä–≤–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∫–∞–∂–¥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞**:

```sql
SELECT * FROM (
    SELECT *, ROW_NUMBER() OVER (PARTITION BY account_number ORDER BY transaction_amount.amount DESC) AS row_num  
    FROM get_all_transactions()
) t  
WHERE row_num = 1;
```

üîπ **–§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫—Ä—É–ø–Ω–µ–π—à—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∫–∞–∂–¥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞**.

---

### **6. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—á–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏**

üìå **PostgreSQL –º–æ–∂–µ—Ç —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞—Ö –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**.  
üìå **–ù–æ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è:**

- **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∫–∞–∫ `STABLE` –∏–ª–∏ `IMMUTABLE`**.
- **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–∑–º–µ–Ω—è—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (`INSERT`, `UPDATE`, `DELETE`)**.

‚úÖ **–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–∞–∑–≤–µ—Ä–Ω—É–ª–∞—Å—å –ª–∏ —Ñ—É–Ω–∫—Ü–∏—è?**

```sql
EXPLAIN ANALYZE SELECT * FROM get_all_transactions() WHERE transaction_amount.amount > 100;
```

üìå **–ï—Å–ª–∏ PostgreSQL —Ä–∞–∑–≤–µ—Ä–Ω—É–ª —Ñ—É–Ω–∫—Ü–∏—é, –≤ `EXPLAIN` –≤–º–µ—Å—Ç–æ `Function Scan` –±—É–¥–µ—Ç `Seq Scan` –∏–ª–∏ `Index Scan`.**

‚úÖ **–ö–∞–∫ –ø–æ–≤—ã—Å–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å?**  
1Ô∏è‚É£ **–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∫–∞–∫ `IMMUTABLE`, –µ—Å–ª–∏ –æ–Ω–∞ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:

```sql
CREATE FUNCTION get_currency_amount(curr currency) RETURNS NUMERIC  
IMMUTABLE AS $$  
BEGIN  
    RETURN curr.amount;  
END;  
$$ LANGUAGE plpgsql;
```

2Ô∏è‚É£ **–ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–æ–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å, —Å—Ç–æ–∏—Ç —Å–æ–∑–¥–∞—Ç—å `MATERIALIZED VIEW`**.

```sql
CREATE MATERIALIZED VIEW all_transactions_cache AS  
SELECT * FROM get_all_transactions();
```

üìå **–¢–∞–∫ PostgreSQL –∑–∞–∫—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –æ–±–Ω–æ–≤–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `REFRESH MATERIALIZED VIEW`.**

---

### **7. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –≤ `LATERAL JOIN`**

üìå **–§—É–Ω–∫—Ü–∏–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ `LATERAL JOIN`, —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –¥—Ä—É–≥—É—é.**

‚úÖ **–ü—Ä–∏–º–µ—Ä: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ—Å—Ç –≤ –∑–∞–ª–µ, –≥–¥–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–æ–º–µ—Ä–∞ —Ä—è–¥–∞**:

```sql
SELECT row_number, seat_number  
FROM generate_series(1, 5) AS row_number  
JOIN LATERAL generate_series(1, row_number) AS seat_number ON TRUE;
```

–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:

```
row_number | seat_number
-----------+------------
1          | 1
2          | 1
2          | 2
3          | 1
3          | 2
3          | 3
...
```

üìå **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `LATERAL` –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –≤–Ω—É—Ç—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞.**

---

### **8. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –ø—è—Ç–æ–π —á–∞—Å—Ç–∏**

üìå **–û—Å–Ω–æ–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã:**

1. **–§—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã** —Å `RETURNS SETOF` –∏ `RETURNS TABLE`.
2. **–¢–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–∞–∫ –∂–µ, –∫–∞–∫ —Ç–∞–±–ª–∏—Ü—ã –≤ `FROM` –∏ `JOIN`**.
3. **–ú–æ–∂–Ω–æ –Ω—É–º–µ—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ —Å `WITH ORDINALITY`**.
4. **PostgreSQL –º–æ–∂–µ—Ç —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞—Ö** (–Ω–æ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `IMMUTABLE`).
5. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –∫ —Ñ—É–Ω–∫—Ü–∏–∏ —á–∞—Å—Ç—ã–µ, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `MATERIALIZED VIEW`**.
6. **–§—É–Ω–∫—Ü–∏–∏ –º–æ–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ `LATERAL JOIN`**, –ø–µ—Ä–µ–¥–∞–≤–∞—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–µ–∂–¥—É –Ω–∏–º–∏.

---

üîπ **–ß—Ç–æ –¥–∞–ª—å—à–µ?**  
–°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å –±—É–¥–µ—Ç –ø–æ—Å–≤—è—â–µ–Ω–∞ **–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º—É –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é: —Å–æ–∑–¥–∞–Ω–∏—é —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–Ω–∏–≥–∞–º–∏, –ø–æ–∏—Å–∫—É –¥–∞–Ω–Ω—ã—Ö –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏**. üöÄ

–ó–∞–ø—Ä–æ—Å–∏ **—Å–ª–µ–¥—É—é—â—É—é —á–∞—Å—Ç—å**, –∏ —è –ø—Ä–æ–¥–æ–ª–∂—É! üòä

