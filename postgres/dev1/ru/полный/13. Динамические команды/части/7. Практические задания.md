### **–ö–æ–Ω—Å–ø–µ–∫—Ç: –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è**

–í —ç—Ç–æ–π —á–∞—Å—Ç–∏ –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –¥–≤–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏:  
1Ô∏è‚É£ **–§—É–Ω–∫—Ü–∏—è `get_catalog()`** ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.  
2Ô∏è‚É£ **–ú–∞—Ç—Ä–∏—á–Ω—ã–π –æ—Ç—á—ë—Ç** ‚Äî —Å–ª–æ–∂–Ω—ã–π SQL-–∑–∞–ø—Ä–æ—Å —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å—Ç—Ä–æ–∫ –∏ —Å—Ç–æ–ª–±—Ü–æ–≤.

---

## **1. –§—É–Ω–∫—Ü–∏—è `get_catalog()` ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π SQL-–∑–∞–ø—Ä–æ—Å**

üìå **–ó–∞–¥–∞—á–∞:**

- –ù–∞–ø–∏—Å–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `get_catalog()`, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
- –ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å—Å—è **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏**, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.
- –î–æ–ª–∂–Ω—ã —É—á–∏—Ç—ã–≤–∞—Ç—å—Å—è —Ä–∞–∑–ª–∏—á–Ω—ã–µ **—Ñ–∏–ª—å—Ç—Ä—ã** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∫–Ω–∏–≥–∏, —Ü–µ–Ω–∞, –∞–≤—Ç–æ—Ä).
- –§—É–Ω–∫—Ü–∏—è **–Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É—è–∑–≤–∏–º–∞ –¥–ª—è SQL-–∏–Ω—ä–µ–∫—Ü–∏–π**.

---

### **1.1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `books`**

–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ `books`:

```sql
CREATE TABLE books (
    id SERIAL PRIMARY KEY,
    title TEXT,
    author TEXT,
    category TEXT,
    price NUMERIC
);
```

---

### **1.2. –ü—Ä–∏–º–µ—Ä —É—è–∑–≤–∏–º–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û!)**

```sql
CREATE FUNCTION get_catalog(category TEXT, max_price NUMERIC) RETURNS SETOF books AS $$
DECLARE
    query TEXT;
BEGIN
    query := 'SELECT * FROM books WHERE 1=1';

    IF category IS NOT NULL THEN
        query := query || ' AND category = ''' || category || '''';
    END IF;

    IF max_price IS NOT NULL THEN
        query := query || ' AND price <= ' || max_price;
    END IF;

    RETURN QUERY EXECUTE query;
END;
$$ LANGUAGE plpgsql;
```

‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞:**

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ (`||`), –∏–∑-–∑–∞ —á–µ–≥–æ –≤–æ–∑–º–æ–∂–Ω—ã SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏.
- –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å `category = '''; DROP TABLE books; --'`, —Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞!

---

### **1.3. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û!)**

–ò—Å–ø–æ–ª—å–∑—É–µ–º `USING` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:

```sql
CREATE FUNCTION get_catalog(category TEXT, max_price NUMERIC) RETURNS SETOF books AS $$
DECLARE
    query TEXT := 'SELECT * FROM books WHERE 1=1';
    param_list TEXT[] := ARRAY[]::TEXT[];  -- –ú–∞—Å—Å–∏–≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
BEGIN
    IF category IS NOT NULL THEN
        query := query || ' AND category = $' || array_length(param_list, 1) + 1;
        param_list := param_list || category;
    END IF;

    IF max_price IS NOT NULL THEN
        query := query || ' AND price <= $' || array_length(param_list, 1) + 1;
        param_list := param_list || max_price::TEXT;
    END IF;

    RETURN QUERY EXECUTE query USING unpack(param_list);
END;
$$ LANGUAGE plpgsql;
```

üìå **–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å?**

- **–ò—Å–ø–æ–ª—å–∑—É–µ–º `USING`** ‚Üí SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã.
- **–ú–∞—Å—Å–∏–≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ `param_list`** ‚Üí –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
- **–§—É–Ω–∫—Ü–∏—è `array_length()`** ‚Üí —É–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä–∞–º–∏ `$1`, `$2`, `$3` –∏ —Ç.–¥.

‚úÖ **–¢–µ–ø–µ—Ä—å –¥–∞–∂–µ –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å `category = '''; DROP TABLE books; --'`, SQL-–∏–Ω—ä–µ–∫—Ü–∏—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.**

---

## **2. –ú–∞—Ç—Ä–∏—á–Ω—ã–π –æ—Ç—á—ë—Ç (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤)**

üìå **–ó–∞–¥–∞—á–∞:**

- –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π SQL-–∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ **—Ç–∞–±–ª–∏—á–Ω–æ–º (–º–∞—Ç—Ä–∏—á–Ω–æ–º) –≤–∏–¥–µ**.
- **–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –∏ —Å—Ç–æ–ª–±—Ü–æ–≤**:
    - –°—Ç—Ä–æ–∫–∏ ‚Äî **—Å—Ö–µ–º—ã –ë–î**.
    - –°—Ç–æ–ª–±—Ü—ã ‚Äî **–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —Å–æ–∑–¥–∞–≤—à–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏**.
    - –í —è—á–µ–π–∫–∞—Ö ‚Äî **–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ—É–Ω–∫—Ü–∏–π –≤ –∫–∞–∂–¥–æ–π —Å—Ö–µ–º–µ –æ—Ç –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**.

---

### **2.1. –ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**

|–°—Ö–µ–º–∞|user1|user2|user3|
|---|---|---|---|
|public|12|5|8|
|auth|3|2|6|
|logs|7|9|4|

–ì–¥–µ:

- `public`, `auth`, `logs` ‚Äî –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ö–µ–º.
- `user1`, `user2`, `user3` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —Å–æ–∑–¥–∞–≤—à–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏.
- –í —è—á–µ–π–∫–∞—Ö ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ—É–Ω–∫—Ü–∏–π, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—â–∏—Ö –¥–∞–Ω–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –¥–∞–Ω–Ω–æ–π —Å—Ö–µ–º–µ.

---

### **2.2. –®–∞–≥–∏ —Ä–µ—à–µ–Ω–∏—è**

1Ô∏è‚É£ **–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–æ–∑–¥–∞–≤—à–∏—Ö —Ñ—É–Ω–∫—Ü–∏–∏**

```sql
SELECT DISTINCT pg_proc.proowner::regrole::text 
FROM pg_proc;
```

2Ô∏è‚É£ **–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å—Ö–µ–º**

```sql
SELECT DISTINCT nspname FROM pg_namespace;
```

3Ô∏è‚É£ **–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π SQL-–∑–∞–ø—Ä–æ—Å —Å `crosstab()`**

- –ò—Å–ø–æ–ª—å–∑—É–µ–º `crosstab()` –∏–∑ `tablefunc`, —á—Ç–æ–±—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª–±—Ü—ã.
- `crosstab()` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞:
    - –ü–µ—Ä–≤—ã–π ‚Äî **–¥–∞–Ω–Ω—ã–µ** (`schema_name`, `user`, `count`).
    - –í—Ç–æ—Ä–æ–π ‚Äî **—Å–ø–∏—Å–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤** (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ `FORMAT()`).

---

### **2.3. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π SQL-–∫–æ–¥**

```sql
DO $$ 
DECLARE 
    col_list TEXT := '';  -- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è crosstab
    sql_query TEXT;
BEGIN 
    -- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    SELECT string_agg(DISTINCT format('%I TEXT', proowner::regrole::text), ', ')
    INTO col_list
    FROM pg_proc;

    -- –°–æ–∑–¥–∞—ë–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
    sql_query := FORMAT(
        'SELECT * FROM crosstab(
            $$SELECT nspname, proowner::regrole::text, COUNT(*) 
              FROM pg_proc 
              JOIN pg_namespace ON pg_proc.pronamespace = pg_namespace.oid 
              GROUP BY 1,2 ORDER BY 1,2$$
        ) AS t (schema_name TEXT, %s);', 
        col_list
    );

    -- –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
    EXECUTE sql_query;
END $$;
```

---

### **2.4. –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?**

‚úÖ **–§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** ‚Üí `col_list`.  
‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–µ–º `FORMAT()` –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤**.  
‚úÖ **–í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ `EXECUTE`**.

---

## **3. –ò—Ç–æ–≥: –ß–µ–º—É –Ω–∞—É—á–∏–ª–∏—Å—å?**

|–ó–∞–¥–∞—á–∞|–†–µ—à–µ–Ω–∏–µ|
|---|---|
|**–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ `SELECT` —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏**|`get_catalog()` —Å `USING`|
|**–ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π**|`quote_ident()`, `quote_literal()`, `FORMAT()`|
|**–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç—Ä–∏—á–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞**|`crosstab()` –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å—Ç–æ–ª–±—Ü—ã|

‚úÖ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º SQL, –∏–∑–±–µ–≥–∞—è SQL-–∏–Ω—ä–µ–∫—Ü–∏–π –∏ –æ—à–∏–±–æ–∫.

---

üëâ **–ü–æ—Å–ª–µ–¥–Ω—è—è —á–∞—Å—Ç—å: –ó–∞–∫–ª—é—á–µ–Ω–∏–µ (–∏—Ç–æ–≥–∏ –≤–∏–¥–µ–æ).** –ì–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å?

