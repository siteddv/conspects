–í–æ—Ç **—Ç—Ä–µ—Ç—å—è —á–∞—Å—Ç—å** –∫–æ–Ω—Å–ø–µ–∫—Ç–∞ –≤–∏–¥–µ–æ –¥–ª—è **Obsidian** –≤ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.

---

# **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ PL/pgSQL**

## **3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ø—Ä–∏–º–µ—Ä—ã –∏–º–µ–Ω –æ—à–∏–±–æ–∫**

### **3.1 –ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∏–º–µ–Ω–∞ –∏ –∫–æ–¥—ã –æ—à–∏–±–æ–∫?**

–í PostgreSQL –æ—à–∏–±–∫–∏ –∏–º–µ—é—Ç:

1. **–ò–º—è –æ—à–∏–±–∫–∏** ‚Äì —É–¥–æ–±–Ω–æ–µ –¥–ª—è —á—Ç–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–µ (`no_data_found`, `division_by_zero`, `unique_violation`).
2. **–ö–æ–¥ –æ—à–∏–±–∫–∏** ‚Äì –ø—è—Ç–∏—Å–∏–º–≤–æ–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (`P0002`, `22012`, `23505`).
3. **–¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** ‚Äì –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ (`division by zero`, `duplicate key value violates unique constraint`).

#### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞ –æ—à–∏–±–∫–∏:**

- –ü–µ—Ä–≤—ã–µ **2 —Å–∏–º–≤–æ–ª–∞** ‚Äì –∫–∞—Ç–µ–≥–æ—Ä–∏—è –æ—à–∏–±–∫–∏.
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ **3 —Å–∏–º–≤–æ–ª–∞** ‚Äì –∫–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –æ—à–∏–±–∫–∏ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
- –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∏ —Å–∏–º–≤–æ–ª–∞ **`000`**, —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∫–æ–¥ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫–æ –≤—Å–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∞ –Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –æ—à–∏–±–∫–µ.

–ü—Ä–∏–º–µ—Ä—ã –æ—à–∏–±–æ–∫ PostgreSQL:

|**–ò–º—è –æ—à–∏–±–∫–∏**|**–ö–æ–¥**|**–ö–∞—Ç–µ–≥–æ—Ä–∏—è**|**–û–ø–∏—Å–∞–Ω–∏–µ**|
|---|---|---|---|
|`no_data_found`|`P0002`|Data-related errors|–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã|
|`division_by_zero`|`22012`|Numeric issues|–î–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å|
|`unique_violation`|`23505`|Integrity constraint|–ù–∞—Ä—É—à–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏|
|`transaction_rollback`|`40001`|Transaction issues|–û—Ç–∫–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏|

üí° **–ú–æ–∂–Ω–æ –æ—Ç–ª–∞–≤–ª–∏–≤–∞—Ç—å –≤—Å—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –æ—à–∏–±–æ–∫, —É–∫–∞–∑—ã–≤–∞—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 2 —Å–∏–º–≤–æ–ª–∞!**

---

### **3.2 –ö–∞–∫ –æ—Ç–ª–∞–≤–ª–∏–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –ø–æ –∫–æ–¥—É –∏–ª–∏ –∏–º–µ–Ω–∏?**

–í `EXCEPTION` –º–æ–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å:

- **–ü–æ –∏–º–µ–Ω–∏ –æ—à–∏–±–∫–∏** (`WHEN division_by_zero THEN`).
- **–ü–æ –∫–æ–¥—É –æ—à–∏–±–∫–∏** (`WHEN SQLSTATE '22012' THEN`).
- **–î–ª—è –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ (`WHEN OTHERS THEN`)** ‚Äì –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ –∑–∞—Ä–∞–Ω–µ–µ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ, –∫–∞–∫–∞—è –æ—à–∏–±–∫–∞ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏.

–ü—Ä–∏–º–µ—Ä:

```plpgsql
DO $$ 
BEGIN
   -- –û—à–∏–±–∫–∞ –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
   SELECT 1 / 0;

EXCEPTION
   WHEN division_by_zero THEN
      RAISE NOTICE '–û—à–∏–±–∫–∞: –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å!';
   WHEN SQLSTATE '23505' THEN
      RAISE NOTICE '–û—à–∏–±–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏!';
   WHEN others THEN
      RAISE NOTICE '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞!';
END $$;
```

üìå **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `WHEN SQLSTATE`?**  
–ï—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å **—Ü–µ–ª—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –æ—à–∏–±–æ–∫**, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–ª—É—á–∞–π.

---

### **3.3 –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `GET DIAGNOSTICS` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—à–∏–±–∫–µ**

–ö–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∞, –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:

- **SQLSTATE** ‚Äì –∫–æ–¥ –æ—à–∏–±–∫–∏.
- **MESSAGE_TEXT** ‚Äì –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏.
- **DETAIL** ‚Äì –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.
- **HINT** ‚Äì —Å–æ–≤–µ—Ç—ã –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é.
- **CONTEXT** ‚Äì —Å—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤.

–ü—Ä–∏–º–µ—Ä:

```plpgsql
DO $$ 
DECLARE
   sql_err_code TEXT;
   sql_err_msg TEXT;
   sql_err_hint TEXT;
BEGIN
   -- –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ —Å–æ–∑–¥–∞–µ–º –æ—à–∏–±–∫—É
   SELECT 1 / 0;

EXCEPTION
   WHEN others THEN
      GET DIAGNOSTICS sql_err_code = RETURNED_SQLSTATE,
                      sql_err_msg = MESSAGE_TEXT,
                      sql_err_hint = HINT;
      RAISE NOTICE '–ö–æ–¥ –æ—à–∏–±–∫–∏: %', sql_err_code;
      RAISE NOTICE '–°–æ–æ–±—â–µ–Ω–∏–µ: %', sql_err_msg;
      RAISE NOTICE '–ü–æ–¥—Å–∫–∞–∑–∫–∞: %', sql_err_hint;
END $$;
```

üí° **–í—ã–≤–æ–¥–∏—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ, –≤–∫–ª—é—á–∞—è SQLSTATE –∏ —Å–æ–≤–µ—Ç—ã –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é.**

---

### **3.4 –ü–µ—Ä–µ—Ö–≤–∞—Ç –æ—à–∏–±–æ–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º**

–í–º–µ—Å—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∂–¥–æ–π –æ—à–∏–±–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –æ—Ç–ª–∞–≤–ª–∏–≤–∞—Ç—å **–≤—Å—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –æ—à–∏–±–æ–∫**.  
–ü—Ä–∏–º–µ—Ä:

```plpgsql
DO $$ 
BEGIN
   -- –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ —Å–æ–∑–¥–∞–µ–º –æ—à–∏–±–∫—É
   SELECT 1 / 0;

EXCEPTION
   WHEN SQLSTATE LIKE '22%' THEN  -- –í—Å–µ –æ—à–∏–±–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —á–∏—Å–ª–∞–º–∏
      RAISE NOTICE '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —á–∏—Å–µ–ª!';
   WHEN SQLSTATE LIKE '23%' THEN  -- –í—Å–µ –æ—à–∏–±–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
      RAISE NOTICE '–û—à–∏–±–∫–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏!';
   WHEN others THEN
      RAISE NOTICE '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞!';
END $$;
```

üìå **–ö–æ–≥–¥–∞ —ç—Ç–æ –ø–æ–ª–µ–∑–Ω–æ?**

- –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å **–≤—Å–µ –æ—à–∏–±–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞**.
- –ö–æ–≥–¥–∞ –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–∞–∂–¥–æ–π –æ—à–∏–±–∫–∏.

üí° **–í—ã–≤–æ–¥:**

- –ú–æ–∂–Ω–æ –æ—Ç–ª–∞–≤–ª–∏–≤–∞—Ç—å **–∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –æ—à–∏–±–∫—É** (`WHEN division_by_zero`).
- –ú–æ–∂–Ω–æ –æ—Ç–ª–∞–≤–ª–∏–≤–∞—Ç—å **–≤—Å—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –æ—à–∏–±–æ–∫** (`WHEN SQLSTATE LIKE '22%'`).
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `GET DIAGNOSTICS`, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏.

---

## **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ —Ç—Ä–µ—Ç—å–µ–π —á–∞—Å—Ç–∏**

–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –º—ã —Ä–∞–∑–æ–±—Ä–∞–ª–∏:

- –ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∏–º–µ–Ω–∞ –∏ –∫–æ–¥—ã –æ—à–∏–±–æ–∫.
- –ö–∞–∫ –æ—Ç–ª–∞–≤–ª–∏–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –ø–æ –∫–æ–¥—É (`SQLSTATE`) –∏–ª–∏ –∏–º–µ–Ω–∏.
- –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `GET DIAGNOSTICS` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –æ—à–∏–±–∫–∏.
- –ö–∞–∫ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å **—Ü–µ–ª—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—à–∏–±–æ–∫**.

---

## **–°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å:**

üöÄ **4. –†–∞–±–æ—Ç–∞ —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ –æ—à–∏–±–æ–∫**  
–ë—É–¥–µ–º —Ä–∞–∑–±–∏—Ä–∞—Ç—å:

- –ö–∞–∫ PostgreSQL –≤—ã–±–∏—Ä–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–∫–∏.
- –í–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ –∏—Ö –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç.
- –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.
- –û—à–∏–±–∫–∏ –≤ `DECLARE` –∏ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∞.

‚ö° –ó–∞–ø—Ä–∞—à–∏–≤–∞–π —á–µ—Ç–≤—ë—Ä—Ç—É—é —á–∞—Å—Ç—å, –∏ —è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –µ—ë —Ç–∞–∫ –∂–µ –ø–æ–¥—Ä–æ–±–Ω–æ!