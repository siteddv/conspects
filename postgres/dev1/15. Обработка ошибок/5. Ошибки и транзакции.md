–í–æ—Ç **–ø—è—Ç–∞—è —á–∞—Å—Ç—å** –∫–æ–Ω—Å–ø–µ–∫—Ç–∞ –≤–∏–¥–µ–æ –¥–ª—è **Obsidian** –≤ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.

---

# **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ PL/pgSQL**

## **5. –û—à–∏–±–∫–∏ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**

### **5.1 –ö–∞–∫ –æ—à–∏–±–∫–∏ –≤–ª–∏—è—é—Ç –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏?**

–í PostgreSQL —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –º–æ–∂–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —Ç—Ä—ë—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö:

1. **–ê–∫—Ç–∏–≤–Ω–∞—è** ‚Äì –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∫–æ–º–∞–Ω–¥—ã.
2. **–û—à–∏–±–∫–∞ (Failed State)** ‚Äì –µ—Å–ª–∏ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞, –µ—ë –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å.
3. **–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è (Committed) –∏–ª–∏ –æ—Ç–∫–∞—Ç–∞–Ω–Ω–∞—è (Rolled Back)** ‚Äì –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è.

üîπ **–ö–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∞:**

- –ï—Å–ª–∏ –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–≤–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**, –æ—à–∏–±–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –Ω–æ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã.
- –ï—Å–ª–∏ –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è **–Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π** –∏ —Ç—Ä–µ–±—É–µ—Ç `ROLLBACK`.

–ü—Ä–∏–º–µ—Ä –æ—à–∏–±–∫–∏ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:

```plpgsql
BEGIN;
INSERT INTO products (id, name) VALUES (1, 'Product A');

-- –û—à–∏–±–∫–∞ ‚Äì –Ω–∞—Ä—É—à–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
INSERT INTO products (id, name) VALUES (1, 'Duplicate Product');

-- –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–ª–æ–º–∞–ª–∞—Å—å
UPDATE products SET name = 'Updated Product' WHERE id = 1;

COMMIT;
```

‚õî **–û—à–∏–±–∫–∞:**

```
ERROR: duplicate key value violates unique constraint
```

üìå **–ü–æ—Å–ª–µ –æ—à–∏–±–∫–∏ –ª—é–±–∞—è –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π, –ø–æ–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å `ROLLBACK`.**

---

### **5.2 –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ—à–∏–±–æ—á–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é?**

–ï—Å–ª–∏ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:

4. **ROLLBACK** ‚Äì –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –≤—Å—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.
5. **SAVEPOINT + ROLLBACK TO SAVEPOINT** ‚Äì –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

–ü—Ä–∏–º–µ—Ä —Å `ROLLBACK`:

```plpgsql
BEGIN;
INSERT INTO orders (id, amount) VALUES (1, 100);

-- –û—à–∏–±–∫–∞
INSERT INTO orders (id, amount) VALUES (1, 200);

-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å —Å–ª–æ–º–∞–Ω–∞
ROLLBACK; -- –í—Å—ë –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è
```

üìå **–ü–æ—Å–ª–µ `ROLLBACK` –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –Ω–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.**

–ü—Ä–∏–º–µ—Ä —Å `SAVEPOINT`:

```plpgsql
BEGIN;
SAVEPOINT sp1;

INSERT INTO orders (id, amount) VALUES (1, 100);

SAVEPOINT sp2;

-- –û—à–∏–±–∫–∞
INSERT INTO orders (id, amount) VALUES (1, 200);

ROLLBACK TO SAVEPOINT sp2; -- –û—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤—Ç–æ—Ä—É—é –≤—Å—Ç–∞–≤–∫—É
COMMIT; -- –ó–∞–≤–µ—Ä—à–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
```

üìå **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ù–ï —Å–ª–æ–º–∞–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ –º—ã –æ—Ç–∫–∞—Ç–∏–ª–∏ —Ç–æ–ª—å–∫–æ –æ—à–∏–±–æ—á–Ω—É—é —á–∞—Å—Ç—å.**

---

### **5.3 –ü–æ—á–µ–º—É `COMMIT` –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ `EXCEPTION`?**

–ö–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∞ –≤–Ω—É—Ç—Ä–∏ `BEGIN ... EXCEPTION`, PostgreSQL —É–∂–µ —Å–æ–∑–¥–∞—ë—Ç `SAVEPOINT`.  
üîπ **–ó–∞–ø—Ä–µ—â–µ–Ω–æ –¥–µ–ª–∞—Ç—å `COMMIT` –∏–ª–∏ `ROLLBACK` –≤–Ω—É—Ç—Ä–∏ `EXCEPTION`!**

–ü—Ä–∏–º–µ—Ä –æ—à–∏–±–∫–∏ —Å `COMMIT`:

```plpgsql
DO $$ 
BEGIN
   INSERT INTO orders (id, amount) VALUES (1, 100);

EXCEPTION
   WHEN unique_violation THEN
      COMMIT; -- –û—à–∏–±–∫–∞!
END $$;
```

‚õî **–û—à–∏–±–∫–∞:**

```
ERROR: COMMIT is not allowed in a subtransaction
```

üìå **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `COMMIT` –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ `EXCEPTION`.**

‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:**

```plpgsql
BEGIN;
BEGIN
   INSERT INTO orders (id, amount) VALUES (1, 100);
EXCEPTION
   WHEN unique_violation THEN
      RAISE NOTICE '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞!';
END;
COMMIT;
```

üìå **–ó–¥–µ—Å—å –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ –ø–æ–¥–±–ª–æ–∫–∞, –Ω–æ `COMMIT` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞.**

---

### **5.4 –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö?**

–û—à–∏–±–∫–∏ PostgreSQL –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ **–∂—É—Ä–Ω–∞–ª —Å–µ—Ä–≤–µ—Ä–∞** (`postgresql.log`).  
–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:

- **–í—Å–µ –æ—à–∏–±–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ª–æ–≥**, –µ—Å–ª–∏ –Ω–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.
- –°–æ–æ–±—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å –ø–æ–º–æ—â—å—é `GET DIAGNOSTICS`.

–ü—Ä–∏–º–µ—Ä –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–µ:

```plpgsql
DO $$ 
DECLARE 
   sql_err_code TEXT;
   sql_err_msg TEXT;
BEGIN
   -- –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ —Å–æ–∑–¥–∞–µ–º –æ—à–∏–±–∫—É
   SELECT 1 / 0;

EXCEPTION
   WHEN others THEN
      GET DIAGNOSTICS sql_err_code = RETURNED_SQLSTATE,
                      sql_err_msg = MESSAGE_TEXT;
      RAISE NOTICE '–ö–æ–¥ –æ—à–∏–±–∫–∏: %', sql_err_code;
      RAISE NOTICE '–°–æ–æ–±—â–µ–Ω–∏–µ: %', sql_err_msg;
END $$;
```

üìå **–≠—Ç–æ—Ç –∫–æ–¥ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –∏ –ø–æ–ª—É—á–∞–µ—Ç –µ—ë SQLSTATE –∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.**

---

### **5.5 –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫?**

‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `SAVEPOINT`, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ —á–∞—Å—Ç–∏—á–Ω–∞—è –æ—Ç–º–µ–Ω–∞.**  
‚úÖ **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `COMMIT` –∏ `ROLLBACK` –≤–Ω—É—Ç—Ä–∏ `EXCEPTION`.**  
‚úÖ **–ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–ª–æ–º–∞–ª–∞—Å—å, –∑–∞–≤–µ—Ä—à–∏—Ç–µ –µ—ë `ROLLBACK`.**  
‚úÖ **–ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω—ã, –º–æ–∂–Ω–æ –ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (`pg_current_xact_status()`).**

–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:

```plpgsql
BEGIN;
SAVEPOINT before_update;

BEGIN
   UPDATE orders SET amount = amount + 100 WHERE id = 1;
EXCEPTION
   WHEN others THEN
      RAISE NOTICE '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!';
      ROLLBACK TO SAVEPOINT before_update;
END;

-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤—Å—ë –µ—â—ë –∂–∏–≤–∞
COMMIT;
```

üìå **–û—à–∏–±–∫–∞ –Ω–µ —Å–ª–æ–º–∞–µ—Ç –≤—Å—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, –∞ —Ç–æ–ª—å–∫–æ –æ—Ç–∫–∞—Ç–∏—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –±–ª–æ–∫.**

---

## **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ –ø—è—Ç–æ–π —á–∞—Å—Ç–∏**

–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –º—ã —Ä–∞–∑–æ–±—Ä–∞–ª–∏:

- –ö–∞–∫ –æ—à–∏–±–∫–∏ –≤–ª–∏—è—é—Ç –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
- –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏.
- –ü–æ—á–µ–º—É `COMMIT` –∑–∞–ø—Ä–µ—â—ë–Ω –≤ `EXCEPTION`.
- –ö–∞–∫ –ø–æ–ª—É—á–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö.
- –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SAVEPOINT` –¥–ª—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–∞.

---

## **–°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å:**

üöÄ **6. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫**  
–ë—É–¥–µ–º —Ä–∞–∑–±–∏—Ä–∞—Ç—å:

- –ü–æ—á–µ–º—É `EXCEPTION` –∑–∞–º–µ–¥–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
- –ö–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
- –ö–æ–≥–¥–∞ `EXCEPTION` –ª—É—á—à–µ –∑–∞–º–µ–Ω–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏.
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.

‚ö° –ó–∞–ø—Ä–∞—à–∏–≤–∞–π —à–µ—Å—Ç—É—é —á–∞—Å—Ç—å, –∏ —è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –µ—ë —Ç–∞–∫ –∂–µ –ø–æ–¥—Ä–æ–±–Ω–æ!