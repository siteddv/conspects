Часть 2: Транзакции в PostgreSQL

1. Введение в транзакции

Транзакции — это основа надежной работы с базами данных. Они позволяют выполнять несколько операций с данными как единое целое, гарантируя их согласованность и целостность.

PostgreSQL поддерживает транзакции, следуя ACID-принципам:

Атомарность (Atomicity) — транзакция выполняется полностью или не выполняется вовсе.

Согласованность (Consistency) — после выполнения транзакции данные остаются в согласованном состоянии.

Изоляция (Isolation) — транзакции не мешают друг другу.

Долговечность (Durability) — после завершения транзакции изменения сохраняются, даже в случае сбоя системы.



---

2. Работа транзакций в PostgreSQL

2.1 Этапы выполнения транзакции

1. Начало транзакции. Команда BEGIN или START TRANSACTION.


2. Выполнение SQL-запросов. Вставка, удаление, изменение данных.


3. Фиксация изменений. Команда COMMIT сохраняет изменения.


4. Откат изменений. Команда ROLLBACK отменяет все изменения в транзакции.



Пример:

BEGIN;  -- Начинаем транзакцию
INSERT INTO accounts (id, balance) VALUES (1, 1000);
UPDATE accounts SET balance = balance - 200 WHERE id = 1;
COMMIT;  -- Фиксируем изменения

Если что-то пошло не так, можно выполнить:

ROLLBACK;  -- Отменяем изменения

2.2 Почему нужна атомарность?

Допустим, нам нужно перевести деньги со счета A на счет B:

BEGIN;
UPDATE accounts SET balance = balance - 500 WHERE id = 1;
UPDATE accounts SET balance = balance + 500 WHERE id = 2;
COMMIT;

Если система сломается между двумя UPDATE, мы получим несогласованные данные. Атомарность гарантирует, что либо вся операция выполнится, либо ничего не изменится.


---

3. Автоматическая и явная фиксация транзакций

3.1 Режим auto-commit

По умолчанию PostgreSQL работает в режиме автофиксации (auto-commit): каждая команда автоматически фиксируется сразу после выполнения.

Пример (режим auto-commit включен):

INSERT INTO users (name) VALUES ('Alice');  -- Сразу фиксируется

То же самое с UPDATE и DELETE.

3.2 Явное управление транзакциями

Если нам нужно выполнить несколько команд в рамках одной транзакции, используем BEGIN и COMMIT:

BEGIN;
INSERT INTO orders (id, status) VALUES (1, 'pending');
UPDATE inventory SET stock = stock - 1 WHERE product_id = 5;
COMMIT;

Пока мы не напишем COMMIT, данные остаются внутри транзакции и не видны другим.


---

4. Точки сохранения (SAVEPOINT)

Иногда нужно отменить часть изменений, но сохранить остальную часть транзакции. Для этого используются точки сохранения (savepoints).

Пример:

BEGIN;
INSERT INTO users (name) VALUES ('Alice');
SAVEPOINT sp1;
INSERT INTO users (name) VALUES ('Bob');
ROLLBACK TO SAVEPOINT sp1;  -- Отменяем только вставку "Bob"
COMMIT;  -- "Alice" остается в базе

ROLLBACK TO SAVEPOINT отменяет изменения после точки сохранения, но не откатывает всю транзакцию.


---

5. Изоляция транзакций

Изоляция важна, когда несколько транзакций выполняются одновременно. PostgreSQL использует MVCC (многоверсионный контроль параллельности), который позволяет транзакциям работать независимо.

Есть 4 уровня изоляции:

1. Read Uncommitted – транзакции могут видеть незавершенные изменения других (не используется в PostgreSQL).


2. Read Committed (по умолчанию) – каждая транзакция видит только зафиксированные данные.


3. Repeatable Read – все данные остаются неизменными в рамках одной транзакции.


4. Serializable – полная изоляция, транзакции выполняются последовательно.



Пример работы Read Committed:

Session 1:
BEGIN;
UPDATE products SET price = 200 WHERE id = 1;

Session 2:
SELECT price FROM products WHERE id = 1;  -- Видим старую цену

Session 1:
COMMIT;

Session 2:
SELECT price FROM products WHERE id = 1;  -- Видим новую цену

Транзакция во втором сеансе не видит изменения, пока оно не зафиксировано.


---

6. Итоги второй части

Транзакции позволяют выполнять операции с базой данных безопасно и согласованно.

PostgreSQL поддерживает ACID-принципы: атомарность, согласованность, изоляция, долговечность.

По умолчанию PostgreSQL работает в режиме auto-commit.

Использование BEGIN, COMMIT, ROLLBACK позволяет управлять транзакциями.

SAVEPOINT позволяет откатывать часть транзакции.

Уровни изоляции управляют конкурентным доступом к данным.



---

Что дальше?

Следующая часть будет посвящена обработке SQL-запросов в PostgreSQL, включая разбор, оптимизацию и работу планировщика. Готов продолжить?

