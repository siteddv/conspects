### **Конспект второй логической части: Определение функций в SQL (на примере PostgreSQL)**

---

#### **1. Создание функций с `CREATE FUNCTION`**

В PostgreSQL функции создаются с помощью оператора **`CREATE FUNCTION`**.

##### **Общий синтаксис создания функции:**

```sql
CREATE FUNCTION имя_функции(параметры) 
RETURNS тип_возвращаемого_значения 
AS $$
  -- тело функции
$$ LANGUAGE язык;
```

- `имя_функции` — имя создаваемой функции.
- `параметры` — входные параметры (если есть).
- `RETURNS` — указывает тип возвращаемого значения.
- `$$ ... $$` — способ задания многострочного текста функции.
- `LANGUAGE` — язык, на котором написана функция (например, SQL, PL/pgSQL, C и др.).

---

#### **2. Пример самой простой функции**

Простейшая функция, которая возвращает строку `"Hello, world!"`:

```sql
CREATE FUNCTION hello() RETURNS text 
AS $$
  SELECT 'Hello, world!';
$$ LANGUAGE sql;
```

- Вызов функции:
    
    ```sql
    SELECT hello();
    ```
    
    **Результат:**
    
    ```
      hello    
    ------------
     Hello, world!
    ```
    
- **Важно:** Если в теле функции один SQL-запрос, его можно просто написать после `AS $$`.

---

#### **3. Использование строковых констант с `$$`**

- PostgreSQL поддерживает **альтернативные способы задания строк** с помощью двойного знака `$`:
    
    ```sql
    SELECT $$Hello, world!$$;
    ```
    
    **Результат:**
    
    ```
      ?column?    
    --------------
     Hello, world!
    ```
    
- Это удобно, если строка содержит кавычки (`'`), так как не нужно их экранировать:
    
    ```sql
    SELECT $$I'm learning SQL$$;
    ```
    
- Можно использовать **именованные разделители**, если требуется вложенная строка:
    
    ```sql
    CREATE FUNCTION example() RETURNS text AS $func$
      SELECT $$Это "цитата" внутри строки$$;
    $func$ LANGUAGE sql;
    ```
    

---

#### **4. Передача параметров в функции**

Функции могут принимать параметры:

```sql
CREATE FUNCTION greet(name text) RETURNS text 
AS $$
  SELECT 'Hello, ' || name || '!';
$$ LANGUAGE sql;
```

- Вызов с параметром:
    
    ```sql
    SELECT greet('Alice');
    ```
    
    **Результат:**
    
    ```
      greet     
    ------------
     Hello, Alice!
    ```
    

##### **Передача нескольких параметров**

```sql
CREATE FUNCTION add_numbers(a int, b int) RETURNS int 
AS $$
  SELECT a + b;
$$ LANGUAGE sql;
```

- Вызов:
    
    ```sql
    SELECT add_numbers(10, 20);
    ```
    
    **Результат:**
    
    ```
     add_numbers 
    -------------
         30
    ```
    

##### **Передача параметров без имен**

Можно объявлять параметры **без имен**:

```sql
CREATE FUNCTION multiply(int, int) RETURNS int 
AS $$
  SELECT $1 * $2;
$$ LANGUAGE sql;
```

- Вызов:
    
    ```sql
    SELECT multiply(4, 5);
    ```
    
    **Результат:**
    
    ```
     multiply 
    ----------
         20
    ```
    

---

#### **5. Различные способы задания параметров**

- Входные параметры можно задавать с модификатором **`IN`** (по умолчанию).
- Можно указать **значение по умолчанию**:
    
    ```sql
    CREATE FUNCTION power(base int, exponent int DEFAULT 2) RETURNS int 
    AS $$
      SELECT base ^ exponent;
    $$ LANGUAGE sql;
    ```
    
    - Вызов с двумя параметрами:
        
        ```sql
        SELECT power(3, 3); -- 3^3 = 27
        ```
        
    - Вызов с одним параметром (используется значение `DEFAULT`):
        
        ```sql
        SELECT power(4); -- 4^2 = 16
        ```
        

##### **Передача параметров по имени**

Можно передавать параметры по **позиции** или **по имени**:

```sql
SELECT power(3, exponent => 4);
```

- Это удобно, если у функции много параметров.

---

#### **6. Вызов функций в SQL-запросах**

Функции можно использовать в:

- `SELECT`:
    
    ```sql
    SELECT greet('John');
    ```
    
- `WHERE`:
    
    ```sql
    SELECT * FROM users WHERE get_age(birth_date) > 30;
    ```
    
- `INSERT`:
    
    ```sql
    INSERT INTO log (message) VALUES (greet('Admin'));
    ```
    
- `UPDATE`:
    
    ```sql
    UPDATE products SET price = discount(price, 10);
    ```
    
- `ORDER BY`:
    
    ```sql
    SELECT * FROM employees ORDER BY get_salary(department);
    ```
    

---

### **Выводы по второй части**

1. **Функции создаются с `CREATE FUNCTION`** и могут принимать параметры.
2. **Язык SQL позволяет писать простые функции** без логики, требующей процедурного программирования.
3. **Строковые константы удобно задавать через `$$`**, чтобы избежать экранирования кавычек.
4. **Параметры можно передавать позиционно или по имени**.
5. **Функции можно использовать в любых частях SQL-запросов**.

---

Готов двигаться дальше? Следующая часть будет про **параметры функций и их использование**.