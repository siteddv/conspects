### **Конспект первой логической части: Введение в тему функций**

---

#### **1. Общая информация о функциях**

- Функции — это фундаментальная концепция как в программировании, так и в реальной жизни.
- Они позволяют **разделять сложные задачи** на отдельные части, что упрощает разработку и поддержку кода.
- В программировании функции могут быть сгруппированы в **модули, пакеты**, а на стороне **базы данных** их можно распределять по разным **схемам**.
- Ключевые свойства функции:
    - **Имя функции**.
    - **Набор параметров** (входных, выходных).
    - **Возвращаемое значение**.
    - **Логика выполнения (тело функции)**.

---

#### **2. Зачем нужны функции на серверной стороне?**

- На стороне базы данных функции позволяют:
    - **Капсулировать бизнес-логику** и переиспользовать код.
    - **Снижать накладные расходы** при выполнении повторяющихся операций.
    - **Упрощать код SQL-запросов**, делая их более читаемыми.
    - **Скрывать сложные вычисления** за интерфейсом функции.
- Важное отличие серверных функций от обычных функций в программировании:
    - Серверные функции **могут изменять состояние базы данных**.
    - Они **могут зависеть от данных в таблицах**, что делает их поведение динамическим.

---

#### **3. Ключевые понятия, связанные с функциями**

- **Параметры функции**:
    - При вызове функции можно передавать входные параметры (`IN`).
    - Функция может возвращать результат через `RETURN` или выходные параметры (`OUT`).
    - Можно комбинировать входные и выходные параметры (`INOUT`).
- **Категория изменчивости (Volatility Categories)**:
    - Это характеристика функции, которая указывает, **как часто её результат может меняться при одинаковых входных параметрах**.
    - Категория изменчивости важна для **оптимизации запросов**, так как влияет на то, как сервер планирует их выполнение.

---

#### **4. Важное понятие — категории изменчивости функций**

Категории изменчивости помогают серверу **понять**, как часто функция может менять своё поведение:

1. **VOLATILE (изменяемая)**
    
    - Функция может возвращать **разные значения при одинаковых входных данных**.
    - Может зависеть от изменяемых данных в таблицах, времени (`NOW()`), случайных чисел (`RANDOM()`).
    - **Используется по умолчанию**.
    - Пример:
        
        ```sql
        CREATE FUNCTION get_random_number() RETURNS float AS $$
          SELECT random();
        $$ LANGUAGE sql VOLATILE;
        ```
        
    - Сервер **выполняет её каждый раз**, так как она может вернуть разный результат.
2. **STABLE (стабильная)**
    
    - Функция **не изменяет данные** в базе.
    - Может считывать данные, но результат **стабилен в рамках одного SQL-запроса**.
    - Пример:
        
        ```sql
        CREATE FUNCTION get_total_users() RETURNS integer AS $$
          SELECT COUNT(*) FROM users;
        $$ LANGUAGE sql STABLE;
        ```
        
    - В рамках одного запроса сервер **гарантирует одинаковый результат**.
3. **IMMUTABLE (неизменяемая)**
    
    - Функция **всегда возвращает одно и то же значение** для одинаковых входных данных.
    - **Не зависит от данных в базе** (работает только с переданными параметрами).
    - Может быть использована для оптимизации, так как сервер **может вычислить её заранее**.
    - Пример:
        
        ```sql
        CREATE FUNCTION square(x int) RETURNS int AS $$
          SELECT x * x;
        $$ LANGUAGE sql IMMUTABLE;
        ```
        
    - Сервер может заранее посчитать `square(4) → 16` и подставить результат вместо вызова функции.

---

#### **5. Как категории изменчивости функций влияют на оптимизацию запросов**

- Если функция `VOLATILE`, то PostgreSQL **не кэширует её результат**, а выполняет каждый раз заново.
- Если функция `STABLE`, то в рамках одного запроса результат **не изменится**, что позволяет серверу **оптимизировать выполнение**.
- Если функция `IMMUTABLE`, PostgreSQL **может заранее вычислить её результат** и подставить его в запрос, уменьшая нагрузку на выполнение.
- **Выбор правильной категории** помогает значительно **ускорить выполнение запросов** и **избежать неожиданных эффектов** при работе с данными.

---

### **Выводы по первой части**

4. Функции **помогают упрощать и структурировать код**, особенно на стороне сервера.
5. Они **принимают параметры, возвращают результат** и могут изменять данные в БД.
6. Категории изменчивости функций **определяют, насколько предсказуем результат**:
    - `VOLATILE` — результат может меняться при каждом вызове.
    - `STABLE` — результат стабилен в рамках одного запроса.
    - `IMMUTABLE` — результат стабилен всегда.
7. **Выбор правильной категории изменчивости критичен** для оптимизации запросов.

---

Если нужно, могу дополнительно раскрыть или объяснить отдельные моменты, прежде чем перейти ко второй части конспекта.