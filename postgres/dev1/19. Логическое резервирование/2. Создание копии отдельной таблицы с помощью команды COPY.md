### 2. **Создание копии отдельной таблицы с помощью команды `COPY`**

#### Основная концепция команды `COPY`

Команда `COPY` в PostgreSQL позволяет экспортировать данные из таблицы в файл или импортировать данные обратно. Она работает быстрее, чем стандартные `INSERT`, так как позволяет вставлять данные пакетами.

Формат базовой команды:

```sql
COPY table_name TO 'file_path' WITH (FORMAT format_type);
```

или

```sql
COPY table_name FROM 'file_path' WITH (FORMAT format_type);
```

- **`TO`** – экспорт данных в файл
- **`FROM`** – импорт данных из файла
- **`FORMAT`** – формат вывода (`TEXT`, `CSV`, `BINARY`)

#### Создание копии таблицы в файл

1. Чтобы экспортировать таблицу в текстовый файл:

```sql
COPY my_table TO '/tmp/my_table_dump.txt' WITH (FORMAT text);
```

Этот файл будет создан на сервере базы данных.

2. Чтобы экспортировать данные в CSV-формате:

```sql
COPY my_table TO '/tmp/my_table_dump.csv' WITH (FORMAT csv, HEADER true);
```

Этот вариант добавляет заголовки столбцов в первый ряд.

1. Можно также экспортировать только определенные столбцы:

```sql
COPY my_table (id, name, price) TO '/tmp/my_table_dump.csv' WITH (FORMAT csv, HEADER true);
```

Здесь в копию попадут только три столбца.

2. Экспорт только части данных по условию:

```sql
COPY (SELECT * FROM my_table WHERE created_at > '2024-01-01')  
TO '/tmp/my_table_dump.csv' WITH (FORMAT csv, HEADER true);
```

Этот способ полезен, если нужно скопировать только определенные данные.

#### Альтернативный способ: экспорт на клиентскую машину

Если у пользователя нет прав на запись в файловую систему сервера, можно использовать `\COPY`, которая работает на стороне клиента:

```sql
\COPY my_table TO 'C:\Users\my_table_dump.csv' WITH (FORMAT csv, HEADER true);
```

Эта команда выполняется в `psql` и сохраняет файл локально на компьютере пользователя.

#### Что происходит при экспорте данных?

После выполнения команды в файл записываются строки таблицы, где:

- **Столбцы разделяются символом-разделителем** (`,` для CSV, `TAB` для `TEXT`).
- **NULL значения заменяются специальными символами**, например `\N` для `TEXT`.
- **Спецсимволы экранируются** (например, запятые внутри значений в CSV).

Пример экспорта данных с разными разделителями и обработкой NULL-значений:

```sql
COPY my_table TO '/tmp/my_table_dump.txt' WITH (FORMAT text, DELIMITER '|', NULL 'NULL');
```

Здесь:

- Данные разделяются `|`
- NULL записываются как `NULL`

#### Вывод данных на консоль

Вместо сохранения в файл можно вывести данные сразу в консоль:

```sql
COPY my_table TO STDOUT WITH (FORMAT csv, HEADER true);
```

Этот способ полезен, если нужно быстро просмотреть резервную копию без записи в файл.

### Пример

Допустим, есть таблица `products`:

```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    price NUMERIC(10,2),
    created_at TIMESTAMP DEFAULT now()
);
INSERT INTO products (name, price) VALUES 
    ('Laptop', 1200.50),
    ('Phone', 799.99),
    ('Tablet', 499.00);
```

Экспортируем таблицу в CSV:

```sql
COPY products TO '/tmp/products.csv' WITH (FORMAT csv, HEADER true);
```

Теперь в файле `products.csv` появится:

```
id,name,price,created_at
1,Laptop,1200.50,2024-02-13 10:00:00
2,Phone,799.99,2024-02-13 10:05:00
3,Tablet,499.00,2024-02-13 10:10:00
```

Это будет полезно для импорта данных в другие системы.

---

Следующая часть будет посвящена **восстановлению данных из резервной копии с помощью `COPY`**. Продолжать?