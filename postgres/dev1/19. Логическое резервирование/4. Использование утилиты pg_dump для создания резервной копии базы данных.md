### 4. **Использование утилиты `pg_dump` для создания резервной копии базы данных**

Утилита `pg_dump` – это стандартный инструмент PostgreSQL для логического резервного копирования баз данных. Она позволяет экспортировать данные и схему в SQL-скрипт или в другие форматы (`custom`, `directory` и т. д.), что делает возможным восстановление данных в любой момент.

---

### **Основные возможности `pg_dump`**

- Создание резервной копии **в текстовом формате** (SQL-скрипт).
- Выгрузка базы **в бинарные форматы** (`custom`, `directory`) с возможностью фильтрации объектов и параллельного восстановления.
- Возможность **копирования отдельных объектов** (схем, таблиц, функций и т. д.).
- **Экспорт в SQL-формате** для последующего выполнения в `psql`.

---

### **Создание резервной копии в текстовом (SQL) формате**

Самый простой способ сделать резервную копию базы:

```sh
pg_dump -U username -d database_name -f backup.sql
```

- `-U username` – имя пользователя, выполняющего резервное копирование.
- `-d database_name` – название базы данных.
- `-f backup.sql` – файл, в который будет записана резервная копия.

Этот вариант создаст SQL-скрипт, содержащий команды `CREATE TABLE`, `INSERT INTO` и т. д. Он легко читается человеком и позволяет редактировать данные перед восстановлением.

#### **Пример содержимого SQL-резервной копии (`backup.sql`):**

```sql
-- PostgreSQL database dump
--
-- Dumped from database version 15.0
-- Dumped by pg_dump version 15.0

CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    price NUMERIC(10,2),
    created_at TIMESTAMP DEFAULT now()
);

COPY products (id, name, price, created_at) FROM stdin;
1	Laptop	1200.50	2024-02-13 10:00:00
2	Phone	799.99	2024-02-13 10:05:00
3	Tablet	499.00	2024-02-13 10:10:00
\.
```

- `CREATE TABLE` – создание структуры таблицы.
- `COPY ... FROM stdin` – вставка данных (быстрее, чем `INSERT`).

---

### **Создание резервной копии в `custom`-формате**

Формат `custom` удобен, если вы хотите **гибко управлять восстановлением**. Он позволяет:

- Выбирать, какие объекты восстанавливать (`pg_restore`).
- Восстанавливать данные **в несколько потоков**.

Команда для создания копии в `custom`-формате:

```sh
pg_dump -U username -d database_name -F c -f backup.dump
```

- `-F c` – указывает формат `custom`.
- `-f backup.dump` – указывает имя файла.

Этот формат **нельзя открыть в текстовом редакторе**, так как он двоичный. Для восстановления используется `pg_restore`.

---

### **Создание резервной копии в `directory`-формате**

Формат `directory` разбивает резервную копию на файлы внутри каталога, что:

- Ускоряет создание копии за счёт **многопоточной обработки**.
- Позволяет восстановить **отдельные объекты**.

Создание резервной копии:

```sh
pg_dump -U username -d database_name -F d -f backup_dir
```

- `-F d` – указывает формат `directory`.
- `-f backup_dir` – создаёт каталог `backup_dir` с копией базы.

Этот формат требует `pg_restore` для восстановления.

---

### **Создание копии отдельной таблицы**

Если нужно сделать копию **не всей базы**, а только одной таблицы, используйте:

```sh
pg_dump -U username -d database_name -t products -f products_backup.sql
```

- `-t products` – копирует только таблицу `products`.
- Можно использовать `-T`, чтобы **исключить** таблицу:
    
    ```sh
    pg_dump -U username -d database_name -T logs -f backup.sql
    ```
    
    Это создаст копию базы **без таблицы `logs`**.

---

### **Создание копии только схемы без данных**

Иногда нужно сохранить только **структуру базы без данных**:

```sh
pg_dump -U username -d database_name --schema-only -f schema_backup.sql
```

- Используется для миграции структуры базы на новый сервер.
- Данные можно загрузить отдельно (`--data-only`).

---

### **Создание копии только данных без структуры**

Если структура уже есть и нужно перенести только данные:

```sh
pg_dump -U username -d database_name --data-only -f data_backup.sql
```

- Все `CREATE TABLE` и `INDEX`-команды будут **пропущены**.
- В файле останутся только команды `COPY`.

---

### **Параллельное создание резервной копии**

Для ускорения процесса можно делать дамп **в несколько потоков**:

```sh
pg_dump -U username -d database_name -F d -j 4 -f backup_dir
```

- `-j 4` – использование **4 потоков**.
- Работает **только с `directory`-форматом**.

---

### **Выборочные объекты**

Иногда нужно сделать копию **только схемы или только таблиц в определённой схеме**:

1. Только таблицы в схеме `analytics`:
    
    ```sh
    pg_dump -U username -d database_name -n analytics -f analytics_backup.sql
    ```
    
2. Исключить таблицы в схеме `temp_data`:
    
    ```sh
    pg_dump -U username -d database_name -N temp_data -f backup.sql
    ```
    

---

### **Дополнительные параметры**

- `--exclude-table=table_name` – исключает определённую таблицу.
- `--no-owner` – убирает команду `ALTER OWNER`, что полезно при восстановлении под другим пользователем.
- `--clean` – добавляет `DROP TABLE` перед `CREATE TABLE`, чтобы удалить старые данные перед восстановлением.
- `--if-exists` – используется вместе с `--clean`, чтобы `DROP`-команды не вызывали ошибку, если объект отсутствует.

---

### **Восстановление данных**

Для SQL-дампа:

```sh
psql -U username -d database_name -f backup.sql
```

Для `custom`- и `directory`-форматов:

```sh
pg_restore -U username -d database_name backup.dump
```

или

```sh
pg_restore -U username -d database_name -j 4 backup_dir
```

- `-j 4` – восстанавливает данные в 4 потока.

---

### **Вывод**

- `pg_dump` – мощный инструмент для создания резервных копий PostgreSQL.
- Поддерживаются **разные форматы**: SQL (`plain`), `custom`, `directory`.
- Можно делать **выборочные копии** (только схемы, только данные, отдельные таблицы).
- Параллельное резервное копирование (`-j 4`) **ускоряет процесс**.

---

Следующая часть будет про **форматы резервных копий и их особенности (`plain`, `custom`, `directory`)**. Продолжаем?