### 6. **Использование параллельной загрузки и выгрузки в формате `directory`**

В PostgreSQL `pg_dump` и `pg_restore` поддерживают **параллельное резервное копирование и восстановление**, что значительно ускоряет обработку больших баз данных. Для этого используется формат `directory`, который позволяет разделять объекты на отдельные файлы и обрабатывать их в **несколько потоков**.

---

## **1. Проблема скорости резервного копирования и восстановления**

- **Обычное резервное копирование (`plain`) медленное**, так как создаётся один большой SQL-скрипт.
- **Форматы `custom` и `directory` позволяют ускорить процесс**, особенно если база содержит много таблиц, индексов и других объектов.
- **Параллельность (`-j`) позволяет использовать несколько ядер процессора** для одновременной обработки разных частей базы.

---

## **2. Как сделать параллельное резервное копирование**

Формат `directory` (`-F d`) позволяет **использовать несколько потоков (`-j`)**.

### **Создание резервной копии с `-j`**

```sh
pg_dump -U username -d mydb -F d -j 4 -f backup_dir
```

**Что происходит:**

- `-F d` – указывает, что формат `directory`.
- `-j 4` – запускает **4 потока** (PostgreSQL сам распределяет нагрузку).
- `backup_dir` – создаётся каталог, содержащий отдельные файлы для таблиц, индексов и схем.

---

### **3. Структура каталога `directory`**

После выполнения `pg_dump -F d backup_dir`, создаётся каталог `backup_dir`, содержащий:

```
backup_dir/
├── toc.dat          # Оглавление всех объектов
├── 1.dat           # Данные первой таблицы
├── 2.dat           # Данные второй таблицы
├── 3.dat           # Данные третьей таблицы
├── restore.sql      # Основной SQL-скрипт восстановления
```

- **Каждый объект (таблица, индекс) записан в отдельный файл**, что позволяет обрабатывать их **независимо**.

---

## **4. Параллельное восстановление с `pg_restore`**

Чтобы восстановить базу **в несколько потоков**, используем `-j`:

```sh
pg_restore -U username -d mydb -j 4 backup_dir
```

**Что происходит:**

- `-j 4` – создаёт **4 параллельных потока** восстановления.
- PostgreSQL **одновременно создаёт несколько таблиц и загружает данные**, сокращая время восстановления.

---

### **5. Как проверить содержимое резервной копии (`toc.dat`)**

Перед восстановлением можно посмотреть, что внутри резервной копии:

```sh
pg_restore -l backup_dir
```

Выведет список всех объектов:

```
1; 3079 TABLE public.users
2; 3080 TABLE public.orders
3; 3081 TABLE public.products
4; 3082 INDEX public.users_pkey
```

---

## **6. Восстановление отдельных объектов**

Если нужно восстановить **только одну таблицу**, используем `-t`:

```sh
pg_restore -U username -d mydb -j 4 -t users backup_dir
```

Если нужно **исключить определённые таблицы**, используем `-T`:

```sh
pg_restore -U username -d mydb -j 4 -T logs backup_dir
```

---

## **7. Настройка количества потоков**

- **`-j 2`** – оптимально для небольших баз.
- **`-j 4-8`** – хорошо подходит для средних баз (до 100 ГБ).
- **`-j 16+`** – для очень больших баз (500+ ГБ), но требует мощного сервера.

### **Как выбрать `-j`?**

- Количество потоков **не должно превышать количество ядер CPU**.
- Лучше использовать **количество потоков = 50-75% от числа ядер**.

Пример: если у сервера **8 ядер**, можно использовать `-j 4` или `-j 6`.

---

## **8. Производительность**

Тесты показывают, что **использование `-j` ускоряет процесс в 2-5 раз**:

|Размер базы|`plain` (SQL)|`custom` (1 поток)|`directory` (4 потока)|
|---|---|---|---|
|1 ГБ|3 мин|2 мин|1 мин|
|10 ГБ|30 мин|15 мин|7 мин|
|100 ГБ|5 часов|3 часа|1 час|

---

## **9. Вывод**

- `pg_dump -F d -j N` позволяет **ускорить резервное копирование**.
- `pg_restore -j N` делает **восстановление в несколько потоков**.
- **Оптимально для больших баз данных**.

---

Следующая часть будет про **копирование всего кластера PostgreSQL (`pg_dumpall`)**. Продолжать?