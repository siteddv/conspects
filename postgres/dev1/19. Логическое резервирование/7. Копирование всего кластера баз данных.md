### 7. **Копирование всего кластера баз данных с помощью `pg_dumpall`**

В отличие от `pg_dump`, который позволяет делать резервную копию только одной базы данных, утилита `pg_dumpall` предназначена для **создания полной копии всего кластера PostgreSQL**, включая:

- **Все базы данных** на сервере.
- **Глобальные объекты**, такие как **роли, привилегии и табличные пространства**.

---

## **1. Почему `pg_dumpall`, а не `pg_dump`?**

|**Функция**|`pg_dump`|`pg_dumpall`|
|---|---|---|
|Копирует одну базу|✅ Да|❌ Нет|
|Копирует все базы|❌ Нет|✅ Да|
|Копирует роли и привилегии|❌ Нет|✅ Да|
|Копирует табличные пространства|❌ Нет|✅ Да|

**Вывод**:

- Если нужно **копировать одну базу** → используйте `pg_dump`.
- Если нужно **создать полный бэкап кластера** → используйте `pg_dumpall`.

---

## **2. Создание полной резервной копии кластера**

Базовая команда:

```sh
pg_dumpall -U postgres -f full_backup.sql
```

- Создаёт **текстовый SQL-скрипт**, который можно выполнить в `psql`.
- Включает **все базы**, роли и настройки.

### **Пример содержимого `full_backup.sql`**

```sql
-- Сохранение ролей пользователей
CREATE ROLE admin WITH LOGIN SUPERUSER PASSWORD 'hashed_password';

-- Создание базы данных
CREATE DATABASE mydb WITH OWNER = admin;

-- Переключение в базу данных и восстановление данных
\connect mydb
CREATE TABLE users (id SERIAL PRIMARY KEY, name TEXT);
INSERT INTO users (name) VALUES ('John'), ('Alice');
```

---

## **3. Как восстановить `pg_dumpall`-бэкап**

Чтобы восстановить полный дамп кластера, выполните:

```sh
psql -U postgres -f full_backup.sql
```

- **Создаст роли, базы данных и таблицы**.
- **Загрузит все данные**.

---

## **4. Резервное копирование без данных (только структура)**

Если нужно создать копию **только структуры баз**, без данных:

```sh
pg_dumpall -U postgres --schema-only -f schema_backup.sql
```

Этот бэкап можно использовать **для переноса структуры** на другой сервер.

---

## **5. Создание копии всех баз (без ролей)**

Если нужна копия всех баз **без пользователей и ролей**, используйте `pg_dumpall` + `pg_dump`:

```sh
pg_dumpall -U postgres --database-only -f databases_backup.sql
```

А затем роли можно сохранить отдельно:

```sh
pg_dumpall -U postgres --globals-only -f roles_backup.sql
```

---

## **6. Автоматизация бэкапов кластера**

Можно настроить ежедневные бэкапы с помощью `cron`:

```sh
0 2 * * * pg_dumpall -U postgres -f /backups/full_backup_$(date +\%F).sql
```

Это создаст резервную копию **каждую ночь в 2:00**.

---

## **7. Вывод**

- `pg_dumpall` нужен **для копирования всего кластера**, включая роли.
- **Лучше всего использовать его в сочетании с `pg_dump`**, если требуется гибкость.
- Можно **автоматизировать процесс**, используя `cron`.

---

Следующая часть будет про **заключение и рекомендации по логическому резервному копированию**. Продолжаем?