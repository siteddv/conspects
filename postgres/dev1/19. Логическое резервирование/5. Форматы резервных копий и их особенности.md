### 5. **Форматы резервных копий и их особенности**

Утилита `pg_dump` поддерживает несколько форматов резервного копирования. Каждый из них имеет свои особенности и предназначен для разных сценариев использования.

#### **Доступные форматы резервных копий**

| Формат        | Описание                                         | Особенности                                                                       | Восстановление                                 |
| ------------- | ------------------------------------------------ | --------------------------------------------------------------------------------- | ---------------------------------------------- |
| `plain` (SQL) | Текстовый SQL-скрипт                             | Читаемый человеком, можно редактировать, удобен для миграции                      | `psql -U user -d dbname -f backup.sql`         |
| `custom`      | Специальный двоичный формат PostgreSQL           | Можно восстанавливать отдельные объекты, поддерживает параллельное восстановление | `pg_restore -U user -d dbname backup.dump`     |
| `directory`   | Каталог с отдельными файлами для каждого объекта | Быстрая параллельная выгрузка и восстановление, удобно для больших баз            | `pg_restore -U user -d dbname -j 4 backup_dir` |
| `tar`         | Архив `tar`, содержащий файлы резервной копии    | Не поддерживает параллельное восстановление, но можно сжимать данные              | `pg_restore -U user -d dbname backup.tar`      |

---

## 1. **Формат `plain` (SQL-скрипт)**

### **Описание**

- Содержит обычные SQL-команды (`CREATE TABLE`, `INSERT INTO`, `COPY`).
- Читаемый человеком.
- Можно редактировать перед восстановлением.
- **Не поддерживает параллельное восстановление**.

### **Как создать копию в формате SQL**

```sh
pg_dump -U user -d mydb -F p -f backup.sql
```

### **Пример содержимого `backup.sql`**

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL
);

COPY users (id, name) FROM stdin;
1	John
2	Alice
\.
```

### **Как восстановить SQL-дамп**

```sh
psql -U user -d mydb -f backup.sql
```

**Минусы:**

- Долгое восстановление на больших базах.
- Нет гибкости в выборе объектов при восстановлении.

---

## 2. **Формат `custom`**

### **Описание**

- Двоичный формат, **не читаемый человеком**.
- Позволяет восстанавливать **отдельные объекты** (таблицы, схемы).
- Поддерживает **параллельное восстановление**.

### **Создание копии в `custom`-формате**

```sh
pg_dump -U user -d mydb -F c -f backup.dump
```

### **Как восстановить всю базу**

```sh
pg_restore -U user -d mydb backup.dump
```

### **Как восстановить только одну таблицу**

```sh
pg_restore -U user -d mydb -t users backup.dump
```

### **Параллельное восстановление**

```sh
pg_restore -U user -d mydb -j 4 backup.dump
```

- `-j 4` – восстанавливает в **4 потока**, ускоряя процесс.

**Плюсы:**  
✅ Быстрое восстановление больших баз  
✅ Можно восстанавливать отдельные таблицы  
✅ Поддержка параллельного восстановления

**Минусы:**  
❌ Файл **не читаемый**, нельзя редактировать  
❌ Нельзя просто выполнить SQL-скрипт для восстановления

---

## 3. **Формат `directory`**

### **Описание**

- **Хранится как каталог**, где каждый объект базы (таблица, индекс) – отдельный файл.
- **Позволяет выполнять многопоточное резервное копирование и восстановление**.
- **Можно восстанавливать отдельные таблицы и схемы**.

### **Создание копии в `directory`-формате**

```sh
pg_dump -U user -d mydb -F d -j 4 -f backup_dir
```

- `-j 4` – выгружает базу **в 4 потока**, что ускоряет процесс.

### **Как восстановить `directory`-копию**

```sh
pg_restore -U user -d mydb -j 4 backup_dir
```

### **Как восстановить только схему `public`**

```sh
pg_restore -U user -d mydb -n public backup_dir
```

**Плюсы:**  
✅ Очень быстрое резервное копирование  
✅ Позволяет **гибко выбирать, какие объекты восстанавливать**  
✅ **Оптимально для больших баз**

**Минусы:**  
❌ Не читаемый текст  
❌ Требует `pg_restore`, нельзя просто выполнить SQL

---

## 4. **Формат `tar`**

### **Описание**

- Это **архив tar**, содержащий резервную копию.
- Можно сжать `gzip`-ом.
- **Не поддерживает параллельное восстановление**.

### **Создание `tar`-копии**

```sh
pg_dump -U user -d mydb -F t -f backup.tar
```

### **Как восстановить `tar`-копию**

```sh
pg_restore -U user -d mydb backup.tar
```

**Плюсы:**  
✅ Можно легко передавать и хранить  
✅ Можно сжимать

**Минусы:**  
❌ Медленное восстановление  
❌ Не поддерживает `-j` для параллельного восстановления

---

## **Какой формат выбрать?**

|Формат|Когда использовать?|
|---|---|
|`plain` (SQL)|Если нужна **читаемая копия**, можно редактировать|
|`custom`|Если нужна **гибкость** (восстанавливать отдельные объекты)|
|`directory`|Если база **очень большая** и нужно **быстрое восстановление**|
|`tar`|Если нужно **архивировать и передавать резервную копию**|

---

## **Сравнение скорости восстановления**

|Формат|Скорость восстановления|Поддержка `-j` (многопоточное восстановление)|
|---|---|---|
|`plain`|Медленное|❌ Нет|
|`custom`|Быстрое|✅ Да|
|`directory`|**Очень быстрое**|✅ Да|
|`tar`|Среднее|❌ Нет|

---

### **Вывод**

- `plain` – подходит для **миграции**, но медленный.
- `custom` – **универсальный формат**, поддерживает **параллельное восстановление**.
- `directory` – **лучший выбор для больших баз**, так как быстро копируется и восстанавливается.
- `tar` – можно использовать для **архивации**, но он менее гибкий.

---

Следующая часть будет про **использование параллельного резервного копирования и восстановления (`-j`)**. Продолжаем?