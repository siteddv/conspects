### 3. **Восстановление данных из резервной копии с помощью команды `COPY`**

#### Основная концепция восстановления данных

Команда `COPY` не только экспортирует данные, но и позволяет загружать их обратно в таблицу. Для этого используется вариант `COPY ... FROM`.

Формат команды:

```sql
COPY table_name FROM 'file_path' WITH (FORMAT format_type);
```

- **`FROM`** – импорт данных из файла в таблицу
- **`FORMAT`** – формат файла (`TEXT`, `CSV`, `BINARY`)
- Файл должен быть доступен на сервере базы данных
- Данные должны соответствовать структуре таблицы

Альтернативный способ: если у вас нет доступа к файловой системе сервера, можно использовать команду `\COPY` в `psql`, которая работает на клиенте.

```sql
\COPY table_name FROM 'file_path' WITH (FORMAT format_type);
```

Этот способ удобен для загрузки файлов с клиентской машины.

---

### **Пример восстановления данных**

#### **1. Восстановление из файла CSV**

Допустим, у нас есть CSV-файл `products.csv`:

```
id,name,price,created_at
1,Laptop,1200.50,2024-02-13 10:00:00
2,Phone,799.99,2024-02-13 10:05:00
3,Tablet,499.00,2024-02-13 10:10:00
```

Мы можем загрузить его в таблицу `products`:

```sql
COPY products FROM '/tmp/products.csv' WITH (FORMAT csv, HEADER true);
```

- Ключ **`HEADER true`** сообщает PostgreSQL, что первая строка – это заголовок, и она не должна загружаться в таблицу.
- Данные будут вставлены в таблицу.

Если файл находится на клиентской машине (например, Windows или Mac), используйте:

```sql
\COPY products FROM 'C:\Users\my_table_dump.csv' WITH (FORMAT csv, HEADER true);
```

---

#### **2. Восстановление только определенных столбцов**

Допустим, в файле есть данные без идентификатора (`id`), который заполняется автоматически:

```
name,price,created_at
Laptop,1200.50,2024-02-13 10:00:00
Phone,799.99,2024-02-13 10:05:00
Tablet,499.00,2024-02-13 10:10:00
```

Мы можем загрузить их, указав конкретные столбцы:

```sql
COPY products(name, price, created_at) FROM '/tmp/products.csv' WITH (FORMAT csv, HEADER true);
```

Значение `id` будет заполнено автоматически, так как оно `SERIAL`.

---

#### **3. Восстановление данных без повторного добавления дубликатов**

Если в таблице уже есть данные, команда `COPY` просто добавит новые строки, что может привести к дубликатам. Чтобы избежать этого:

1. Очищаем таблицу перед вставкой:
    
    ```sql
    TRUNCATE TABLE products;
    ```
    
2. Вставляем данные:
    
    ```sql
    COPY products FROM '/tmp/products.csv' WITH (FORMAT csv, HEADER true);
    ```
    

---

#### **4. Восстановление без дублирования строк**

Если у нас нет уверенности, что в файле нет дубликатов, лучше использовать временную таблицу:

```sql
CREATE TEMP TABLE temp_products AS TABLE products WITH NO DATA;

COPY temp_products FROM '/tmp/products.csv' WITH (FORMAT csv, HEADER true);

INSERT INTO products
SELECT * FROM temp_products
ON CONFLICT (id) DO NOTHING;
```

- Данные загружаются во временную таблицу.
- Затем мы вставляем их в основную таблицу, избегая дубликатов с `ON CONFLICT (id) DO NOTHING`.

---

#### **5. Обработка NULL-значений**

В файлах CSV пустые значения по умолчанию считаются `NULL`, но в `TEXT`-формате используются `\N`.

Пример CSV с `NULL`:

```
id,name,price,created_at
1,Laptop,1200.50,2024-02-13 10:00:00
2,Phone,,2024-02-13 10:05:00
3,Tablet,499.00,
```

Здесь у `Phone` нет цены, а у `Tablet` нет даты.

При загрузке нужно явно указать `NULL`:

```sql
COPY products FROM '/tmp/products.csv' WITH (FORMAT csv, HEADER true, NULL '');
```

Теперь пустые значения будут корректно обработаны.

---

#### **6. Восстановление данных из `TEXT`-формата**

Формат `TEXT` обычно используется для универсального экспорта. Он разделяет столбцы табуляцией и использует `\N` для `NULL`.

Файл `products.txt`:

```
1	Laptop	1200.50	2024-02-13 10:00:00
2	Phone	\N	2024-02-13 10:05:00
3	Tablet	499.00	\N
```

Загрузка данных:

```sql
COPY products FROM '/tmp/products.txt' WITH (FORMAT text, DELIMITER E'\t', NULL '\N');
```

- `E'\t'` – указывает, что разделитель – это символ табуляции.
- `NULL '\N'` – указывает, что `\N` обозначает `NULL`.

---

#### **7. Восстановление данных в новую таблицу**

Если мы хотим восстановить копию таблицы с другим именем, можно создать новую таблицу и загрузить в нее данные:

```sql
CREATE TABLE products_backup AS TABLE products WITH NO DATA;

COPY products_backup FROM '/tmp/products.csv' WITH (FORMAT csv, HEADER true);
```

Теперь у нас есть копия данных в `products_backup`.

---

### **Вывод**

- `COPY ... TO` – экспорт данных в файл.
- `COPY ... FROM` – восстановление данных из файла.
- `\COPY` – клиентская версия для экспорта и импорта данных.
- `HEADER true` – используется в CSV, чтобы не загружать заголовки.
- `NULL ''` – обработка `NULL`-значений.
- `ON CONFLICT DO NOTHING` – предотвращение дубликатов.
- **Использование временной таблицы** помогает безопасно загружать данные.

---

Следующая часть будет посвящена **использованию утилиты `pg_dump` для создания резервной копии базы данных**. Продолжаем?