### **Часть 1: Введение в триггеры**

#### **Определение триггеров и их составные части**

Триггер в базе данных — это механизм, который автоматически выполняет определенные действия в ответ на заданные события. Они состоят из двух частей:

1. **Сам триггер** – объект базы данных, который определяет, при каком событии он должен срабатывать.
2. **Триггерная функция** – функция, выполняемая при срабатывании триггера.

Триггеры работают на уровне базы данных и могут отслеживать изменения в таблицах или представлениях. Они полезны для автоматизации задач, поддержания целостности данных и выполнения логики без необходимости изменения клиентского кода.

---

#### **Как работают триггеры в базе данных**

Когда в базе данных выполняется операция (`INSERT`, `UPDATE`, `DELETE` и др.), система анализирует, есть ли соответствующий триггер. Если триггер найден, он выполняет триггерную функцию, которая может:

- **Отменить операцию**, выбросив исключение.
- **Изменить данные перед записью в таблицу**.
- **Запустить дополнительные действия**, например, записать изменение в журнал или обновить связанные таблицы.

Триггеры работают внутри транзакций и могут выполнять сложную логику на уровне базы данных.

---

#### **Взаимодействие триггеров с транзакциями**

Триггер выполняется **в той же транзакции**, в которой происходит основная операция. Это значит, что:

- Если триггер выбрасывает исключение, вся транзакция откатывается.
- Можно гарантировать согласованность данных, так как триггеры выполняются **до или после основного изменения**.
- `AFTER`-триггеры могут использоваться для логирования или других побочных эффектов без изменения данных.

Важное свойство триггеров – возможность **отменить выполнение основной операции** с помощью `RAISE EXCEPTION`, что предотвращает некорректные изменения в базе.

---

#### **Введение в триггерные функции**

Триггерная функция – это специальная функция, которая вызывается при срабатывании триггера. Ее ключевые особенности:

- **Не принимает параметры** (определяются контекстом триггера).
- **Возвращает специальный тип `TRIGGER`**.
- Может использовать переменные `OLD` и `NEW`, содержащие данные до и после изменения.
- Доступ к контекстным переменным (`TG_OP`, `TG_TABLE_NAME`, `TG_WHEN` и др.).

**Пример объявления триггерной функции в PostgreSQL:**

```sql
CREATE FUNCTION my_trigger_function() RETURNS TRIGGER AS $$
BEGIN
  -- Пример проверки данных перед вставкой
  IF NEW.amount < 0 THEN
    RAISE EXCEPTION 'Negative amount is not allowed';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

Эта функция:

- Проверяет, что `amount` неотрицательный.
- Если условие нарушено, операция прерывается (`RAISE EXCEPTION`).
- Если всё нормально, возвращает `NEW`, и запись выполняется.

Триггерная функция используется в триггере:

```sql
CREATE TRIGGER check_amount
BEFORE INSERT OR UPDATE ON transactions
FOR EACH ROW EXECUTE FUNCTION my_trigger_function();
```

Такой триггер:

- Работает **до вставки или обновления**.
- Применяется **к каждой строке**.
- Вызывает `my_trigger_function()`, которая проверяет корректность данных.

---

### **Выводы по части 1**

- Триггер — это механизм автоматического выполнения операций при изменении данных.
- Он состоит из триггера (определяет событие) и триггерной функции (определяет, что делать).
- Триггеры работают в рамках транзакций и могут **изменять данные, предотвращать некорректные изменения, выполнять вспомогательные операции**.
- Триггерные функции не принимают параметры и возвращают специальный тип `TRIGGER`.

---

Хочешь перейти к **Части 2: Механика работы триггеров**?