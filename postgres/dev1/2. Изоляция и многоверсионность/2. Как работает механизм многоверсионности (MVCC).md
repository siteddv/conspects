Пересказ второй логической части: Как работает механизм многоверсионности (MVCC)

1. Принцип хранения нескольких версий строк

В отличие от традиционных СУБД, которые обновляют данные в одной и той же строке, PostgreSQL использует многоверсионность (MVCC), при которой каждая транзакция может видеть разные версии одной и той же строки. Это достигается за счет хранения нескольких копий строк в базе данных.

Как это работает:

Когда выполняется INSERT, в таблице создается новая строка с уникальным номером транзакции.

Когда выполняется UPDATE, PostgreSQL не изменяет строку напрямую, а создает новую версию строки, а старая остается в истории.

Когда выполняется DELETE, строка не удаляется сразу, а просто становится невидимой для новых транзакций.


Таким образом, вместо того чтобы переписывать данные, система просто создает новые версии строк, что позволяет избежать блокировок при чтении.

2. Метаданные строк: транзакционные метки xmin и xmax

Каждая версия строки в PostgreSQL хранит два специальных параметра:

xmin – номер транзакции, которая создала эту версию строки.

xmax – номер транзакции, которая сделала строку невидимой (например, обновила или удалила ее).


Пример:
| id | data  | xmin | xmax | |----|-------|------|------| | 1  | "A"   | 100  | 102  |
| 1  | "B"   | 102  | 0    |

Строка "A" была создана транзакцией 100, а стала недоступной после выполнения транзакции 102.

Строка "B" была создана транзакцией 102 и пока еще актуальна (xmax = 0).


Таким образом, каждая транзакция может «видеть» только те версии строк, xmin и xmax которых соответствуют правилам видимости.

3. Как работает обновление строк (UPDATE)

Как уже сказано, UPDATE в PostgreSQL – это фактически комбинация DELETE + INSERT.

Рассмотрим пример:

1. Изначально в таблице есть строка:

id | name  | xmin | xmax
----+------+------+------
1  | "Alex" | 100  | 0


2. Транзакция 102 выполняет UPDATE и изменяет имя:

PostgreSQL создает новую версию строки.

Старая версия остается, но становится невидимой.


id | name  | xmin | xmax
----+------+------+------
1  | "Alex" | 100  | 102  -- старая версия строки
1  | "Alice" | 102  | 0  -- новая версия строки


3. В момент коммита:

Для новых транзакций будет видна только строка "Alice", а "Alex" исчезнет.

Но пока транзакция 102 не зафиксирована (не выполнен COMMIT), другая транзакция может видеть разные версии этой строки.




4. Как работает удаление (DELETE)

DELETE не уничтожает строку сразу, а просто делает ее невидимой для будущих транзакций, изменяя xmax.

Пример:

1. Транзакция 200 выполняет DELETE:

id | name  | xmin | xmax
----+------+------+------
1  | "Alice" | 102  | 200  -- строка удалена


2. Теперь эта строка не видна для новых транзакций, но все еще физически существует в таблице.



Только после очистки (VACUUM, о котором поговорим позже) такие строки полностью удаляются из базы.


---

Вывод

PostgreSQL не перезаписывает строки, а создает новые версии, управляя их доступностью через xmin и xmax.

Обновление (UPDATE) – это DELETE старой версии + INSERT новой.

Удаление (DELETE) – это просто пометка строки как невидимой, но физически она остается в таблице.

Это позволяет разным транзакциям видеть разные версии одних и тех же данных без блокировок.



---

Пересказать третью часть? Там мы разберем, как PostgreSQL создает снимки данных, как они помогают транзакциям видеть согласованные версии строк и как это влияет на производительность.

 
