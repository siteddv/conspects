–ü–µ—Ä–µ—Å–∫–∞–∑ —à–µ—Å—Ç–æ–π –ª–æ–≥–∏—á–µ—Å–∫–æ–π —á–∞—Å—Ç–∏: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ –∏—Ö –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

–í —ç—Ç–æ–π —á–∞—Å—Ç–∏ —Ä–∞–∑–±–µ—Ä–µ–º:

–ö–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ PostgreSQL.

–ö–∞–∫–∏–µ –µ—Å—Ç—å —Ç–∏–ø—ã –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.

–ö–∞–∫ MVCC –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –ª–∏—à–Ω–∏—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.

–ö–∞–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.



---

1. –ö–æ–≥–¥–∞ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ PostgreSQL?

–í PostgreSQL –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö:

1. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (UPDATE, DELETE, INSERT) ‚Äì —Å—Ç—Ä–æ–∫–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.


2. –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ –¥–∞–Ω–Ω—ã—Ö.


3. –û–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ (ALTER TABLE, VACUUM FULL) ‚Äì –º–æ–≥—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é —Ç–∞–±–ª–∏—Ü—É.



üîπ –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (SELECT) –æ–±—ã—á–Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –Ω–æ –µ—Å—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏—è.


---

2. –¢–∏–ø—ã –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –≤ PostgreSQL

PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.

–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–Ω–∏–º–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.


---

3. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫ (Row-Level Lock)?

–ö–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è UPDATE, PostgreSQL –±–ª–æ–∫–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω—è–µ–º—É—é —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –º–æ–≥–ª–∏ –µ—ë –º–µ–Ω—è—Ç—å.

üîπ –ß—Ç–µ–Ω–∏–µ (SELECT) –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫–∏, –Ω–æ UPDATE –∏ DELETE –±–ª–æ–∫–∏—Ä—É—é—Ç –∏—Ö –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.


---

–ü—Ä–∏–º–µ—Ä 1: –î–≤–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (UPDATE –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏)

–®–∞–≥ 1: –ü–µ—Ä–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (TX1) –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É, –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç COMMIT

BEGIN;
UPDATE accounts SET balance = balance - 50 WHERE id = 1;

–°—Ç—Ä–æ–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.


–®–∞–≥ 2: –í—Ç–æ—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (TX2) –ø—ã—Ç–∞–µ—Ç—Å—è –∏–∑–º–µ–Ω–∏—Ç—å —Ç—É –∂–µ —Å—Ç—Ä–æ–∫—É

BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;

TX2 –∑–∞–≤–∏—Å–∞–µ—Ç –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è TX1.


–®–∞–≥ 3: TX1 –≤—ã–ø–æ–ª–Ω—è–µ—Ç COMMIT

COMMIT;

–¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ TX2 –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.


–í—ã–≤–æ–¥:

UPDATE –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É, –ø–æ–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω COMMIT.

–î—Ä—É–≥–∏–µ UPDATE –∂–¥—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–≤–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.



---

4. –ö–∞–∫ MVCC —Å–Ω–∏–∂–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏?

PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MVCC (–º–Ω–æ–≥–æ–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å), —á—Ç–æ–±—ã —á—Ç–µ–Ω–∏–µ (SELECT) –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–æ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

üîπ –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –¥—Ä—É–≥–∏—Ö –°–£–ë–î, –≤ PostgreSQL SELECT –Ω–µ —Å—Ç–∞–≤–∏—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —Å—Ç—Ä–æ–∫–∏.

–≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –¥–∞–∂–µ –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ (UPDATE), –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —á—Ç–µ–Ω–∏–µ.

PostgreSQL –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é —Å—Ç—Ä–æ–∫–∏ –∏–∑ —Å–Ω–∏–º–∫–∞ –¥–∞–Ω–Ω—ã—Ö.


–ü—Ä–∏–º–µ—Ä 2: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ SELECT –∏ UPDATE

–®–∞–≥ 1: TX1 –Ω–∞—á–∏–Ω–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏ —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ

BEGIN;
SELECT * FROM products WHERE id = 1;

TX1 –≤–∏–¥–∏—Ç "price = 100".


–®–∞–≥ 2: TX2 –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç—É –∂–µ —Å—Ç—Ä–æ–∫—É –∏ –∫–æ–º–º–∏—Ç–∏—Ç

BEGIN;
UPDATE products SET price = 120 WHERE id = 1;
COMMIT;

TX2 –∑–∞–≤–µ—Ä—à–∏–ª–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏ –∏–∑–º–µ–Ω–∏–ª–∞ –¥–∞–Ω–Ω—ã–µ.


–®–∞–≥ 3: TX1 —Å–Ω–æ–≤–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç SELECT

SELECT * FROM products WHERE id = 1;

TX1 –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –≤–∏–¥–∏—Ç "price = 100", —Ç–∞–∫ –∫–∞–∫ –µ—ë —Å–Ω–∏–º–æ–∫ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è.



---

5. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ SELECT ... FOR UPDATE

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω—è—Ç—Å—è –ø–æ—Å–ª–µ —á—Ç–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SELECT ... FOR UPDATE.

BEGIN;
SELECT * FROM orders WHERE status = 'pending' FOR UPDATE;

–°—Ç—Ä–æ–∫–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è ‚Äì –¥—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ —Å–º–æ–≥—É—Ç –∏—Ö –∏–∑–º–µ–Ω—è—Ç—å.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –∑–∞–∫–∞–∑–æ–≤, –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π.


üîπ –û–¥–Ω–∞–∫–æ —ç—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Ç–∞–∫ –∫–∞–∫ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.


---

6. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü (Table-Level Lock)

–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã –±–ª–æ–∫–∏—Ä—É—é—Ç –≤—Å—é —Ç–∞–±–ª–∏—Ü—É.

üîπ –≠—Ç–∏ –∫–æ–º–∞–Ω–¥—ã —Å–ª–µ–¥—É–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤–Ω–µ —Ä–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤ –∏–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–µ–∞–Ω—Å–∞—Ö.


---

7. –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫?

1. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏

–ß—Ç–µ–Ω–∏–µ (SELECT) –Ω–µ –¥–æ–ª–∂–Ω–æ –º–µ—à–∞—Ç—å UPDATE.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MVCC, —á—Ç–æ–±—ã —á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ –¥–∞–Ω–Ω—ã—Ö.


2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å NOWAIT –∏–ª–∏ SKIP LOCKED

–ï—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å NOWAIT:

SELECT * FROM orders WHERE status = 'pending' FOR UPDATE NOWAIT;

–ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –∫–æ–º–∞–Ω–¥–∞ —Å—Ä–∞–∑—É –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π.



---

–í—ã–≤–æ–¥

–ß—Ç–µ–Ω–∏–µ (SELECT) –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –±–ª–∞–≥–æ–¥–∞—Ä—è MVCC.

–ò–∑–º–µ–Ω–µ–Ω–∏–µ (UPDATE, DELETE) –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫–∏ –¥–æ COMMIT.

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SELECT ... FOR UPDATE, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º–∏.

VACUUM FULL –∏ ALTER TABLE –±–ª–æ–∫–∏—Ä—É—é—Ç –≤—Å—é —Ç–∞–±–ª–∏—Ü—É, –∏—Ö –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ.



---

–ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ø–µ—Ä–µ—Å–∫–∞–∑? –í —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏ —Ä–∞–∑–±–µ—Ä–µ–º –º–µ—Ö–∞–Ω–∏–∑–º –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π —Å—Ç—Ä–æ–∫ (VACUUM) –∏ –±–æ—Ä—å–±—É —Å —Ä–∞–∑—Ä–∞—Å—Ç–∞–Ω–∏–µ–º —Ç–∞–±–ª–∏—Ü –≤ PostgreSQL.

 
