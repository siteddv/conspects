Пересказ третьей логической части: Снимки данных и согласованность в PostgreSQL

1. Что такое снимок данных (Snapshot) и зачем он нужен?

В многоверсионной системе PostgreSQL каждое чтение данных не блокирует другие транзакции, потому что каждая транзакция работает со своей версией данных.
Чтобы обеспечить согласованность, PostgreSQL использует механизм снимков данных (Snapshot) – это логический срез базы данных на момент начала транзакции.

Зачем нужны снимки данных?

Позволяют транзакции видеть только те данные, которые были зафиксированы на момент её старта.

Исключают необходимость блокировки чтения (SELECT никогда не блокирует другие операции).

Обеспечивают консистентность данных, даже если другие транзакции продолжают изменять таблицу.



---

2. Как строится снимок данных в PostgreSQL?

Снимок данных создается при начале транзакции и состоит из трех элементов:

1. Номер текущей транзакции (txid), которая запросила снимок.


2. Список активных транзакций, которые начались, но ещё не завершились.


3. Диапазон видимых xmin и xmax – какие версии строк будут видны этой транзакции.



При построении снимка система отбрасывает невидимые версии строк, используя xmin и xmax.


---

3. Как MVCC использует снимки данных?

При выполнении запроса PostgreSQL анализирует xmin и xmax каждой строки, чтобы определить, какие версии строк транзакция может видеть.

Пример работы снимка данных

Допустим, в таблице есть следующие версии строк:

Если новая транзакция началась после 150, но до 200, то она увидит строку "B".

Если транзакция началась после 200, она увидит строку "C", а "B" уже не существует для неё.

Если транзакция началась до 150, она увидит "A", так как "B" ещё не существовала в тот момент.


Таким образом, каждая транзакция видит только ту версию данных, которая была актуальна в момент её старта.


---

4. Что происходит при одновременном обновлении строк разными транзакциями?

Рассмотрим сценарий двух параллельных транзакций, которые работают с одной строкой:

1. Первая транзакция (TX1) читает данные и видит версию "A" (xmin=100, xmax=0).


2. Вторая транзакция (TX2) обновляет эту строку, создавая "B" (xmin=200, xmax=0).


3. Первая транзакция (TX1) продолжает работать и выполняет SELECT снова.



Что она увидит?

Несмотря на то, что "B" уже существует, TX1 по-прежнему видит "A", потому что "B" была создана после начала её транзакции.

Только после завершения TX1 новые транзакции смогут работать с "B".



---

5. Что происходит при COMMIT и ROLLBACK?

Когда транзакция завершается:

Если выполнен COMMIT, новая версия строки становится видимой для всех последующих транзакций.

Если выполнен ROLLBACK, новая версия строки просто помечается как несуществующая, а база продолжает работать со старыми данными.


PostgreSQL при ROLLBACK не удаляет строку, а просто отмечает её как недоступную в снимках данных.


---

Вывод

Снимок данных (Snapshot) – это логический слепок базы данных, который позволяет транзакциям работать с консистентными данными, независимо от изменений в других транзакциях.

Каждая транзакция видит только те версии строк, которые были зафиксированы до её начала.

Многоверсионность (MVCC) позволяет читать данные без блокировок и сохранять согласованность.



---

Продолжать пересказ? В следующей части рассмотрим четыре уровня изоляции транзакций в PostgreSQL, их влияние на согласованность данных и производительность.

 
