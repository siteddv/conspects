–ü–µ—Ä–µ—Å–∫–∞–∑ —Å–µ–¥—å–º–æ–π –ª–æ–≥–∏—á–µ—Å–∫–æ–π —á–∞—Å—Ç–∏: –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ—Ü–µ—Å—Å VACUUM –≤ PostgreSQL

–í —ç—Ç–æ–π —á–∞—Å—Ç–∏ —Ä–∞–∑–±–µ—Ä–µ–º:

–ü–æ—á–µ–º—É —Ç–∞–±–ª–∏—Ü—ã –≤ PostgreSQL —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º —Ä–∞–∑—Ä–∞—Å—Ç–∞—é—Ç—Å—è.

–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (VACUUM).

–í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É VACUUM –∏ VACUUM FULL.

–ö–∞–∫ PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç –Ω–µ–Ω—É–∂–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫.



---

1. –ü–æ—á–µ–º—É —Ç–∞–±–ª–∏—Ü—ã —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è?

–í PostgreSQL —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º MVCC (–º–Ω–æ–≥–æ–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å), –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫ –ø—Ä–∏ –∫–∞–∂–¥–æ–º UPDATE –∏ DELETE, –Ω–æ –Ω–µ —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ä–∞–∑—É.

–ü—Ä–∏–º–µ—Ä:

1. –í—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É:

INSERT INTO users (id, name) VALUES (1, 'Alice');


2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É (UPDATE —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é):

UPDATE users SET name = 'Alice Smith' WHERE id = 1;


3. –í –±–∞–∑–µ —Ç–µ–ø–µ—Ä—å –¥–≤–µ –≤–µ—Ä—Å–∏–∏:

Alice (–Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω–∞—è, –Ω–æ –≤—Å–µ –µ—â–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è).

Alice Smith (–Ω–æ–≤–∞—è, –≤–∏–¥–∏–º–∞—è –≤–µ—Ä—Å–∏—è).




–ò—Ç–æ–≥:

–§–∏–∑–∏—á–µ—Å–∫–∏ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —Å—Ç—Ä–æ–∫–∏ –æ—Å—Ç–∞–µ—Ç—Å—è –≤ —Ñ–∞–π–ª–µ —Ç–∞–±–ª–∏—Ü—ã.

–ï—Å–ª–∏ —Ç–∞–∫ –¥–µ–ª–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ, —Ä–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –±—É–¥–µ—Ç —Ä–∞—Å—Ç–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –±–æ–ª—å—à–µ.



---

2. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç VACUUM?

–ß—Ç–æ–±—ã —É–¥–∞–ª—è—Ç—å –Ω–µ–≤–∏–¥–∏–º—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫, PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å VACUUM.

VACUUM –¥–µ–ª–∞–µ—Ç —Ç—Ä–∏ –≤–µ—â–∏:

1. –ù–∞—Ö–æ–¥–∏—Ç —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –±–æ–ª—å—à–µ –Ω–µ –≤–∏–¥–Ω—ã –Ω–∏ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.


2. –ü–æ–º–µ—á–∞–µ—Ç –∏—Ö –∫–∞–∫ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ, —á—Ç–æ–±—ã –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–≥–ª–∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –≤ —ç—Ç–∏ –æ–±–ª–∞—Å—Ç–∏.


3. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–ª—É–∂–µ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö.



–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:

VACUUM;

üîπ –í–∞–∂–Ω–æ: VACUUM –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ —Ç–∞–±–ª–∏—Ü—ã, –∞ –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ "–Ω–µ–≤–∏–¥–∏–º—ã–º–∏".


---

3. –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É VACUUM –∏ VACUUM FULL

–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VACUUM FULL?

–ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —Ä–∞–∑—Ä–æ—Å–ª–∞—Å—å —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ, –∏ VACUUM —É–∂–µ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç.

–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö.


–ö–æ–º–∞–Ω–¥–∞:

VACUUM FULL users;

‚ùó –ú–∏–Ω—É—Å: –≤–æ –≤—Ä–µ–º—è VACUUM FULL —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è!


---

4. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ (autovacuum)?

PostgreSQL –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ (autovacuum), –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –∏ —Å–∞–º –≤—ã–ø–æ–ª–Ω—è–µ—Ç VACUUM.

–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç autovacuum?

–û–Ω —Å–ª–µ–¥–∏—Ç –∑–∞ —Ç–∞–±–ª–∏—Ü–∞–º–∏ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –Ω–∞–∫–æ–ø–∏–ª–æ—Å—å –º–Ω–æ–≥–æ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π —Å—Ç—Ä–æ–∫.

–†–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è —Ç–∞–±–ª–∏—Ü—ã.


–ú–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã autovacuum:

SELECT relname, last_autovacuum FROM pg_stat_all_tables WHERE schemaname = 'public';


---

5. –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞–∑—Ä–∞—Å—Ç–∞–Ω–∏–µ–º —Ç–∞–±–ª–∏—Ü –∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏

–î–∞–∂–µ –µ—Å–ª–∏ VACUUM —É–¥–∞–ª–∏–ª —Å—Ç–∞—Ä—ã–µ —Å—Ç—Ä–æ–∫–∏, —Ä–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –≤—Å–µ —Ä–∞–≤–Ω–æ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –±–æ–ª—å—à–∏–º.

–ü–æ—á–µ–º—É?

1. –§–∏–∑–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤ PostgreSQL –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ VACUUM.


2. –ò–Ω–¥–µ–∫—Å—ã —Ç–∞–∫–∂–µ —Ä–∞–∑—Ä–∞—Å—Ç–∞—é—Ç—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ —É–∂–µ –º–µ–Ω—å—à–µ —Å—Ç—Ä–æ–∫.



–†–µ—à–µ–Ω–∏–µ: REINDEX

–ß—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –∏ —É–º–µ–Ω—å—à–∏—Ç—å –∏—Ö —Ä–∞–∑–º–µ—Ä:

REINDEX TABLE users;

üîπ –ü–æ–ª–µ–∑–Ω–æ –¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ –º–∞—Å—Å–æ–≤—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (UPDATE) –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–π (DELETE).


---

6. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å autovacuum?

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ñ–∞–π–ª–µ postgresql.conf:

–ï—Å–ª–∏ autovacuum —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ, –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å autovacuum_vacuum_cost_limit:

ALTER SYSTEM SET autovacuum_vacuum_cost_limit = 2000;

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:

pg_ctl restart


---

7. –ö–æ–≥–¥–∞ —Å—Ç–æ–∏—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å —Ä—É—á–Ω–æ–π VACUUM?

–õ—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äì –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ autovacuum.

–ù–æ —Ä—É—á–Ω–æ–π VACUUM —Å—Ç–æ–∏—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤ —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞—è—Ö:

1. –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–¥–∫–æ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è, autovacuum –º–æ–∂–µ—Ç –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è.


2. –ï—Å–ª–∏ –Ω–µ–¥–∞–≤–Ω–æ –±—ã–ª–æ –º–Ω–æ–≥–æ DELETE –∏–ª–∏ UPDATE, –∏ —Ç–∞–±–ª–∏—Ü–∞ —Ä–∞–∑–¥—É–ª–∞—Å—å.


3. –ï—Å–ª–∏ –≤ –±–∞–∑–µ –º–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–æ–≤, –∏ –æ–Ω–∏ —Å—Ç–∞–ª–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–º–∏.



–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –±–∞–∑—ã:

–†–∞–∑ –≤ –¥–µ–Ω—å: VACUUM ANALYZE –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü.

–†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é: REINDEX –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤.

–†–∞–∑ –≤ –º–µ—Å—è—Ü: VACUUM FULL –¥–ª—è —Å–∏–ª—å–Ω–æ –∏–∑–º–µ–Ω—è—é—â–∏—Ö—Å—è —Ç–∞–±–ª–∏—Ü.



---

–í—ã–≤–æ–¥

1. PostgreSQL –Ω–µ —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å—Ä–∞–∑—É, –∏–∑-–∑–∞ —á–µ–≥–æ —Ç–∞–±–ª–∏—Ü—ã —Ä–∞–∑—Ä–∞—Å—Ç–∞—é—Ç—Å—è.


2. VACUUM –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º–µ—Å—Ç–æ –≤–Ω—É—Ç—Ä–∏ —Ç–∞–±–ª–∏—Ü—ã, –Ω–æ –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞.


3. VACUUM FULL —É–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã, –Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –µ—ë.


4. autovacuum —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –Ω–æ –∏–Ω–æ–≥–¥–∞ –µ–≥–æ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é.


5. REINDEX –ø–æ–º–æ–≥–∞–µ—Ç —É–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ—Å–ª–µ –±–æ–ª—å—à–∏—Ö UPDATE –∏–ª–∏ DELETE.




---

–ò—Ç–æ–≥ –≤—Å–µ–≥–æ –∫–æ–Ω—Å–ø–µ–∫—Ç–∞

–≠—Ç–æ—Ç –∫—É—Ä—Å —Ä–∞–∑–æ–±—Ä–∞–ª:
‚úÖ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–Ω–æ–≥–æ–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å (MVCC) –≤ PostgreSQL.
‚úÖ –ö–∞–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º.
‚úÖ –ö–∞–∫–∏–µ –µ—Å—Ç—å —É—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏ –∏ –∫–∞–∫ –æ–Ω–∏ –≤–ª–∏—è—é—Ç –Ω–∞ –¥–∞–Ω–Ω—ã–µ.
‚úÖ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.
‚úÖ –ö–∞–∫ PostgreSQL –æ—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (VACUUM, autovacuum, REINDEX).

üî• –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –∏–∑–æ–ª—è—Ü–∏–∏ –∏ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL!


---

–ï—Å–ª–∏ –Ω—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–æ–Ω—Å–ø–µ–∫—Ç–∞ –¥–ª—è Obsidian, –º–æ–≥—É –æ—Ñ–æ—Ä–º–∏—Ç—å –µ–≥–æ –≤ —É–¥–æ–±–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ!

 