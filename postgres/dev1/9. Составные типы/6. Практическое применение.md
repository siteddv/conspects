### üîπ **–ü–µ—Ä–µ—Å–∫–∞–∑ —à–µ—Å—Ç–æ–π –ª–æ–≥–∏—á–µ—Å–∫–æ–π —á–∞—Å—Ç–∏: –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∏ —Ç–∞–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π** üîπ

---

### **1. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–Ω–∏–≥–∞–º–∏**

üìå **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ:** —Å–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –∫–Ω–∏–≥–∏ –≤ –Ω–∞–ª–∏—á–∏–∏**.  
üìå **–§—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞:**

- –ü—Ä–∏–Ω–∏–º–∞—Ç—å **—Å–æ—Å—Ç–∞–≤–Ω–æ–π —Ç–∏–ø** `books`.
- –í–æ–∑–≤—Ä–∞—â–∞—Ç—å **—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ** (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥).
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º `catalog`.

‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `count_available_books`**:

```sql
CREATE FUNCTION count_available_books(book books)  
RETURNS INTEGER AS $$  
DECLARE  
    available_count INTEGER;  
BEGIN  
    SELECT quantity INTO available_count  
    FROM book_inventory  
    WHERE book_inventory.book_id = book.id;  
    RETURN available_count;  
END;  
$$ LANGUAGE plpgsql;
```

üìå **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?**

- –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `book` **—Ç–∏–ø–∞ `books`**.
- –í–Ω—É—Ç—Ä–∏ –¥–µ–ª–∞–µ—Ç—Å—è `SELECT` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `book_inventory`, –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ª–∏—á–∏–∏ –∫–Ω–∏–≥.
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –≤ –Ω–∞–ª–∏—á–∏–∏.

‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ `catalog`**:

```sql
CREATE VIEW catalog AS  
SELECT b.*, count_available_books(b) AS available  
FROM books b;
```

üìå **–¢–µ–ø–µ—Ä—å –≤ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ `catalog` –ø–æ—è–≤–∏—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü `available`**.

‚úÖ **–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–Ω–∏–≥**:

```sql
SELECT title, author, available  
FROM catalog  
WHERE available > 0;
```

üîπ **–í—ã–≤–µ–¥–µ—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–∏–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –Ω–∞–ª–∏—á–∏–∏.**

---

### **2. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–Ω–∏–≥ (`get_catalog`)**

üìå **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ:** —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—á–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç **–∏—Å–∫–∞—Ç—å –∫–Ω–∏–≥–∏ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º**.  
üìå **–§—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞:**

- –ü—Ä–∏–Ω–∏–º–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç —Ñ–æ—Ä–º—ã –ø–æ–∏—Å–∫–∞.
- –í–æ–∑–≤—Ä–∞—â–∞—Ç—å **—Ç–∞–±–ª–∏—Ü—É —Å –∫–Ω–∏–≥–∞–º–∏**.
- –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥–∏ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É, –∞–≤—Ç–æ—Ä—É, –≥–æ–¥—É –≤—ã–ø—É—Å–∫–∞.

‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `get_catalog`**:

```sql
CREATE FUNCTION get_catalog(search_title TEXT, search_author TEXT, search_year INT DEFAULT NULL)  
RETURNS TABLE(id INT, title TEXT, author TEXT, year INT, available INT) AS $$  
BEGIN  
    RETURN QUERY  
    SELECT b.id, b.title, b.author, b.year, count_available_books(b)  
    FROM books b  
    WHERE (search_title IS NULL OR b.title ILIKE '%' || search_title || '%')  
      AND (search_author IS NULL OR b.author ILIKE '%' || search_author || '%')  
      AND (search_year IS NULL OR b.year = search_year);  
END;  
$$ LANGUAGE plpgsql;
```

üìå **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?**

- –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç—Ä–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (`title`, `author`, `year`).
- –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä `NULL`, –æ–Ω –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (`IS NULL OR`).
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ILIKE` –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞.
- –í—ã–∑–æ–≤ `count_available_books(b)` –¥–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–ª–∏—á–∏–∏ –∫–Ω–∏–≥.
- `RETURN QUERY` –≤—ã–ø–æ–ª–Ω—è–µ—Ç `SELECT` –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏.

‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –ø–æ–∏—Å–∫–µ**:

```sql
SELECT * FROM get_catalog('Harry Potter', NULL, NULL);
```

–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:

```
id  | title          | author          | year | available
----+---------------+----------------+------+----------
1   | Harry Potter  | J.K. Rowling    | 1997 | 5
2   | Harry Potter  | J.K. Rowling    | 1998 | 3
```

‚úÖ **–ü–æ–∏—Å–∫ –ø–æ –∞–≤—Ç–æ—Ä—É**:

```sql
SELECT * FROM get_catalog(NULL, 'J.R.R. Tolkien', NULL);
```

‚úÖ **–ü–æ–∏—Å–∫ –ø–æ –≥–æ–¥—É –≤—ã–ø—É—Å–∫–∞**:

```sql
SELECT * FROM get_catalog(NULL, NULL, 2001);
```

üìå **–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–Ω–∏–≥ –≤ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏!**

---

### **3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∫–Ω–∏–≥ –≤ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**

üìå **–§—É–Ω–∫—Ü–∏—é `get_catalog` –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É.**  
üìå **–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã –≤ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:**

1. –§–æ—Ä–º–∞ –Ω–∞ —Å–∞–π—Ç–µ –ø–µ—Ä–µ–¥–∞—ë—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ (`title`, `author`, `year`).
2. –°–µ—Ä–≤–µ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç SQL-—Ñ—É–Ω–∫—Ü–∏—é `get_catalog(...)`.
3. –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥**.
4. –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç JSON-–æ—Ç–≤–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥.

‚úÖ **–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –∫ API** (–Ω–∞ Python/Flask):

```python
import psycopg2

def search_books(title=None, author=None, year=None):
    conn = psycopg2.connect("dbname=library user=postgres password=secret")
    cur = conn.cursor()
    
    cur.execute("SELECT * FROM get_catalog(%s, %s, %s);", (title, author, year))
    books = cur.fetchall()
    
    cur.close()
    conn.close()
    return books
```

üìå **–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ `get_catalog` —á–µ—Ä–µ–∑ API.**

‚úÖ **–ü—Ä–∏–º–µ—Ä –≤—ã–∑–æ–≤–∞ API –∏–∑ JavaScript (fetch)**:

```javascript
fetch('/api/books?title=Harry Potter')
  .then(response => response.json())
  .then(data => console.log(data));
```

üìå **–†–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥, –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥ –∫—Ä–∏—Ç–µ—Ä–∏–∏.**

---

### **4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—á–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ `get_catalog`**

üìå **–ö–∞–∫ —É—Å–∫–æ—Ä–∏—Ç—å –ø–æ–∏—Å–∫ –≤ `get_catalog`?**

1Ô∏è‚É£ **–°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –Ω–∞ `title` –∏ `author`**

```sql
CREATE INDEX idx_books_title ON books USING GIN (title gin_trgm_ops);
CREATE INDEX idx_books_author ON books USING GIN (author gin_trgm_ops);
```

üìå **–ò—Å–ø–æ–ª—å–∑—É–µ–º `GIN` + `trigram` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ `ILIKE`.**

2Ô∏è‚É£ **–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤ MATERIALIZED VIEW**

```sql
CREATE MATERIALIZED VIEW catalog_view AS  
SELECT * FROM get_catalog(NULL, NULL, NULL);
```

üìå **–¢–∞–∫ PostgreSQL —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞, –∏ –ø–æ–∏—Å–∫ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±—ã—Å—Ç—Ä–µ–µ.**  
üìå **–û–±–Ω–æ–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –º–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é (`REFRESH MATERIALIZED VIEW catalog_view`).**

3Ô∏è‚É£ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `EXPLAIN ANALYZE` –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è**

```sql
EXPLAIN ANALYZE SELECT * FROM get_catalog('Harry Potter', NULL, NULL);
```

üìå **–ï—Å–ª–∏ `Sequential Scan`, –∑–Ω–∞—á–∏—Ç, –Ω—É–∂–µ–Ω –∏–Ω–¥–µ–∫—Å. –ï—Å–ª–∏ `Index Scan` ‚Äî –≤—Å—ë —Ö–æ—Ä–æ—à–æ.**

---

### **5. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –ø–æ —à–µ—Å—Ç–æ–π —á–∞—Å—Ç–∏**

üìå **–û—Å–Ω–æ–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã:**

1. **–§—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –≤—ã—á–∏—Å–ª—è—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–Ω–∏–≥** (`count_available_books`).
2. **–¢–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–æ—â–Ω—ã–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã** (`get_catalog`).
3. **–§—É–Ω–∫—Ü–∏–∏ –º–æ–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API**.
4. **–î–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã `GIN` –∏ `MATERIALIZED VIEW`**.
5. **PostgreSQL –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ SQL-—Ñ—É–Ω–∫—Ü–∏–∏, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ –∫–∞–∫ API-–∑–∞–ø—Ä–æ—Å—ã**.

---

üîπ **–ß—Ç–æ –¥–∞–ª—å—à–µ?**  
–°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å –±—É–¥–µ—Ç –ø–æ—Å–≤—è—â–µ–Ω–∞ **—Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É –æ–±–∑–æ—Ä—É –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∏ —Ç–∞–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, –∏—Ö –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞–º**. üöÄ

–ó–∞–ø—Ä–æ—Å–∏ **—Å–ª–µ–¥—É—é—â—É—é —á–∞—Å—Ç—å**, –∏ —è –ø—Ä–æ–¥–æ–ª–∂—É! üòä