В настоящей главе мы рассмотрели тему пакетной обработки. Мы начали с изучения инструментов Unix, таких как awk, grep и sort, и увидели, как философия этих инструментов переносится в MapReduce и более современные системы потоковой обработки данных.

## Основные принципы проектирования

Часть из описанных принципов проектирования заключается в том, что:
- Входные данные неизменяемы
- Выходные предназначены служить входными для другой (пока неизвестной) программы
- Для решения сложных задач создаются небольшие инструменты, которые «хорошо делают что-то одно»

В мире Unix предусмотрен стандартный интерфейс, позволяющий соединять одну программу с другой и основанный на применении файлов и каналов; в MapReduce этот интерфейс является распределенной файловой системой. Системы потоковой обработки данных добавляют собственные конвейероподобные механизмы передачи данных, чтобы избежать материализации промежуточных состояний в распределенной файловой системе, но исходные и окончательные выходные данные задачи по-прежнему обычно хранятся в HDFS.

## Две основные проблемы распределенных систем пакетной обработки

### Секционирование

В MapReduce функции сопоставления размещаются в секциях в соответствии с входными файловыми блоками. Выходные данные переупорядочиваются, сортируются и объединяются в разделы сжатия, количество которых определяется в зависимости от задачи. Цель этого процесса — разместить все связанные данные, например все записи с одинаковым ключом, в одной секции.

Системы потоковой обработки данных, созданные на базе MapReduce, стараются избегать сортировки там, где это не требуется, но в остальном широко используют принцип секционирования.

### Отказоустойчивость

MapReduce часто записывает данные на диск, что упрощает восстановление после неудачно совершенной операции без повторного выполнения всей задачи, но замедляет выполнение при отсутствии сбоев.

Системы потоковой обработки данных реже используют материализацию промежуточных состояний и держат больше данных в памяти. Это значит, что при выходе узла из строя им приходится выполнять больше повторных вычислений. Детерминированные операторы сокращают объем данных, которые необходимо пересчитывать.

## Алгоритмы объединения в MapReduce

Мы обсудили несколько алгоритмов объединения в MapReduce, большинство из которых используются в базах данных MPP и системах потоковой обработки данных. Они также служат хорошей иллюстрацией того, как работают алгоритмы секционирования.

### Объединение с сортировкой слияния

Каждый из наборов входных данных обрабатывается функцией сопоставления, которая извлекает ключ объединения. При секционировании, сортировке и объединении все записи с одинаковым ключом направляются в одну и ту же функцию сжатия. Затем эта функция может выводить объединенные записи.

### Широковещательное объединение по хешу

Когда один из двух входных наборов данных мал, он не секционируется и может быть полностью загружен в хеш-таблицу. Это позволяет запускать функцию сопоставления для каждого раздела большого входного набора данных, загружая хеш-таблицу с меньшим набором данных в каждый обработчик, и затем сканировать большой набор, извлекая из него по одной записи и каждый раз запрашивая для нее хеш-таблицу.

### Секционированные хеш-объединения

Если два набора входных данных секционированы одинаково (по одному и тому же ключу, одной и той же хеш-функции, с одинаковым количеством разделов), то объединение с помощью хеш-таблицы может применяться независимо для каждого раздела.

## Модель программирования

Распределенные системы пакетной обработки имеют преднамеренно ограниченную модель программирования: функции обратного вызова (сопоставления и сжатия) считаются не меняющими состояния и не имеющими внешних видимых побочных эффектов, кроме генерируемых ими выходных данных.

Это ограничение позволяет системе скрыть некоторые проблемы жестких распределенных систем за абстракцией:
- В случае сбоев и сетевых проблем задачи можно безопасно повторить
- Выходные данные неудачно завершенных задач отбрасываются
- Если несколько задач для какой-либо секции выполнены успешно, то только одна из них генерирует фактически видимые выходные данные

Благодаря такой системе при разработке кода для пакетной обработки не приходится беспокоиться о механизмах отказоустойчивости: система сама гарантирует состояние конечного результата задачи таким же, как если бы никаких ошибок не произошло, хотя в действительности различные операции, возможно, пришлось повторить. Эти надежные семантические структуры намного надежнее, чем те, что обычно применяются в онлайн-сервисах, обрабатывающих пользовательские запросы, и имеют побочные результаты обработки запроса в виде информации, записанной в базу данных.

