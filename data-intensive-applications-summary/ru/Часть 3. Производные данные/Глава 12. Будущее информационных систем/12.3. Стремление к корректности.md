Мы хотим создавать надежные и корректные приложения (программы, семантика которых четко определена и понятна даже в случае различных ошибок). В течение последних 40 лет основой построения корректных приложений служили такие свойства транзакций, как атомарность, изоляция и долговечность.

## Сквозные аргументы в базе данных

То обстоятельство, что приложение использует информационную систему, обеспечивающую сравнительно высокую надежность, — например, сериализируемые транзакции, — еще не означает гарантию от потери или повреждения данных. Например, если в коде приложения есть ошибка, которая приводит к записи некорректных данных или удалению данных из базы, то сериализируемые транзакции не помогут.

**Однократное выполнение операций:**
- Если во время обработки сообщения что-то пойдет не так, то вы можете либо отказаться от результата, либо повторить попытку
- При повторной попытке выполнить задачу существует вероятность, что в действительности предыдущая попытка была успешной, но вы об этом просто не узнали и, как следствие, сообщение будет обработано дважды
- Двойная обработка — форма искажения данных

**Подавление дублирования:**
- Паттерн отбрасывания дубликатов встречается не только в потоковой обработке, но и во многих других местах
- Например, в TCP используются порядковые номера пакетов — для размещения последних в правильном порядке на стороне получателя и определения того, были ли какие-либо пакеты потеряны или дублированы при прохождении по сети
- Однако такое подавление дублирования работает только в контексте одного TCP-соединения

**Идентификаторы операций:**
- Чтобы сделать операцию идемпотентной при нескольких переходах по сети, недостаточно полагаться только на механизм транзакций, предоставляемый базой данных — необходимо сквозное прохождение запроса
- Можно создать уникальный идентификатор операции (например, UUID) и сделать его скрытым полем формы в клиентском приложении
- Затем можно передать идентификатор операции в базу и убедиться, что выполнена только одна операция с данным идентификатором

**Сквозной аргумент:**
- Этот сценарий подавления дублирующихся транзакций — лишь один из примеров более общего принципа, называемого сквозным аргументом
- Эта функция может быть полностью правильно реализована только с учетом знаний и с помощью приложения, стоящего в конечных точках системы связи
- Сквозные аргументы также применяются для проверки целостности данных и шифрования

## Принудительные ограничения

**Ограничения уникальности требуют согласованности:**
- В распределенной среде принудительное ограничение уникальности требует согласованности: если существует несколько конкурентных запросов с одинаковым значением, система каким-то образом должна решить, какая из конфликтующих операций будет принята, и отклонить остальные
- Самый распространенный способ достижения такой согласованности — назначить один узел ведущим и возложить на него ответственность за принятие решений
- Проверка уникальности может быть масштабирована путем секционирования по значению, которое должно быть уникальным

**Уникальность в сообщениях на основе журналирования:**
- Ведение журнала гарантирует, что все пользователи видят сообщения в одинаковой последовательности
- Потоковый процессор потребляет все сообщения из журнала данного раздела последовательно, в одном потоке
- При секционировании журнала по значению, которое должно быть уникальным, потоковый процессор может однозначно решить, какая из нескольких конфликтующих операций была первой

**Обработка запросов в нескольких разделах:**
- Когда задействовано несколько разделов, задача обеспечения атомарности операции с учетом ограничений становится более интересной
- Оказывается, что такая же корректность может быть достигнута без атомарной фиксации, с помощью секционированных журналов
- Разбивая транзакцию, затрагивающую несколько разделов, на два этапа, каждый из которых имеет дело со своим разделом, и используя сквозной идентификатор запроса, мы получаем такой же уровень корректности

## Своевременность и целостность

**Два разных требования:**
- **Своевременность** — означает, что пользователи видят систему в ее актуальном состоянии
- **Целостность** — означает отсутствие повреждения данных: потерь, противоречивых или ложных данных

**Важность целостности:**
- В большинстве приложений целостность гораздо важнее, чем своевременность
- Нарушения своевременности раздражают и вводят в заблуждение, но нарушения целостности могут иметь катастрофические последствия

**Корректность потоков данных:**
- Транзакции ACID обычно обеспечивают как своевременность (линеаризуемость), так и целостность (атомарную фиксацию)
- Интересное свойство систем информационных потоков, основанных на событиях, заключается в том, что в них своевременность и целостность разделены
- При асинхронной обработке потоков событий гарантии своевременности отсутствуют, если только явно не созданы потребители, ожидающие сообщений
- Однако целостность в потоковых системах является необходимым условием

**Недостаточные ограничения:**
- Многим реальным приложениям достаточно гораздо более слабых требований уникальности
- Во многих бизнес-контекстах фактически приемлемо временно нарушать ограничения и исправлять их позже, принося извинения
- Независимо от того, приемлема ли стоимость извинений, это коммерческое решение

**Информационные системы без координации:**
- Системы информационных потоков позволяют предоставлять сервисы управления данными для многих приложений, не требуя координации, но притом обеспечивая надежные гарантии целостности
- Такие информационные системы без координации очень привлекательны: они обеспечивают более высокую производительность и отказоустойчивость, чем системы с синхронной координацией

## Доверяй, но проверяй

**Модели систем:**
- До сих пор все наши рассуждения о корректности, целостности и отказоустойчивости были основаны на предположении, что некий один момент может пойти не так, но все остальное будет в порядке
- Такие допущения называют моделью систем
- Вопрос заключается в том, достаточно ли часто наши предположения нарушаются на практике

**Обеспечение целостности при ошибках программного обеспечения:**
- Кроме аппаратных проблем, всегда есть риск ошибок программного обеспечения, которые не улавливаются на более низких уровнях сети, памяти или контрольных сумм файловой системы
- Несмотря на значительные усилия по тщательному проектированию, тестированию и проверкам, ошибки все еще появляются

**Не верьте слепо обещаниям:**
- Поскольку и аппаратное, и программное обеспечение не всегда соответствует желаемому идеалу, повреждение данных неизбежно произойдет, рано или поздно
- Поэтому необходим по крайней мере способ выяснить, были ли данные повреждены, чтобы можно было их исправить и попытаться найти источник ошибки
- Проверка целостности данных называется аудитом

**Культура проверки:**
- Системы, подобные HDFS и S3, все еще предполагают правильную работу дисков большую часть времени — это разумно, но не равняется предположению, что диски всегда работают правильно
- Я опасаюсь, что культура баз данных ACID привела нас к разработке приложений на основе слепо доверяющих технологий, пренебрегая любыми проверками в процессе

**Аудитопригодная архитектура:**
- Системы, основанные на событиях, способны обеспечить лучшую аудитопригодность
- В случае применения источников данных пользовательский ввод в систему представляется как одно неизменяемое событие, и все результирующие обновления состояния производятся из него
- Благодаря явному представлению информационного потока происхождение данных становится более понятным; это делает более выполнимой проверку целостности

**И снова о сквозных аргументах:**
- Проверку целостности систем данных лучше всего выполнять в сквозном режиме: чем больше систем включено в проверку целостности, тем меньше вероятность того, что на каком-то этапе процесса повреждение останется незамеченным
- Непрерывные сквозные проверки целостности обеспечивают повышенную уверенность в корректности системы; это, в свою очередь, позволяет двигаться быстрее

