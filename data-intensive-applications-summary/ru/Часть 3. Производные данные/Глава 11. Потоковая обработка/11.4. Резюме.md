В этой главе были рассмотрены потоки событий — для каких целей они применяются и как их обрабатывать. В некоторых отношениях потоковая обработка очень похожа на пакетную, представленную в главе 10, с той разницей, что потоковая выполняется непрерывно и не на наборе входных данных фиксированного размера, а для неограниченных (бесконечных) потоков.

## Два типа брокерских сообщений

**Брокеры сообщений типа AMQP/JMS:**
- Брокер отправляет сообщения потребителям, а те высылают подтверждение каждый раз, когда сообщение успешно обработано
- После получения подтверждения удаляются из брокера сообщения
- Такая технология подходит в качестве асинхронной формы RPC — например, в очереди задач, где точный порядок обработки сообщений неважен и нет необходимости возвращаться и заново читать старые сообщения после их обработки

**Брокер сообщений на основе журналирования:**
- Брокер отправляет все сообщения из данного раздела одному узлу-потребителю и всегда в одном и том же порядке
- Параллелизм достигается путем секционирования, а потребители отслеживают прогресс, проверяя смещение последнего обработанного сообщения
- Брокер сохраняет сообщения на диске, поэтому при необходимости можно вернуться и прочитать старые сообщения заново

## Применение журналов в потоковой обработке

Применение журналов в потоковой обработке похоже на использование журналов репликации в базах данных и системы хранения информации на основе журналирования. Эта технология особенно подходит для систем потоковой обработки, которые потребляют входные потоки и генерируют производные состояния или выходные потоки.

**Представление баз данных в виде потоков:**
- Можно фиксировать историю всех изменений, сделанных в базе — либо неявно, путем захвата данных об изменениях, либо явно, через источники событий
- Уплотнение журнала позволяет потоку сохранять полную копию содержимого БД
- Представление баз данных в виде потоков открывает широкие возможности для интеграции систем

**Производные информационные системы:**
- Можно постоянно поддерживать актуальность производных информационных систем, таких как индексы поиска, кэши и аналитические системы, потребляя журнал изменений и применяя их к производной системе
- Можно даже создавать новые представления для уже существующих данных, потребляя журнал изменений с самого начала вплоть до настоящего времени

## Применения потоковой обработки

Средства для поддержания состояния в виде потоков и повторения сообщений легли в основу технологий, которые позволяют объединять потоки и обеспечивать отказоустойчивость в различных системах потоковой обработки.

**Несколько применений:**
- Поиск событий по шаблону (сложная обработка событий)
- Вычисление оконных агрегаций (анализ потоков)
- Поддержание производных информационных систем в актуальном состоянии (материализованные представления)

## Трудности при определении временных интервалов

Мы обсудили трудности, возникающие при определении временных интервалов в потоковых процессорах:
- Различия между временем обработки и временными метками событий
- Проблема взаимодействия с событиями, которые появляются после того, как временное окно было закрыто

## Три типа объединений в потоковых процессах

**Объединения «поток — поток»:**
- Оба входных потока состоят из событий активности
- Оператор объединения ищет связанные события, произошедшие в течение некоего времени
- Например, это могут быть два действия одного и того же пользователя, интервал между которыми не превышает 30 минут

**Объединения «поток — таблица»:**
- Один входной поток состоит из событий активности, а другой — из обновлений таблицы
- Потоковый процессор может подписаться на журнал изменений таблицы и обновлять свою локальную копию базы данных

**Объединения «таблица — таблица»:**
- Оба входных потока состоят из обновлений таблиц
- Пример: лента сообщений Twitter, где процесс потока поддерживает базу данных, содержащую набор подписчиков для каждого пользователя

