Мы провели ряд сравнений между брокерами сообщений и базами данных. По традиции их принято считать отдельными категориями инструментов, но мы увидели, что брокеры сообщений на основе журналирования успешно восприняли некоторые идеи из БД в применении к обмену сообщениями. Можно пойти и в обратном направлении: взять идеи из области обмена сообщениями и потоков и применить их к базам.

## Связь между базами и потоками

Событие — запись о том, что произошло в некий момент времени. Это может быть не только действие пользователя или чтение показаний датчика, но и запись в базу данных. Факт записи в БД является событием, которое может быть зафиксировано, сохранено и обработано.

**Журнал репликации:**
- Журнал репликации представляет собой поток событий записи в базу данных, создаваемый ведущим узлом в процессе обработки транзакции
- Ведомые применяют этот поток записей к своим копиям БД и, таким образом, получают свою точную копию
- События в журнале репликации описывают изменения данных

**Репликация конечных автоматов:**
- Если каждое событие представляет собой запись в базу данных и каждая реплика обрабатывает одни и те же события в одном и том же порядке, то все реплики будут завершены в том же конечном состоянии
- Это просто еще один случай потоков событий!

## Синхронизация систем

Большинству нетривиальных приложений для удовлетворения своих потребностей требуется объединить разные технологии: например, задействовать базу данных OLTP для пользовательских запросов, кэш для ускоренной обработки общих запросов, полнотекстовый индекс для поисковых запросов и склад данных для аналитики.

**Проблема двойной записи:**
- Если какой-либо элемент обновляется в БД, то должен обновиться также в кэше, индексах поиска и складе данных
- При двойной записи приложение явно записывает информацию в каждую из систем
- Однако у двойной записи есть ряд серьезных проблем, одна из которых — состояние гонки
- Другая проблема с двойной записью заключается в том, что одна из записей может оказаться неудачной, а вторая — успешной

**Решение:**
- Если бы ведущий узел был только один — например, база данных — и если сделать поисковый индекс ведомым, то это улучшило бы ситуацию

## Перехват изменений данных

Проблема большинства журналов репликации БД заключается в том, что они долгое время считались внутренней деталью реализации базы, а не открытым API.

**Перехват изменений данных (CDC):**
- Процесс наблюдения за всеми изменениями данных, записанными в базу, и их извлечения в той форме, в какой они могут быть реплицированы в другие системы
- CDC особенно интересен, если изменения доступны в виде потока сразу же после их записи
- Можно перехватывать изменения базы данных и постоянно применять их к поисковому индексу

**Реализация CDC:**
- Для реализации перехвата изменений можно использовать триггеры базы данных
- Синтаксический анализ журнала репликации — более надежный подход
- Примеры инструментов: LinkedIn Databus, Facebook Wormhole, Yahoo! Sherpa, Bottled Water, Maxwell, Debezium, Mongoriver, GoldenGate

**Исходный снимок:**
- Если есть журнал всех изменений, то, повторив его, можно полностью восстановить ее состояние
- Однако постоянное хранение всех изменений зачастую требует чрезмерно большого объема дискового пространства
- Для построения нового полнотекстового индекса требуется полная копия всей базы данных — журнала последних изменений недостаточно
- Снимок базы данных должен соответствовать известной позиции или смещению в журнале изменений

**Уплотнение журнала:**
- Подсистема периодически просматривает журнал и при нахождении записи с одинаковыми ключами отбрасывает дубликаты, оставляя только последнее обновление для каждого ключа
- Объем дискового пространства, необходимый для хранения уплотненного журнала, зависит только от текущего содержимого базы данных, а не от количества операций записей
- Уплотнение журнала поддерживается в Apache Kafka

**API для потоков изменений:**
- Все чаще встречаются базы с поддержкой потоков изменений как интерфейса первого уровня
- Примеры: RethinkDB, Firebase, CouchDB, Meteor, VoltDB, Kafka Connect

## Источники событий

Есть несколько параллелей между рассмотренными здесь идеями и источниками событий — технологией, разработанной сообществом предметно-ориентированного проектирования (DDD).

**Различия между CDC и источниками событий:**
- При перехвате изменений данных приложение использует базу разными способами, обновляя и удаляя записи по мере необходимости. Журнал изменений извлекается из БД на низком уровне
- Применительно к источникам событий логика приложения явно построена на основе неизменяемых событий, которые записываются в журнал. События отражают то, что происходит на уровне приложений, а не изменения низкоуровневых состояний

**Преимущества источников событий:**
- Эффективная технология моделирования данных: с точки зрения приложения более важно записывать действия пользователя как неизменные события, а не результат этих действий в изменяемой базе
- Облегчают развитие приложений, помогают при отладке, упрощая понимание того, что и почему происходит
- Защищают от ошибок приложений

**Получение текущего состояния из журнала событий:**
- Сам по себе журнал событий не очень полезен: обычно пользователи ожидают увидеть текущее состояние системы, а не историю его изменений
- Приложения, применяющие источники событий, должны брать журнал событий и преобразовывать их в состояние, подходящее для представления пользователю
- Это преобразование должно быть однозначным, чтобы при многократном выполнении генерировать по данным из журнала событий одинаковое состояние приложения

**Команды и события:**
- Философия источников событий четко различает события и команды
- Когда поступает запрос от пользователя, вначале он представляет собой команду
- Сначала приложение должно проверить, может ли выполнить команду
- Если проверка прошла успешно и команда принята, то она становится событием, которое является долговечным и неизменным

## Состояние, потоки и неизменяемость

**Связь между состоянием и событиями:**
- Всякий раз, когда состояние изменяется, это является результатом изменившихся событий
- Изменяемое состояние и список событий, открытый только для дополнения, не противоречат друг другу: это две стороны одной и той же медали
- В математическом представлении состояние приложения — интеграл потока событий по времени, а поток изменений — производная состояния по времени

**Преимущества неизменяемых событий:**
- Неизменяемость в базах данных — старая идея (например, бухгалтеры веками использовали неизменяемость в финансовом учете)
- При ошибке бухгалтер не удаляет и не изменяет неверную транзакцию в реестре, а добавляет еще одну, которая компенсирует ошибку
- Благодаря журналу неизменяемых событий, доступному только для дописывания, гораздо легче диагностировать, что произошло, и устранить проблему
- Неизменяемые события хранят больше информации, чем только текущее состояние

**Получение нескольких представлений из одного журнала событий:**
- Отделяя изменяемое состояние от журнала неизменяемых событий, из одного и того же журнала событий можно получить разные представления, рассчитанные на чтение
- Наличие явного этапа перевода данных из журнала событий в базу упрощает дальнейшее развитие приложения
- Эта идея иногда называется разделением ответственности на команды и запросы (CQRS)

**Контроль конкурентных процессов:**
- Действия потребителей журнала событий обычно являются асинхронными, вследствие чего существует вероятность, что пользователь сделает запись в журнал, затем попробует ее прочитать из производного представления и обнаружит, что эта запись еще не отражена в представлении для чтения
- Одним из решений данной проблемы является обновление представления для чтения одновременно с добавлением события в журнал
- Получение текущего состояния из журнала событий упрощает некоторые аспекты контроля конкурентного доступа

**Ограничения неизменяемости:**
- Насколько реально хранить неизменяемую историю всех изменений постоянно? Ответ зависит от количества перезаписей в наборе данных
- Бывают обстоятельства, при которых необходимо удалить данные из соображений администрирования, несмотря на принцип неизменяемости
- В этих обстоятельствах недостаточно просто дописать в журнал новое событие — надо действительно переписать историю и притвориться, будто эти данные никогда не существовали

