Проблема с ежедневными пакетными процессами заключается в том, что изменения входной информации отражаются на выходе только через день — для многих нетерпеливых пользователей это слишком долго. Для уменьшения задержки можно чаще повторять обработку: например, обрабатывать данные раз в секунду или даже непрерывно, полностью отказавшись от разделения времени на фиксированные интервалы. Просто обрабатывать события по мере их возникновения. Это и есть идея потоковой обработки.

## Потоки событий

Вообще говоря, потоком называют данные, которые становятся доступными постепенно, с течением времени. В контексте обработки потока записи обычно называют событиями — небольшой, автономный, неизменный объект, хранящий детали произошедшего в какой-то момент времени. Обычно событие содержит временную метку, показывающую, в какое время суток оно произошло.

**Произошедшее событие может быть:**
- Действием пользователя, например просмотром страницы или сделанной покупкой
- Результатом периодического измерения от датчика температуры или показателем нагрузки на процессор
- Строкой журнала веб-сервера

**Представление событий:**
- Событие может быть представлено в виде текстовой строки, или кода JSON, или в некой двоичной форме
- Такое представление позволяет сохранять события, например записывая их в файл, вставляя в реляционную таблицу или занося в документную базу данных
- Оно также позволяет передавать событие по сети на другой узел для последующей обработки

**Инициаторы и потребители:**
- Событие генерируется один раз инициатором (также известным как издатель или отправитель)
- Затем может обрабатываться разными потребителями (подписчиками или получателями)
- В файловой системе имя файла идентифицирует набор взаимосвязанных записей; в потоковой системе связанные события обычно объединяются в тему или поток

## Системы обмена сообщениями

Вместо опроса хранилища данных на предмет новых событий лучше отправлять потребителям уведомления о появлении новых событий. Для доставки уведомлений о событиях были разработаны специализированные инструменты — системы обмена сообщениями.

**Два ключевых вопроса для классификации систем:**
1. Что произойдет, если инициаторы будут отправлять сообщения быстрее, чем потребители смогут их обрабатывать?
   - Система будет отбрасывать сообщения
   - Буферизовать их в виде очереди
   - Использовать контроль обратного потока (управление потоком)
2. Что произойдет, если узел сети даст сбой или будет временно недоступен?
   - Будут ли сообщения потеряны?
   - Ради надежности может быть реализована некая комбинация записи на диск и/или репликации

## Прямой обмен сообщениями между инициаторами и потребителями

В некоторых системах обмена сообщениями используется прямая связь по сети между инициаторами и потребителями, без узлов-посредников.

**Примеры:**
- В финансовой сфере для таких потоков, как каналы фондового рынка, где важна низкая латентность, широко применяется групповая рассылка UDP
- В библиотеках обмена сообщениями без посредников, таких как ZeroMQ и nanomsg, использован аналогичный подход
- В StatsD и Brubeck задействован ненадежный обмен сообщениями по протоколу UDP для сбора и мониторинга показателей датчиков
- Webhooks — паттерн, в котором URL обратного вызова сервиса регистрируется другим сервисом и делает запрос на этот адрес всякий раз, когда происходит событие

**Ограничения:**
- Эти системы прямого обмена сообщениями обычно требуют, чтобы в коде приложения учитывалась возможность потери сообщения
- Если потребитель отключится, то может пропустить сообщения, отправленные, пока он был вне доступа

## Брокеры сообщений

Вместо прямого обмена сообщениями часто используется отправка через брокеров сообщений (также известная как очередь сообщений). По существу, это своего рода база данных, оптимизированная для обработки потоков сообщений.

**Преимущества брокеров:**
- Благодаря централизации данных у брокеров такие системы более легко справляются с ситуациями, когда клиенты появляются и исчезают
- Задача обеспечения надежности возлагается на брокера
- Одни брокеры сохраняют сообщения только в памяти, другие (в зависимости от конфигурации) записывают их на диск
- Столкнувшись с медленным потребителем, они позволяют обеспечить неограниченную очередь

**Различия между брокерами сообщений и базами данных:**
- Информация в БД обычно хранится до тех пор, пока не будет явно удалена, тогда как большинство брокеров автоматически удаляют сообщение после того, как оно было успешно доставлено потребителям
- Поскольку брокеры быстро удаляют сообщения, большинство из них рассчитано на относительно небольшой рабочий набор данных
- Базы обычно поддерживают вторичные индексы и различные способы поиска данных, в то время как брокеры сообщений обеспечивают какой-либо способ подписки на подмножество тем
- Результат запроса в БД обычно основан на ее текущем состоянии в данный момент времени; брокеры сообщений, напротив, уведомляют клиентов об изменении данных

## Паттерны обмена сообщениями

Когда несколько потребителей читают сообщения в одной теме, используются два основных паттерна обмена сообщениями.

**Распределение нагрузки:**
- Каждое сообщение доставляется одному потребителю
- Потребители могут распределить между собой обработку сообщений в теме
- Полезно, когда обработка сообщений требует значительных ресурсов, и поэтому желательно распараллелить обработку между потребителями

**Разветвление:**
- Каждое сообщение доставляется всем потребителям
- Разветвление позволяет нескольким потребителям независимо друг от друга «настраиваться» на одну и ту же рассылку сообщений
- Потоковый эквивалент нескольких пакетных задач, читающих общий входной файл

## Подтверждение и повторная доставка

В любой момент у потребителя может случиться сбой. Вероятна ситуация, когда брокер доставил сообщение, но потребитель его так и не обработал или обработал лишь частично перед сбоем.

**Механизм подтверждения:**
- Клиент должен явно сообщить брокеру о завершении обработки сообщения
- Тогда брокер удалит сообщение из очереди
- Если соединение с клиентом было закрыто или время ожидания истекло, а брокер так и не получил подтверждение, то он предполагает, что сообщение не было обработано, и поэтому передает сообщение другому пользователю

**Проблема с порядком сообщений:**
- В сочетании с распределением нагрузки такая технология повторной доставки интересно влияет на последовательность сообщений
- Сообщения могут доставляться не в том порядке, в каком они были отправлены инициатором
- Чтобы избежать этой проблемы, можно использовать отдельную очередь для каждого потребителя

## Секционирование журналов

В основе баз данных и файловых систем лежит противоположный подход: предполагается, что все записанное в БД или файл внесено туда навсегда, по крайней мере пока кто-нибудь явно его не удалит.

**Проблема с традиционными брокерами:**
- При обмене сообщениями AMQP/JMS после подтверждения брокер удаляет доставленное сообщение
- Вследствие чего нельзя снова запустить программу-потребитель и получить тот же результат
- Если добавить в систему обмена сообщениями нового потребителя, то он обычно начнет получать сообщения, отправленные после того, как был зарегистрирован

**Решение: брокеры сообщений на базе журналирования**
- Журнал — это просто хранящаяся на диске последовательность записей с разрешением только на добавление записей
- Инициатор отправляет сообщение, добавляя в конец журнала, а потребитель получает его, последовательно читая журнал
- Чтобы обеспечить журналу более высокую пропускную способность, подойдет секционирование
- Тему можно определить как группу разделов, обслуживающих однотипные сообщения

**Смещения потребителей:**
- Внутри каждого раздела брокер назначает каждому сообщению монотонно увеличивающийся порядковый номер (смещение)
- Последовательное использование раздела позволяет легко определить, какие сообщения были обработаны
- Брокеру не приходится отслеживать подтверждения для каждого сообщения — достаточно лишь периодически записывать смещения потребителей

**Использование дискового пространства:**
- При постоянном ведении журнала рано или поздно наступит момент, когда на диске перестанет хватать места
- На практике журнал делится на сегменты; время от времени старые сегменты удаляются или перемещаются в архивное хранилище
- Если медленный потребитель не справляется со скоростью поступления сообщений и настолько отстает, что его потребительское смещение указывает на удаленный сегмент, то он пропустит некоторые сообщения

**Преимущества журналирования:**
- Обработка больше похожа на чтение из файла: это операция только чтения, не меняющая журнал
- Можно запустить копию потребителя со вчерашними смещениями и записать выходные данные в другое место, чтобы заново обработать сообщения последнего дня
- Такое обстоятельство делает обработку сообщений на основе журналирования похожей на пакетные процессы, описанные в предыдущей главе

