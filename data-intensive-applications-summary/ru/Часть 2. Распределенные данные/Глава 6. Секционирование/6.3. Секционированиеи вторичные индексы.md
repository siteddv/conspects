Вторичные индексы не идентифицируют записи однозначно, а служат для поиска значений по критериям, что усложняет их использование при секционировании баз данных. Это актуально для реляционных и документоориентированных БД, таких как HBase, Voldemort, Riak, Solr и Elasticsearch. Основные подходы к секционированию с вторичными индексами — по документам и по термам.

### Секционирование вторичных индексов по документам

При секционировании базы данных по документам каждый документ имеет уникальный ID, и данные делятся на секции по диапазонам ID (например, ID 0-499 — секция 0, 500-999 — секция 1). Для поиска автомобилей по дополнительным признакам (цвет, производитель) создаются вторичные индексы, которые автоматически обновляются при добавлении документов. Каждый индекс локален для своей секции, что позволяет эффективно выполнять записи, обновления и удаления.

![[37. Sectioning by secondary indexes.png]]

Однако при чтении данных возникает проблема: автомобили одного цвета могут быть распределены по нескольким секциям. В таком случае нужно выполнять запросы ко всем секциям и объединять результаты, что может быть затратным по времени. Этот процесс называется фрагментированным чтением (scatter/gather), и при параллельной обработке запросов он может увеличить время ожидания. Несмотря на это, фрагментированное чтение активно используется в таких системах, как MongoDB, Riak, Cassandra и Elasticsearch. Рекомендуется проектировать схему так, чтобы запросы по вторичным индексам обрабатывались в одной секции, хотя это не всегда возможно.

### Секционирование вторичных индексов по термам

Вместо локальных индексов, которые хранятся в каждой секции, можно использовать глобальные индексы, охватывающие все секции базы данных. Однако глобальный индекс также нужно секционировать, чтобы избежать узкого места. Например, индекс автомобилей может быть секционирован по алфавитному порядку первых букв цвета или производителя, что делит индекс на секции (например, цвета от a до r — в одной секции, от s до z — в другой). Такой подход называется секционированием по терму, где термом является значение (например, color:red).

![[38. Sectioning by terms.png]]

Глобальные индексы ускоряют чтение, так как запросы выполняются только в нужной секции, а не по всем секциям, как при локальных индексах. Однако они усложняют запись: обновление одного документа может затронуть несколько секций глобального индекса, что требует распределённых транзакций, поддержка которых есть не в каждой СУБД. В реальности обновления глобальных индексов часто выполняются асинхронно, что может привести к задержкам.

Глобальные индексы по термам применяются в таких системах, как Riak и Oracle, где пользователь может выбирать между локальной и глобальной индексацией.