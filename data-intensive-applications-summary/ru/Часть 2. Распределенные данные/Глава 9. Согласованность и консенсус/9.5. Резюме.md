В этой главе с разных точек зрения были рассмотрены темы согласованности и консенсуса.

## Линеаризуемость

Мы подробно изучили **линеаризуемость** — популярную модель согласованности: ее цель состоит в том, чтобы реплицированные данные выглядели так, как если бы существовала только одна копия и все операции воздействовали на нее атомарно.

Несмотря на привлекательность линеаризуемости, поскольку ее легко понять, она тем не менее приводит к тому, что база данных ведет себя как переменная в однопоточной программе — ее недостаток заключается в замедлении работы системы, особенно в средах с большими сетевыми задержками.

## Причинность

Мы также исследовали **причинность**, которая требует соблюдения последовательности событий в системе (что произошло раньше, а что позже, на основании причинно-следственных взаимосвязей). В отличие от линеаризуемости, выстраивающей все операции в единую, полностью упорядоченную временную последовательность, причинность позволяет построить более слабую модель согласованности: отдельные события могут быть конкурентными, как в истории версий с ее ветвлениями и слияниями.

Причинная согласованность не несет накладных расходов на линеаризуемость и гораздо менее чувствительна к сетевым проблемам.

## Временные метки и рассылка общей последовательности

Однако даже если зафиксировать причинно-следственный порядок (например, с помощью временных меток Лампорта), то все равно остаются системы, которые не могут быть реализованы таким образом. Например, обеспечение уникальности имени пользователя и отклонение конкурентных попыток регистрации под одним и тем же именем требует знания того, когда будет построена окончательная последовательность.

Эта проблема привела нас к идее **рассылки общей последовательности** — протокола обмена сообщениями между узлами, который требует надежной доставки и полностью упорядоченной доставки сообщений.

## Консенсус

Мы увидели: достичь консенсуса означает принять решение о чем-то таким образом, чтобы с этим решением согласились все узлы и данное решение являлось неотменяемым. При ближайшем рассмотрении выяснилось: весь широкий спектр проблем фактически сводится к консенсусу, они эквивалентны (в том смысле, что если есть решение для одной из них, то его можно легко превратить в таковое для остальных).

К таким эквивалентным проблемам относятся:
- Линейные реестры сравнения с присвоением
- Атомарная транзакция
- Рассылка общей последовательности
- Блокировки и аренда
- Сервис членства и координации
- Ограничение уникальности

## Двухфазная фиксация

Мы изучили **двухфазную фиксацию** (2PC) — наиболее распространенный способ атомарной фиксации распределенных транзакций. Оказывается, 2PC является своего рода консенсусным алгоритмом, хотя и не очень хорошим.

2PC имеет серьезные проблемы:
- При выходе координатора из строя участники могут застрять в состоянии неопределенности
- Блокировки удерживаются в течение всего времени неопределенности
- Это блокирующий протокол, который может зависнуть в ожидании восстановления координатора

## Отказоустойчивые консенсусные алгоритмы

Мы рассмотрели лучшие консенсусные алгоритмы, такие как те, что используются в ZooKeeper (Zab) и etcd (Raft). Эти алгоритмы фактически реализуют рассылку общей последовательности, что делает их алгоритмами консенсуса.

Все консенсусные протоколы основаны на использовании ведущего узла в той или иной форме, но не гарантируют, что он уникален. Вместо этого они предлагают более слабую гарантию: протоколы определяют номер периода и гарантируют, что в каждый период ведущий узел уникален.

## Ограничения консенсуса

Алгоритмы консенсуса являются огромным прорывом для распределенных систем, но за их преимущества приходится расплачиваться:

- Процесс голосования является своего рода синхронной репликацией
- Консенсусные системы всегда требуют строгого большинства
- Большинство консенсусных алгоритмов предполагает фиксированный набор узлов
- Для обнаружения узлов, вышедших из строя, консенсусные системы обычно полагаются на время ожидания
- Иногда консенсусные алгоритмы особенно чувствительны к сетевым проблемам

## Сервисы координации

Проекты, подобные ZooKeeper или etcd, реализуют не только рассылку общей последовательности (и, следовательно, консенсус), но и интересный набор других функций, которые оказываются особенно полезными при создании распределенных систем:

- Линеаризуемые атомарные операции
- Общая последовательность операций
- Обнаружение сбоев
- Изменение уведомлений

Эти функции делают такие системы полезными для координации в распределенных средах, например, для выбора ведущего узла или распределения нагрузки между узлами.

## Ключевые выводы

1. **Линеаризуемость** — сильная, но дорогая гарантия согласованности
2. **Причинность** — более слабая, но более эффективная модель согласованности
3. **Рассылка общей последовательности** — эквивалентна консенсусу
4. **Консенсус** — фундаментальная проблема распределенных систем, к которой сводятся многие другие проблемы
5. **2PC** — простой, но проблемный алгоритм консенсуса
6. **Отказоустойчивые консенсусные алгоритмы** (Paxos, Raft, Zab) — более надежные решения
7. **Сервисы координации** (ZooKeeper, etcd) — практические реализации консенсуса с дополнительными полезными функциями

