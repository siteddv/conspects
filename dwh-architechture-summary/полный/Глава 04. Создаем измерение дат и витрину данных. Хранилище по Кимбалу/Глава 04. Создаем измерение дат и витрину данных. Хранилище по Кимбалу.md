# Глава 04. Создаем измерение дат и витрину данных. Хранилище по Кимбалу

Четвертая глава курса посвящена созданию измерения дат (date dimension) и витрины данных для построения отчетов. Рассматривается работа с внешними базами данных, создание таблицы с измерениями дат, связывание таблицы дат с фактами и измерениями, создание слоя витрин и подготовка данных для отчетов.

## Проблемы с перезабором базы данных и добавлением данных

Рассматриваются проблемы, возникающие при работе с базой данных источника. Важно правильно настроить подключение к внешней базе данных и обеспечить корректную загрузку данных без дублирования и ошибок.

## Работа с внешними базами данных и подключение film_src

Настраивается подключение к внешней базе данных источника через PostgreSQL FDW. Создается серверное соединение с базой данных `film_src`, настраивается маппинг пользователей. Это позволяет получать данные из источника для загрузки в хранилище.

## Создание таблицы с измерениями дат (dim_date)

Таблица `dim_date` необходима для хранения различных представлений дат, которые часто используются в отчетах. Она позволяет преобразовывать даты в нужный формат, оптимизировать агрегацию данных (группировка по кварталам, неделям, годам), исключить необходимость вычислений в каждом отчете (все значения уже предрассчитаны).

Таблица создается в схеме `core`, поскольку является одним из ключевых измерений. В таблицу добавляются все даты за определенный период (например, с 1 января 2007 по 31 декабря 2022). Создается последовательность дат, которая начинается с 1 января 2007 года (первый зафиксированный платеж в системе), охватывает 16 лет (до 2022 года), заполняется автоматически с помощью генерации последовательности в PostgreSQL.

Таблица содержит ключевые поля: `date_id` (первичный ключ в формате `YYYYMMDD`), `date_actual` (фактическая дата), `day_of_month` (номер дня в месяце), `day_of_week` (номер дня недели), `week_of_year` (номер недели), `month` (номер месяца), `month_name` (название месяца), `quarter` (номер квартала), `year` (год), `fiscal_week` (фискальная неделя, если требуется).

Для быстрого поиска дат добавляется индекс по `date_actual`, что ускоряет соединение таблицы фактов с `dim_date`. Вместо хранения `DATE`-формата в связующих таблицах используется целочисленный идентификатор (`date_id`), что сокращает размер данных. Все вычисления с датами производятся один раз при загрузке данных, а не в каждом SQL-запросе.

## Связывание таблицы дат с фактами и измерениями

Таблица `dim_date` связывается с таблицами фактов через поле `date_id`. В таблицах фактов (`fact_payment`, `fact_rental`) добавляется поле `payment_date_id` или `rental_date_id`, которое ссылается на `dim_date.date_id`. Это позволяет эффективно группировать факты по временным периодам и строить отчеты по датам.

## Создание слоя витрин (report) и подготовка данных для отчета

Слой витрин (`report`) — это последний уровень в хранилище данных, предназначенный для быстрого получения предрассчитанных данных для отчетов. В отличие от `core`, который содержит детальные данные, `report` уже содержит агрегированные значения, готовые к визуализации.

Для хранения витрин создается отдельная схема `report`. Создается таблица для отчета `sales_date` (продажи по датам): `date_title` (дата в отформатированном виде, например "1 сентября 2022"), `date_sort` (идентификатор даты из `dim_date` для сортировки), `total_sales` (сумма продаж за день).

Создается процедура `calc_sales_date()`, которая берет данные из `fact_payment`, агрегирует их по дням и записывает в `report.sales_date`. Процедура очищает таблицу, выбирает дату из `dim_date`, группирует по `date_id` и суммирует `amount`, записывает результат в `report.sales_date`. После создания процедуры данные пересчитываются каждый раз при обновлении хранилища.

## Создание процедуры для наполнения отчета

Процедура `calc_sales_date()` автоматизирует процесс заполнения витрины. Она выполняется после обновления данных в Core-слое, чтобы витрина всегда содержала актуальные агрегированные данные. Процедура может быть добавлена в общий процесс загрузки данных для автоматического обновления витрин.

## Визуализация данных и интеграция с BI-инструментами

После создания витрины данные готовы для использования в BI-инструментах (Power BI, Tableau, Metabase). Витрина содержит предрассчитанные данные, что ускоряет построение отчетов и визуализацию. Форматированные даты упрощают создание интерактивных дашбордов.

## Домашнее задание и заключение

Домашнее задание включает создание дополнительных витрин для различных отчетов, настройку автоматического обновления витрин, интеграцию с BI-инструментами. Занятие завершается обсуждением преимуществ использования измерения дат и витрин данных для аналитики.

---

**Подробнее:** [[Глава 04. Создаем измерение дат и витрину данных. Хранилище по Кимбалу]] [Глава 04. Создаем измерение дат и витрину данных. Хранилище по Кимбалу](../полный/Глава 04. Создаем измерение дат и витрину данных. Хранилище по Кимбалу/Глава 04. Создаем измерение дат и витрину данных. Хранилище по Кимбалу.md)

