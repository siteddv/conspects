# 01.3. Оптимизация загрузки данных в Staging Layer и работа с типами данных

### **3.1. Дополнительные настройки Staging Layer**

После того как создана таблица `staging.film` и настроена процедура загрузки данных, лектор объясняет, какие дополнительные шаги можно сделать для **оптимизации работы** Staging-слоя.

#### **3.1.1. Оптимизация загрузки данных**

При загрузке данных в Staging можно использовать два подхода:

1. **Транкейт и полная перезагрузка (`TRUNCATE + INSERT`)**
    - Перед каждой загрузкой данные из Staging-таблицы **удаляются полностью**.
    - Затем **вставляются все записи заново**.
    - **Плюсы**: Простота реализации.
    - **Минусы**: Увеличенная нагрузка на сервер при больших объемах данных.
2. **Инкрементальная загрузка (`DELETE + INSERT`)**
    - **Удаляются только изменённые записи**, а остальные остаются.
    - **Добавляются новые и обновленные записи**.
    - **Плюсы**: Уменьшает нагрузку на сервер.
    - **Минусы**: Требует **механизма определения изменений** (например, с помощью `timestamp`).

На данном этапе курса используется **подход с полным удалением (`TRUNCATE`)**.

#### **3.1.2. Различия между Staging и основной БД**

- В Staging-слое данные **записываются без изменений**, как есть в источнике.
- В **основном хранилище (Core Layer)** данные уже **обрабатываются, очищаются и нормализуются**.
- **Важное правило**:
    - **Staging = копия источника** (никаких преобразований).
    - **Core = обработанные данные** (после валидации и нормализации).

---

### **3.2. Проблемы с типами данных**

Лектор объясняет, какие **проблемы могут возникнуть при переносе данных** из одной базы данных в другую.

#### **3.2.1. Разные типы данных в источнике и хранилище**

В **базе-источнике** (PostgreSQL) могут быть специфические типы данных:

- **ENUM (перечисления)** — например, тип `mpaa_rating` для рейтинга фильма (`G`, `PG`, `R` и т. д.).
- **Пользовательские типы** (`custom data types`), созданные в БД источника.
- **Сериализованные ключи** (`SERIAL`), которые автоматически увеличиваются.

В **хранилище (DWH)** эти типы могут быть **неподдерживаемыми**.  
Поэтому их нужно **заменять** на стандартные типы.

#### **3.2.2. Замена пользовательских типов на стандартные**

Пример:

- В базе-источнике рейтинг фильма (`mpaa_rating`) имеет тип `ENUM`.
- В Staging-слое этот тип **не поддерживается**.
- **Решение**: заменить `ENUM` на **`VARCHAR(10)`**.

**SQL для создания таблицы с исправленным типом:**

```sql
CREATE TABLE staging.film (
    film_id INT PRIMARY KEY,
    title VARCHAR(255),
    description TEXT,
    release_year INT,
    rating VARCHAR(10) -- ENUM заменён на VARCHAR
);
```

---

### **3.3. Создание таблиц для дополнительных данных**

Лектор предлагает расширить Staging-слой и добавить еще **две таблицы**:

- `staging.inventory` (информация о физических копиях фильмов).
- `staging.rental` (информация о прокате фильмов клиентами).

#### **3.3.1. Создание таблицы `staging.inventory`**

- В **базе-источнике** есть таблица `inventory`, содержащая информацию о дисках.
- Необходимо создать **такую же таблицу** в Staging.

**SQL для создания таблицы:**

```sql
CREATE TABLE staging.inventory (
    inventory_id INT PRIMARY KEY,
    film_id INT,
    store_id INT,
    last_update TIMESTAMP
);
```

- Поля **не изменяются**, так как все они являются стандартными типами.

#### **3.3.2. Создание таблицы `staging.rental`**

- Эта таблица хранит информацию о прокате фильмов:
    - Кто взял диск.
    - Когда взял и когда вернул.
    - Какой платёж был произведён.

**SQL для создания таблицы:**

```sql
CREATE TABLE staging.rental (
    rental_id INT PRIMARY KEY,
    rental_date TIMESTAMP,
    inventory_id INT,
    customer_id INT,
    return_date TIMESTAMP,
    staff_id INT,
    last_update TIMESTAMP
);
```

- Данные записываются **без изменений**.

---

### **3.4. Создание процедур загрузки данных**

После создания новых таблиц необходимо создать **процедуры для их заполнения**.

#### **3.4.1. Процедура для загрузки данных о дисках (`inventory`)**

```sql
CREATE OR REPLACE PROCEDURE staging.load_inventory_data()
LANGUAGE plpgsql AS
$$
BEGIN
    TRUNCATE TABLE staging.inventory;
    INSERT INTO staging.inventory (inventory_id, film_id, store_id, last_update)
    SELECT inventory_id, film_id, store_id, last_update FROM film_pg.public.inventory;
END;
$$;
```

- Очищает таблицу `staging.inventory`.
- Загружает новые данные из базы-источника.

#### **3.4.2. Процедура для загрузки данных о прокате (`rental`)**

```sql
CREATE OR REPLACE PROCEDURE staging.load_rental_data()
LANGUAGE plpgsql AS
$$
BEGIN
    TRUNCATE TABLE staging.rental;
    INSERT INTO staging.rental (rental_id, rental_date, inventory_id, customer_id, return_date, staff_id, last_update)
    SELECT rental_id, rental_date, inventory_id, customer_id, return_date, staff_id, last_update
    FROM film_pg.public.rental;
END;
$$;
```

- Очищает таблицу `staging.rental`.
- Загружает новые записи из базы-источника.

#### **3.4.3. Запуск процедур**

После создания всех процедур их можно **запускать вручную**:

```sql
CALL staging.load_inventory_data();
CALL staging.load_rental_data();
```

После выполнения этих команд **все данные загружаются в Staging Layer**.

---

### **3.5. Автоматизация загрузки данных**

Лектор объясняет, что вручную запускать процедуры **неудобно**, поэтому в будущем их можно **автоматизировать**.

#### **3.5.1. Создание общей процедуры для загрузки всех данных**

Можно создать одну **объединяющую процедуру**, которая будет запускать все три загрузки:

```sql
CREATE OR REPLACE PROCEDURE staging.load_all_data()
LANGUAGE plpgsql AS
$$
BEGIN
    CALL staging.load_film_data();
    CALL staging.load_inventory_data();
    CALL staging.load_rental_data();
END;
$$;
```

После этого **запуск одной команды** загрузит все данные:

```sql
CALL staging.load_all_data();
```

#### **3.5.2. Настройка выполнения по расписанию**

- В PostgreSQL можно **настроить автоматическое выполнение** процедуры раз в день.
- Для этого используется **pg_cron** (планировщик заданий).

**Пример задания в `pg_cron`:**

```sql
SELECT cron.schedule('0 2 * * *', 'CALL staging.load_all_data()');
```

- Это задание будет **выполняться каждый день в 2:00 ночи**.

---

### **Выводы из третьей части**

- **Добавлены новые таблицы** (`inventory`, `rental`).
- **Созданы процедуры** для загрузки данных из базы-источника.
- **Автоматизирован процесс загрузки данных** с помощью общей процедуры.
- **Запланирована настройка выполнения загрузки по расписанию**.

---

