# Глава 01. Создаем staging слой

Первая глава курса посвящена созданию базового слоя хранилища данных — Staging Layer. Это фундаментальный этап, который закладывает основу для всей последующей работы с данными.

## [[01.1. Введение в курс и концепция хранилищ данных]] [01.1. Введение в курс и концепция хранилищ данных](../полный/Глава 01. Создаем staging слой/подтемы/01.1. Введение в курс и концепция хранилищ данных.md)

Курс начинается с объяснения необходимости хранилищ данных. На примере магазина компакт-дисков показано, что данные часто распределены по разным системам (БД магазина, бухгалтерская система 1С), что затрудняет построение аналитических отчетов. Аналитические запросы создают большую нагрузку на операционные базы данных, замедляя их работу.

Решение — создание отдельного хранилища данных (DWH), которое объединяет данные из разных источников, разгружает операционные БД и позволяет быстро строить отчеты. Хранилище состоит из трех основных слоев: Staging (промежуточный слой для сырых данных), Core (основное хранилище с обработанными данными) и Data Marts (витрины данных для конкретных отчетов). Также рассмотрены OLAP-кубы как специализированные структуры для анализа, хотя в современных системах они используются реже благодаря улучшенной производительности баз данных.

## [[01.2. Создание слоёв хранилища данных (staging layer)]] [01.2. Создание слоёв хранилища данных (staging layer)](../полный/Глава 01. Создаем staging слой/подтемы/01.2. Создание слоёв хранилища данных (staging layer).md)

Практическая часть начинается с создания Staging Layer — промежуточного хранилища сырых данных. Слой изолирует основное хранилище от источников, сохраняет данные без изменений и упрощает их дальнейшую обработку.

Рассмотрены варианты загрузки данных: первоначальная загрузка (полная загрузка всех данных при первом запуске), инкрементальная загрузка (только изменения) и полная перезагрузка (для небольших таблиц). В курсе сначала используется полная перезагрузка.

Создается отдельная база данных для DWH (например, `dw_film`) и схема `staging` внутри нее. Для подключения к базе данных источника используется PostgreSQL FDW (Foreign Data Wrapper) — современный способ подключения к удаленным серверам. Настраивается серверное соединение и маппинг пользователей.

Создается таблица `staging.film` для хранения данных о фильмах. Важно заменить специфические типы данных источника (например, ENUM) на стандартные типы (VARCHAR) в хранилище. Создается процедура `staging.load_film_data()` для загрузки данных из источника в Staging Layer.

## [[01.3. Оптимизация загрузки данных в Staging Layer и работа с типами данных]] [01.3. Оптимизация загрузки данных в Staging Layer и работа с типами данных](../полный/Глава 01. Создаем staging слой/подтемы/01.3. Оптимизация загрузки данных в Staging Layer и работа с типами данных.md)

Для оптимизации работы Staging Layer рассматриваются два подхода к загрузке данных: TRUNCATE + INSERT (полная перезагрузка, простая в реализации) и DELETE + INSERT (инкрементальная загрузка, требует механизма определения изменений). На данном этапе используется первый подход.

Важное правило: Staging = копия источника (никаких преобразований), Core = обработанные данные. При переносе данных из источника могут возникнуть проблемы с типами данных — специфические типы PostgreSQL (ENUM, пользовательские типы) нужно заменять на стандартные типы.

Staging-слой расширяется добавлением таблиц `staging.inventory` (информация о физических копиях фильмов) и `staging.rental` (информация о прокате). Создаются процедуры для загрузки данных в эти таблицы. Для автоматизации создается общая процедура `staging.load_all_data()`, которая запускает все загрузки, и настраивается автоматическое выполнение через `pg_cron` (например, каждый день в 2:00 ночи).

## [[01.4. Переход от Staging к Core Layer, нормализация данных и оптимизация]] [01.4. Переход от Staging к Core Layer, нормализация данных и оптимизация](../полный/Глава 01. Создаем staging слой/подтемы/01.4. Переход от Staging к Core Layer, нормализация данных и оптимизация.md)

После создания Staging Layer данные переносятся в Core Layer — основной слой хранилища с нормализованными и обработанными данными. В отличие от Staging, где данные хранятся "как есть", в Core Layer данные очищаются, нормализуются и приводятся к единому формату.

Создается схема `core` и таблица `core.film` с добавлением поля `created_at` для хранения даты загрузки. Выполняется очистка данных: удаление дубликатов, замена NULL значений на значения по умолчанию, нормализация (разделение данных на отдельные таблицы, например, категории фильмов).

Создается ETL-процедура `core.load_film_to_core()` для переноса данных из Staging в Core. Для оптимизации производительности добавляются индексы на ключевые поля и используется партиционирование таблиц для больших объемов данных. Автоматизируется процесс загрузки через общую процедуру `core.load_all_to_core()` и настройку выполнения по расписанию через `pg_cron`.

## [[01.5. Создание витрин данных (Data Marts) и построение отчетов]] [01.5. Создание витрин данных (Data Marts) и построение отчетов](../полный/Глава 01. Создаем staging слой/подтемы/01.5. Создание витрин данных (Data Marts) и построение отчетов.md)

Завершающий этап — создание Data Marts (витрин данных) — оптимизированных наборов данных для построения конкретных отчетов. Витрины содержат агрегированные данные, готовые для анализа, и разгружают основное хранилище.

Создается схема `mart` для изоляции витрин. Разрабатываются два отчета: `mart.revenue_report` (выручка по месяцам с расчетом прибыли) и `mart.category_sales` (продажи по категориям фильмов). Для каждого отчета создаются процедуры загрузки данных из Core Layer с агрегацией.

Автоматизируется обновление витрин через общую процедуру `mart.load_all_marts()` и настройку выполнения по расписанию. Витрины готовы для подключения к BI-системам (Power BI, Tableau, Metabase) для визуализации данных.

---

**Подробнее:** [[Глава 01. Создаем staging слой]] [Глава 01. Создаем staging слой](../полный/Глава 01. Создаем staging слой/Глава 01. Создаем staging слой.md)

